<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title></title>
<style>
    body {font-family:Arial,sans-serif;background:#1e1e1e;color:#eee;margin:0;padding:10px;box-sizing:border-box;}
    #chat {height:100vh;overflow-y:auto;background:#2c2f33;padding:10px;border-radius:8px;margin-bottom:10px;}
    .msg {margin:6px 0;word-wrap:break-word;line-height:1.6;}
    .name {font-weight:bold;margin-right:6px;}
    #status {margin:0px 0;font-weight:bold;color:#0f0;}
    #inputArea {display:none;align-items:center;flex-wrap:wrap;gap:8px;}
    #msgInput {flex:1;min-width:200px;padding:12px;background:#333;color:white;border:none;border-radius:6px;font-size:14px;}
    button {padding:10px 16px;background:#9146ff;color:white;border:none;border-radius:6px;cursor:pointer;}
    button:disabled {background:#444;cursor:not-allowed;}
    #loginBtn {background:#6441a5;}
    #logoutBtn {background:#c42b1c;}
    #userInfo {display:flex;align-items:center;gap:10px;margin-left:auto;}
    #userInfo img {width:36px;height:36px;border-radius:50%;}

    a {color:#1e90ff;text-decoration:underline;}
    img, video, iframe {max-width:320px;max-height:220px;margin:6px 0;border-radius:8px;display:block;cursor:pointer;}
    video {background:#000;}
    iframe {border:none;}

    /* 新增：讓 [s][e] 圖片更好看 */
    .zero-width-image {
        max-width: 340px;
        max-height: 260px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.6);
        margin: 10px 0;
    }

    .emoji-panel {
        position:fixed;background:#18181b;border:1px solid #333;border-radius:10px;z-index:999999;
        width:380px;height:460px;display:none;box-shadow:0 0 30px rgba(0,0,0,0.9);color:white;
        flex-direction:column;font-size:13px;
    }
    .emoji-header {background:#9146ff;padding:12px;text-align:center;cursor:move;font-weight:bold;}
    .emoji-tabs {display:flex;flex-wrap:wrap;background:#1f1f23;padding:8px;gap:5px;overflow-x:auto;}
    .emoji-tab {
        width:36px;height:36px;background:#333;border-radius:6px;cursor:pointer;
        background-size:cover;background-position:center;flex-shrink:0;
    }
    .emoji-tab.active {outline:3px solid #9146ff;}
    .emoji-content {flex:1;overflow-y:auto;padding:10px;background:#18181b;display:flex;flex-wrap:wrap;gap:8px;}
    .emoji-item {position:relative;}
    .emoji-item img {width:40px;height:40px;border-radius:6px;cursor:pointer;}
    .delete-btn {
        position:absolute;top:-8px;right:-8px;background:red;color:white;width:20px;height:20px;
        border-radius:50%;font-size:12px;line-height:20px;text-align:center;cursor:pointer;display:none;
    }
    .emoji-item:hover .delete-btn {display:block;}
    .bttv-input {width:100%;display:flex;gap:6px;margin-bottom:10px;}
    .bttv-input input {flex:1;padding:8px;background:#333;color:white;border:none;border-radius:4px;}
</style>
</head>
<body>

<h2></h2>
<div id="status">載入中...</div>

<div id="userInfo" style="display:none;">
    <img id="userAvatar" src="" alt="頭像">
    <span id="userName"></span>
    <button id="logoutBtn">登出</button>
</div>

<div id="chat"></div>

<div id="inputArea">
    <input type="text" id="msgInput" placeholder="登入後即可發言..." autocomplete="off" disabled>
    <button id="sendBtn" disabled>送出</button>
    <button id="emojiBtn">表情</button>
    <button id="loginBtn">Twitch 登入</button>
</div>

<!-- 自訂表情面板 -->
<div id="emojiPanel" class="emoji-panel">
    <div class="emoji-header">自訂表情面板（拖曳移動）</div>
    <div class="emoji-tabs" id="emojiTabs"></div>
    <div class="emoji-content" id="emojiContent"></div>
</div>

<script src="https://chicktv.github.io/tv/tmi.min.js"></script>
<script>
// ===================== 重要設定 =====================
const CLIENT_ID = '請填入你的_CLIENT_ID'; // 前往 https://twitchapps.com/tmi/ 取得（點 Connect with Twitch 後會給你）
const channel = "whitewing940920"; // 要觀看的頻道（小寫）

const REDIRECT_URI = encodeURIComponent(location.origin + location.pathname);
const AUTH_URL = `https://id.twitch.tv/oauth2/authorize?client_id=${CLIENT_ID}&redirect_uri=${REDIRECT_URI}&response_type=token&scope=chat:read+chat:edit`;

// ===================== 全域變數 =====================
let oauthToken = '';
let username = 'justinfan666';
let userDisplayName = '';
let userAvatar = '';
let client = null;

const status   = document.getElementById('status');
const chat     = document.getElementById('chat');
const input    = document.getElementById('msgInput');
const loginBtn = document.getElementById('loginBtn');
const logoutBtn = document.getElementById('logoutBtn');
const userInfo = document.getElementById('userInfo');
const userAvatarEl = document.getElementById('userAvatar');
const userNameEl   = document.getElementById('userName');

// 表情系統
let emojiLists = {};
let altToEmojiMap = {};
let isDeleteMode = false;

// 正則
const youtubeRegex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
const twitterImageRegex = /https?:\/\/pbs\.twimg\.com\/media\/[^?]+\?format=(jpg|jpeg|png|gif|webp)/i;
const mp4Regex = /\.mp4(?:[/?].*)?$/i;

// ===================== 登入系統 =====================
function checkLogin() {
    if (location.hash.includes('access_token=')) {
        const token = new URLSearchParams(location.hash.slice(1)).get('access_token');
        if (token) {
            oauthToken = 'oauth:' + token;
            localStorage.setItem('twitch_token', oauthToken);
            history.replaceState(null, null, location.pathname);
            fetchUserInfo(token);
        }
    } else {
        const saved = localStorage.getItem('twitch_token');
        if (saved) {
            oauthToken = saved;
            fetchUserInfo(saved.replace('oauth:', ''));
        }
    }
}

async function fetchUserInfo(token) {
    try {
        const res = await fetch('https://api.twitch.tv/helix/users', {
            headers: { 'Client-ID': CLIENT_ID, 'Authorization': 'Bearer ' + token }
        });
        const data = await res.json();
        if (data.data?.[0]) {
            username = data.data[0].login;
            userDisplayName = data.data[0].display_name;
            userAvatar = data.data[0].profile_image_url;
            loginSuccess();
        }
    } catch (e) {
        alert('登入失敗，請重新登入');
        logout();
    }
}

function loginSuccess() {
    status.textContent = `已登入成功：${userDisplayName}，可以發言囉！`;
    input.disabled = false;
    document.getElementById('sendBtn').disabled = false;
    loginBtn.style.display = 'none';
    userInfo.style.display = 'flex';
    userAvatarEl.src = userAvatar;
    userNameEl.textContent = userDisplayName;
    connectChat();
}

function logout() {
    localStorage.removeItem('twitch_token');
    location.reload();
}

loginBtn.onclick = () => {
    if (!CLIENT_ID.includes('請填入')) location.href = AUTH_URL;
    else alert('請先填入 CLIENT_ID！\n前往 https://twitchapps.com/tmi/ 點「Connect with Twitch」取得');
};
logoutBtn.onclick = logout;

// ===================== 訊息處理（重點：加入 [s]網址[e] 支援）=====================
// ═══════════════════ 完美修好的 processMessage ═══════════════════

// ═══════════════════ 2025 終極防呆版 processMessage ═══════════════════
// ═══════════════════ 最終極簡無腦版（強烈推薦）═══════════════════
// ═══════════════════ 永遠不會再壞的終極版（2025-2030 通用）═══════════════════
function processMessage(text) {
    let html = text;

    // Step 1: [s]...[e] 直接暴力當圖片（不管三七二十一）
    html = html.replace(/\[s\](https?:\/\/[^\s\[\]]+)\[e\]/gi, (match, url) => {
        return `<br><img src="${url}" class="zero-width-image" loading="lazy" 
                onerror="this.style.display='none';this.insertAdjacentHTML('afterend','<a href=&quot;${url}&quot; target=_blank>${url}</a>')"
                onclick="window.open(this.src,'_blank')">`;
    });

    // Step 2: 裸網址也用同樣暴力策略
    html = html.replace(/(https?:\/\/[^\s<>"'\]\[]+)/g, url => {
        // YouTube、MP4 還是走原本邏輯
        if (youtubeRegex.test(url)) {
            const id = url.match(youtubeRegex)[1];
            return `<br><iframe src="https://www.youtube.com/embed/${id}?autoplay=0" width="340" height="191" frameborder="0" allowfullscreen></iframe>`;
        }
        if (mp4Regex.test(url)) {
            return `<br><video src="${url}" controls autoplay loop muted class="zero-width-image" loading="lazy"></video>`;
        }

        // 其餘所有網址：先當圖片試，失敗就自動變連結（永遠不會壞）
        return `<br><img src="${url}" class="zero-width-image" loading="lazy"
                onerror="this.style.display='none';this.insertAdjacentHTML('afterend','<a href=&quot;${url}&quot; target=_blank>${url}</a>')"
                onclick="window.open(this.src,'_blank')">`;
    });

    // Step 3: 最後才處理表情（避免吃到網址）
    for (const [alt, data] of Object.entries(altToEmojiMap)) {
        const escaped = alt.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const regex = new RegExp(`(^|\\s)(${escaped})(?=$|\\s|[\\.,!\\?\\)\\(])`, 'g');
        html = html.replace(regex, `$1<img src="${data.src}" style="height:7em;vertical-align:middle;margin:0 3px;cursor:pointer;" onclick="window.open(this.src,'_blank')">`);
    }

    return html;
}

// ===================== 表情系統（完整保留）=====================
function loadEmojiSets() {
    // 公開表情包
    fetch("https://chicktv.github.io/tv/showset.txt").then(r=>r.json()).then(setarray=>{
        setarray.set.forEach(list=>{
            emojiLists[list.name] = {emojis:[], image:list.image||''};
            fetch(`https://chicktv.github.io/tv/${list.name}.txt`).then(r=>r.json()).then(data=>{
                data[list.name].forEach(icon=>{
                    if(icon.alt && icon.src){
                        emojiLists[list.name].emojis.push({alt:icon.alt, src:icon.src, dis:icon.dis||icon.alt});
                        altToEmojiMap[icon.alt] = {src:icon.src, width:'32', height:'32'};
                    }
                });
                renderEmojiPanel();
            });
        });
    });

    // 本台專屬
    fetch("https://chicktv.github.io/tv/skuser_icon.txt").then(r=>r.json()).then(icons=>{
        emojiLists["本台"] = {emojis:[], image:"https://i.imgur.com/5z3X8dP.png"};
        icons.forEach(i=>{
            emojiLists["本台"].emojis.push({alt:i.alt, src:i.src, dis:i.alt});
            altToEmojiMap[i.alt] = {src:i.src, width:'32', height:'32'};
        });
        renderEmojiPanel();
    });

    // 個人 BTTV
    const saved = JSON.parse(localStorage.getItem('myBTTV')||'[]');
    emojiLists["BTTV"] = {
        emojis: saved.map(url=>({alt:url.split('/').pop().split('?')[0], src:url, dis:url})),
        image: "https://cdn.betterttv.net/assets/logo.png"
    };
    renderEmojiPanel();
}

function renderEmojiPanel() { /* 以下完全不變，略過 100 行，保持原樣 */ 
    const tabs = document.getElementById('emojiTabs');
    const content = document.getElementById('emojiContent');
    tabs.innerHTML = ''; content.innerHTML = '';

    Object.keys(emojiLists).forEach((name, i) => {
        const tab = document.createElement('div');
        tab.className = 'emoji-tab';
        tab.style.backgroundImage = `url(${emojiLists[name].image || 'https://via.placeholder.com/36?text=' + name[0]})`;
        tab.title = name;
        tab.onclick = () => {
            document.querySelectorAll('.emoji-tab').forEach(t=>t.classList.remove('active'));
            tab.classList.add('active');
            renderTabContent(name);
        };
        if (i===0) tab.classList.add('active');
        tabs.appendChild(tab);
    });
    renderTabContent(Object.keys(emojiLists)[0] || 'BTTV');
}

function renderTabContent(name) {
    const content = document.getElementById('emojiContent');
    content.innerHTML = '';

    if (name === "BTTV") {
        content.innerHTML += `
            <div class="bttv-input">
                <input type="text" id="bttvUrl" placeholder="輸入 BTTV 圖片網址">
                <button onclick="addBTTV()">儲存</button>
                <button onclick="isDeleteMode=!isDeleteMode;renderEmojiPanel()" style="background:${isDeleteMode?'#666':'#c42b1c'}">
                    ${isDeleteMode?'取消刪除':'開啟刪除'}
                </button>
            </div>`;
    }

    emojiLists[name].emojis.forEach(emoji => {
        const div = document.createElement('div');
        div.className = 'emoji-item';
        div.innerHTML = `<img src="${emoji.src}" title="${emoji.dis||emoji.alt}">`;
        if (name==="BTTV" && isDeleteMode) {
            div.innerHTML += `<div class="delete-btn" onclick="event.stopPropagation();deleteBTTV('${emoji.src}')">X</div>`;
        }
        div.onclick = () => {
            if (name!=="BTTV" || !isDeleteMode) {
                input.value += (input.value ? ' ' : '') + (emoji.alt || emoji.src);
                input.focus();
            }
        };
        content.appendChild(div);
    });
}

window.addBTTV = () => {
    const url = document.getElementById('bttvUrl').value.trim();
    if (!url) return;
    const saved = JSON.parse(localStorage.getItem('myBTTV')||'[]');
    if (!saved.includes(url)) {
        saved.push(url);
        localStorage.setItem('myBTTV', JSON.stringify(saved));
        emojiLists["BTTV"].emojis.push({alt:url.split('/').pop().split('?')[0], src:url});
        renderEmojiPanel();
    }
    document.getElementById('bttvUrl').value = '';
};

window.deleteBTTV = (url) => {
    let saved = JSON.parse(localStorage.getItem('myBTTV')||'[]');
    saved = saved.filter(u=>u!==url);
    localStorage.setItem('myBTTV', JSON.stringify(saved));
    emojiLists["BTTV"].emojis = emojiLists["BTTV"].emojis.filter(e=>e.src!==url);
    renderEmojiPanel();
};

// 表情面板拖曳
let dragging = false, offsetX, offsetY;
document.querySelector('.emoji-header')?.addEventListener('mousedown', e=>{
    dragging = true;
    const p = document.getElementById('emojiPanel');
    offsetX = e.clientX - p.offsetLeft;
    offsetY = e.clientY - p.offsetTop;
});
document.addEventListener('mousemove', e=>{
    if(dragging){
        const p = document.getElementById('emojiPanel');
        p.style.left = (e.clientX - offsetX) + 'px';
        p.style.top = (e.clientY - offsetY) + 'px';
    }
});
document.addEventListener('mouseup', ()=>{dragging=false;});

document.getElementById('emojiBtn').onclick = () => {
    const p = document.getElementById('emojiPanel');
    p.style.display = p.style.display==='flex' ? 'none' : 'flex';
    if (p.style.display==='flex') {
        p.style.left = '50%'; p.style.top = '50%';
        p.style.transform = 'translate(-50%,-50%)';
        renderEmojiPanel();
    }
};

// ===================== tmi.js 連線 =====================
function connectChat() {
    client = new tmi.client({
        connection: { secure: true, reconnect: true },
        identity: oauthToken ? { username, password: oauthToken } : undefined,
        channels: [channel]
    });

    client.on('connected', () => {
        status.textContent = `已連線 ${oauthToken?'（已登入）':''}`;
        loadEmojiSets();
    });

    client.on('message', (ch, tags, message) => {
        const div = document.createElement('div');
        div.className = 'msg';

        const name = document.createElement('span');
        name.className = 'name';
        name.style.color = tags.color || '#9146ff';
        name.textContent = (tags['display-name'] || tags.username) + ': ';
        div.appendChild(name);

        const msg = document.createElement('span');
        msg.innerHTML = processMessage(message);
        div.appendChild(msg);

        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
    });

    client.connect().catch(console.error);
}

function send() {
    const msg = input.value.trim();
    if (msg && oauthToken && client?.readyState() === 'OPEN') {
        client.say(channel, msg);
        input.value = '';
    }
}

document.getElementById('sendBtn').onclick = send;
input.addEventListener('keypress', e => { if(e.key==='Enter') send(); });

// ===================== 啟動 =====================
if (!oauthToken) connectChat();
checkLogin();
</script>
</body>
</html>
