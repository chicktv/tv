<!DOCTYPE html>
<html>
<head>
    <title>Streaming Hub</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <style>
        body {
            background-color: rgb(50, 50, 50);
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            color: white;
            text-align: center;
        }
        .live {
            color: #32CD32;
            box-shadow: 0 0 10px #32CD32, 0 0 10px #32CD32, 0 0 40px #32CD32, 0 0 10px #52D017 inset;
            transform: scale(1.05);
        }
        .not-live {
            background-color: red;
        }
        .active {
            background-color: yellow;
        }
        .status-button {
            margin-right: 5px;
            margin-bottom: 5px;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
        }
        #top-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            flex-wrap: wrap;
            padding: 10px;
        }
        #input-container {
            display: flex;
            align-items: center;
            gap: 5px;
            white-space: nowrap;
        }
        .unknown {
            background-color: white;
        }
        #lists {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 5px;
            flex-grow: 1;
        }
        .input-container {
            display: flex;
            align-items: center;
            gap: 5px;
            order: 99;
        }
        .content {
            display: flex;
            flex: 1;
            flex-direction: column;
            height: 100%;
        }
        .video, .chat {
            border: none;
        }
        .video {
            height: 30vh;
            width: 100%;
        }
        .chat {
            height: 70vh;
            width: 100%;
        }
        input {
            padding: 5px;
            margin-right: 5px;
        }
        button {
            padding: 5px 10px;
            cursor: pointer;
        }
        @media (min-width: 768px) {
            .content {
                flex-direction: row;
            }
            .video {
                height: 100%;
                width: 70%;
            }
            .chat {
                height: 100%;
                width: 30%;
            }
        }
    </style>
</head>
<body>

<script>
    let channels = [];

   async function loadChannelsFromUrl() {
    try {
        const response = await fetch('https://chicktv.github.io/tv/channels.txt');
        const data = await response.text();
        // Assuming the file contains the channel info in a comma-separated format (name, id, platform)
        const channelLines = data.split('\n');

        channels = channelLines.map(line => {
            // Split the line by comma and trim spaces
            const parts = line.split(',').map(part => part.trim());
            // Ensure the line contains exactly 3 parts (name, id, platform)
            if (parts.length === 3) {
                const [name, id, platform] = parts;
                return { name, id, platform };
            } else {
                return null; // Skip invalid lines
            }
        }).filter(channel => channel !== null); // Remove null entries

        saveChannelsToStorage();
        generateButtons();
    } catch (error) {
        console.error('Error loading channels from URL:', error);
    }
}


    function saveChannelsToStorage() {
        localStorage.setItem("customChannels", JSON.stringify(channels.filter(ch => !isDefaultChannel(ch))));
    }

    function loadChannelsFromStorage() {
        const storedChannels = JSON.parse(localStorage.getItem("customChannels") || "[]");
        channels = [...channels.filter(isDefaultChannel), ...storedChannels];
    }

    function isDefaultChannel(channel) {
        return ["ww291603", "Eastsnake25", "collartv", "nanase-maru525", "jeukpo", "qt369", "cobra2024", 
                "alancml", "mingpig930_2", "godzilla_2025", "yaubotai2", "3849262800563", "9013975129715"]
               .includes(channel.id);
    }

    function generateButtons() {
        const container = document.getElementById("lists");
        container.innerHTML = "";  // Clear previous buttons
        channels.forEach(channel => addButton(channel));
        fetchAllStatuses();
    }

    function addButton(channel) {
        const container = document.getElementById("lists");

        // Create button to switch live stream
        const btn = document.createElement("button");
        btn.className = "status-button";
        btn.id = `btn-${channel.id}`;
        btn.innerText = `${channel.platform === "kick" ? "Ⓚ" : channel.platform === "twitch" ? "Ⓣ" : "ⓞ"}${channel.name}`;

        // Button event handler to change live stream source
        btn.onclick = () => {
            console.log("Switching to stream for:", channel.name);
            changeSrc(getStreamUrl(channel)); // Call function to change the iframe source
        };

        // Create delete button
        const deleteBtn = document.createElement("button");
        deleteBtn.innerText = "刪除";
        deleteBtn.style.display = "none"; // Initially hide delete button

        // Delete button event handler
        deleteBtn.onclick = () => {
            console.log("Deleting channel:", channel.name);
            channels = channels.filter(ch => ch.id !== channel.id); // Remove channel from list
            saveChannelsToStorage();
            generateButtons();  // Regenerate buttons after deletion
        };

        // Wrapper for both buttons
        const buttonWrapper = document.createElement("div");
        buttonWrapper.appendChild(btn);
        buttonWrapper.appendChild(deleteBtn);

        container.appendChild(buttonWrapper);
    }

    // Helper function to fetch stream URL based on platform
    function getStreamUrl(channel) {
        if (channel.platform === "kick") {
            return `https://player.kick.com/${channel.id}`;
        } else if (channel.platform === "twitch") {
            return `https://player.twitch.tv/?channel=${channel.id}&parent=chicktv.github.io`;
        } else if (channel.platform === "ok") {
            return `https://ok.ru/videoembed/${channel.id}?nochat=1&autoplay=1`;
        }
    }

    // Function to change the iframe src to the selected channel's stream
    function changeSrc(url) {
        document.getElementById("MyFrame").src = url; // Change the source of the iframe
    }

    async function fetchStatus(channel) {
        const btn = document.getElementById(`btn-${channel.id}`);
        let url = getPlatformUrl(channel);

        if (channel.platform === "ok") {
            btn.classList.add("unknown");
            btn.classList.remove("live", "not-live");
            return;
        }
        try {
            const response = await fetch(url);
            const data = await response.json();
            let isLive = false;

            if (channel.platform === "kick") {
                isLive = data.livestream && data.livestream.is_live;
            } else if (channel.platform === "twitch") {
                isLive = data.data.length > 0;
            }

            if (isLive) {
                btn.classList.add('live');
                btn.classList.remove('not-live');
            } else {
                btn.classList.add('not-live');
                btn.classList.remove('live');
            }
        } catch (error) {
            console.error('Error fetching status:', error);
            btn.classList.add('not-live');
            btn.classList.remove('live');
        }
    }

    // Helper function to generate platform specific URL
    function getPlatformUrl(channel) {
        if (channel.platform === "kick") {
            return `https://kick.com/api/v2/channels/${channel.id}`;
        } else if (channel.platform === "twitch") {
            return `https://twitch-proxy.freecodecamp.rocks/helix/streams?user_login=${channel.id}`;
        } else {
            return "";
        }
    }

    function fetchAllStatuses() {
        channels.forEach(channel => fetchStatus(channel));
    }

    function clickyClick() {
        let input = document.getElementById("newid").value.trim();
        if (!input) return;

        let platform = "twitch"; // 默認平台為Twitch
        let id = input;

        if (input.startsWith("[k]")) {
            platform = "kick"; // 如果以 [k] 開頭，設置平台為 Kick
            id = input.substring(3); // 去掉 [k] 前綴
        } else if (input.startsWith("[o]")) {
            platform = "ok"; // 如果以 [o] 開頭，設置平台為 OK
            id = input.substring(3); // 去掉 [o] 前綴
        }

        const existingChannelIndex = channels.findIndex(ch => ch.id === id);
        if (existingChannelIndex > -1) {
            channels[existingChannelIndex].platform = platform;
        } else {
            const newChannel = { name: id, id, platform };
            channels.push(newChannel);
        }

        saveChannelsToStorage();
        generateButtons();
    }

    function editClick() {
        // 找到所有的刪除按鈕，並讓它們顯示
        const deleteButtons = document.querySelectorAll("button");
        deleteButtons.forEach(btn => {
            if (btn.innerText === "刪除") {
                btn.style.display = "inline"; // 顯示刪除按鈕
            }
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadChannelsFromUrl(); // Load channels from the URL when the page loads
        setInterval(fetchAllStatuses, 480000);
    });
</script>

<div id="top-bar">
    <div id="lists"></div>
    <div id="input-container">
        <input type="text" id="newid" placeholder="twitch id / k台 id 前加 [k]" />
        <button onclick="clickyClick()">加台</button>
        <button onclick="editClick()">del台</button>
		<button onclick="window.location.href ='https://chicktv.github.io/tv/chicktv3.html'">看更台</button>
        <button onclick="changechatSrc('https://sk-knower.com/chat/whitewing940920?pop=true')">SKchat</button>
        <button onclick="changechatSrc('https://www.twitch.tv/embed/whitewing940920/chat?darkpopout&parent=chicktv.github.io')">Tchat</button>
    </div>
</div>

<div class="content">
    <iframe id="MyFrame" class="video" src="https://ok.ru/videoembed/9013975129715?nochat=1&autoplay=1" frameborder="0" allowfullscreen></iframe>
    <iframe class="chat" id="chat_embed" src="https://www.twitch.tv/embed/Whitewing940920/chat?darkpopout&parent=chicktv.github.io"></iframe>
</div>

</body>
</html>
