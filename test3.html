<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Chickchat</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        :root { --t-bg: #0e0e10; --t-alt: #18181b; --t-purp: #9147ff; --t-text: #efeff1; --input-bg: #18181b; }
        body { background: var(--t-bg); color: var(--t-text); font-family: sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* --- Webkit Scrollbar æ¨£å¼ --- */
        #chat-container::-webkit-scrollbar, #emojiContent::-webkit-scrollbar, #emojiTabs::-webkit-scrollbar, #mention-list::-webkit-scrollbar { width: 8px; height: 8px; }
        #chat-container::-webkit-scrollbar-track, #emojiContent::-webkit-scrollbar-track, #emojiTabs::-webkit-scrollbar-track, #mention-list::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.2); }
        #chat-container::-webkit-scrollbar-thumb, #emojiContent::-webkit-scrollbar-thumb, #emojiTabs::-webkit-scrollbar-thumb, #mention-list::-webkit-scrollbar-thumb { background: #444; border-radius: 10px; }
        #chat-container::-webkit-scrollbar-thumb:hover, #emojiContent::-webkit-scrollbar-thumb:hover, #emojiTabs::-webkit-scrollbar-thumb:hover, #mention-list::-webkit-scrollbar-thumb:hover { background: var(--t-purp); }

        /* çµ±ä¸€æ§åˆ¶åª’é«”åµŒå…¥å¤§å° */
        #chat-container .media-preview,
        #chat-container iframe.media-preview,
        #chat-container iframe[src*="youtube.com"],
        #chat-container iframe[src*="youtube-nocookie.com"],
        #chat-container iframe[src*="youtu.be"],
        #chat-container iframe[src*="facebook.com"],
        #chat-container blockquote.twitter-tweet,
        #chat-container .twitter-tweet-container,
        #chat-container iframe[src*="store.steampowered.com"],
        #chat-container iframe[src*="threads.com"] {
            width: auto !important;
            height: auto !important;
            max-width: 250px !important;
            max-height: 250px !important;
            border-radius: 8px !important;
            border: 0px solid #444 !important;
            margin: 5px 0 !important;
            object-fit: fill !important;
        }

        /* é‡å°YouTubeã€Twitterã€Threadsã€Steamçš„ç‰¹æ®Šèª¿æ•´ */
        #chat-container iframe[src*="youtube.com"],
        #chat-container iframe[src*="youtube-nocookie.com"],
        #chat-container blockquote.twitter-tweet,
        #chat-container iframe[src*="threads.com"],
        #chat-container iframe[src*="store.steampowered.com"] {
            min-height: 400px !important;
        }

        #chat-container iframe[src*="threads.com"] { background: #FFF !important; }

        /* åœ–ç‰‡èˆ‡å½±ç‰‡ä¿æŒåŸæœ‰æ¯”ä¾‹ */
        #chat-container img.media-preview {
            height: auto !important;
            max-height: 250px !important;
            min-height: auto !important;
            object-fit: fill !important;
        }
        #chat-container video.media-preview {
            height: auto !important;
            max-height: 250px !important;
            min-height: auto !important;
        }

        .header-bar { background: var(--t-alt); padding: 0px 0px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; flex-shrink: 0; }
        #chat-container { flex: 1; overflow-y: auto; padding: 15px; background: #0e0e10; scroll-behavior: smooth; position: relative; }
        .chat-line { position: relative; border-radius: 4px; line-height: 1.6; word-wrap: break-word; color: var(--t-text); transition: background 0.3s, border 0.3s; padding: 1px; margin-bottom: 5px; border: 1px solid transparent; }
        .chat-line:hover { background: rgba(255,255,255,0.08); }
        .chat-line:has(.quote-box) { border: 1px solid #9147ff; background: rgba(145, 71, 255, 0.1) !important; margin-left: 2px; }
        .self-name { color: var(--t-purp); font-weight: bold; }
        .media-preview { max-width: 250px !important; max-height: 250px !important; border-radius: 6px; margin-top: 10px; vertical-align: top; display: block; border: 1px solid #444; }
        
        .audio-player { margin-top: 10px; display: block; max-width: 300px; }
        .alt-emoji { max-width: 180px !important; max-height: 180px !important; vertical-align: top; margin: 2px; }
        .badge { width: 18px; height: 18px; vertical-align: middle; margin-right: 4px; display: inline-block; }
        .reply-btn { position: absolute; right: 10px; top: 10px; width: 28px; height: 28px; border-radius: 50%; display: none; align-items: center; justify-content: center; cursor: pointer; color: #fff; font-size: 10px; z-index: 10; border: 1px solid #444; }
        .reply-btn:hover {background-color: #3c3a39;}
        .chat-line:hover .reply-btn { display: flex; }
        .quote-box { color: #adadb8; padding: 1px; border-radius: 4px; margin-bottom: 1px; line-height: 1.4; display: block; cursor: pointer; border: 1px solid rgba(255,255,255,0.05); }
        .quote-box:hover { background: rgba(255,255,255,0.15); }
        .quote-user { color: #adadb8; margin-right: 5px; }
        .mention-self-tag { background-color: #9147ff; color: #ffffff !important; padding: 2px 6px; border-radius: 4px; font-weight: bold; display: inline-block; margin-bottom: 2px; }
        
        /* --- æ ¹æ“šåœ–ç‰‡å„ªåŒ–è¼¸å…¥å€ä½ˆå±€ --- */
        .footer { background: #0e0e10; padding: 1px 10px 1px 10px; border-top: 0px solid rgba(255, 255, 255, 0.05); position: relative; }
        
        #reply-indicator { display:none; color:#adadb8; font-size:12px; margin-bottom:8px; padding:8px; background:rgba(145,71,255,0.1); border-radius:4px; border: 1px solid rgba(145,71,255,0.3); }
        
        .tool-bar { display: flex; gap: 3px; margin-bottom: -8px; align-items: center; }
        .tool-link { background: none; border: none; color: #adadb8; cursor: pointer; font-size: 14px; padding: 0; font-weight: 500; transition: color 0.2s; display: flex; align-items: center; }
        .tool-link:hover { color: #fff; }
        .tool-link svg { margin-left: 1px; }
        .tool-link svg:hover { fill: #9147ff; }
        .input-section { position: relative; display: flex; flex-direction: column; gap: 10px; }
        .input-box-wrapper { position: relative; display: flex; align-items: center; background: var(--t-input); border: 1px solid #fff; border-radius: 8px; padding: 2px 10px; transition: border 0.2s;}
        .input-box-wrapper:focus-within { border-color: var(--t-purp); background: #000; }
        #msginput { 
            flex: 1; 
            background: transparent; 
            border: none; 
            color: #efeff1; 
            font-size: 14px; 
            outline: none; 
            padding: 10px 0; 
            font-family: inherit; 
            box-sizing: border-box; 
            font-family: inherit; 
            overflow-wrap: break-word; 
            max-height: calc(5lh + 20px); 
            overflow: hidden auto;
            white-space: pre-wrap;
            min-height: 20px;
        }
        #msginput:empty:before {
            content: attr(placeholder);
            color: #777;
        }
        #msginput:focus:empty:before {
            content: attr(placeholder);
            color: #777;
        }
        #msginput:disabled { cursor: not-allowed; opacity: 0.5; }

        .action-bar { display: flex; justify-content: flex-end; margin-top: 0px; }
        #sendbtn { background: var(--t-purp); border: none; color: white; cursor: pointer; padding: 6px 16px; border-radius: 18px; font-weight: bold; font-size: 14px; transition: background 0.2s; }
        #sendbtn:hover { background: #a970ff; }
        #sendbtn:disabled { background: #3a3a3d; color: #777; cursor: not-allowed; }
        
        /* è¡¨æƒ…é¢æ¿ */
        #emojiPanel { 
            position: fixed; 
            display: none; 
            width: 350px; 
            height: 400px; 
            background: #1f182e; 
            border: 2px solid #443a5a; 
            border-radius: 12px; 
            z-index: 5000; 
            left: 50%; 
            top: 50%; 
            transform: translate(-50%, -50%); 
            flex-direction: column; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            cursor: default;
        }
        #emojiPanel.dragging { cursor: grabbing; }
        .emoji-header { 
            padding: 12px; 
            display: flex; 
            justify-content: space-between; 
            background: #26262c; 
            border-radius: 12px 12px 0 0; 
            align-items: center;
            cursor: grab;
            user-select: none;
        }
        .emoji-header:active { cursor: grabbing; }
        #emojiTabs {display: flex;flex-wrap: wrap;background: #1f1f23;padding: 8px;gap: 5px;overflow-x auto;border-bottom: 1px solid #26262c;}
        #emojiContent { flex: 1;overflow-y: auto;padding: 10px;background: #18181b;display: flex;flex-wrap: wrap;gap: 5px;align-content: flex-start; }
        .emoji-tab { width: 36px;height: 36px;background: #3a3a3d;border-radius: 4px;cursor: pointer;background-size: cover;background-position: center;flex-shrink: 0; }
        .emoji-item { position: relative;width: 40px;height: 40px;border-radius: 4px;cursor: pointer;}
        .emoji-item img {width: 40px;height: 40px;border-radius: 4px;cursor: pointer;}
        .bttv-input-area, .audio-input-form { width: 100%;display: flex;gap: 6px;margin-bottom: 10px; }
        .custom-input { background: #000; border: 1px solid #444; color: #fff; padding: 8px; border-radius: 4px; }
        

        /* ========== æ–°æ·»åŠ ï¼šæ²å‹•åˆ°åº•éƒ¨æŒ‰éˆ• ========== */
        #scrollToBottomBtn {
            position: absolute;
            bottom: 80px;
            right: 20px;
            width: 40px;
            height: 40px;
            background: rgba(145, 71, 255, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            transition: all 0.3s ease;
            font-size: 20px;
        }
        
        #scrollToBottomBtn:hover {
            background: rgba(145, 71, 255, 1);
            transform: scale(1.1);
        }
        
        #scrollToBottomBtn:active {
            transform: scale(0.95);
        }
        
        #scrollToBottomBtn svg {
            width: 24px;
            height: 24px;
        }

        .delete-btn { position: absolute;top: -8px;right: -8px;background: #e91916;color: white;width: 20px;height: 20px;border-radius: 50%;font-size: 12px;line-height: 20px;text-align: center;cursor: pointer;display: none; z-index: 100; border: 1px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.5); }
        .show-del .delete-btn { display: block; }
        .audio-item { cursor:pointer; background:rgba(145,71,255,0.1); border:1px solid #444; border-radius:4px; padding:8px; text-align:center; font-size:11px; position:relative; color: #fff; }
        .audio-icon-btn { cursor: pointer; font-size: 20px; vertical-align: middle; display: inline-block; padding: 5px; background: rgba(145, 71, 255, 0.2); border-radius: 4px; transition: all 0.2s ease; user-select: none; }
        .audio-icon-btn.playing { background: #9147ff; color: white; border-color: white; animation: pulse-audio 1.5s infinite; }
        
        @keyframes pulse-audio {
            0% { box-shadow: 0 0 0 0px rgba(145, 71, 255, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(145, 71, 255, 0); }
            100% { box-shadow: 0 0 0 0px rgba(145, 71, 255, 0); }
        }
        
        #userInfo { display: none; align-items: center; gap: 8px; font-size: 13px; }
        #userInfo img { width: 30px; height: 30px; border-radius: 50%; }
        #logoutBtn { background: #e91916; color: white; border: none; border-radius: 4px; padding: 6px 12px; cursor: pointer; font-size: 12px; font-weight: 600; transition: background-color 0.2s; margin-left: 8px; }
        #logoutBtn:hover { background: #c51614; }
        #loginBtn { background: #9147ff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 600; transition: background-color 0.2s; padding: 8px 16px; }
        #loginBtn:hover { background: #772ce8; }
        #status { margin: 8px 12px; font-weight: 500; color: #bf94ff; font-size: 10px; }
        
        /* è¨Šæ¯çµ±è¨ˆ */
        #message-stats {
            margin: 8px 12px;
            font-weight: 500;
            color: #00ff00;
            font-size: 10px;
        }
        
        /* @æåŠé¸å–®æ¨£å¼ - é¡ä¼¼Twitch */
        #mention-list {
            position: absolute;
            bottom: 100%;
            left: 0;
            width: 300px;
            max-height: 350px;
            background: var(--t-alt);
            border: 1px solid #333;
            border-radius: 6px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.5);
            z-index: 9999;
            display: none;
            overflow-y: auto;
            padding: 4px 0;
        }
        
        .mention-item {
            padding: 8px 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s;
            color: var(--t-text);
            font-size: 14px;
        }
        
        .mention-item:hover, .mention-item.selected {
            background: rgba(145, 71, 255, 0.2);
        }
        
        .mention-item .badge {
            width: 16px;
            height: 16px;
            border-radius: 3px;
        }
        
        .mention-item .user-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            object-fit: cover;
        }
        
        .mention-item .display-name {
            font-weight: 600;
            color: var(--t-purp);
        }
        
        .mention-item .login-name {
            color: #adadb8;
            font-size: 12px;
            margin-left: 4px;
        }
        
        .mention-header {
            padding: 8px 12px;
            font-size: 12px;
            color: #adadb8;
            border-bottom: 1px solid #333;
            margin-bottom: 4px;
            background: rgba(0,0,0,0.2);
        }
    </style>
</head>
<body onload="initApp()">

<div class="header-bar">
    <div id="status">è¼‰å…¥ä¸­...</div>
    <div id="message-stats">è¨Šæ¯: 0</div>
    <div id="auth-area">
        <div id="userInfo" style="display:none;">
            <img id="userAvatar" src="" alt="é ­åƒ">
            <span id="userName"></span>
            <button id="logoutBtn">ç™»å‡º</button>
        </div>
        <button id="loginBtn">TWITCH ç™»å…¥</button>
    </div>
</div>

<div id="chat-container">
    <div id="messages"></div>
   
</div>

<!-- @æåŠé¸å–® -->
<div id="mention-list"></div>

<div id="emojiPanel">
    <div class="emoji-header">
        <b style="font-size:14px;">è³‡æºåº« (è¡¨æƒ…/éŸ³è¨Š)</b>
        <button id="emojiCloseBtn" style="background:none; border:none; color:white; cursor:pointer; font-size:18px;">âœ•</button>
    </div>
    <div id="emojiTabs"></div>
    <div id="emojiContent"></div>
</div>

<div class="footer">
    <div id="reply-indicator">
        æ­£åœ¨å›è¦† <span id="replying-to-user" style="color:#9147ff; font-weight:bold;"></span> 
        <span onclick="cancelReply()" style="float:right; cursor:pointer; color:#efeff1;">âœ• å–æ¶ˆå›è¦†</span>
    </div>
    
    <div class="input-section">
        <div class="tool-bar">
         <button id="scrollToBottomBtn" title="æ»¾å‹•åˆ°æœ€æ–°è¨Šæ¯" style="font-size: 24px; line-height: 1;">â‡£</button>
            <button class="tool-link" onclick="insertTagOnly('[s] ')">åœ–ç‰‡</button>
            <button class="tool-link" onclick="insertTagOnly('[y] ')">å½±ç‰‡</button>
            <button class="tool-link" onclick="insertTagOnly('[a] ')">éŸ³è¨Š</button>
        </div>
        
        <div class="input-box-wrapper">
            <div id="msginput" contenteditable="true" placeholder="å‚³é€è¨Šæ¯..." autocomplete="off" disabled></div>
            <button class="tool-link" onclick="renderEmojiPanel(); $('#emojiPanel').css('display','flex')">
                <svg width="30" height="30" viewBox="0 0 20 20" fill="#FFFF00">
                    <path d="M10 2C5.58 2 2 5.58 2 10s3.58 8 8 8 8-3.58 8-8-3.58-8-8-8zm0 14.5c-3.59 0-6.5-2.91-6.5-6.5S6.41 3.5 10 3.5s6.5 2.91 6.5 6.5-2.91 6.5-6.5 6.5zM6.5 9c.83 0 1.5-.67 1.5-1.5S7.33 6 6.5 6 5 6.67 5 7.5 5.67 9 6.5 9zm7 0c.83 0 1.5-.67 1.5-1.5S14.33 6 13.5 6 12 6.67 12 7.5s.67 1.5 1.5 1.5zM10 14c-1.66 0-3.14-.69-4.2-1.8l1.41-1.41C7.83 11.53 8.84 12 10 12s2.17-.47 2.79-1.21l1.41 1.41C13.14 13.31 11.66 14 10 14z"/>
                </svg>
            </button>
        </div>

        <div class="action-bar">
            <button id="sendbtn" onclick="sendMessage()" disabled>èŠå¤©</button>
        </div>
    </div>
</div>

<script>
    // ===================== é‡è¦è¨­å®š =====================
    const CLIENT_ID = '0uhjgjpko804ba35q1nj1h6x2eriq9';
    const CHANNEL = "69nodomcon";
    const REDIRECT_URI = encodeURIComponent(location.origin + location.pathname);
    const AUTH_URL = `https://id.twitch.tv/oauth2/authorize?client_id=${CLIENT_ID}&redirect_uri=${REDIRECT_URI}&response_type=token&scope=chat:read+chat:edit`;

    // ===================== å…¨åŸŸè®Šæ•¸ =====================
    let ACCESS_TOKEN = "";
    let myLoginId = "";
    let myDisplayName = "";
    let myAvatar = "";
    let myBadges = "";
    let socket;
    let altMap = {};
    let emojiLists = {};
    let audioLists = {};
    let customBadges = {};
    let msgCache = {}; 
    let userCache = {}; 
    let pendingReply = { id: null, user: null, displayName: null };
    let isDeleteMode = false;
    let isAudioDeleteMode = false;
    
    // ===================== æ‹–æ›³åŠŸèƒ½è®Šæ•¸ =====================
    let dragging = false;
    let offsetX = 0;
    let offsetY = 0;
    
    // ===================== å¾test3.htmlç§»æ¤çš„æ²å‹•æ§åˆ¶è®Šæ•¸ =====================
    let autoScroll = true;
    let userScrolling = false;
    let scrollTimeout = null;
    const scrollToBottomBtn = document.getElementById('scrollToBottomBtn');
    
    const MAX_MESSAGES = 100;
    let mediaLoadCount = 0;
    let mediaLoadTimer = null;
    
    // @æåŠç›¸é—œè®Šæ•¸
    let recentUsers = [];
    let mentionListVisible = false;
    let mentionSelectedIndex = 0;
    let mentionSearchTerm = "";
    
    // è¨Šæ¯çµ±è¨ˆ
    let messageCount = 0;
    
    // ç”¨æ–¼é˜²æ­¢éè¿´å¼•ç”¨çš„é›†åˆ
    let processedMessages = new Set();
    
    // èª¿è©¦æ¨¡å¼
    window.debugMode = true;

    // ===================== è¼”åŠ©å‡½æ•¸ =====================
    function logDebug(...args) {
        if (window.debugMode) {
            console.log('[DEBUG]', ...args);
        }
    }

    function getParameterByName(name, url) {
        name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
        var regexS = "[\\?&]" + name + "=([^&#]*)";
        var regex = new RegExp(regexS);
        var results = regex.exec(url);
        if (results == null) return "";
        else return decodeURIComponent(results[1].replace(/\+/g, " "));
    }

    function extractTagAndUrl(str) {
        const regex = /\[(s|y|start)\]\s+<a\s+href="([^"]+)"[^>]+>[^<]+<\/a>/i;
        const match = str.match(regex);
        if (match) {
            const tag = match[1];
            const url = match[2];
            return { tag, url, match };
        } else {
            return null;
        }
    }

    function getTagValue(tags, key) { 
        const regex = new RegExp(`${key}=([^;\\s]+)`); 
        const match = tags.match(regex); 
        return match ? match[1] : null; 
    }

    // ç°¡åŒ–ç‰ˆå…§å®¹è§£æï¼ˆç”¨æ–¼å¼•ç”¨å…§å®¹ï¼Œä¸éè¿´ [r]ï¼‰
    function parseContentBasic(str) {
        if (!str) return "...";

        let a = str, placeholders = [];
        
        // åœ–ç‰‡ [s]...e]
        a = a.replace(/\[s\](.*?)e\]/g, (m, content) => {
            let b = content.replace(/[\r\n]/g, "").replace(/ /g, '').replace('[s]', '').replace('[', '');
            let id = `__PH_BASIC_${placeholders.length}__`;
            let e = `<a href="${b}" target="_blank"><img src="${b}" class="media-preview" onload="onMediaLoaded()" onerror="onMediaLoaded()" /></a>`;
            placeholders.push(e);
            return id;
        });
        
        // å½±ç‰‡ [y]...[t]
        a = a.replace(/\[y\](.*?)[\[]?t\]/gi, (m, content) => {
            let b = content.replace(/[\r\n]/g, "").replace(/ /g, '').replace('[y]', '').replace('[', '');
            let id = `__PH_BASIC_${placeholders.length}__`;
            let e = "";
            if (b.match(/youtu/g)) {
                let vid = b.match(/watch\?/g) ? getParameterByName('v', b) : b.replace('https://www.', '').replace('https://', '').replace('youtu.be/', '').replace('youtube.com/embed/', '').replace('youtube.com/shorts/', '').replace('youtube.com/live/', '').replace('&feature=share', '');
                e = `<iframe class="media-preview" onload="onMediaLoaded()" onerror="onMediaLoaded()" src="https://www.youtube.com/embed/${vid}" frameborder="0" allowfullscreen></iframe>`;
            } else {
                e = `<video class="media-preview" onload="onMediaLoaded()" onerror="onMediaLoaded()" autoplay loop muted playsinline src="${b}"></video>`;
            }
            placeholders.push(e);
            return id;
        });
        
        // éŸ³è¨Š [a]...[o]
        a = a.replace(/\[a\](.*?)\[o\]/gi, (m, content) => {
            const url = content.trim(); 
            let id = `__PH_BASIC_${placeholders.length}__`;
            placeholders.push(`<span class="audio-icon-btn" onclick="handleAudioClick(this, '${url}')" data-is-playing="false" title="é»æ“Šæ’­æ”¾éŸ³è¨Š">ğŸ”ˆ</span>`);
            return id;
        });
        
        // ä¸€èˆ¬é€£çµ
        a = a.replace(/https?:\/\/[^\s]+/gi, (url) => url.includes('__PH_BASIC_') ? url : `<a href="${url}" target="_blank" style="color:#58a6ff;">${url}</a>`);
        
        // è‡ªè¨‚è¡¨æƒ…
        let words = a.split(' ');
        a = words.map(w => { 
            if(w.includes('__PH_BASIC_')) return w; 
            const src = altMap[w.toLowerCase()]; 
            return src ? `<img src="${src}" class="alt-emoji">` : w; 
        }).join(' ');
        
        // é‚„åŸä½”ä½
        placeholders.forEach((html, i) => { 
            a = a.replace(`__PH_BASIC_${i}__`, html); 
        });
        
        return a || "...";
    }

    // åŠ å¼·ç‰ˆï¼šéè¿´è§£æ [r]...[m]ï¼Œä¸¦å¢åŠ é˜²å‘†èˆ‡å»¶é²æŸ¥æ‰¾
    function parseMessageWithReplies(content, depth = 0) {
        if (depth > 4) return content; // é˜²æ­¢éæ·±éè¿´

        let result = content;

        result = result.replace(/\[r\](.*?),([\d\w-]+)\[m\]/gi, (match, userLogin, timestamp) => {
            // å„ªå…ˆå¾ msgCache æ‰¾
            let repliedMsg = msgCache[timestamp];

            // å¦‚æœé‚„æ²’æ‰¾åˆ°ï¼Œå˜—è©¦ç”¨ msg-id å†æ‰¾ä¸€æ¬¡ï¼ˆæœ‰æ™‚å€™æ™‚é–“æˆ³æœƒæœ‰å»¶é²ï¼‰
            if (!repliedMsg) {
                for (let key in msgCache) {
                    if (msgCache[key].msgId === timestamp) {
                        repliedMsg = msgCache[key];
                        break;
                    }
                }
            }

            if (!repliedMsg) {
                // é‚„æ‰¾ä¸åˆ° â†’ é¡¯ç¤ºã€Œè¼‰å…¥ä¸­...ã€ä¸¦è¨˜éŒ„ç­‰å¾…
                console.warn(`æ‰¾ä¸åˆ°è¢«å¼•ç”¨çš„è¨Šæ¯ timestamp=${timestamp}, user=${userLogin}`);
                return `<span style="color:#777;">[@${userLogin}] è¨Šæ¯è¼‰å…¥ä¸­...</span>`;
            }

            let rawBody = repliedMsg.content || "...";
            let displayName = repliedMsg.displayName || userLogin;

            // éè¿´è§£æå…§å±¤ [r]
            let body = parseMessageWithReplies(rawBody, depth + 1);

            // å†åšä¸€æ¬¡åŸºæœ¬åª’é«”è§£æ
            body = parseContentBasic(body);

            let isMe = (displayName === myDisplayName || displayName === myLoginId);
            const userTagClass = isMe ? 'quote-user mention-self-tag' : 'quote-user';

            return `<span style="color: #9147ff; cursor: pointer;" onclick="scrollToMsg('${timestamp}')">@${displayName}</span>: ${body}`;
        });

        return result;
    }

    // ===================== æ²å‹•æ§åˆ¶ =====================
    function checkScrollPosition() {
        const chat = document.getElementById('chat-container');
        const isAtBottom = chat.scrollHeight - chat.clientHeight - chat.scrollTop < 50;
        
        if (isAtBottom) {
            autoScroll = true;
            hideScrollButton();
        } else {
            autoScroll = false;
            showScrollButton();
        }
    }

    function showScrollButton() {
        scrollToBottomBtn.style.display = 'flex';
    }

    function hideScrollButton() {
        scrollToBottomBtn.style.display = 'none';
    }

    function scrollToBottom() {
        const chat = document.getElementById('chat-container');
        chat.scrollTop = chat.scrollHeight;
        autoScroll = true;
        hideScrollButton();
        
        setTimeout(() => {
            chat.scrollTop = chat.scrollHeight;
        }, 50);
    }

    function setupScrollListener() {
        const chat = document.getElementById('chat-container');
        chat.addEventListener('scroll', () => {
            if (scrollTimeout) clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(checkScrollPosition, 150);
        });
    }

    function forceScrollToBottom() {
        if (autoScroll) {
            const chat = document.getElementById('chat-container');
            chat.scrollTop = chat.scrollHeight;
            
            let attempts = 0;
            const maxAttempts = 10;
            const scrollInterval = setInterval(() => {
                chat.scrollTop = chat.scrollHeight;
                attempts++;
                if (attempts >= maxAttempts) clearInterval(scrollInterval);
            }, 100);
        }
    }

    // ===================== æ‹–æ›³è¡¨æƒ…é¢æ¿ =====================
    function setupEmojiPanelDrag() {
        const emojiPanel = document.getElementById('emojiPanel');
        const emojiHeader = emojiPanel.querySelector('.emoji-header');
        const emojiCloseBtn = document.getElementById('emojiCloseBtn');
        
        emojiHeader.addEventListener('mousedown', function(e) {
            if (e.target === emojiCloseBtn || e.target.closest('#emojiCloseBtn')) return;
            dragging = true;
            offsetX = e.clientX - emojiPanel.offsetLeft;
            offsetY = e.clientY - emojiPanel.offsetTop;
            emojiPanel.classList.add('dragging');
            e.preventDefault();
        });
        
        document.addEventListener('mousemove', function(e) {
            if (dragging) {
                emojiPanel.style.left = (e.clientX - offsetX) + 'px';
                emojiPanel.style.top = (e.clientY - offsetY) + 'px';
                emojiPanel.style.transform = 'none';
            }
        });
        
        document.addEventListener('mouseup', function() {
            if (dragging) {
                dragging = false;
                emojiPanel.classList.remove('dragging');
            }
        });
        
        emojiCloseBtn.addEventListener('click', function() {
            emojiPanel.style.display = 'none';
        });
    }

    // ===================== ç™»å…¥ç›¸é—œ =====================
    function checkLogin() {
        const saved = localStorage.getItem('twitch_token');
        if (saved) {
            ACCESS_TOKEN = saved.replace('oauth:', '');
            fetchUserInfo(ACCESS_TOKEN);
        } else {
            startChat();
        }
    }

    function loginWithPopup() {
        const width = 600, height = 700;
        const left = (screen.width - width) / 2;
        const top = (screen.height - height) / 2;
        
        const popup = window.open(
            AUTH_URL,
            'Twitch Login',
            `width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=yes,status=yes`
        );

        if (!popup) {
            alert('å½ˆå‡ºè¦–çª—è¢«é˜»æ“‹ï¼Œè«‹å…è¨±å½ˆå‡ºè¦–çª—');
            return;
        }

        const checkPopup = setInterval(() => {
            if (popup.closed) {
                clearInterval(checkPopup);
                const token = localStorage.getItem('twitch_token');
                if (token) {
                    ACCESS_TOKEN = token.replace('oauth:', '');
                    fetchUserInfo(ACCESS_TOKEN);
                }
            }
        }, 500);
    }

    async function fetchUserInfo(token) {
        try {
            const res = await fetch('https://api.twitch.tv/helix/users', {
                headers: { 
                    'Client-ID': CLIENT_ID, 
                    'Authorization': 'Bearer ' + token 
                }
            });
            const data = await res.json();
            if (data.data?.[0]) {
                myLoginId = data.data[0].login;
                myDisplayName = data.data[0].display_name;
                myAvatar = data.data[0].profile_image_url;
                loginSuccess();
            }
        } catch (e) {
            console.error('å–å¾—ç”¨æˆ¶è³‡è¨Šå¤±æ•—:', e);
            alert('ç™»å…¥å¤±æ•—ï¼Œè«‹é‡æ–°ç™»å…¥');
            logout();
        }
    }

    function loginSuccess() {
        document.getElementById('status').textContent = `å·²ç™»å…¥æˆåŠŸï¼š${myDisplayName}ï¼Œå¯ä»¥ç™¼è¨€å›‰ï¼`;
        document.getElementById('msginput').disabled = false;
        document.getElementById('sendbtn').disabled = false;
        document.getElementById('loginBtn').style.display = 'none';
        document.getElementById('userInfo').style.display = 'flex';
        document.getElementById('userAvatar').src = myAvatar;
        document.getElementById('userName').textContent = myDisplayName;
        
        if (socket) socket.close();
        startChat();
    }

    function logout() {
        localStorage.removeItem('twitch_token');
        location.reload();
    }

    // ===================== åˆå§‹åŒ– =====================
    async function initApp() {
        if (location.hash.includes('access_token=')) {
            const token = new URLSearchParams(location.hash.slice(1)).get('access_token');
            if (token) {
                const oauthToken = 'oauth:' + token;
                localStorage.setItem('twitch_token', oauthToken);
                
                if (window.opener) {
                    window.close();
                } else {
                    history.replaceState(null, null, location.pathname);
                    ACCESS_TOKEN = token;
                    fetchUserInfo(token);
                }
            }
        } else {
            checkLogin();
        }
        
        document.getElementById('loginBtn').onclick = loginWithPopup;
        document.getElementById('logoutBtn').onclick = logout;
        
        scrollToBottomBtn.addEventListener('click', scrollToBottom);
        setupScrollListener();
        
        await fetchBadges();
        await loadResources();
        setupAutoTag();
        setupMentionEvents();
        setupEmojiPanelDrag();
        
        if (!ACCESS_TOKEN) {
            startChat();
        }
    }

    // ===================== @æåŠåŠŸèƒ½ =====================
    function setupMentionEvents() {
        const msgInput = document.getElementById('msginput');
        
        msgInput.addEventListener('input', handleMentionInput);
        msgInput.addEventListener('keydown', handleMentionKeydown);
        
        document.addEventListener('click', e => {
            if (!e.target.closest('#mention-list') && !e.target.closest('#msginput')) {
                hideMentionList();
            }
        });
    }
    
    function handleMentionInput(e) {
        const input = e.target;
        const selection = window.getSelection();
        const range = selection.getRangeAt(0);
        const textBeforeCursor = input.textContent.substring(0, range.startOffset);
        
        const lastAtPos = textBeforeCursor.lastIndexOf('@');
        if (lastAtPos === -1 || textBeforeCursor.substring(lastAtPos).includes(' ')) {
            hideMentionList();
            return;
        }
        
        mentionSearchTerm = textBeforeCursor.substring(lastAtPos + 1, range.startOffset).toLowerCase();
        updateRecentUsersList();
        
        const filtered = recentUsers.filter(u => 
            u.displayName.toLowerCase().includes(mentionSearchTerm) || 
            u.login.toLowerCase().includes(mentionSearchTerm)
        );
        
        if (filtered.length > 0 && mentionSearchTerm.length > 0) {
            showMentionList(filtered, lastAtPos);
        } else {
            hideMentionList();
        }
    }
    
    function handleMentionKeydown(e) {
        if (!mentionListVisible) return;
        
        const items = document.querySelectorAll('.mention-item');
        if (items.length === 0) return;
        
        switch(e.key) {
            case 'ArrowUp':
                e.preventDefault();
                mentionSelectedIndex = (mentionSelectedIndex - 1 + items.length) % items.length;
                updateMentionSelection();
                break;
            case 'ArrowDown':
                e.preventDefault();
                mentionSelectedIndex = (mentionSelectedIndex + 1) % items.length;
                updateMentionSelection();
                break;
            case 'Enter':
            case 'Tab':
                e.preventDefault();
                if (mentionSelectedIndex >= 0 && mentionSelectedIndex < items.length) {
                    selectMentionUser(items[mentionSelectedIndex]);
                }
                break;
            case 'Escape':
                hideMentionList();
                break;
        }
    }
    
    function updateRecentUsersList() {
        recentUsers = [];
        const seen = new Set();
        
        Object.values(msgCache)
            .sort((a,b) => (b.timestamp||0) - (a.timestamp||0))
            .forEach(msg => {
                if (msg.user?.login && !seen.has(msg.user.login)) {
                    seen.add(msg.user.login);
                    recentUsers.push({
                        login: msg.user.login,
                        displayName: msg.displayName || msg.user.login,
                        badges: msg.badges,
                        avatar: msg.avatar || 'https://static-cdn.jtvnw.net/user-default-pictures-uv/75305d54-c7cc-40d1-bb9c-91fbe85943c7-profile_image-70x70.png'
                    });
                }
            });
        
        recentUsers = recentUsers.slice(0, 50);
    }
    
    function showMentionList(users, atPos) {
        const list = document.getElementById('mention-list');
        list.innerHTML = '';
        
        if (users.length === 0) return hideMentionList();
        
        list.appendChild(Object.assign(document.createElement('div'), {
            className: 'mention-header',
            textContent: `é¸æ“‡ç”¨æˆ¶ (${users.length})`
        }));
        
        users.forEach((user, idx) => {
            const item = document.createElement('div');
            item.className = 'mention-item' + (idx === 0 ? ' selected' : '');
            item.innerHTML = `
                <img class="user-avatar" src="${user.avatar}" alt="${user.displayName}">
                ${renderBadges(user.badges)}
                <span class="display-name">${user.displayName}</span>
                <span class="login-name">@${user.login}</span>
            `;
            item.dataset.login = user.login;
            item.dataset.displayName = user.displayName;
            item.onclick = () => selectMentionUser(item);
            list.appendChild(item);
        });
        
        list.style.display = 'block';
        mentionListVisible = true;
        mentionSelectedIndex = 0;
        positionMentionList(atPos);
    }
    
    function positionMentionList(atPos) {
        const list = document.getElementById('mention-list');
        const input = document.getElementById('msginput');
        const footer = document.querySelector('.footer');
        
        const temp = document.createElement('span');
        temp.style.font = getComputedStyle(input).font;
        temp.style.visibility = 'hidden';
        temp.style.position = 'absolute';
        temp.style.whiteSpace = 'pre-wrap';
        temp.textContent = input.textContent.substring(0, atPos);
        document.body.appendChild(temp);
        
        const x = temp.offsetWidth;
        document.body.removeChild(temp);
        
        list.style.left = x + 'px';
        list.style.bottom = (footer.offsetHeight + 10) + 'px';
    }
    
    function updateMentionSelection() {
        document.querySelectorAll('.mention-item').forEach((el, i) => {
            el.classList.toggle('selected', i === mentionSelectedIndex);
            if (i === mentionSelectedIndex) el.scrollIntoView({block: 'nearest', behavior: 'smooth'});
        });
    }
    
    function selectMentionUser(item) {
        const login = item.dataset.login;
        const display = item.dataset.displayName;
        insertTextAtCursor(`@${display} `);
        hideMentionList();
        document.getElementById('msginput').focus();
    }
    
    function hideMentionList() {
        document.getElementById('mention-list').style.display = 'none';
        mentionListVisible = false;
        mentionSelectedIndex = 0;
    }

    // ===================== è³‡æºè¼‰å…¥ =====================
    async function fetchBadges() { 
        try {
            const res = await fetch('https://chicktv.github.io/tv/badges.txt');
            customBadges = await res.json();
        } catch(e) {
            console.error('è¼‰å…¥å¾½ç« å¤±æ•—', e);
            customBadges = {};
        }
    }

    async function loadResources() {
        try {
            const sk = await $.getJSON("https://chicktv.github.io/tv/skuser_icon.txt");
            if (Array.isArray(sk)) {
                emojiLists["å¸¸ç”¨"] = { emojis: sk, image: sk[0]?.src || "" };
                sk.forEach(i => { if (i.alt) altMap[i.alt.toLowerCase()] = i.src; });
            }

            const savedBttv = JSON.parse(localStorage.getItem('myBTTV') || '[]');
            emojiLists["BTTV"] = {
                emojis: savedBttv.map(url => ({ alt: url.split('/').pop().split('?')[0], src: url, dis: url })),
                image: "https://static-cdn.jtvnw.net/badges/v1/ed51a614-2c44-4a60-80b6-62908436b43a/3"
            };

            await loadAudioData();

            const sets = await $.getJSON("https://chicktv.github.io/tv/showset.txt");
            for (const item of sets.set || []) {
                let name = typeof item === 'object' ? item.name : item;
                let img  = typeof item === 'object' ? item.image : "";
                if (!name || name === "skuser_icon") continue;

                $.getJSON(`https://chicktv.github.io/tv/${name}.txt`, d => {
                    let list = d[name] || [];
                    emojiLists[name] = { emojis: list, image: img };
                    list.forEach(e => { if (e.alt) altMap[e.alt.toLowerCase()] = e.src; });
                });
            }
        } catch(e) {
            console.error('è¼‰å…¥è³‡æºå¤±æ•—', e);
        }
    }

    async function loadAudioData() {
        try {
            const res = await fetch('https://chicktv.github.io/tv/audio.txt');
            const remote = res.ok ? await res.json() : [];
            const local = JSON.parse(localStorage.getItem('myAudios') || '[]');
            audioLists["éŸ³è¨Š"] = {
                audios: mergeAudioLists(remote, local),
                image: "ğŸ”Š"
            };
        } catch(e) {
            audioLists["éŸ³è¨Š"] = {
                audios: JSON.parse(localStorage.getItem('myAudios') || '[]'),
                image: "ğŸ”Š"
            };
        }
    }

    function mergeAudioLists(remote, local) {
        const merged = [...remote];
        const seen = new Set(remote.map(a => a.url));
        local.forEach(l => {
            if (!seen.has(l.url)) {
                merged.push(l);
                seen.add(l.url);
            }
        });
        return merged;
    }

    // ===================== è¡¨æƒ…é¢æ¿ =====================
    function renderEmojiPanel() {
        const tabs = $("#emojiTabs").empty();
        Object.keys(emojiLists).forEach((name, i) => {
            const tab = $('<div class="emoji-tab"></div>')
                .css("background-image", `url(${emojiLists[name].image})`)
                .attr("title", name)
                .on('click', function() {
                    $(".emoji-tab").css("opacity", "0.6");
                    $(this).css("opacity", "1");
                    renderTabContent(name);
                });
            if (i===0) tab.css("opacity", "1");
            tabs.append(tab);
        });

        tabs.append(
            $('<div class="emoji-tab" style="color:white;text-align:center;line-height:32px;">ğŸ”Š</div>')
                .on('click', function() {
                    $(".emoji-tab").css("opacity", "0.6");
                    $(this).css("opacity", "1");
                    renderTabContent("éŸ³è¨Š");
                })
        );

        renderTabContent(Object.keys(emojiLists)[0] || "å¸¸ç”¨");
    }

    function renderTabContent(name) {
        const content = $("#emojiContent").empty();

        if (name === "BTTV") {
            content.append(`
                <div class="bttv-input-area">
                    <input type="text" id="bttvUrl" class="custom-input" placeholder="è²¼ä¸Šåœ–ç‰‡ç¶²å€..." style="flex:1">
                    <div style="display:flex;gap:5px;">
                        <button onclick="addBTTV()" style="background:var(--t-purp);color:white;border:none;border-radius:4px;padding:5px 15px;">å„²å­˜</button>
                        <button onclick="isDeleteMode=!isDeleteMode;renderTabContent('BTTV')" style="background:${isDeleteMode?'#666':'#c42b1c'};color:white;border:none;border-radius:4px;padding:5px 15px;">${isDeleteMode?'å–æ¶ˆ':'åˆªé™¤'}</button>
                    </div>
                </div>`);

            emojiLists[name].emojis.forEach(e => {
                const item = $(`<div class="emoji-item ${isDeleteMode?'show-del':''}">
                    <img src="${e.src}" style="max-width:40px;">
                    <div class="delete-btn" onclick="event.stopPropagation();deleteBTTV('${e.src}')">âœ•</div>
                </div>`);
                item.on('click', () => {
                    if (!isDeleteMode) {
                        insertTextAtCursor(` [s] ${e.src} [e] `);
                        $("#emojiPanel").hide();
                    }
                });
                content.append(item);
            });
        } 
        else if (name === "éŸ³è¨Š") {
            content.append(`
                <div class="audio-input-form" style="flex-wrap:wrap">
                    <input type="text" id="audioName" class="custom-input" placeholder="éŸ³è¨Šåç¨±" style="flex:1;min-width:120px;">
                    <input type="text" id="audioUrl" class="custom-input" placeholder="éŸ³è¨Šç¶²å€" style="flex:2;min-width:180px;">
                    <div style="display:flex;gap:5px;">
                        <button onclick="addAudio()" style="background:var(--t-purp);color:white;border:none;border-radius:4px;padding:5px 15px;">å„²å­˜éŸ³è¨Š</button>
                        <button onclick="isAudioDeleteMode=!isAudioDeleteMode;renderTabContent('éŸ³è¨Š')" style="background:${isAudioDeleteMode?'#666':'#c42b1c'};color:white;border:none;border-radius:4px;padding:5px 15px;">${isAudioDeleteMode?'å–æ¶ˆ':'åˆªé™¤'}</button>
                    </div>
                </div>`);

            audioLists[name].audios.forEach((a, idx) => {
                const item = $(`<div class="audio-item ${isAudioDeleteMode?'show-del':''}">
                    ğŸ”Š<br>${a.name}
                    <div class="delete-btn" onclick="event.stopPropagation();deleteAudio(${idx})">âœ•</div>
                </div>`);
                item.on('click', () => {
                    if (!isAudioDeleteMode) {
                        insertTextAtCursor(` [a] ${a.url} [o] `);
                        $("#emojiPanel").hide();
                    }
                });
                content.append(item);
            });
        } 
        else {
            emojiLists[name].emojis.forEach(e => {
                $('<div class="emoji-item"></div>')
                    .append($('<img style="max-width:40px;">').attr('src', e.src))
                    .on('click', () => {
                        insertTextAtCursor(` ${e.alt} `);
                        $('#emojiPanel').hide();
                    })
                    .appendTo(content);
            });
        }
    }

    function insertTextAtCursor(text) {
        const el = document.getElementById('msginput');
        if (!el) return;
        
        el.focus();
        
        if (document.queryCommandSupported('insertText')) {
            document.execCommand('insertText', false, text);
        } else {
            const sel = window.getSelection();
            if (sel.rangeCount) {
                const range = sel.getRangeAt(0);
                range.deleteContents();
                range.insertNode(document.createTextNode(text));
                range.collapse(false);
                sel.removeAllRanges();
                sel.addRange(range);
            } else {
                el.textContent += text;
            }
        }
    }

    function insertTagOnly(s) { 
        insertTextAtCursor(s);
    }

    window.addBTTV = () => {
        const url = $("#bttvUrl").val().trim();
        if (!url) return;
        let saved = JSON.parse(localStorage.getItem('myBTTV') || '[]');
        if (!saved.includes(url)) {
            saved.push(url);
            localStorage.setItem('myBTTV', JSON.stringify(saved));
            emojiLists["BTTV"].emojis.push({ alt: url.split('/').pop(), src: url });
            renderTabContent("BTTV");
        }
        $("#bttvUrl").val("");
    };

    window.deleteBTTV = (url) => {
        let saved = JSON.parse(localStorage.getItem('myBTTV') || '[]');
        saved = saved.filter(u => u !== url);
        localStorage.setItem('myBTTV', JSON.stringify(saved));
        emojiLists["BTTV"].emojis = emojiLists["BTTV"].emojis.filter(e => e.src !== url);
        renderTabContent("BTTV");
    };

    window.addAudio = () => {
        const name = $("#audioName").val().trim();
        const url  = $("#audioUrl").val().trim();
        if (!name || !url) return alert("è«‹å¡«å¯«å®Œæ•´");
        let saved = JSON.parse(localStorage.getItem('myAudios') || '[]');
        saved.push({ name, url });
        localStorage.setItem('myAudios', JSON.stringify(saved));
        audioLists["éŸ³è¨Š"].audios = mergeAudioLists([], saved);
        renderTabContent("éŸ³è¨Š");
    };

    window.deleteAudio = (idx) => {
        let saved = JSON.parse(localStorage.getItem('myAudios') || '[]');
        saved.splice(idx, 1);
        localStorage.setItem('myAudios', JSON.stringify(saved));
        audioLists["éŸ³è¨Š"].audios = saved;
        renderTabContent("éŸ³è¨Š");
    };
    
    window.handleAudioClick = (btn, url) => {
        if (btn.dataset.isPlaying === "true") {
            if (btn.currentAudio) {
                btn.currentAudio.pause();
                btn.currentAudio.currentTime = 0;
            }
            resetAudioState(btn);
        } else {
            const audio = new Audio(url);
            btn.currentAudio = audio;
            btn.dataset.isPlaying = "true";
            btn.classList.add('playing');
            btn.innerHTML = 'ğŸ”Š';
            btn.title = 'æ’­æ”¾ä¸­...é»æ“Šåœæ­¢';

            audio.play().catch(err => {
                console.error('éŸ³è¨Šæ’­æ”¾å¤±æ•—:', err);
                resetAudioState(btn);
                btn.title = 'æ’­æ”¾å¤±æ•—';
                btn.innerHTML = 'âŒ';
            });

            audio.onended = () => resetAudioState(btn);
        }
    };
    
    function resetAudioState(btn) {
        btn.dataset.isPlaying = "false";
        btn.classList.remove('playing');
        btn.innerHTML = 'ğŸ”ˆ';
        btn.title = 'é»æ“Šæ’­æ”¾éŸ³è¨Š';
        btn.currentAudio = null;
    }

    // ===================== æ ¸å¿ƒè§£æ =====================
    function parseContent(str) {
        if (!str) return "";

        let a = str, placeholders = [];

        // [S]...E] å¤§å¯«ç‰ˆï¼ˆèˆŠæ ¼å¼ï¼‰
        a = a.replace(/\[S\](.*?)E\]/g, (m, b) => {
            b = b.replace(/[\r\n]/g, "").replace(/ /g, '').replace('[S]', '').replace('[', '');
            const num = Math.floor(Math.random() * 1000) + 1;
            let id = `__PH_${placeholders.length}__`;
            placeholders.push(`<a href="${b}" target="_blank"><img id="${num}" src="${b}" class="media-preview" onload="onMediaLoaded()" onerror="onMediaLoaded()"/></a>`);
            return id;
        });

        // [s]...e] å°å¯«ç‰ˆï¼ˆæ–°æ ¼å¼ï¼‰
        a = a.replace(/\[s\](.*?)e\]/g, (m, content) => {
            let url = content.replace(/[\r\n]/g, "").replace(/ /g, '').replace('[s]', '').replace('[', '');
            let id = `__PH_${placeholders.length}__`;
            let html = "";

            if (url.match(/youtu/)) {
                let vid = url.match(/watch\?/g) ? getParameterByName('v', url) : url.replace('https://www.', '').replace('https://', '').replace('youtu.be/', '').replace('youtube.com/embed/', '').replace('youtube.com/shorts/', '').replace('youtube.com/live/', '').replace('&feature=share', '');
                let t = getParameterByName('t', url);
                html = `<iframe class="media-preview" onload="onMediaLoaded()" onerror="onMediaLoaded()" src="https://www.youtube.com/embed/${vid}?start=${t}" frameborder="0" allowfullscreen></iframe>`;
            } else if (url.match(/twitter|x\.com/)) {
                let tw = url.replace('https://x.com', 'https://twitter.com');
                html = `<div class="twitter-tweet-container" style="width:300px;height:400px;overflow:hidden;"><blockquote class="twitter-tweet"><a href="${tw}"></a></blockquote><script async src="https://platform.twitter.com/widgets.js"><\/script></div>`;
            } else if (url.match(/threads\.net/)) {
                let m = url.match(/@[\w.]+\/post\/[\w]+/);
                html = m ? `<iframe src="https://www.threads.net/${m[0]}/embed" allowtransparency="true" allowfullscreen frameborder="0" style="background:#FFF;border-radius:12px;width:100%" height="300"></iframe>` : url;
            } else if (url.match(/\.(mp4|webm)/i)) {
                html = `<video class="media-preview" onload="onMediaLoaded()" onerror="onMediaLoaded()" autoplay loop muted playsinline src="${url}"></video>`;
            } else if (url.match(/steampowered|steamcommunity/)) {
                let app = url.match(/app\/(\d+)/);
                html = app ? `<iframe class="media-preview" onload="onMediaLoaded()" onerror="onMediaLoaded()" src="https://store.steampowered.com/widget/${app[1]}/" frameborder="0"></iframe>` : url;
            } else {
                html = `<a href="${url}" target="_blank"><img src="${url}" class="media-preview" onload="onMediaLoaded()" onerror="onMediaLoaded()"/></a>`;
            }

            placeholders.push(html);
            return id;
        });

        // [y]...[t]
        a = a.replace(/\[y\](.*?)[\[]?t\]/gi, (m, content) => {
            let url = content.replace(/[\r\n]/g, "").replace(/ /g, '').replace('[y]', '').replace('[', '');
            let id = `__PH_${placeholders.length}__`;
            let html = "";

            if (url.match(/facebook/)) {
                html = `<iframe src="https://www.facebook.com/plugins/video.php?href=${encodeURIComponent(url)}&show_text=0&width=300" width="300" height="200" style="border:none;overflow:hidden" scrolling="no" frameborder="0" allowfullscreen></iframe>`;
            } else if (url.match(/youtu/)) {
                let vid = url.match(/watch\?/g) ? getParameterByName('v', url) : url.replace('https://www.', '').replace('https://', '').replace('youtu.be/', '').replace('youtube.com/embed/', '').replace('youtube.com/shorts/', '').replace('youtube.com/live/', '').replace('&feature=share', '');
                html = `<iframe class="media-preview" onload="onMediaLoaded()" onerror="onMediaLoaded()" src="https://www.youtube.com/embed/${vid}" frameborder="0" allowfullscreen></iframe>`;
            } else if (url.match(/\.(mp4|webm)/i)) {
                html = `<video class="media-preview" onload="onMediaLoaded()" onerror="onMediaLoaded()" autoplay loop muted playsinline src="${url}"></video>`;
            } else if (url.match(/twitter|x\.com/)) {
                let tw = url.replace('https://x.com', 'https://twitter.com');
                html = `<div class="twitter-tweet-container" style="width:300px;height:400px;overflow:hidden;"><blockquote class="twitter-tweet"><a href="${tw}"></a></blockquote><script async src="https://platform.twitter.com/widgets.js"><\/script></div>`;
            } else {
                html = `<a href="${url}" target="_blank" style="color:#58a6ff;">${url}</a>`;
            }

            placeholders.push(html);
            return id;
        });

        // [a]...[o]
        a = a.replace(/\[a\](.*?)\[o\]/gi, (m, content) => {
            const url = content.trim();
            let id = `__PH_${placeholders.length}__`;
            placeholders.push(`<span class="audio-icon-btn" onclick="handleAudioClick(this, '${url}')" data-is-playing="false" title="é»æ“Šæ’­æ”¾éŸ³è¨Š">ğŸ”ˆ</span>`);
            return id;
        });

        // è‡ªå‹•è­˜åˆ¥ <a> è£¡é¢çš„ [s] ä¹‹é¡ï¼ˆèˆŠç‰ˆç›¸å®¹ï¼‰
        let htmlMatch = extractTagAndUrl(a);
        if (htmlMatch) {
            let url = htmlMatch.url;
            let rep = `<a href="${url}" target="_blank"><img src="${url}" style="max-height:150px;max-width:100%;border-radius:6px;"/></a>`;
            a = a.replace(htmlMatch.match[0], rep);
        }

        // ä¸€èˆ¬é€£çµ + è‡ªè¨‚è¡¨æƒ…
        a = a.replace(/https?:\/\/[^\s]+/gi, u => u.includes('__PH_') ? u : `<a href="${u}" target="_blank" style="color:#58a6ff;">${u}</a>`);
        
        let words = a.split(' ');
        a = words.map(w => {
            if (w.includes('__PH_')) return w;
            const src = altMap[w.toLowerCase()];
            return src ? `<img src="${src}" class="alt-emoji">` : w;
        }).join(' ');

        // é‚„åŸ
        placeholders.forEach((html, i) => {
            a = a.replace(`__PH_${i}__`, html);
        });

        return a;
    }

    function onMediaLoaded() {
        mediaLoadCount++;
        if (mediaLoadTimer) clearTimeout(mediaLoadTimer);
        
        mediaLoadTimer = setTimeout(() => {
            if (autoScroll) forceScrollToBottom();
            mediaLoadCount = 0;
        }, 150);
    }

    function limitMessages() {
        const msgs = $("#messages");
        const children = msgs.children();
        if (children.length > MAX_MESSAGES) {
            children.slice(0, children.length - MAX_MESSAGES).remove();
        }
    }

    function renderBadges(badgeStr) {
        if (!badgeStr) return "";
        let html = "";
        badgeStr.split(',').forEach(b => {
            const key = b.split('/')[0];
            const url = customBadges[b] || customBadges[key];
            if (url) html += `<img class="badge" src="${url}">`;
        });
        return html;
    }

    // ===================== è™•ç†å–®æ¢è¨Šæ¯ =====================
    function processMessage(tags, rawMsg) {
        const msgId = getTagValue(tags, "id");
        const ts    = getTagValue(tags, "tmi-sent-ts") || Date.now().toString();
        const user  = getTagValue(tags, "display-name") || "User";
        const login = getTagValue(tags, "login") || user.toLowerCase();
        const color = getTagValue(tags, "color") || "#9147ff";
        const badges = getTagValue(tags, "badges") || "";

        const cacheKey = ts;

        if (msgCache[cacheKey]) {
            logDebug('é‡è¤‡è¨Šæ¯ï¼Œå·²è·³é', cacheKey);
            return;
        }

        userCache[login] = user;

        msgCache[cacheKey] = {
            content: rawMsg,
            user: { login, displayName: user },
            displayName: user,
            badges,
            avatar: `https://static-cdn.jtvnw.net/user-default-pictures-uv/75305d54-c7cc-40d1-bb9c-91fbe85943c7-profile_image-70x70.png`,
            timestamp: parseInt(ts),
            msgId
        };

        // é™åˆ¶å¿«å–å¤§å°
        const keys = Object.keys(msgCache);
        if (keys.length > 1200) {
            keys.sort((a,b) => (msgCache[a].timestamp||0) - (msgCache[b].timestamp||0));
            keys.slice(0, 200).forEach(k => delete msgCache[k]);
        }

        let replyHtml = "";
        let displayMsg = rawMsg;

        // Twitch åŸç”Ÿå›è¦†
        const pUser = getTagValue(tags, "reply-parent-display-name");
        const pMsgId = getTagValue(tags, "reply-parent-msg-id");
        const pBodyRaw = getTagValue(tags, "reply-parent-msg-body");

        if (pUser && pMsgId) {
            let isMe = (pUser === myDisplayName || pUser === myLoginId);
            let original = pBodyRaw ? pBodyRaw.replace(/\\s/g, " ") : "...";
            let parsed = parseContentBasic(original);

            const cls = isMe ? 'quote-user mention-self-tag' : 'quote-user';

            replyHtml = `<div class="quote-box" onclick="scrollToMsg('${pMsgId}')">
                <svg width="17" height="17" viewBox="0 0 24 20" fill="currentColor">
                    <path d="M9 10h2v2H9v-2Zm6 0h-2v2h2v-2Z"></path>
                    <path fill-rule="evenodd" d="m12 22-3-3H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v12a2 2 0 0 1 2 2h-4l-3 3Zm-2.172-5L12 19.172 14.172 17H19V5H5v12h4.828Z" clip-rule="evenodd"></path>
                </svg> å›è¦†
                <span class="${cls}">@${pUser}:</span>${parsed}
            </div>`;

            const mention = `@${pUser} `;
            if (displayMsg.startsWith(mention)) {
                displayMsg = displayMsg.substring(mention.length);
            }
        }
        // è‡ªè¨‚ [r]...[m]
        else if (rawMsg.includes("[r]")) {
            const rMatch = rawMsg.match(/\[r\](.*?),([\d\w-]+)\[m\]/);
            if (rMatch) {
                const repliedUser = rMatch[1];
                const repliedTs   = rMatch[2];

                let repliedMsg = msgCache[repliedTs];
                // å‚™æ´ï¼šç”¨ msg-id æ‰¾
                if (!repliedMsg) {
                    for (let k in msgCache) {
                        if (msgCache[k].msgId === repliedTs) {
                            repliedMsg = msgCache[k];
                            break;
                        }
                    }
                }

                let quoteContent = "...";
                let quoteUser = repliedUser;

                if (repliedMsg) {
                    quoteContent = parseContentBasic(repliedMsg.content || "...");
                    quoteUser = repliedMsg.displayName || repliedUser;
                }

                let isMe = (quoteUser === myDisplayName || quoteUser === myLoginId);
                const cls = isMe ? 'quote-user mention-self-tag' : 'quote-user';

                replyHtml = `<div class="quote-box" onclick="scrollToMsg('${repliedTs}')">
                    <svg width="17" height="17" viewBox="0 0 24 20" fill="currentColor">
                        <path d="M9 10h2v2H9v-2Zm6 0h-2v2h2v-2Z"></path>
                        <path fill-rule="evenodd" d="m12 22-3-3H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v12a2 2 0 0 1 2 2h-4l-3 3Zm-2.172-5L12 19.172 14.172 17H19V5H5v12h4.828Z" clip-rule="evenodd"></path>
                    </svg> å›è¦†
                    <span class="${cls}">@${quoteUser}:</span>${quoteContent}
                </div>`;

                // ç§»é™¤ [r]...[m] æ¨™ç±¤
                displayMsg = rawMsg.replace(/\[r\](.*?),([\d\w-]+)\[m\]/gi, "").trim();
            }
        }

        // å†è™•ç†ä¸€æ¬¡ [r]ï¼ˆå¯èƒ½æœ‰å¤šå±¤ï¼‰
        displayMsg = parseMessageWithReplies(displayMsg);

        const badgeHtml = renderBadges(badges);

        const line = `
            <div class="chat-line ts-${ts} id-${msgId || cacheKey}" data-msg-id="${msgId || cacheKey}" data-timestamp="${ts}">
                <div class="reply-btn" onclick="replyNative('${login}','${cacheKey}','${user}')">
                    <img src="https://chicktv.github.io/tv/re2.png" width="35" height="35">
                </div>
                ${replyHtml}
                ${badgeHtml}
                <b style="color:${color}">${user}:</b> 
                <span>${parseContent(displayMsg)}</span>
            </div>`;

        $("#messages").append(line);

        messageCount++;
        document.getElementById('message-stats').textContent = `è¨Šæ¯: ${messageCount}`;

        limitMessages();

        if (autoScroll) {
            forceScrollToBottom();
        }
    }

    // ===================== ç™¼é€è¨Šæ¯ =====================
    function sendMessage() {
        const input = document.getElementById('msginput');
        const val = input.textContent.trim();
        
        if (!val || !socket || socket.readyState !== 1) return;

        const selfTs = Date.now().toString();
        let cmd = "";
        let replyHtml = "";

        if (pendingReply.id) {
            cmd = `PRIVMSG #${CHANNEL} :[r]${pendingReply.user},${pendingReply.id}[m]${val}`;

            let quoted = "...";
            const refMsg = msgCache[pendingReply.id];
            if (refMsg) {
                quoted = parseContentBasic(refMsg.content || "...");
            }

            const isMe = (pendingReply.displayName === myDisplayName || pendingReply.displayName === myLoginId);
            const cls = isMe ? 'quote-user mention-self-tag' : 'quote-user';

            replyHtml = `<div class="quote-box" onclick="scrollToMsg('${pendingReply.id}')">
                <svg width="17" height="17" viewBox="0 0 24 20" fill="currentColor">
                    <path d="M9 10h2v2H9v-2Zm6 0h-2v2h2v-2Z"></path>
                    <path fill-rule="evenodd" d="m12 22-3-3H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v12a2 2 0 0 1 2 2h-4l-3 3Zm-2.172-5L12 19.172 14.172 17H19V5H5v12h4.828Z" clip-rule="evenodd"></path>
                </svg> å›è¦†
                <span class="${cls}">@${pendingReply.displayName}:</span>${quoted}
            </div>`;
        } else {
            cmd = `PRIVMSG #${CHANNEL} :${val}`;
        }

        socket.send(cmd);

        // é¡¯ç¤ºè‡ªå·±ç™¼çš„è¨Šæ¯
        const badgeHtml = renderBadges(myBadges || "");
        $("#messages").append(`
            <div class="chat-line ts-${selfTs} id-${selfTs}" data-timestamp="${selfTs}">
                ${replyHtml}
                ${badgeHtml}
                <b class="self-name">${myDisplayName || myLoginId}:</b> 
                <span>${parseContent(val)}</span>
            </div>`);

        // å­˜å…¥è‡ªå·±ç™¼çš„è¨Šæ¯
        msgCache[selfTs] = {
            content: val,
            user: { login: myLoginId, displayName: myDisplayName },
            displayName: myDisplayName,
            badges: myBadges || "",
            avatar: myAvatar,
            timestamp: parseInt(selfTs)
        };

        messageCount++;
        document.getElementById('message-stats').textContent = `è¨Šæ¯: ${messageCount}`;

        limitMessages();

        if (autoScroll) forceScrollToBottom();

        cancelReply();
        input.textContent = "";
    }

    function startChat() {
        if (socket) socket.close();

        socket = new WebSocket('wss://irc-ws.chat.twitch.tv:443');

        socket.onopen = () => {
            socket.send('CAP REQ :twitch.tv/tags twitch.tv/commands');
            socket.send(`PASS oauth:${ACCESS_TOKEN || 'dummy'}`);
            socket.send(`NICK ${ACCESS_TOKEN ? 'user' : 'justinfan'+Math.floor(Math.random()*1000)}`);
            socket.send(`JOIN #${CHANNEL}`);
            document.getElementById('status').textContent = `å·²é€£ç·šåˆ° ${CHANNEL} ${ACCESS_TOKEN?'ï¼ˆå·²ç™»å…¥ï¼‰':'ï¼ˆåŒ¿åï¼‰'}`;
        };

        socket.onmessage = (e) => {
            if (e.data.startsWith('PING')) {
                socket.send('PONG :tmi.twitch.tv');
                return;
            }

            const lines = e.data.split('\r\n').filter(Boolean);

            lines.forEach(line => {
                if (line.includes('PRIVMSG')) {
                    try {
                        const parts = line.split(` PRIVMSG #${CHANNEL} :`);
                        if (parts.length >= 2) {
                            processMessage(parts[0], parts.slice(1).join(' :').trim());
                        } else {
                            const m = line.match(/PRIVMSG #([^ ]+) :(.+)/);
                            if (m && m[1] === CHANNEL) {
                                const tagPart = line.substring(0, line.indexOf('PRIVMSG')).trim();
                                processMessage(tagPart, m[2]);
                            }
                        }
                    } catch(err) {
                        console.error('è§£æ PRIVMSG å¤±æ•—:', err, line);
                    }
                }
            });
        };

        socket.onerror = (err) => {
            console.error('WebSocket Error:', err);
            document.getElementById('status').textContent = `é€£æ¥éŒ¯èª¤ï¼Œå˜—è©¦é‡æ–°é€£ç·š...`;
        };

        socket.onclose = (ev) => {
            console.log('WebSocket é—œé–‰', ev.code, ev.reason);
            document.getElementById('status').textContent = `æ–·ç·š (${ev.code})ï¼Œ3ç§’å¾Œé‡é€£...`;
            socket = null;
            setTimeout(startChat, 3000);
        };
    }

    function setupAutoTag() {
        document.getElementById('msginput').addEventListener('paste', e => {
            const text = (e.clipboardData || window.clipboardData).getData('text');
            if (!/^https?:\/\//i.test(text)) return;

            const current = e.target.textContent;

            if (current.endsWith('[s] ')) {
                e.preventDefault();
                insertTextAtCursor(text + ' [e]');
            } else if (current.endsWith('[y] ')) {
                e.preventDefault();
                insertTextAtCursor(text + ' [t]');
            } else if (current.endsWith('[a] ')) {
                e.preventDefault();
                insertTextAtCursor(text + ' [o]');
            }
        });
    }

    function scrollToMsg(key) {
        const el = document.querySelector(`[data-timestamp="${key}"], .id-${key}`);
        if (el) {
            const container = document.getElementById('chat-container');
            const offset = el.offsetTop - container.offsetTop - 50;
            container.scrollTo({ top: offset + container.scrollTop, behavior: 'smooth' });
        }
    }

    function replyNative(login, key, display) {
        pendingReply = {
            id: key,
            user: login,
            displayName: display || login
        };
        document.getElementById('replying-to-user').textContent = display || login;
        document.getElementById('reply-indicator').style.display = 'block';
        document.getElementById('msginput').focus();
    }

    function cancelReply() {
        pendingReply = { id: null, user: null, displayName: null };
        document.getElementById('reply-indicator').style.display = 'none';
    }

    document.getElementById('msginput').addEventListener('keydown', e => {
        if (mentionListVisible && (e.key === 'Enter' || e.key === 'Tab')) {
            return;
        }
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
</script>
</body>
</html>
