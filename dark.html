<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Twitch Console v8.44 - Full Feature Edition</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        :root { --t-bg: #0e0e10; --t-alt: #18181b; --t-purp: #9147ff; --t-text: #efeff1; }
        body { background: var(--t-bg); color: var(--t-text); font-family: sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* --- Webkit Scrollbar æ¨£å¼ --- */
        #chat-container::-webkit-scrollbar, #emojiContent::-webkit-scrollbar, #emojiTabs::-webkit-scrollbar { width: 8px; height: 8px; }
        #chat-container::-webkit-scrollbar-track, #emojiContent::-webkit-scrollbar-track, #emojiTabs::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.2); }
        #chat-container::-webkit-scrollbar-thumb, #emojiContent::-webkit-scrollbar-thumb, #emojiTabs::-webkit-scrollbar-thumb { background: #444; border-radius: 10px; }
        #chat-container::-webkit-scrollbar-thumb:hover, #emojiContent::-webkit-scrollbar-thumb:hover, #emojiTabs::-webkit-scrollbar-thumb:hover { background: var(--t-purp); }

        /* çµ±ä¸€æ§åˆ¶åª’é«”åµŒå…¥å¤§å° */
        #chat-container .media-preview,
        #chat-container iframe.media-preview,
        #chat-container iframe[src*="youtube.com"],
        #chat-container iframe[src*="youtube-nocookie.com"],
        #chat-container iframe[src*="youtu.be"],
        #chat-container iframe[src*="facebook.com"],
        #chat-container blockquote.twitter-tweet,
        #chat-container .twitter-tweet-container,
        #chat-container iframe[src*="store.steampowered.com"],
        #chat-container iframe[src*="threads.com"] {
            width: 300px !important;
            height: 400px !important;
            max-width: 300px !important;
            max-height: 400px !important;
            border-radius: 8px !important;
            border: 0px solid #444 !important;
            margin: 5px 0 !important;
        }

        /* é‡å°YouTubeçš„ç‰¹æ®Šèª¿æ•´ */
        #chat-container iframe[src*="youtube.com"],
        #chat-container iframe[src*="youtube-nocookie.com"] {
            min-height: 400px !important;
        }

        /* é‡å°Twitterçš„ç‰¹æ®Šèª¿æ•´ */
        #chat-container blockquote.twitter-tweet {
            min-height: 400px !important;
        }

        /* é‡å°Threadsçš„ç‰¹æ®Šèª¿æ•´ */
        #chat-container iframe[src*="threads.com"] {
            min-height: 400px !important;
            background: #FFF !important;
        }

        /* é‡å°Steamçš„ç‰¹æ®Šèª¿æ•´ */
        #chat-container iframe[src*="store.steampowered.com"] {
            min-height: 400px !important;
        }

        /* åœ–ç‰‡ä¿æŒåŸæœ‰æ¯”ä¾‹ï¼Œä¸å¼·åˆ¶è¨­å®šé«˜åº¦ */
        #chat-container img.media-preview {
            height: auto !important;
            max-height: 250px !important;
            min-height: auto !important;
        }

        /* å½±ç‰‡æ¨™ç±¤ä¿æŒåŸæœ‰æ¯”ä¾‹ */
        #chat-container video.media-preview {
            height: auto !important;
            max-height: 250px !important;
            min-height: auto !important;
        }

        .header-bar { background: var(--t-alt); padding: 5px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; flex-shrink: 0; }
        #chat-container { flex: 1; overflow-y: auto; padding: 15px; background: #000; scroll-behavior: smooth; }
        .chat-line { position: relative; border-radius: 4px; line-height: 1.6; word-wrap: break-word; color: var(--t-text); transition: background 0.3s, border 0.3s; padding: 1px; margin-bottom: 5px; border: 1px solid transparent; }
        .chat-line:hover { background: rgba(255,255,255,0.08); }
        .chat-line:has(.quote-box) { border: 1px solid #9147ff; background: rgba(145, 71, 255, 0.1) !important; margin-left: 2px; }
        .self-name { color: var(--t-purp); font-weight: bold; }
        .media-preview { max-width: 250px !important; max-height: 250px !important; border-radius: 6px; margin-top: 10px; vertical-align: top; display: block; border: 1px solid #444; }
        
        .audio-player { margin-top: 10px; display: block; max-width: 300px; }
        .alt-emoji { max-width: 120px !important; max-height: 120px !important; vertical-align: top; margin: 2px; }
        .badge { width: 18px; height: 18px; vertical-align: middle; margin-right: 4px; display: inline-block; }
        .reply-btn { position: absolute; right: 10px; top: 10px; width: 28px; height: 28px; border-radius: 50%; display: none; align-items: center; justify-content: center; cursor: pointer; color: #fff; font-size: 10px; z-index: 10; border: 1px solid #444; }
        .reply-btn:hover {background-color: #3c3a39;}
        .chat-line:hover .reply-btn { display: flex; }
        .quote-box { color: #adadb8; padding: 1px; border-radius: 4px; margin-bottom: 1px; line-height: 1.4; display: block; cursor: pointer; border: 1px solid rgba(255,255,255,0.05); }
        .quote-box:hover { background: rgba(255,255,255,0.15); }
        .quote-user { color: #adadb8; margin-right: 5px; }
        .mention-self-tag { background-color: #9147ff; color: #ffffff !important; padding: 2px 6px; border-radius: 4px; font-weight: bold; display: inline-block; margin-bottom: 2px; }
        .footer {  background: #1f1f23;padding: 1px 1px;border-top: 1px solid rgba(255, 255, 255, 0.1); }
        .chat-input-wrapper {display: flex;align-items: flex-start;background: #0e0e10;border-radius: 4px;padding: 5px 5px;position: relative;}
        #reply-indicator { display:none; color:#adadb8; font-size:12px; margin-bottom:8px; padding:8px; background:rgba(145,71,255,0.1); border-radius:4px; border: 1px solid rgba(145,71,255,0.3); }
        #input-container {background: #1f1f23;padding: 1px 1px;border-top: 1px solid rgba(255, 255, 255, 0.1);}
        #msginput { flex: 1;background: transparent;color: #efeff1;font-size: 14px;outline: none;flex-wrap: wrap;resize: none;min-height: 40px;max-height: 120px;font-family: inherit;line-height: 1.4;padding: 8px 0;border-radius: 0.2rem; }
        #sendbtn { background: transparent;border: none;color: #9147ff;cursor: pointer;padding: 4px;border-radius: 4px;display: flex;align-items: center;justify-content: center;}
        #sendbtn:hover {background: #3a3a3d;}
        .chat-buttons {display: flex;gap: 8px;margin-top: 5px; color: #ffd400;}
        .tool-btn { padding: 1px 1px; background: #2f2f35; color: #ccc; border: 1px solid #444; border-radius: 4px; cursor: pointer; font-size: 11px; margin-right: 5px; }
        
        /* è¡¨æƒ…é¢æ¿ */
        #emojiPanel { position: fixed; display: none; width: 450px; height: 500px; background: #1f182e; border: 2px solid #443a5a; border-radius: 12px; z-index: 5000; left: 50%; top: 50%; transform: translate(-50%, -50%); flex-direction: column; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        #emojiTabs {display: flex;flex-wrap: wrap;background: #1f1f23;padding: 8px;gap: 5px;overflow-x: auto;border-bottom: 1px solid #26262c;}
        #emojiContent { flex: 1;overflow-y: auto;padding: 10px;background: #18181b;display: flex;flex-wrap: wrap;gap: 5px;align-content: flex-start; }
        .emoji-tab { width: 36px;height: 36px;background: #3a3a3d;border-radius: 4px;cursor: pointer;background-size: cover;background-position: center;flex-shrink: 0; }
        .emoji-item {  position: relative;width: 40px;height: 40px;border-radius: 4px;cursor: pointer;}
        .emoji-item img {width: 40px;height: 40px;border-radius: 4px;cursor: pointer;}
        .bttv-input-area, .audio-input-form { width: 100%;display: flex;gap: 6px;margin-bottom: 10px; }
        .custom-input { background: #000; border: 1px solid #444; color: #fff; padding: 8px; border-radius: 4px; }

        /* æ»¾å‹•åˆ°æœ€åº•æŒ‰éˆ• */
        #scroll-to-bottom-btn {position: absolute;bottom: 80px; /* ä½æ–¼è¼¸å…¥æ¡†ä¸Šæ–¹ */left: 50%;transform: translateX(-50%);background: rgba(145, 71, 255, 0.9); /* Twitch ç´«è‰² */color: white;border: none;padding: 8px 16px; border-radius: 20px; cursor: pointer;z-index: 1000;font-weight: bold;display: none; /* åˆå§‹éš±è— */box-shadow: 0 4px 12px rgba(0,0,0,0.5);transition: background 0.2s;}
        #scroll-to-bottom-btn:hover {background: #a970ff;}

        /* é—œéµä¿®æ­£ï¼šç¢ºä¿ âœ• å‡ºç¾ */
        .delete-btn { position: absolute;top: -8px;right: -8px;background: #e91916;color: white;width: 20px;height: 20px;border-radius: 50%;font-size: 12px;line-height: 20px;text-align: center;cursor: pointer;display: none; z-index: 100; border: 1px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.5); }
        /* ç•¶çˆ¶å±¤æœ‰ .show-del æ™‚é¡¯ç¤ºæŒ‰éˆ• */
        .show-del .delete-btn { display: block; }

        .audio-item { cursor:pointer; background:rgba(145,71,255,0.1); border:1px solid #444; border-radius:4px; padding:8px; text-align:center; font-size:11px; position:relative; color: #fff; }
         /* éŸ³è¨Šåœ–ç¤ºæŒ‰éˆ•æ¨£å¼ */
        .audio-icon-btn { cursor: pointer; font-size: 20px; vertical-align: middle; display: inline-block; padding: 5px; background: rgba(145, 71, 255, 0.2); border-radius: 4px; transition: all 0.2s ease; user-select: none; }
        .audio-icon-btn:hover { background: rgba(145, 71, 255, 0.4); }
        .audio-icon-btn.playing { background: #9147ff; color: white; border-color: white; animation: pulse-audio 1.5s infinite; }
        
        @keyframes pulse-audio {
            0% { box-shadow: 0 0 0 0px rgba(145, 71, 255, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(145, 71, 255, 0); }
            100% { box-shadow: 0 0 0 0px rgba(145, 71, 255, 0); }
        }

        /* æ–°å¢ï¼šç™»å…¥ç³»çµ±æ¨£å¼ */
        #userInfo { display: none; align-items: center; gap: 8px; margin: 0 12px 8px; font-size: 13px; }
        #userInfo img { width: 30px; height: 30px; border-radius: 50%; }
        #logoutBtn { margin-left: auto; background: #e91916; color: white; border: none; border-radius: 4px; padding: 6px 12px; cursor: pointer; font-size: 12px; font-weight: 600; transition: background-color 0.2s; }
        #logoutBtn:hover { background: #c51614; }
        #loginBtn { padding: 8px 16px; background: #9147ff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 600; transition: background-color 0.2s; margin-top: 8px; }
        #loginBtn:hover { background: #772ce8; }
        #status { margin: 8px 12px; font-weight: 500; color: #bf94ff; font-size: 10px; }
        .char-counter { position: absolute; right: 40px; bottom: 5px; font-size: 12px; color: #adadb8; pointer-events: none; padding: 2px 6px; border-radius: 4px; }
        .char-counter.over-limit { color: #e91916; font-weight: bold; }
        .char-counter.near-limit { color: #ffd400; }
    </style>
</head>
<body onload="initApp()">

<!-- æ–°å¢ï¼šç‹€æ…‹é¡¯ç¤º -->
<div id="status">è¼‰å…¥ä¸­...</div>

<!-- æ–°å¢ï¼šç”¨æˆ¶è³‡è¨Š -->
<div id="userInfo" style="display:none;">
    <img id="userAvatar" src="" alt="é ­åƒ">
    <span id="userName"></span>
    <button id="logoutBtn">ç™»å‡º</button>
</div>

<div class="header-bar">
    <div style="font-weight:bold;"></div>
    <div id="auth-area"><button id="loginBtn">TWITCH ç™»å…¥</button></div>
</div>

<div id="chat-container"><div id="messages"></div><button id="scroll-to-bottom-btn" onclick="scrollToBottom()">â†“ æ›´å¤šè¨Šæ¯</button></div>

<div id="emojiPanel">
    <div style="padding:12px; display:flex; justify-content:space-between; background:#26262c; border-radius: 12px 12px 0 0; align-items:center;">
        <b style="font-size:14px;">è³‡æºåº« (è¡¨æƒ…/éŸ³è¨Š)</b>
        <button onclick="$('#emojiPanel').hide()" style="background:none; border:none; color:white; cursor:pointer; font-size:18px;">âœ•</button>
    </div>
    <div id="emojiTabs"></div>
    <div id="emojiContent"></div>
</div>

<div class="footer">
    <div id="reply-indicator">
        æ­£åœ¨å›è¦† <span id="replying-to-user" style="color:#9147ff; font-weight:bold;"></span> 
        <span onclick="cancelReply()" style="float:right; cursor:pointer; color:#efeff1;">âœ• å–æ¶ˆå›è¦†</span>
    </div>
    <div style="position: relative;display: flex;gap: 0px;background: #000;">
        <button class="tool-btn" onclick="insertTagOnly('[s] ')">åœ–ç‰‡</button>
        <button class="tool-btn" onclick="insertTagOnly('[y] ')">å½±ç‰‡</button>
        <button class="tool-btn" onclick="insertTagOnly('[a] ')">éŸ³è¨Š</button>
        <button class="tool-btn" onclick="renderEmojiPanel(); $('#emojiPanel').css('display','flex')"><svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M10 2C5.58 2 2 5.58 2 10s3.58 8 8 8 8-3.58 8-8-3.58-8-8-8zm0 14.5c-3.59 0-6.5-2.91-6.5-6.5S6.41 3.5 10 3.5s6.5 2.91 6.5 6.5-2.91 6.5-6.5 6.5zM6.5 9c.83 0 1.5-.67 1.5-1.5S7.33 6 6.5 6 5 6.67 5 7.5 5.67 9 6.5 9zm7 0c.83 0 1.5-.67 1.5-1.5S14.33 6 13.5 6 12 6.67 12 7.5s.67 1.5 1.5 1.5zM10 14c-1.66 0-3.14-.69-4.2-1.8l1.41-1.41C7.83 11.53 8.84 12 10 12s2.17-.47 2.79-1.21l1.41 1.41C13.14 13.31 11.66 14 10 14z"/>
                    </svg></button>
    </div>
    <div id="input-container">
    <div class="chat-input-wrapper">
        <input id="msginput" type="text" placeholder="ç™»å…¥å¾Œå³å¯ç™¼è¨€..." autocomplete="off" disabled>
        <div id="charCounter" class="char-counter">0/500</div>
        <div class="chat-buttons"><button id="sendbtn" onclick="sendMessage()" disabled><svg width="20" height="40" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M2.93 4.26l14.76-2.66c.95-.17 1.73.61 1.56 1.56L15.74 17.1c-.2 1.09-1.57 1.41-2.23.49l-3.14-4.37-2.66 2.66c-.39.39-1.02.39-1.41 0-.39-.39-.39-1.02 0-1.41l2.66-2.66L1.44 6.49c-.92-.66-.6-2.03.49-2.23z"/>
                    </svg></button>
                    </div>
    </div>
    
</div>

<script src="https://chicktv.github.io/tv/tmi.min.js"></script>
<script>
    // ===================== é‡è¦è¨­å®š =====================
    const CLIENT_ID = '0uhjgjpko804ba35q1nj1h6x2eriq9';
    const CHANNEL = "69nocondom";
    const REDIRECT_URI = encodeURIComponent(location.origin + location.pathname);
    const AUTH_URL = `https://id.twitch.tv/oauth2/authorize?client_id=${CLIENT_ID}&redirect_uri=${REDIRECT_URI}&response_type=token&scope=chat:read+chat:edit`;

    // ===================== å…¨åŸŸè®Šæ•¸ =====================
    let oauthToken = '';
    let username = 'justinfan666';
    let userDisplayName = '';
    let userAvatar = '';
    let client = null;
    let isConnected = false;
    
    // éŸ³è¨Šç³»çµ±è®Šæ•¸
    let audioLists = {};
    let isAudioDeleteMode = false;

    // æ²å‹•æ§åˆ¶è®Šæ•¸
    let autoScroll = true;
    let userScrolling = false;
    let scrollTimeout = null;

    const status = document.getElementById('status');
    const userInfo = document.getElementById('userInfo');
    const userAvatarEl = document.getElementById('userAvatar');
    const userNameEl = document.getElementById('userName');
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const msgInput = document.getElementById('msginput');
    const sendBtn = document.getElementById('sendbtn');
    const charCounter = document.getElementById('charCounter');
    const scrollToBottomBtn = document.getElementById('scroll-to-bottom-btn');

    // åŸæœ‰è®Šæ•¸
    let altMap = {}, emojiLists = {}, customBadges = {};
    let msgCache = {}; 
    let userCache = {}; 
    let myLoginId = "", myDisplayName = "", myBadges = "";
    let pendingReply = { id: null, user: null, displayName: null };
    let isDeleteMode = false;
    let isAtBottom = true;
    let isAutoScrolling = false;
    const MAX_MESSAGES = 100;
    let mediaLoadCount = 0;
    let mediaLoadTimer = null;
    let socket;

    // ===================== ç™»å…¥ç³»çµ± (ä¾†è‡ªtest3.html) =====================
    function checkLogin() {
        const saved = localStorage.getItem('twitch_token');
        if (saved) {
            oauthToken = saved;
            fetchUserInfo(saved.replace('oauth:', ''));
        } else {
            connectChat();
        }
    }

    function loginWithPopup() {
        if (CLIENT_ID.includes('è«‹å¡«å…¥')) {
            alert('è«‹å…ˆå¡«å…¥ CLIENT_IDï¼\nå‰å¾€ https://twitchapps.com/tmi/ é»ã€ŒConnect with Twitchã€å–å¾—');
            return;
        }
        
        const width = 600;
        const height = 700;
        const left = (screen.width - width) / 2;
        const top = (screen.height - height) / 2;
        
        const popup = window.open(
            AUTH_URL,
            'Twitch Login',
            `width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=yes,status=yes`
        );
        
        if (!popup || popup.closed || typeof popup.closed === 'undefined') {
            alert('å½ˆå‡ºè¦–çª—è¢«é˜»æ“‹äº†ï¼è«‹å…è¨±å½ˆå‡ºè¦–çª—ï¼Œæˆ–ä½¿ç”¨å…¶ä»–ç€è¦½å™¨ã€‚');
            return;
        }
        
        const checkPopup = setInterval(() => {
            if (popup.closed) {
                clearInterval(checkPopup);
                const token = localStorage.getItem('twitch_token');
                if (token) {
                    oauthToken = token;
                    fetchUserInfo(token.replace('oauth:', ''));
                }
            }
        }, 500);
    }

    async function fetchUserInfo(token) {
        try {
            const res = await fetch('https://api.twitch.tv/helix/users', {
                headers: { 'Client-ID': CLIENT_ID, 'Authorization': 'Bearer ' + token }
            });
            const data = await res.json();
            if (data.data?.[0]) {
                username = data.data[0].login;
                userDisplayName = data.data[0].display_name;
                userAvatar = data.data[0].profile_image_url;
                myLoginId = username;
                myDisplayName = userDisplayName;
                
                // ä¿å­˜åˆ°localStorage
                localStorage.setItem('twitch_my_login', myLoginId);
                localStorage.setItem('twitch_my_display', myDisplayName);
                
                loginSuccess();
            }
        } catch (e) {
            console.error('å–å¾—ç”¨æˆ¶è³‡è¨Šå¤±æ•—:', e);
            alert('ç™»å…¥å¤±æ•—ï¼Œè«‹é‡æ–°ç™»å…¥');
            logout();
        }
    }

    function loginSuccess() {
        status.textContent = `å·²ç™»å…¥æˆåŠŸï¼š${userDisplayName}ï¼Œå¯ä»¥ç™¼è¨€å›‰ï¼`;
        msgInput.disabled = false;
        msgInput.placeholder = "å‚³é€è¨Šæ¯";
        sendBtn.disabled = false;
        loginBtn.style.display = 'none';
        userInfo.style.display = 'none';
        userAvatarEl.src = userAvatar;
        userNameEl.textContent = userDisplayName;
        
        // æ›´æ–°æˆæ¬Šå€åŸŸ
        $("#auth-area").html(`<span style="color:#00ff00; font-weight:bold; margin-right:10px;">â— ${userDisplayName}</span><button onclick="logout()" style="background:#444; color:white; border:none; padding:4px 8px; border-radius:4px; cursor:pointer; font-size:11px;">ç™»å‡º</button>`);
        
        reconnectChat();
    }

    function logout() {
        localStorage.removeItem('twitch_token');
        localStorage.removeItem('twitch_my_login');
        localStorage.removeItem('twitch_my_display');
        location.reload();
    }

    // ===================== å­—æ•¸è¨ˆæ•¸å™¨åŠŸèƒ½ =====================
    function updateCharCounter() {
        const text = msgInput.value;
        const count = text.length;
        
        charCounter.textContent = `${count}/500`;
        
        if (count > 500) {
            charCounter.classList.add('over-limit');
            charCounter.classList.remove('near-limit');
        } else if (count > 450) {
            charCounter.classList.add('near-limit');
            charCounter.classList.remove('over-limit');
        } else {
            charCounter.classList.remove('over-limit', 'near-limit');
        }
        
        if (count > 500) {
            sendBtn.disabled = true;
            sendBtn.title = 'è¨Šæ¯é•·åº¦è¶…é500å­—é™åˆ¶';
        } else if (msgInput.disabled) {
            sendBtn.disabled = true;
            sendBtn.title = 'è«‹å…ˆç™»å…¥';
        } else {
            sendBtn.disabled = false;
            sendBtn.title = 'é€å‡ºè¨Šæ¯';
        }
    }

    function limitInputLength(e) {
        const text = msgInput.value;
        
        if (text.length >= 500) {
            if (e.key.length === 1 && !e.ctrlKey && !e.metaKey) {
                e.preventDefault();
                return;
            }
        }
    }

    // ===================== è¼”åŠ©å‡½æ•¸ =====================
    function getParameterByName(name, url) {
        name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
        var regexS = "[\\?&]" + name + "=([^&#]*)";
        var regex = new RegExp(regexS);
        var results = regex.exec(url);
        if (results == null) return "";
        else return decodeURIComponent(results[1].replace(/\+/g, " "));
    }

    function extractTagAndUrl(str) {
        const regex = /\[(s|y|start)\]\s+<a\s+href="([^"]+)"[^>]+>[^<]+<\/a>/i;
        const match = str.match(regex);
        if (match) {
            const tag = match[1];
            const url = match[2];
            return { tag, url, match };
        } else {
            return null;
        }
    }

    function getTagValue(tags, key) { 
        const regex = new RegExp(`${key}=([^;\\s]+)`); 
        const match = tags.match(regex); 
        return match ? match[1] : null; 
    }

    // ===================== åˆå§‹åŒ– =====================
    async function initApp() {
        // æ›´æ–°å­—æ•¸è¨ˆæ•¸å™¨
        updateCharCounter();
        
        // ç¶å®šäº‹ä»¶
        loginBtn.onclick = loginWithPopup;
        logoutBtn.onclick = logout;
        msgInput.addEventListener('input', updateCharCounter);
        msgInput.addEventListener('keydown', limitInputLength);
        
        // æª¢æŸ¥æ˜¯å¦å¾æˆæ¬Šå›èª¿è¿”å›
        if (location.hash.includes('access_token=')) {
            const token = new URLSearchParams(location.hash.slice(1)).get('access_token');
            if (token) {
                oauthToken = 'oauth:' + token;
                localStorage.setItem('twitch_token', oauthToken);
                
                if (window.opener) {
                    window.close();
                } else {
                    history.replaceState(null, null, location.pathname);
                    await fetchUserInfo(token);
                }
            }
        } else {
            checkLogin();
        }
        
        await fetchBadges();
        await loadResources();
        setupAutoTag();
        startChat();
    }

    // ===================== åŸæœ‰åŠŸèƒ½ (ç¨ä½œä¿®æ”¹) =====================
    async function loadResources() {
        try {
            const skData = await $.getJSON("https://chicktv.github.io/tv/skuser_icon.txt");
            if (Array.isArray(skData)) {
                emojiLists["å¸¸ç”¨"] = { emojis: skData, image: skData[0].src };
                skData.forEach(i => { if(i.alt) altMap[i.alt.toLowerCase()] = i.src; });
            }
            
            const savedBTTV = JSON.parse(localStorage.getItem('myBTTV') || '[]');
            emojiLists["BTTV"] = {
                emojis: savedBTTV.map(url => ({ alt: url.split('/').pop().split('?')[0], src: url, dis: url })),
                image: "https://static-cdn.jtvnw.net/badges/v1/ed51a614-2c44-4a60-80b6-62908436b43a/3"
            };

            await loadAudioData();

            const res = await $.getJSON("https://chicktv.github.io/tv/showset.txt");
            for (const item of res.set) {
                let n = (typeof item === 'object') ? item.name : item;
                let img = (typeof item === 'object') ? item.image : "";
                if (!n || n === "skuser_icon") continue;
                $.getJSON(`https://chicktv.github.io/tv/${n}.txt`, d => {
                    let list = d[n] || [];
                    emojiLists[n] = { emojis: list, image: img };
                    list.forEach(e => { if(e.alt) altMap[e.alt.toLowerCase()] = e.src; });
                });
            }
        } catch(e){}
    }

    async function loadAudioData() {
        try {
            const response = await fetch('https://chicktv.github.io/tv/audio.txt');
            const localAudios = JSON.parse(localStorage.getItem('myAudios') || '[]');
            if (response.ok) {
                const remoteAudios = await response.json();
                audioLists["éŸ³è¨Š"] = { audios: mergeAudioLists(remoteAudios, localAudios), image: "ğŸ”Š" };
            } else { throw new Error(); }
        } catch (e) {
            audioLists["éŸ³è¨Š"] = { audios: JSON.parse(localStorage.getItem('myAudios') || '[]'), image: "ğŸ”Š" };
        }
    }

    function mergeAudioLists(remote, local) {
        const merged = [...remote];
        const urlSet = new Set(remote.map(a => a.url));
        local.forEach(l => { if (!urlSet.has(l.url)) { merged.push(l); urlSet.add(l.url); } });
        return merged;
    }

    function renderEmojiPanel() {
        const tabs = $("#emojiTabs").empty();
        Object.keys(emojiLists).forEach((name, i) => {
            const tab = $('<div class="emoji-tab"></div>')
                .css("background-image", `url(${emojiLists[name].image})`)
                .attr("title", name)
                .on('click', function() { $(".emoji-tab").css("opacity", "0.6"); $(this).css("opacity", "1"); renderTabContent(name); });
            if (i === 0) tab.css("opacity", "1");
            tabs.append(tab);
        });

        const audioTab = $('<div class="emoji-tab" style="color:white; text-align:center; line-height:32px;">ğŸ”Š</div>')
            .on('click', function() { $(".emoji-tab").css("opacity", "0.6"); $(this).css("opacity", "1"); renderTabContent("éŸ³è¨Š"); });
        tabs.append(audioTab);

        renderTabContent(Object.keys(emojiLists)[0]);
    }

    function renderTabContent(name) {
        const content = $("#emojiContent").empty();
        if (name === "BTTV") {
            content.append(`
                <div class="bttv-input-area">
                    <input type="text" id="bttvUrl" class="custom-input" placeholder="è²¼ä¸Šåœ–ç‰‡ç¶²å€..." style="flex:1">
                    <div style="display:flex; gap:5px;">
                        <button onclick="addBTTV()" style="background:var(--t-purp); color:white; border:none; border-radius:4px; cursor:pointer; padding:5px 15px;">å„²å­˜</button>
                        <button onclick="isDeleteMode=!isDeleteMode;renderTabContent('BTTV')" style="background:${isDeleteMode?'#666':'#c42b1c'}; color:white; border:none; border-radius:4px; padding:5px 15px;">${isDeleteMode?'å–æ¶ˆ':'åˆªé™¤'}</button>
                    </div>
                </div>`);
            emojiLists[name].emojis.forEach(e => {
                const item = $(`<div class="emoji-item ${isDeleteMode ? 'show-del' : ''}"><img src="${e.src}" style="max-width:40px;"><div class="delete-btn" onclick="event.stopPropagation();deleteBTTV('${e.src}')">âœ•</div></div>`);
                item.on('click', () => { if(!isDeleteMode) { insertAtCursor(` [s] ${e.src} [e] `); $("#emojiPanel").hide(); } });
                content.append(item);
            });
        } else if (name === "éŸ³è¨Š") {
            content.append(`
                <div class="audio-input-form" style="flex-wrap:wrap">
                    <input type="text" id="audioName" class="custom-input" placeholder="éŸ³è¨Šåç¨±" style="flex:1; min-width:120px;">
                    <input type="text" id="audioUrl" class="custom-input" placeholder="éŸ³è¨Šç¶²å€" style="flex:2; min-width:180px;">
                    <div style="display:flex; gap:5px;">
                        <button onclick="addAudio()" style="background:var(--t-purp); color:white; border:none; border-radius:4px; padding:5px 15px;">å„²å­˜éŸ³è¨Š</button>
                        <button onclick="isAudioDeleteMode=!isAudioDeleteMode;renderTabContent('éŸ³è¨Š')" style="background:${isAudioDeleteMode?'#666':'#c42b1c'}; color:white; border:none; border-radius:4px; padding:5px 15px;">${isAudioDeleteMode?'å–æ¶ˆ':'åˆªé™¤'}</button>
                    </div>
                </div>`);
            audioLists[name].audios.forEach((a, index) => {
                const item = $(`<div class="audio-item ${isAudioDeleteMode ? 'show-del' : ''}">ğŸ”Š<br>${a.name}<div class="delete-btn" onclick="event.stopPropagation();deleteAudio(${index})">âœ•</div></div>`);
                item.on('click', () => { if(!isAudioDeleteMode) { insertAtCursor(` [a] ${a.url} [o] `); $("#emojiPanel").hide(); } });
                content.append(item);
            });
        } else {
            emojiLists[name].emojis.forEach(e => {
                $('<div class="emoji-item"></div>').append($('<img style="max-width:40px;">').attr('src', e.src))
                .on('click', () => { insertAtCursor(` ${e.alt} `); $('#emojiPanel').hide(); }).appendTo(content);
            });
        }
    }

    window.addBTTV = () => {
        const url = $("#bttvUrl").val().trim();
        if (!url) return;
        const saved = JSON.parse(localStorage.getItem('myBTTV') || '[]');
        if (!saved.includes(url)) {
            saved.push(url);
            localStorage.setItem('myBTTV', JSON.stringify(saved));
            emojiLists["BTTV"].emojis.push({ alt: url.split('/').pop(), src: url });
            renderTabContent("BTTV");
        }
        $("#bttvUrl").val("");
    };

    window.deleteBTTV = (url) => {
        let saved = JSON.parse(localStorage.getItem('myBTTV') || '[]');
        saved = saved.filter(u => u !== url);
        localStorage.setItem('myBTTV', JSON.stringify(saved));
        emojiLists["BTTV"].emojis = emojiLists["BTTV"].emojis.filter(e => e.src !== url);
        renderTabContent("BTTV");
    };

    window.addAudio = () => {
        const name = $("#audioName").val().trim(), url = $("#audioUrl").val().trim();
        if (!name || !url) return alert("è«‹å¡«å¯«å®Œæ•´");
        const saved = JSON.parse(localStorage.getItem('myAudios') || '[]');
        saved.push({ name, url });
        localStorage.setItem('myAudios', JSON.stringify(saved));
        audioLists["éŸ³è¨Š"].audios = mergeAudioLists([], saved);
        renderTabContent("éŸ³è¨Š");
    };

    window.deleteAudio = (i) => {
        let saved = JSON.parse(localStorage.getItem('myAudios') || '[]');
        saved.splice(i, 1);
        localStorage.setItem('myAudios', JSON.stringify(saved));
        audioLists["éŸ³è¨Š"].audios = saved;
        renderTabContent("éŸ³è¨Š");
    };
    
    window.handleAudioClick = (btn, url) => {
        if (btn.dataset.isPlaying === "true") {
            if (btn.currentAudio) {
                btn.currentAudio.pause();
                btn.currentAudio.currentTime = 0;
            }
            resetAudioState(btn);
        } else {
            const audioElem = new Audio(url);
            btn.currentAudio = audioElem;
            btn.dataset.isPlaying = "true";
            btn.classList.add('playing');
            btn.innerHTML = 'ğŸ”Š';
            btn.title = 'æ’­æ”¾ä¸­...é»æ“Šåœæ­¢';

            audioElem.play().catch(error => {
                console.error('éŸ³è¨Šæ’­æ”¾å¤±æ•—:', error);
                resetAudioState(btn);
                btn.title = 'æ’­æ”¾å¤±æ•—';
                btn.innerHTML = 'âŒ';
            });

            audioElem.onended = () => {
                resetAudioState(btn);
            };
        }
    };
    
    function resetAudioState(btn) {
        btn.dataset.isPlaying = "false";
        btn.classList.remove('playing');
        btn.innerHTML = 'ğŸ”ˆ';
        btn.title = 'é»æ“Šæ’­æ”¾éŸ³è¨Š';
        btn.currentAudio = null;
    }

    // ===================== è§£æå…§å®¹ =====================
    function parseContent(str) {
        let a = str, placeholders = [];

        // 1. è™•ç†å¤§å¯« [S]...E] (åŸå‰µç°¡æ˜“åœ–ç‰‡)
        a = a.replace(/\[S\](.*?)E\]/g, (m, b) => {
            b = b.replace(/[\r\n]/g, "").replace(/ /g, '').replace('[S]', '').replace('[', '');
            const number = Math.floor((Math.random() * 1000) + 1);
            let id = `__PH_${placeholders.length}__`;
            placeholders.push(`<a class="media-preview" href="${b}" target="_blank"><img id="${number}" alt="[S]${b}[E]" src="${b}" onload="onMediaLoaded()" onerror="onMediaLoaded()"/></a>`);
            return id;
        });

        // 2. è™•ç†å°å¯« [s]...e] (æ–°é‚è¼¯å¢å¼·ç‰ˆ)
        a = a.replace(/\[s\](.*?)e\]/g, (m, content) => {
            let b = content.replace(/[\r\n]/g, "").replace(/ /g, '').replace('[s]', '').replace('[', '');
            let id = `__PH_${placeholders.length}__`;
            let e = "";
            const number = Math.floor((Math.random() * 1000) + 1);

            if (b.match(/youtu/g) && !b.match(/img|jpg|png|gif/g)) {
                let vid = b.match(/watch\?/g) ? getParameterByName('v', b) : b.replace('https://www.', '').replace('https://', '').replace('youtu.be/', '').replace('youtube.com/embed/', '').replace('youtube.com/shorts/', '').replace('youtube.com/live/', '').replace('&feature=share', '');
                let t = getParameterByName('t', b);
                e = `<div><a style="text-decoration: none;" href="https://www.youtube.com/watch?v=${vid}"><div style="padding: 5px;background: rgba(0, 0, 0, 0.45);color: white;border-radius: 5px 5px 0px 0px;"> <i class="material-icons" style="font-size: 20px;float: right;"></i></div></a><iframe class="media-preview" onload="onMediaLoaded()" onerror="onMediaLoaded()" src="https://www.youtube.com/embed/${vid}?start=${t}" frameborder="0"  allowfullscreen></iframe></div>`;
            } else if (b.match(/twitter|https:\/\/x.com/g)) {
                let twUrl = b.replace('https://x.com', 'https://twitter.com');
                e = `<div class="twitter-tweet-container" style="width:300px;height:400px;overflow:hidden;"><blockquote class="twitter-tweet"><a href="${twUrl}"></a></blockquote></div><script async src="https://platform.twitter.com/widgets.js"><\/script>`;
            } else if (b.match(/www.threads.com/g)) {
                let threadUrl = b.match(/@[\w.]+\/post\/[\w]+/);
                e = threadUrl ? `<iframe src="https://www.threads.com/${threadUrl[0]}/embed" allowtransparency="true" allowfullscreen="true" frameborder="0" height="300" style="background:#FFF;border-radius:12px;width:100%"></iframe>` : b;
            } else if (b.match(/\.(webm|mp4)/g)) {
                e = `<video class="media-preview"  onload="onMediaLoaded()" onerror="onMediaLoaded()" autoplay loop muted playsinline src="${b}"></video>`;
            } else if (b.match(/steampowered|steamcommunity/g)) {
                let appId = b.match("app/([0-9]+)");
                e = appId ? `<iframe class="media-preview" onload="onMediaLoaded()" onerror="onMediaLoaded()"  src="https://store.steampowered.com/widget/${appId[1]}" frameborder="0"></iframe>` : b;
            } else {
                e = `<a href="${b}" target="_blank"><img src="${b}" class="media-preview" onload="onMediaLoaded()" onerror="onMediaLoaded()" /></a>`;
            }
            placeholders.push(e);
            return id;
        });

        // 3. è™•ç†å½±ç‰‡æ¨™ç±¤ [y]...[t] (æ–°é‚è¼¯)
        a = a.replace(/\[y\](.*?)[\[]?t\]/gi, (m, content) => {
            let b = content.replace(/[\r\n]/g, "").replace(/ /g, '').replace('[y]', '').replace('[', '');
            let id = `__PH_${placeholders.length}__`;
            let e = "";
            if (b.match(/facebook/g)) {
                e = `<iframe src="https://www.facebook.com/plugins/video.php?href=${encodeURIComponent(b)}&show_text=0&width=300" width="300" height="200" style="border:none;overflow:hidden" scrolling="no" frameborder="0" allowfullscreen="true"></iframe>`;
            } else if (b.match(/youtu/g)) {
                let vid = b.match(/watch\?/g) ? getParameterByName('v', b) : b.replace('https://www.', '').replace('https://', '').replace('youtu.be/', '').replace('youtube.com/embed/', '').replace('youtube.com/shorts/', '').replace('youtube.com/live/', '').replace('&feature=share', '');
                e = `<iframe class="media-preview"  onload="onMediaLoaded()" onerror="onMediaLoaded()" src="https://www.youtube.com/embed/${vid}" frameborder="0" allowfullscreen></iframe>`;
            } 
              else if (b.match(/\.(webm|mp4)/g)) {
                e = `<video class="media-preview" onload="onMediaLoaded()" onerror="onMediaLoaded()" autoplay loop muted playsinline src="${b}"></video>`;}
                 else if (b.match(/twitter|https:\/\/x.com/g)) {
                let twUrl = b.replace('https://x.com', 'https://twitter.com');
                e = `<div class="twitter-tweet-container" style="width:300px;height:400px;overflow:hidden;"><blockquote class="twitter-tweet"><a href="${twUrl}"></a></blockquote><script async src="https://platform.twitter.com/widgets.js"><\/script>`;}
            else {
                e = `<a href="${b}" target="_blank" style="color:#58a6ff;">${b}</a>`;
            }
            placeholders.push(e);
            return id;
        });

        // 4. è™•ç†éŸ³è¨Šæ¨™ç±¤ [a]...[o]
        a = a.replace(/\[a\](.*?)\[o\]/gi, (m, content) => {
            const url = content.trim(); let id = `__PH_${placeholders.length}__`;
            placeholders.push(`<span class="audio-icon-btn" onclick="handleAudioClick(this, '${url}')" data-is-playing="false" title="é»æ“Šæ’­æ”¾éŸ³è¨Š">ğŸ”ˆ</span>`);
            return id;
        });

        // 5. è™•ç†è‡ªå‹•è§£æ HTML é€£çµä¸­çš„æ¨™ç±¤ (extractTagAndUrl æ–°é‚è¼¯)
        let htmlMatch = extractTagAndUrl(a);
        if (htmlMatch) {
            let b = htmlMatch.url;
            let e = `<a href="${b}" target="_blank"><img src="${b}" style="max-height: 150px; max-width: 100%; border-radius:6px;"/></a>`;
            a = a.replace(htmlMatch.match[0], e);
        }

        // 6. è™•ç†ä¸€èˆ¬ç¶²å€èˆ‡è‡ªè¨‚è¡¨æƒ…
        a = a.replace(/https?:\/\/[^\s]+/gi, (url) => url.includes('__PH_') ? url : `<a href="${url}" target="_blank" style="color:#58a6ff;">${url}</a>`);
        let words = a.split(' ');
        a = words.map(w => { 
            if(w.includes('__PH_')) return w; 
            const src = altMap[w.toLowerCase()]; 
            return src ? `<img src="${src}" class="alt-emoji">` : w; 
        }).join(' ');

        // æœ€å¾Œé‚„åŸæ‰€æœ‰é ç•™ä½”ä½ç¬¦
        placeholders.forEach((html, i) => { a = a.replace(`__PH_${i}__`, html); });
        return a;
    }

    // åª’é«”è¼‰å…¥å®Œæˆçš„å›èª¿å‡½æ•¸ - æ”¹å–„ç‰ˆ
    function onMediaLoaded() {
        mediaLoadCount++;
        
        if (mediaLoadTimer) {
            clearTimeout(mediaLoadTimer);
        }
        
        mediaLoadTimer = setTimeout(() => {
            setTimeout(() => {
                if (isAtBottom && !isAutoScrolling) {
                    const container = $("#chat-container")[0];
                    isAutoScrolling = true;
                    container.scrollTop = container.scrollHeight;
                    
                    setTimeout(() => {
                        if (isAtBottom && !isAutoScrolling) {
                            container.scrollTop = container.scrollHeight;
                        }
                        setTimeout(() => {
                            isAutoScrolling = false;
                        }, 100);
                    }, 100);
                }
                mediaLoadCount = 0;
            }, 50);
        }, 150);
    }

    // é™åˆ¶è¨Šæ¯æ•¸é‡å‡½æ•¸
    function limitMessages() {
        const $messages = $("#messages");
        const $children = $messages.children();
        if ($children.length > MAX_MESSAGES) {
            $children.slice(0, $children.length - MAX_MESSAGES).remove();
        }
    }

    // ç²å–ç”¨æˆ¶çš„ display name
    function getUserDisplayName(userId, fallbackName) {
        if (userCache[userId]) {
            return userCache[userId];
        }
        
        const userMessages = Object.keys(msgCache).filter(key => {
            const msg = msgCache[key];
            return msg && msg.user && (msg.user.login === userId || msg.user.displayName === userId || msg.user === userId);
        });
        
        if (userMessages.length > 0) {
            const latestMsg = msgCache[userMessages[userMessages.length - 1]];
            if (latestMsg && latestMsg.displayName) {
                userCache[userId] = latestMsg.displayName;
                return latestMsg.displayName;
            }
        }
        
        return fallbackName || userId;
    }

    // æ–°å¢ï¼šç²å–è‡ªå·±çš„ badge è³‡è¨Š
    function getMyBadges() {
        return myBadges || "";
    }

    // ===================== tmi.js é€£ç·š (ä¾†è‡ªtest3.html) =====================
    function connectChat() {
        if (isConnected) return;
        
        client = new tmi.client({
            connection: { secure: true, reconnect: true },
            identity: oauthToken ? { username, password: oauthToken } : undefined,
            channels: [CHANNEL]
        });

        client.on('connected', () => {
            isConnected = true;
            status.textContent = `å·²é€£ç·š ${CHANNEL} ${oauthToken?'ï¼ˆå·²ç™»å…¥ï¼‰':''}`;
        });

        client.on('message', async (ch, tags, message, self) => {
            try {
                const ts = Date.now().toString();
                const msgId = tags.id;
                const user = tags['display-name'] || tags.username;
                const userLogin = tags.username;
                const color = tags.color || "#9147ff";
                const badgeStr = tags.badges;
                
                // å¿«å–ç”¨æˆ¶è³‡è¨Š
                userCache[userLogin] = user;
                
                // å¿«å–è¨Šæ¯ï¼ˆåŒ…å«ç”¨æˆ¶è³‡è¨Šï¼‰
                if (msgId) {
                    msgCache[msgId] = {
                        content: message,
                        user: { login: userLogin, displayName: user },
                        displayName: user,
                        badges: badgeStr
                    };
                }
                msgCache[ts] = {
                    content: message,
                    user: { login: userLogin, displayName: user },
                    displayName: user,
                    badges: badgeStr
                };
                
                let replyHtml = "", displayMsg = message;
                const pUser = tags['reply-parent-display-name'];
                const pId = tags['reply-parent-msg-id'];
                const pBodyRaw = tags['reply-parent-msg-body'];
                
                if (pUser && pId) {
                    let isMe = (pUser === userDisplayName || pUser === username);
                    
                    let originalText = pBodyRaw ? pBodyRaw.replace(/\\s/g, " ") : "...";
                    let pBody = parseContent(originalText); 
                    
                    const userTagClass = isMe ? 'quote-user mention-self-tag' : 'quote-user';
                    
                    replyHtml = `<div class="quote-box" onclick="scrollToMsg('${pId}')"><svg width="17" height="17" viewBox="0 0 24 20" fill="currentColor"><path d="M9 10h2v2H9v-2Zm6 0h-2v2h2v-2Z"></path><path fill-rule="evenodd" d="m12 22-3-3H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v12a2 2 0 0 1 2 2h-4l-3 3Zm-2.172-5L12 19.172 14.172 17H19V5H5v12h4.828Z" clip-rule="evenodd"></path></svg> å›è¦†<span class="${userTagClass}">@${pUser}:</span>${pBody}</div>`;
                    
                    const mention = `@${pUser} `;
                    if (displayMsg.startsWith(mention)) {
                        displayMsg = displayMsg.substring(mention.length);
                    }
                }
                
                const badgeHtml = renderBadges(badgeStr);
                const line = `<div class="chat-line ts-${ts} id-${msgId}" data-msg-id="${msgId}">
                    <div class="reply-btn" onclick="replyNative('${userLogin}','${msgId}','${user}')"><img src="https://chicktv.github.io/tv/re2.png" width="35" height="35"></div>
                    ${replyHtml}
                    ${badgeHtml}
                    <b style="color:${color}">${user}:</b> <span>${parseContent(displayMsg)}</span>
                </div>`;
                $("#messages").append(line);
                
                limitMessages();
                
                if (isAtBottom) {
                    const container = $("#chat-container")[0];
                    isAutoScrolling = true;
                    container.scrollTop = container.scrollHeight;
                    
                    setTimeout(() => {
                        if (isAtBottom) {
                            container.scrollTop = container.scrollHeight;
                        }
                        setTimeout(() => {
                            isAutoScrolling = false;
                        }, 100);
                    }, 100);
                }
            } catch (error) {
                console.error('è™•ç†è¨Šæ¯æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
            }
        });

        client.connect().catch(console.error);
    }

    function reconnectChat() {
        if (client) {
            client.disconnect();
            isConnected = false;
        }
        
        connectChat();
    }

    function renderBadges(badgeStr) {
        if (!badgeStr) return "";
        let html = "";
        badgeStr.split(',').forEach(b => {
            const key = b.split('/')[0];
            const url = customBadges[b] || customBadges[key];
            if (url) html += `<img class="badge" src="${url}">`;
        });
        return html;
    }

    function fetchBadges() { return $.getJSON("https://chicktv.github.io/tv/badges.txt", d => { customBadges = d; }); }

    // ===================== ç™¼é€è¨Šæ¯åŠŸèƒ½ =====================
    function sendMessage() {
        let msg = msgInput.value.trim();
        
        if (msg.length > 500) {
            alert('è¨Šæ¯é•·åº¦ä¸èƒ½è¶…é500å­—ï¼ç›®å‰å­—æ•¸ï¼š' + msg.length);
            msg = msg.substring(0, 500);
            msgInput.value = msg;
            updateCharCounter();
            return;
        }
        
        if (msg && oauthToken && client?.readyState() === 'OPEN') {
            if (pendingReply.id) {
                client.reply(CHANNEL, msg, pendingReply.id).then(() => {
                    msgInput.value = '';
                    updateCharCounter();
                    cancelReply();
                }).catch(err => {
                    console.error('å›è¦†ç™¼é€å¤±æ•—:', err);
                    client.say(CHANNEL, msg).then(() => {
                        msgInput.value = '';
                        updateCharCounter();
                        cancelReply();
                    });
                });
            } else {
                client.say(CHANNEL, msg).then(() => {
                    msgInput.value = '';
                    updateCharCounter();
                });
            }
        }
    }

    // ===================== å…¶ä»–åŠŸèƒ½ =====================
    function setupAutoTag() { 
        msgInput.addEventListener('paste', (e) => {
            const data = (e.clipboardData || window.clipboardData).getData('text');
            if (!data.match(/^https?:\/\//i)) return;
            if (msgInput.value.endsWith('[s] ')) { e.preventDefault(); insertAtCursor(data + ' [e]'); }
            else if (msgInput.value.endsWith('[y] ')) { e.preventDefault(); insertAtCursor(data + ' [t]'); }
            else if (msgInput.value.endsWith('[a] ')) { e.preventDefault(); insertAtCursor(data + ' [o]'); }
        });
    }
    
    // æ»¾å‹•åˆ°æŒ‡å®šè¨Šæ¯
    function scrollToMsg(msgId) {
        const $msg = $(`.id-${msgId}`);
        if ($msg.length) {
            const container = $("#chat-container")[0];
            const msgTop = $msg.offset().top - $(container).offset().top;
            
            container.scrollTo({
                top: msgTop + container.scrollTop - 50,
                behavior: 'smooth'
            });
        }
    }
    
    function scrollToBottom() {
        const container = document.getElementById('chat-container');
        isAutoScrolling = false;
        container.scrollTo({
            top: container.scrollHeight,
            behavior: 'smooth' 
        });
        isAtBottom = true;
        $("#scroll-to-bottom-btn").fadeOut();
    }
    
    function insertTagOnly(s) { 
        const i = msgInput, st = i.selectionStart; 
        i.value = i.value.substring(0, st) + s + i.value.substring(i.selectionEnd); 
        i.focus(); 
        updateCharCounter();
    }
    
    function insertAtCursor(v) { 
        const i = msgInput, st = i.selectionStart; 
        i.value = i.value.substring(0, st) + v + i.value.substring(i.selectionEnd); 
        i.focus(); 
        updateCharCounter();
    }
    
    function replyNative(userLogin, msgId, displayName) { 
        pendingReply = { 
            id: msgId, 
            user: userLogin, 
            displayName: displayName || userLogin 
        }; 
        $("#replying-to-user").text(displayName || userLogin); 
        $("#reply-indicator").show(); 
        msgInput.focus(); 
    }
    
    function cancelReply() { 
        pendingReply = { id: null, user: null, displayName: null }; 
        $("#reply-indicator").hide(); 
    }
    
    // ç›£è½ Enter éµç™¼é€
    msgInput.addEventListener('keydown', e => {
        if (e.key === 'Enter') {
            e.preventDefault();
            sendMessage();
        }
    });

    // ç›£è½æ²å‹•äº‹ä»¶
    const container = document.getElementById('chat-container');
    container.addEventListener('scroll', () => {
        if (isAutoScrolling) {
            return;
        }
        
        const distanceFromBottom = container.scrollHeight - container.scrollTop - container.clientHeight;
        
        if (distanceFromBottom > 100) {
            isAtBottom = false;
            $("#scroll-to-bottom-btn").fadeIn();
        } else {
            isAtBottom = true;
            $("#scroll-to-bottom-btn").fadeOut();
        }
    });

</script>
</body>
</html>
