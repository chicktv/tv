<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Twitch Chat Ultimate - History Loader</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        :root { --t-bg: #0e0e10; --t-alt: #18181b; --t-purp: #9147ff; --t-text: #efeff1; }
        body { background: var(--t-bg); color: var(--t-text); font-family: sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .header-bar { background: var(--t-alt); padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; }
        #chat-container { flex-grow: 1; overflow-y: auto; padding: 15px; background: #000; }
        .chat-line { margin-bottom: 12px; padding: 8px; border-radius: 4px; border-left: 3px solid transparent; cursor: pointer; }
        .chat-line:hover { background: #1f1f23; border-left-color: var(--t-purp); }
        .badge { display: inline-block; width: 18px; height: 18px; margin-right: 4px; vertical-align: middle; }
        .username { font-weight: bold; margin-right: 5px; vertical-align: middle; }
        .media-preview { max-width: 200px; max-height: 200px; border-radius: 6px; margin-top: 8px; display: block; border: 1px solid #444; object-fit: contain; }
        .alt-emoji { max-width: 150px; max-height: 150px; height: auto; width: auto; vertical-align: middle; margin: 2px; object-fit: contain; }
        .quote-box { font-size: 12px; color: #adadb8; background: rgba(145, 71, 255, 0.1); padding: 8px; border-radius: 6px; margin-bottom: 8px; border-left: 4px solid #e6d670; max-height: 80px; overflow: hidden; }
        .quote-box img { max-height: 20px; width: auto; }
        #emojiPanel { position: fixed; display: none; width: 400px; height: 500px; background: #1f1f23; border: 1px solid #333; border-radius: 10px; z-index: 1000; left: 50%; top: 45%; transform: translate(-50%, -50%); flex-direction: column; }
        #emojiTabs { display: flex; gap: 5px; padding: 10px; overflow-x: auto; background: #000; border-bottom: 1px solid #333; }
        .emoji-tab { width: 35px; height: 35px; background-size: cover; cursor: pointer; border-radius: 4px; flex-shrink: 0; border: 1px solid #444; }
        #emojiContent { flex-grow: 1; overflow-y: auto; padding: 10px; display: flex; flex-wrap: wrap; gap: 8px; }
        .emoji-item { width: 45px; height: 45px; cursor: pointer; }
        .footer { padding: 15px; background: var(--t-alt); border-top: 1px solid #333; }
        .tag-row { display: flex; gap: 8px; margin-bottom: 10px; overflow-x: auto; }
        .tag-btn { background: #2f2f35; border: none; color: #efeff1; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; border-bottom: 3px solid #555; white-space: nowrap; }
        #msginput { flex-grow: 1; background: #000; border: 1px solid #444; color: #fff; padding: 12px; border-radius: 4px; outline: none; }
    </style>
</head>
<body onload="initApp()">

<div class="header-bar">
    <div style="font-size:14px; font-weight:bold;">whitewing940920 Console (w/ History)</div>
    <div id="auth-area"><button onclick="twitchLogin()" style="background:var(--t-purp); color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">ç™»å…¥ Twitch</button></div>
</div>

<div id="chat-container"><div id="messages"></div></div>

<div id="emojiPanel">
    <div style="padding:10px; background:#26262c; display:flex; justify-content:space-between;"><b>è³‡æºé¢æ¿</b><span onclick="$('#emojiPanel').hide()" style="cursor:pointer;">&times;</span></div>
    <div id="emojiTabs"></div>
    <div id="emojiContent"></div>
</div>

<div class="footer">
    <div class="tag-row">
        <button class="tag-btn" onclick="insertTag('[r]', ',REF[m]')">å¼•ç”¨å›è¦†</button>
        <button class="tag-btn" onclick="insertTag('[s]', '[e]')">åœ–å½±ç›´é€£</button>
        <button class="tag-btn" onclick="insertTag('[y]', '[t]')">YouTube</button>
        <button class="tag-btn" onclick="insertTag('[a]', '[o]')">éŸ³è¨Š</button>
        <button class="tag-btn" onclick="$('#emojiPanel').toggle()">â˜º è¡¨æƒ…</button>
    </div>
    <div style="display:flex; gap:10px;">
        <input id="msginput" type="text" placeholder="è¼‰å…¥ä¸­..." autocomplete="off">
        <button onclick="sendMessage()" style="background:var(--t-purp); color:white; border:none; padding:0 25px; border-radius:4px; cursor:pointer; font-weight:bold;">ç™¼é€</button>
    </div>
</div>

<script>
    const CLIENT_ID = '0uhjgjpko804ba35q1nj1h6x2eriq9';
    const CHANNEL = "whitewing940920";
    const CHANNEL_ID = "483664062"; // é€™æ˜¯ whitewing940920 çš„é »é“ IDï¼Œç”¨æ–¼è¼‰å…¥æ­·å²è¨Šæ¯
    const REDIRECT_URI = encodeURIComponent(location.origin + location.pathname);

    let ACCESS_TOKEN = "", LOGIN_NAME = "justinfan" + Math.floor(Math.random() * 10000);
    let socket, altMap = {}, altMapLower = {}, emojiSets = {}, customBadges = {};
    let msgCache = {}, displayedIds = new Set();

    async function initApp() { 
        checkToken(); 
        await loadAllResources(); 
        await fetchBadges();
        await loadHistory(); // å…ˆè¼‰å…¥æ­·å²ç´€éŒ„
        startChat(); // å†é–‹å•Ÿ WebSocket
        $("#msginput").attr("placeholder", "è¼¸å…¥è¨Šæ¯...");
    }

    function checkToken() {
        const hash = window.location.hash;
        if (hash) {
            const params = new URLSearchParams(hash.substring(1));
            ACCESS_TOKEN = params.get("access_token");
            if (ACCESS_TOKEN) {
                fetch("https://api.twitch.tv/helix/users", { headers: { "Authorization": `Bearer ${ACCESS_TOKEN}`, "Client-Id": CLIENT_ID } })
                .then(r => r.json()).then(data => {
                    LOGIN_NAME = data.data[0].display_name;
                    $("#auth-area").html(`<span style="color:#0f0">â—</span> ${LOGIN_NAME}`);
                });
            }
        }
    }

    function twitchLogin() { window.location.href = `https://id.twitch.tv/oauth2/authorize?client_id=${CLIENT_ID}&redirect_uri=${REDIRECT_URI}&response_type=token&scope=chat:read+chat:edit`; }

    async function fetchBadges() {
        try { const r = await fetch("https://chicktv.github.io/tv/badges.txt"); customBadges = await r.json(); } catch(e){}
    }

    async function loadAllResources() {
        const r = await fetch("https://chicktv.github.io/tv/showset.txt");
        const data = await r.json();
        for (let set of data.set) {
            if (!set.name) continue;
            emojiSets[set.name] = { icon: set.image, list: [] };
            const res = await fetch(`https://chicktv.github.io/tv/${set.name}.txt`);
            const d = await res.json();
            if (d[set.name]) {
                d[set.name].forEach(e => { 
                    emojiSets[set.name].list.push(e); 
                    altMap[e.alt] = e.src;
                    altMapLower[e.alt.toLowerCase()] = e.src;
                });
            }
        }
        renderEmojiUI();
    }

    function renderEmojiUI() {
        const tabs = $("#emojiTabs").empty();
        Object.keys(emojiSets).forEach(k => {
            $(`<div class="emoji-tab"></div>`).css("background-image", `url(${emojiSets[k].icon})`).click(() => {
                const cont = $("#emojiContent").empty();
                emojiSets[k].list.forEach(e => {
                    $(`<div class="emoji-item"><img src="${e.src}" title="${e.alt}" style="width:100%"></div>`).click(() => insertAtCursor(` ${e.alt} `)).appendTo(cont);
                });
            }).appendTo(tabs);
        });
    }

    // --- è¼‰å…¥æ­·å²è¨Šæ¯é‚è¼¯ ---
    async function loadHistory() {
        try {
            const res = await fetch(`https://tmi.twitch.tv/api/rooms/${CHANNEL_ID}/recent_messages`);
            const data = await res.json();
            if (data.messages) {
                data.messages.forEach(rawMsg => {
                    // é€™è£¡çš„ rawMsg æ˜¯åŸå§‹çš„ IRC å­—ä¸²ï¼Œæˆ‘å€‘éœ€è¦æ¨¡æ“¬è§£æ
                    processRawIRC(rawMsg, true);
                });
                $("#messages").append(`<div style="text-align:center; color:#555; font-size:12px; margin: 10px 0;">--- ä»¥ä¸Šç‚ºæ­·å²è¨Šæ¯ ---</div>`);
            }
        } catch (e) { console.error("ç„¡æ³•è¼‰å…¥æ­·å²è¨Šæ¯", e); }
    }

    function processRawIRC(data, isHistory = false) {
        if (!data.includes('PRIVMSG')) return;
        const parts = data.split(` PRIVMSG #${CHANNEL} :`);
        if (parts.length < 2) return;

        let msg = parts[1].trim();
        const tags = parts[0];
        
        const ts = tags.match(/tmi-sent-ts=([\d]+)/)?.[1];
        const msgId = tags.match(/id=([^;]+)/)?.[1];

        // é˜²æ­¢æ­·å²ç´€éŒ„èˆ‡å³æ™‚è¨Šæ¯é‡è¤‡
        if (msgId && displayedIds.has(msgId)) return;
        if (msgId) displayedIds.add(msgId);

        const badgeStr = tags.match(/badges=([^;]*)/)?.[1];
        const user = tags.match(/display-name=([^;]+)/)?.[1] || "User";
        const userColor = tags.match(/color=([^;]+)/)?.[1] || "#bf94ff";

        // è§£æ [r][m] å¼•ç”¨
        if (msg.includes('[r]')) {
            msg = msg.replace(/\[r\](.*?,.*?)\[m\]/gi, (m, c) => {
                const [u, refKey] = c.split(',');
                let refContent = msgCache[refKey] || "è¨Šæ¯";
                return `<div class="quote-box"><strong>@${u}</strong>: ${refContent}</div>`;
            });
        }

        // è§£æåª’é«”èˆ‡ Alt è¡¨æƒ… (é‚è¼¯èˆ‡ä¹‹å‰ç›¸åŒ)
        msg = msg.replace(/\[s\]\s*(.*?)\s*\[e\]/gi, (m, url) => {
            if (url.match(/\.(mp4|webm|ogg)$/i)) return `<video src="${url}" class="media-preview" controls muted autoplay loop></video>`;
            return `<img src="${url}" class="media-preview">`;
        });
        msg = msg.replace(/\[y\]\s*(.*?)\s*\[t\]/gi, (m, url) => {
            let vid = url.match(/(?:v=|\/shorts\/|youtu.be\/|embed\/)([^#&?]*)/);
            return vid ? `<iframe class="media-preview" src="https://www.youtube.com/embed/${vid[1]}" frameborder="0" allowfullscreen style="width:200px; height:150px;"></iframe>` : `[é€£çµ]`;
        });

        let words = msg.split(/(\s+)/);
        msg = words.map(w => {
            let token = w.trim();
            let src = altMap[token] || altMapLower[token.toLowerCase()];
            return src ? `<img src="${src}" title="${token}" class="alt-emoji">` : w;
        }).join('');

        msg = msg.replace(/\[a\]\s*(.*?)\s*\[o\]/gi, (m, url) => { 
            if(!isHistory) new Audio(url).play().catch(()=>{}); 
            return `ğŸ”Š`; 
        });

        // å­˜å…¥ç·©å­˜
        if(ts) msgCache[ts] = msg;
        if(msgId) msgCache[msgId] = msg;

        // æ¸²æŸ“åˆ°ç•«é¢
        const html = `
            <div class="chat-line" onclick="reply('${user}','${ts}')">
                ${parseBadges(badgeStr)}
                <span class="username" style="color:${userColor}">${user}</span>: 
                <span class="ts-${ts} id-${msgId}">${msg}</span>
            </div>`;
        
        $("#messages").append(html);
        if(!isHistory) $("#chat-container").scrollTop($("#chat-container")[0].scrollHeight);
    }

    function startChat() {
        socket = new WebSocket('wss://irc-ws.chat.twitch.tv:443');
        socket.onopen = () => {
            socket.send('CAP REQ :twitch.tv/tags twitch.tv/commands');
            socket.send(ACCESS_TOKEN ? `PASS oauth:${ACCESS_TOKEN}` : 'PASS dummy');
            socket.send(`NICK ${ACCESS_TOKEN ? 'anything' : LOGIN_NAME}`);
            socket.send(`JOIN #${CHANNEL}`);
        };
        socket.onmessage = (e) => { processRawIRC(e.data); };
        // è‡ªå‹•æ²åˆ°åº•éƒ¨
        setTimeout(() => { $("#chat-container").scrollTop($("#chat-container")[0].scrollHeight); }, 500);
    }

    function sendMessage() {
        const val = $("#msginput").val();
        if (!val) return;
        socket.send(`PRIVMSG #${CHANNEL} :${val}`);
        $("#msginput").val("");
    }

    function reply(u, ts) { $("#msginput").val(`[r]${u},${ts}[m] @${u} `).focus(); }
    function insertAtCursor(val) { $("#msginput").val($("#msginput").val() + val).focus(); }
    function insertTag(s, e) {
        let el = document.getElementById("msginput");
        let start = el.selectionStart;
        el.value = el.value.slice(0, start) + s + el.value.slice(start, el.selectionEnd) + e + el.value.slice(el.selectionEnd);
        el.focus();
        el.setSelectionRange(start + s.length, start + s.length);
    }
    $(document).on('keypress', '#msginput', e => { if (e.which == 13) sendMessage(); });
</script>
</body>
</html>
