<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>chickchat</title>
<style>
    /* ========== Twitch Dark Theme ========== */
    body {
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
        background: #0e0e10;
        color: #efeff1;
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        line-height: 1.4;
        height: 100vh;
        display: flex;
        flex-direction: column;
    }
    
    #status {
        margin: 8px 12px;
        font-weight: 500;
        color: #bf94ff;
        font-size: 10px;
    }
    
    #userInfo {
        display: flex;
        align-items: center;
        gap: 8px;
        margin: 0 12px 8px;
        font-size: 13px;
    }
    
    #userInfo img {
        width: 30px;
        height: 30px;
        border-radius: 50%;
    }
    
    #logoutBtn {
        margin-left: auto;
        background: #e91916;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 6px 12px;
        cursor: pointer;
        font-size: 12px;
        font-weight: 600;
        transition: background-color 0.2s;
    }
    
    #logoutBtn:hover {
        background: #c51614;
    }
    
    #chat-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        background: #0e0e10;
        position: relative;
    }
    
    #chat {
        flex: 1;
        overflow-y: auto;
        white-space: wrap; 
        background: #0e0e10;
        padding: 12px;
        border-radius: 0;
        border: 1px solid #26262c;
        font-size: 14px;
        scroll-behavior: smooth;
    }
    
    #input-container {
        background: #1f1f23;
        padding: 1px 1px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    /* å­—æ•¸è¨ˆæ•¸å™¨æ¨£å¼ */
.char-counter {
    position: absolute;
    right: 40px;
    bottom: 5px;
    font-size: 12px;
    color: #adadb8;
    pointer-events: none;
    padding: 2px 6px;
    border-radius: 4px;
}

.char-counter.over-limit {
    color: #e91916;
    font-weight: bold;
}

.char-counter.near-limit {
    color: #ffd400;
}

/* èª¿æ•´è¼¸å…¥æ¡†å®¹å™¨ä½ç½® */
.chat-input-wrapper {
    display: flex;
    align-items: flex-start;
    background: #0e0e10;
    border-radius: 4px;
    padding: 5px 5px;
    position: relative;
}

    /* ä¿®æ”¹è¼¸å…¥æ¡†ç‚º textarea ä¸¦èª¿æ•´æ¨£å¼ */
    .chat-input {
        flex: 1;
        background: transparent;
        color: #efeff1;
        font-size: 14px;
        outline: none;
        flex-wrap: wrap;
        resize: none;
        min-height: 40px;
        max-height: 120px;
        font-family: inherit;
        line-height: 1.4;
        padding: 8px 0;
		border-radius: 0.2rem;
    }

    .chat-input::placeholder {
        color: #adadb8;
    }

    .chat-buttons {
        display: flex;
        gap: 8px;
        margin-top: 5px;
    }

    .chat-button {
        background: transparent;
        border: none;
        color: #9147ff;
        cursor: pointer;
        padding: 4px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .chat-button:hover {
        background: #3a3a3d;
    }
    
	
	
	/* éŸ³è¨Šæ’­æ”¾å™¨æ¨£å¼ */
.audio-player {
    max-width: 300px !important;
    background: #1f1f23 !important;
    border-radius: 8px !important;
    padding: 8px !important;
    margin: 4px 0 !important;
    border: 1px solid #3a3a3d !important;
}

.audio-player audio {
    width: 100% !important;
    height: 40px !important;
    background: #0e0e10 !important;
    border-radius: 4px !important;
}

.audio-info {
    font-size: 11px;
    color: #adadb8;
    margin-top: 4px;
    text-align: center;
}
	
	/* éŸ³è¨Šå–‡å­åœ–æ¨™æ¨£å¼ */
.audio-icon {
    display: inline-block;
    background: #9147ff;
    color: white;
    border-radius: 50%;
    width: 32px;
    height: 32px;
    text-align: center;
    line-height: 32px;
    font-size: 16px;
    cursor: pointer;
    margin: 2px;
    vertical-align: middle;
    transition: all 0.2s ease;
    position: relative;
}

.audio-icon:hover {
    background: #772ce8;
    transform: scale(1.1);
}

.audio-icon.playing {
    background: #e91916;
    animation: pulse 1s infinite;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

/* éš±è—çš„éŸ³è¨Šå…ƒç´  */
.hidden-audio {
    position: absolute;
    opacity: 0;
    pointer-events: none;
    width: 0;
    height: 0;
}


/* éŸ³è¨Šåˆ†é æ¨£å¼ */
.audio-item {
    position: relative;
    width: 40px;
    height: 40px;
    background: #3a3a3d;
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    padding: 4px;
    transition: background-color 0.2s;
}

.audio-item:hover {
    background: #53535f;
}

.audio-item.playing {
    background: #9147ff;
}

.audio-icon-small {
    font-size: 16px;
    margin-bottom: 2px;
}

.audio-name {
    font-size: 10px;
    text-align: center;
    word-break: break-word;
    line-height: 1.2;
    max-width: 100%;
    
    text-overflow: ellipsis;
    white-space: wrap;
}
.audio-item .delete-btn {
    position: absolute;
    top: -8px;
    right: -8px;
    background: #e91916;
    color: white;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    font-size: 12px;
    line-height: 20px;
    text-align: center;
    cursor: pointer;
    display: none;
    z-index: 10;
}

.audio-item:hover .delete-btn {
    display: block;
}

/* éŸ³è¨Šè¼¸å…¥è¡¨å–®æ¨£å¼ */
.audio-input-form {
   
    width: 95%;
    display: flex;
    gap: 1px;
    margin-bottom: 2px;

}

.audio-input-row {
    display: flex;
    gap: 6px;
}

.audio-input-row input {
    flex: 1;
    padding: 6px;
    background: #0e0e10;
    color: white;
    border: 1px solid #3a3a3d;
    border-radius: 4px;
    font-size: 12px;
}

.audio-input-row input:focus {
    outline: none;
    border-color: #9147ff;
}

.audio-buttons {
    display: flex;
    gap: 6px;
}

.audio-buttons button {
    flex: 1;
    padding: 6px;
    background: #9147ff;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    transition: background-color 0.2s;
}

.audio-buttons button:hover {
    background: #772ce8;
}

.audio-buttons button.delete-mode {
    background: #e91916;
}

.audio-buttons button.delete-mode:hover {
    background: #c51614;
}
	
	
    #loginBtn {
        padding: 8px 16px;
        background: #9147ff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 600;
        transition: background-color 0.2s;
        margin-top: 8px;
    }
    
    #loginBtn:hover {
        background: #772ce8;
    }
    
    #loginBtn:disabled {
        background: #464649;
        cursor: not-allowed;
    }
    
    .msg {
        margin: 4px 0;
        word-wrap: break-word;
        padding: 2px 0;
        position: relative;
    }
    
    .msg:hover .reply-btn {
        opacity: 1;
    }
    
    .name {
        font-weight: bold;
        margin-right: 6px;
        color: inherit;
        flex-shrink: 0;
        white-space: nowrap;
    }
    
    /* å¿«é€ŸæŒ‰éˆ• */
    #pastebtn {
      position: relative;
      display: flex;
      gap: 0px;
      margin-top: 8px;
    }
    .sk_botton {
      position: relative;
      padding: 0 8px;
      height: 24px;
      line-height: 24px;
      font-size: 12px;
      background: #333;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-right: 4px;
    }
    
    .sk_botton:hover {
      background: #444;
    }

    /* é€£çµå’Œåª’é«”æ¨£å¼ */
    a {
        color: #bf94ff;
        text-decoration: none;
    }
    
    a:hover {
        text-decoration: underline;
    }
    
    /* ç¢ºä¿æ‰€æœ‰åª’é«”å…ƒç´ éƒ½æœ‰ç›¸åŒçš„å¤§å° */
    img.zero-width-image, 
    video.zero-width-image, 
    iframe.zero-width-image, 
    .zero-width-image {
        max-width: 250px !important;
        max-height: 200px !important;
        border-radius: 6px !important;
        object-fit: fill !important;
        background: #000 !important;
        flex-shrink: 0 !important;
        vertical-align: top !important;
        align-self: flex-start !important;
        padding: 0px !important;
    }

    /* å¦å¤–ç¢ºä¿æ™®é€šçš„ img, video, iframe ä¹Ÿæœ‰ç›¸åŒçš„å¤§å° */
    img, video, iframe {
        max-width: 150px !important;
        max-height: 150px !important;
        border-radius: 6px !important;
        object-fit: fill !important;
        background: #000 !important;
        flex-shrink: 0 !important;
        vertical-align: top !important;
        align-self: flex-start !important;
        padding: 0px !important;
    }
    
    video {
        background: #000;
    }
    
    iframe {
        border: none;
    }

    .message-text {
        line-height: 1.4;
        word-break: break-word;
        overflow-wrap: break-word;
        white-space: normal;
        display: inline;
    }

    /* è¡¨æƒ…é¢æ¿æ¨£å¼ */
    .emoji-panel {
        position: fixed;
        background: #18181b;
        border: 1px solid #26262c;
        border-radius: 4px;
        z-index: 999999;
        width: 380px;
        height: 460px;
        display: none;
        box-shadow: 0 0 30px rgba(0,0,0,0.9);
        color: white;
        flex-direction: column;
        font-size: 13px;
    }
    
    .emoji-header {
        background: #9147ff;
        padding: 12px;
        text-align: center;
        cursor: move;
        font-weight: 600;
        border-radius: 4px 4px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .emoji-close-btn {
        background: none;
        border: none;
        color: white;
        font-size: 18px;
        cursor: pointer;
        width: 24px;
        height: 24px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.2s;
    }
    
    .emoji-close-btn:hover {
        background: rgba(255, 255, 255, 0.2);
    }
    
    .emoji-tabs {
        display: flex;
        flex-wrap: wrap;
        background: #1f1f23;
        padding: 8px;
        gap: 5px;
        overflow-x: auto;
        border-bottom: 1px solid #26262c;
    }
    
    .emoji-tab {
        width: 36px;
        height: 36px;
        background: #3a3a3d;
        border-radius: 4px;
        cursor: pointer;
        background-size: cover;
        background-position: center;
        flex-shrink: 0;
    }
    
    .emoji-tab.active {
        outline: 2px solid #9147ff;
    }
    
    .emoji-content {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
    background: #18181b;
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
    align-content: flex-start;

}
    
    .emoji-item {
		position: relative;
         width: 40px;
        height: 40px;
        border-radius: 4px;
        cursor: pointer;
    }
    
    .emoji-item img {
        width: 40px;
        height: 40px;
        border-radius: 4px;
        cursor: pointer;
    }
    
    .delete-btn {
        position: absolute;
        top: -8px;
        right: -8px;
        background: #e91916;
        color: white;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        font-size: 12px;
        line-height: 20px;
        text-align: center;
        cursor: pointer;
        display: none;
    }
    
    .emoji-item:hover .delete-btn {
        display: block;
    }
    
    .bttv-input {
        width: 100%;
        display: flex;
        gap: 6px;
        margin-bottom: 10px;
		
    }
    
    .bttv-input input {
        flex: 1;
        padding: 8px;
        background: #1f1f23;
        color: white;
        border: 1px solid #3a3a3d;
        border-radius: 4px;
    }
    
    .bttv-input input:focus {
        outline: none;
        border-color: #9147ff;
    }
    
    /* æ²è»¸æ¨£å¼ */
    #chat::-webkit-scrollbar {
        width: 8px;
    }
    
    #chat::-webkit-scrollbar-track {
        background: #1f1f23;
    }
    
    #chat::-webkit-scrollbar-thumb {
        background: #3a3a3d;
        border-radius: 4px;
    }
    
    #chat::-webkit-scrollbar-thumb:hover {
        background: #53535f;
    }
    
    .emoji-content::-webkit-scrollbar {
        width: 6px;
    }
    
    .emoji-content::-webkit-scrollbar-track {
        background: #1f1f23;
    }
    
    .emoji-content::-webkit-scrollbar-thumb {
        background: #3a3a3d;
        border-radius: 3px;
    }
    
    /* å›è¦†åŠŸèƒ½æ¨£å¼ */
    .reply-btn {
        opacity: 0;
        background: none;
        border: none;
        color: #adadb8;
        font-size: 12px;
        cursor: pointer;
        padding: 4px 6px;
        transition: all 0.2s;
        border-radius: 3px;
        white-space: nowrap;
        flex-shrink: 0;
    }
    
    .reply-btn:hover {
        background: #3a3a3d;
        color: #efeff1;
    }
    
    .reply-indicator {
        display: flex;
        align-items: center;
        background: #1f1f23;
        padding: 6px 10px;
        border-radius: 4px;
        margin-bottom: 8px;
        font-size: 12px;
        color: #adadb8;
    }
    
    .reply-indicator .cancel-reply {
        margin-left: auto;
        background: none;
        border: none;
        color: #adadb8;
        cursor: pointer;
        font-size: 12px;
        padding: 2px 6px;
        border-radius: 3px;
    }
    
    .reply-indicator .cancel-reply:hover {
        background: #3a3a3d;
        color: #efeff1;
    }
    
    .reply-preview {
        background: #1f1f23;
        padding: 8px;
        border-radius: 4px;
        margin-bottom: 8px;
        border-left: 3px solid #9147ff;
        font-size: 12px;
        color: #adadb8;
    }
    
    .reply-preview .replying-to {
        font-weight: bold;
        color: #9147ff;
    }
    
    /* æ”¹é€²çš„å›è¦†è¨Šæ¯æ¨£å¼ */
    .reply-context {
        font-size: 11px;
        color: #adadb8;
        margin-bottom: 4px;
        display: flex;
        align-items: center;
    }
    
    .reply-context .reply-icon {
        margin-right: 4px;
        color: #9147ff;
    }
    
    .reply-context .replying-to {
        font-weight: bold;
        color: #9147ff;
    }
    
    .reply-message {
        background: #1f1f23;
        border-left: 2px solid #9147ff;
        padding: 6px 8px;
        margin-bottom: 6px;
        border-radius: 0 4px 4px 0;
        font-size: 12px;
        color: #adadb8;
        display: flex;
        align-items: flex-start;
    }
    
    .reply-message .reply-avatar {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        margin-right: 6px;
        flex-shrink: 0;
    }
    
    .reply-message .reply-content {
        flex: 1;
        overflow: hidden;
    }
    
    .reply-message .reply-username {
        font-weight: bold;
        color: #9147ff;
        margin-right: 6px;
        font-size:14px;
        font-weight: bold;
        flex-shrink: 0;
    }
    
    .reply-message .reply-text {
        color: #adadb8;
        word-break: break-word;
        line-height: 1.3;
    }
    
    .reply-message .reply-arrow {
        color: #9147ff;
        margin-right: 6px;
        font-size: 10px;
    }
    
    .reply-container {
        margin-bottom: 8px;
    }
    
    /* æ”¹é€²çš„å®Œæ•´å›è¦†è¨Šæ¯å®¹å™¨ */
    .msg-with-reply {
        background: rgba(30, 30, 35, 0.7);
        border-radius: 8px;
        margin: 8px 0;
        padding: 0;
        overflow: hidden;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .reply-header {
        display: flex;
        align-items: center;
        padding: 6px 12px;
        background: rgba(31, 31, 35, 0.8);
        display:none;
        font-size: 11px;
        color: #bf94ff;
    }
    
    .reply-header .reply-icon {
        margin-right: 6px;
        font-size: 10px;
    }
    
    .reply-header .reply-username {
        font-weight: bold;
        margin-right: 0px;
    }
    
    .reply-original {
        padding: 8px 12px;
        background: rgba(31, 31, 35, 0.8);
        margin: 0;
        font-size: 12px;
        color: #adadb8;
        max-height: 60px;
        overflow: hidden;
        line-height: 1.3;
    }
    
    .reply-original .original-username {
        font-weight: bold;
        color: #9147ff;
        margin-right: 6px;
    }
    
    /* ä¿®æ­£è¨Šæ¯å…§å®¹å¸ƒå±€ - ä½¿ç”¨ table ä½ˆå±€è€Œä¸æ˜¯ flex */
    .msg-content {
        display: flex;
        align-items: flex-start;
        gap: 6px;
        width: 100%;
        line-height: 1.4;
    }
    
     .msg-with-reply .msg-content {
        padding: 8px 12px;
        display: flex;
        align-items: flex-start;
        gap: 6px;
        width: 100%;
    }
    
    .msg-with-reply:hover .reply-btn {
        opacity: 1;
    }
    
    /* ä½¿ç”¨ table-cell ä½ˆå±€ç¢ºä¿æ­£ç¢ºå°é½Š */
    .name-container {
        flex-shrink: 0;
        white-space: nowrap;
        display: flex;
        align-items: flex-start;
    }
    
    .text-container {
        flex: 1;
        min-width: 0; /* é‡è¦ï¼šå…è¨±æ–‡å­—å®¹å™¨æ”¶ç¸® */
        word-break: break-word;
        overflow-wrap: break-word;
    }
    
     .button-container {
        flex-shrink: 0;
        white-space: nowrap;
        margin-left: auto;
        padding-left: 8px;
    }

    /* @åŠŸèƒ½æ¨£å¼ */
    .mention-autocomplete {
        position: absolute;
        bottom: 100%;
        left: 0;
        right: 0;
        background: #18181b;
        border: 1px solid #26262c;
        border-radius: 4px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        display: none;
    }
    
    .mention-item {
        padding: 8px 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        border-bottom: 1px solid #26262c;
    }
    
    .mention-item:last-child {
        border-bottom: none;
    }
    
    .mention-item:hover, .mention-item.active {
        background: #9147ff;
        color: white;
    }
    
    .mention-item img {
        width: 20px;
        height: 20px;
        border-radius: 50%;
    }
    
    .mention-item .username {
        font-weight: bold;
    }
    
    .mention-item .display-name {
        color: #adadb8;
    }
    
    .mention-item:hover .display-name, .mention-item.active .display-name {
        color: white;
    }
    
    /* @æåŠè¦–è¦ºåé¥‹æ¨£å¼ */
    .mention-highlight {
        background-color: #9147ff;
        color: #ffffff;
        padding: 2px 6px;
        border-radius: 4px;
        font-weight: bold;
    }
    
    /* è¢«æåŠçš„è¨Šæ¯å®¹å™¨æ¨£å¼ */
    .mentioned-message .msg-content {
        padding: 0;
    }
    
    /* å¾½ç« æ¨£å¼ */
    .badge {
        width: 18px;
        height: 18px;
        margin-right: 4px;
        vertical-align: middle;
    }
    
    /* ========== æ–°æ·»åŠ ï¼šæ²å‹•åˆ°åº•éƒ¨æŒ‰éˆ• ========== */
    #scrollToBottomBtn {
        position: absolute;
        bottom: 80px;
        right: 20px;
        width: 40px;
        height: 40px;
        background: rgba(145, 71, 255, 0.8);
        color: white;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 100;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        transition: all 0.3s ease;
        font-size: 20px;
    }
    
    #scrollToBottomBtn:hover {
        background: rgba(145, 71, 255, 1);
        transform: scale(1.1);
    }
    
    #scrollToBottomBtn:active {
        transform: scale(0.95);
    }
    
    #scrollToBottomBtn svg {
        width: 24px;
        height: 24px;
    }
</style>
</head>
<body>
    <div id="status">è¼‰å…¥ä¸­...</div>
    
    <div id="userInfo" style="display:none;">
        <img id="userAvatar" src="" alt="é ­åƒ">
        <span id="userName"></span>
        <button id="logoutBtn">ç™»å‡º</button>
    </div>
    
    <div id="chat-container">
        <div id="chat"></div>
        <button id="scrollToBottomBtn" title="æ»¾å‹•åˆ°æœ€æ–°è¨Šæ¯" style="font-size: 24px; line-height: 1;">â‡£</button>
		 <div id="pastebtn">
            <button id="pastephoto" data-name="photo" type="button" class="sk_botton">åœ–ç‰‡</button>
            <button id="pastevideo" type="button" class="sk_botton" data-name="video">å½±ç‰‡</button>
			<button id="pasteaudio" type="button" class="sk_botton" data-name="audio">éŸ³è¨Š</button>
			   <button class="chat-button" id="emojiBtn" title="è¡¨æƒ…">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M10 2C5.58 2 2 5.58 2 10s3.58 8 8 8 8-3.58 8-8-3.58-8-8-8zm0 14.5c-3.59 0-6.5-2.91-6.5-6.5S6.41 3.5 10 3.5s6.5 2.91 6.5 6.5-2.91 6.5-6.5 6.5zM6.5 9c.83 0 1.5-.67 1.5-1.5S7.33 6 6.5 6 5 6.67 5 7.5 5.67 9 6.5 9zm7 0c.83 0 1.5-.67 1.5-1.5S14.33 6 13.5 6 12 6.67 12 7.5s.67 1.5 1.5 1.5zM10 14c-1.66 0-3.14-.69-4.2-1.8l1.41-1.41C7.83 11.53 8.84 12 10 12s2.17-.47 2.79-1.21l1.41 1.41C13.14 13.31 11.66 14 10 14z"/>
                    </svg>
                </button>
        </div>
        <div id="replyIndicator" class="reply-indicator" style="display: none;">
            <span>å›è¦†çµ¦ <span id="replyTargetName"></span></span>
            <button class="cancel-reply" id="cancelReplyBtn">å–æ¶ˆ</button>
        </div>
    </div>
    
    <div id="input-container">
        <div class="chat-input-wrapper">
            <textarea id="msgInput" class="chat-input" placeholder="ç™»å…¥å¾Œå³å¯ç™¼è¨€..." autocomplete="off" disabled rows="1"></textarea>
            <div class="mention-autocomplete" id="mentionAutocomplete"></div>
			<div id="charCounter" class="char-counter">0/500</div>
            <div class="chat-buttons">
              
                <button class="chat-button" id="sendBtn" disabled title="é€å‡ºè¨Šæ¯">
                    <svg width="20" height="40" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M2.93 4.26l14.76-2.66c.95-.17 1.73.61 1.56 1.56L15.74 17.1c-.2 1.09-1.57 1.41-2.23.49l-3.14-4.37-2.66 2.66c-.39.39-1.02.39-1.41 0-.39-.39-.39-1.02 0-1.41l2.66-2.66L1.44 6.49c-.92-.66-.6-2.03.49-2.23z"/>
                    </svg>
                </button>
            </div>
        </div>
        
       
        
        <button id="loginBtn">TWITCH ç™»å…¥</button>
    </div>

    <!-- è‡ªè¨‚è¡¨æƒ…é¢æ¿ -->
    <div id="emojiPanel" class="emoji-panel">
        <div class="emoji-header">
            è‡ªè¨‚è¡¨æƒ…é¢æ¿ï¼ˆæ‹–æ›³ç§»å‹•ï¼‰
            <button class="emoji-close-btn" id="emojiCloseBtn" title="é—œé–‰">Ã—</button>
        </div>
        <div class="emoji-tabs" id="emojiTabs"></div>
        <div class="emoji-content" id="emojiContent"></div>
    </div>

    <script src="https://chicktv.github.io/tv/tmi.min.js"></script>

  <script>
// ===================== é‡è¦è¨­å®š =====================
// ===================== é‡è¦è¨­å®š =====================
const CLIENT_ID = '0uhjgjpko804ba35q1nj1h6x2eriq9';
const channel = "whitewing940920";

const REDIRECT_URI = encodeURIComponent(location.origin + location.pathname);
const AUTH_URL = `https://id.twitch.tv/oauth2/authorize?client_id=${CLIENT_ID}&redirect_uri=${REDIRECT_URI}&response_type=token&scope=chat:read+chat:edit`;

// ===================== å…¨åŸŸè®Šæ•¸ =====================
let oauthToken = '';
let username = 'justinfan666';
let userDisplayName = '';
let userAvatar = '';
let client = null;
let isConnected = false;

// éŸ³è¨Šç³»çµ±è®Šæ•¸
let audioLists = {};
let isAudioDeleteMode = false;

// æ²å‹•æ§åˆ¶è®Šæ•¸
let autoScroll = true;
let userScrolling = false;
let scrollTimeout = null;

const status   = document.getElementById('status');
const chat     = document.getElementById('chat');
const input    = document.getElementById('msgInput');
const loginBtn = document.getElementById('loginBtn');
const logoutBtn = document.getElementById('logoutBtn');
const userInfo = document.getElementById('userInfo');
const userAvatarEl = document.getElementById('userAvatar');
const userNameEl   = document.getElementById('userName');
const scrollToBottomBtn = document.getElementById('scrollToBottomBtn');

// å›è¦†åŠŸèƒ½è®Šæ•¸
let replyingTo = null;
const replyIndicator = document.getElementById('replyIndicator');
const replyTargetName = document.getElementById('replyTargetName');
const cancelReplyBtn = document.getElementById('cancelReplyBtn');

// è¡¨æƒ…ç³»çµ±
let emojiLists = {};
let altToEmojiMap = {};
let isDeleteMode = false;

// å¾½ç« æ˜ å°„
let badgeMap = {};

// @åŠŸèƒ½è®Šæ•¸
let recentUsers = []; // å­˜å„²æœ€è¿‘ç™¼è¨€çš„ç”¨æˆ¶
let mentionAutocomplete = document.getElementById('mentionAutocomplete');
let mentionActive = false;
let mentionIndex = -1;
let mentionQuery = '';

// æ­£å‰‡
const youtubeRegex = /(?:https?:\/\/)?(?:www\.)?youtu(?:\.be\/|be\.com\/(?:shorts\/|(?:\S*(?:watch|embed)(?:(?:(?=\/[-a-zA-Z0-9_]{11,}(?!\S))\/)|(?:\S*v=|v\/)))))([-a-zA-Z0-9_]{11,})/;
const twitterImageRegex = /https?:\/\/pbs\.twimg\.com\/media\/[^?]+\?format=(jpg|jpeg|png|gif|webp)/i;
const mp4Regex = /\.mp4(?:[/?].*)?$/i;

// è¨Šæ¯è¨ˆæ•¸å™¨
let messageCount = 0;
const MAX_MESSAGES = 100;

// è¨Šæ¯ ID æ˜ å°„ç³»çµ± (ä½¿ç”¨ timestamp)
const messageIdMap = new Map();

// ===================== é˜²æ­¢ XSS =====================
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// ===================== æ²å‹•æ§åˆ¶åŠŸèƒ½ =====================
function checkScrollPosition() {
  const isAtBottom = chat.scrollHeight - chat.clientHeight - chat.scrollTop < 50;
  
  if (isAtBottom) {
    autoScroll = true;
    hideScrollButton();
  } else {
    autoScroll = false;
    showScrollButton();
  }
}

function showScrollButton() {
  scrollToBottomBtn.style.display = 'flex';
}

function hideScrollButton() {
  scrollToBottomBtn.style.display = 'none';
}

function scrollToBottom() {
  chat.scrollTop = chat.scrollHeight;
  autoScroll = true;
  hideScrollButton();
  
  setTimeout(() => {
    chat.scrollTop = chat.scrollHeight;
  }, 50);
}

chat.addEventListener('scroll', () => {
  if (scrollTimeout) {
    clearTimeout(scrollTimeout);
  }
  
  scrollTimeout = setTimeout(() => {
    checkScrollPosition();
  }, 150);
});

scrollToBottomBtn.addEventListener('click', scrollToBottom);

// ===================== å¾½ç« åŠŸèƒ½ =====================
async function loadBadgeMap() {
  try {
    const response = await fetch('https://chicktv.github.io/tv/badges.txt');
    const data = await response.json();
    badgeMap = data;
    console.log('å¾½ç« æ˜ å°„è¼‰å…¥æˆåŠŸ');
  } catch (error) {
    console.error('è¼‰å…¥å¾½ç« æ˜ å°„å¤±æ•—:', error);
    badgeMap = {};
  }
}

function parseBadges(badgesData) {
  if (!badgesData) return [];
  
  const badges = [];
  
  try {
    let badgePairs = [];
    
    if (typeof badgesData === 'string') {
      badgePairs = badgesData.split(',');
    } else if (typeof badgesData === 'object') {
      badgePairs = Object.entries(badgesData).map(([name, version]) => `${name}/${version}`);
    }
    
    for (const pair of badgePairs) {
      const [name, version] = pair.split('/');
      if (name && version) {
        const badgeKey = `${name}/${version}`;
        let badgeUrl;
        
        if (badgeMap[badgeKey]) {
          badgeUrl = badgeMap[badgeKey];
        } else {
          badgeUrl = `https://static-cdn.jtvnw.net/badges/v1/${name}/${version}`;
        }
        
        badges.push({
          name: name,
          displayName: name.charAt(0).toUpperCase() + name.slice(1),
          url: badgeUrl,
          version: version
        });
      }
    }
  } catch (error) {
    console.error('è§£æå¾½ç« æ™‚ç™¼ç”ŸéŒ¯èª¤:', error, badgesData);
    return [];
  }
  
  return badges;
}

function renderBadges(badges) {
  if (!badges || badges.length === 0) return '';
  
  return badges.map(badge => 
    `<img src="${badge.url}" class="badge" title="${badge.displayName}" alt="${badge.displayName}" onerror="this.style.display='none'">`
  ).join('');
}

// ===================== å¼·åˆ¶æ»¾å‹•è§£æ±ºæ–¹æ¡ˆ =====================
function forceScrollToBottom() {
  if (autoScroll) {
    chat.scrollTop = chat.scrollHeight;
    
    const maxAttempts = 10;
    let attempts = 0;
    
    const scrollInterval = setInterval(() => {
      chat.scrollTop = chat.scrollHeight;
      attempts++;
      
      if (attempts >= maxAttempts) {
        clearInterval(scrollInterval);
      }
    }, 100);
  }
}

// ===================== è¨Šæ¯é™åˆ¶åŠŸèƒ½ =====================
function limitMessages() {
  const messages = chat.querySelectorAll('.msg, .msg-with-reply');
  
  if (messages.length > MAX_MESSAGES) {
    const messagesToRemove = messages.length - MAX_MESSAGES;
    for (let i = 0; i < messagesToRemove; i++) {
      if (messages[i]) {
        messages[i].remove();
      }
    }
  }
}

// ===================== ç™»å…¥ç³»çµ± - å½ˆå‡ºè¦–çª—æ–¹æ¡ˆ =====================
function checkLogin() {
  const saved = localStorage.getItem('twitch_token');
  if (saved) {
    oauthToken = saved;
    fetchUserInfo(saved.replace('oauth:', ''));
  } else {
    connectChat();
  }
}

function loginWithPopup() {
  if (CLIENT_ID.includes('è«‹å¡«å…¥')) {
    alert('è«‹å…ˆå¡«å…¥ CLIENT_IDï¼\nå‰å¾€ https://twitchapps.com/tmi/ é»ã€ŒConnect with Twitchã€å–å¾—');
    return;
  }
  
  const width = 600;
  const height = 700;
  const left = (screen.width - width) / 2;
  const top = (screen.height - height) / 2;
  
  const popup = window.open(
    AUTH_URL,
    'Twitch Login',
    `width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=yes,status=yes`
  );
  
  if (!popup || popup.closed || typeof popup.closed === 'undefined') {
    alert('å½ˆå‡ºè¦–çª—è¢«é˜»æ“‹äº†ï¼è«‹å…è¨±å½ˆå‡ºè¦–çª—ï¼Œæˆ–ä½¿ç”¨å…¶ä»–ç€è¦½å™¨ã€‚');
    return;
  }
  
  const checkPopup = setInterval(() => {
    if (popup.closed) {
      clearInterval(checkPopup);
      const token = localStorage.getItem('twitch_token');
      if (token) {
        oauthToken = token;
        fetchUserInfo(token.replace('oauth:', ''));
      }
    }
  }, 500);
}

async function fetchUserInfo(token) {
  try {
    const res = await fetch('https://api.twitch.tv/helix/users', {
      headers: { 'Client-ID': CLIENT_ID, 'Authorization': 'Bearer ' + token }
    });
    const data = await res.json();
    if (data.data?.[0]) {
      username = data.data[0].login;
      userDisplayName = data.data[0].display_name;
      userAvatar = data.data[0].profile_image_url;
      loginSuccess();
    }
  } catch (e) {
    console.error('å–å¾—ç”¨æˆ¶è³‡è¨Šå¤±æ•—:', e);
    alert('ç™»å…¥å¤±æ•—ï¼Œè«‹é‡æ–°ç™»å…¥');
    logout();
  }
}

function loginSuccess() {
  status.textContent = `å·²ç™»å…¥æˆåŠŸï¼š${userDisplayName}ï¼Œå¯ä»¥ç™¼è¨€å›‰ï¼`;
  input.disabled = false;
  document.getElementById('sendBtn').disabled = false;
  input.placeholder = "å‚³é€è¨Šæ¯";
  loginBtn.style.display = 'none';
  userInfo.style.display = 'none';
  userAvatarEl.src = userAvatar;
  userNameEl.textContent = userDisplayName;
  
  reconnectChat();
}

function logout() {
  localStorage.removeItem('twitch_token');
  location.reload();
}

loginBtn.onclick = loginWithPopup;
logoutBtn.onclick = logout;

window.addEventListener('load', async function() {
  await loadBadgeMap();
  updateCharCounter();
  
  if (location.hash.includes('access_token=')) {
    const token = new URLSearchParams(location.hash.slice(1)).get('access_token');
    if (token) {
      oauthToken = 'oauth:' + token;
      localStorage.setItem('twitch_token', oauthToken);
      
      if (window.opener) {
        window.close();
      } else {
        history.replaceState(null, null, location.pathname);
        fetchUserInfo(token);
      }
    }
  } else {
    checkLogin();
  }
});

// ===================== æˆªæ–·è¨Šæ¯æ–‡æœ¬å‡½æ•¸ =====================
function truncateMessageText(text, maxLength) {
  if (!text) return '[ç„¡å…§å®¹]';
  
  // ç§»é™¤ HTML æ¨™ç±¤å’Œæ›è¡Œç¬¦
  const cleanText = text.replace(/<[^>]*>/g, '').replace(/\n/g, ' ');
  
  if (cleanText.length <= maxLength) return cleanText;
  return cleanText.substring(0, maxLength) + '...';
}

// ===================== æ»¾å‹•åˆ° timestamp çš„å‡½æ•¸ =====================
function scrollToTimestamp(timestamp) {
  console.log('å˜—è©¦æ»¾å‹•åˆ° timestamp:', timestamp);
  
  let targetElement = null;
  
  // å˜—è©¦å¤šç¨®å¯èƒ½çš„é¸æ“‡å™¨ä¾†æ‰¾åˆ° timestamp
  const selectors = [
    `[data-timestamp="${timestamp}"]`,
    `[data-time="${timestamp}"]`,
    `[data-original-timestamp="${timestamp}"]`,
    `[data-reply-to-timestamp="${timestamp}"]`,
    `.timestamp-${CSS.escape(timestamp)}`
  ];
  
  for (const selector of selectors) {
    try {
      const element = document.querySelector(selector);
      if (element) {
        targetElement = element;
        console.log('æ‰¾åˆ°è¨Šæ¯å…ƒç´ :', selector);
        break;
      }
    } catch (e) {
      console.warn('é¸æ“‡å™¨ç„¡æ•ˆï¼Œè·³é:', selector, e);
      continue;
    }
  }
  
  if (targetElement) {
    // æ»¾å‹•åˆ°è©²è¨Šæ¯
    targetElement.scrollIntoView({
      behavior: 'smooth',
      block: 'center'
    });
    
    // é«˜äº®æ•ˆæœ
    targetElement.style.transition = 'all 0.5s ease';
    targetElement.style.boxShadow = '0 0 0 3px rgba(145, 71, 255, 0.5)';
    targetElement.style.backgroundColor = 'rgba(145, 71, 255, 0.1)';
    
    // 3ç§’å¾Œç§»é™¤é«˜äº®
    setTimeout(() => {
      targetElement.style.boxShadow = '';
      targetElement.style.backgroundColor = '';
    }, 3000);
    
    return true;
  } else {
    console.log('æ‰¾ä¸åˆ° timestamp å°æ‡‰çš„è¨Šæ¯:', timestamp);
    
    // å˜—è©¦åœ¨ messageIdMap ä¸­æŸ¥æ‰¾
    const messageInfo = messageIdMap.get(timestamp);
    if (messageInfo) {
      console.log('åœ¨ messageIdMap ä¸­æ‰¾åˆ°è¨Šæ¯è³‡è¨Š:', messageInfo);
      showNotification(`å·²æ‰¾åˆ° timestamp ${timestamp} çš„è¨˜éŒ„ï¼Œä½† DOM å…ƒç´ å¯èƒ½å·²è¢«æ¸…é™¤`, 'info');
    } else {
      showNotification(`æ‰¾ä¸åˆ° timestamp ${timestamp} å°æ‡‰çš„è¨Šæ¯ï¼Œå¯èƒ½å·²è¢«æ¸…é™¤æˆ–å°šæœªè¼‰å…¥`, 'warning');
    }
    
    return false;
  }
}

// ===================== é¡¯ç¤ºé€šçŸ¥çš„å‡½æ•¸ =====================
function showNotification(message, type = 'info') {
  const colors = {
    info: '#9147ff',
    warning: '#e91916',
    success: '#00ff00'
  };
  
  const notification = document.createElement('div');
  notification.style.cssText = `
    position: fixed;
    top: 20px;
    left: 50%;
    transform: translateX(-50%);
    background: ${colors[type]};
    color: white;
    padding: 10px 20px;
    border-radius: 4px;
    z-index: 10000;
    font-size: 14px;
    font-weight: 500;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  `;
  
  notification.textContent = message;
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.style.opacity = '0';
    notification.style.transition = 'opacity 0.5s ease';
    setTimeout(() => {
      document.body.removeChild(notification);
    }, 500);
  }, 3000);
}


// ===================== è™•ç†åª’é«”å’Œè¡¨æƒ…çš„å‡½æ•¸ =====================
function processMediaAndEmojis(text) {
  let html = escapeHtml(text);
  
  // è™•ç†@æåŠé«˜äº®
  if (username && username !== 'justinfan666') {
    const mentionRegex = new RegExp(`@${username}\\b`, 'gi');
    html = html.replace(mentionRegex, `<span class="mention-highlight">@${username}</span>`);
    
    if (userDisplayName && userDisplayName !== username) {
      const displayNameMentionRegex = new RegExp(`@${escapeRegExp(userDisplayName)}(?=$|\\s|[\\.,!\\?\\)\\(])`, 'gi');
      html = html.replace(displayNameMentionRegex, `<span class="mention-highlight">@${userDisplayName}</span>`);
    }
  }

  // è™•ç†è¡¨æƒ…ç¬¦è™Ÿ
  for (const [alt, data] of Object.entries(altToEmojiMap)) {
    try {
      const escapedAlt = escapeRegExp(alt);
      const regex = new RegExp(`(^|\\s)(${escapedAlt})(?=$|\\s|[\\.,!\\?\\)\\(])`, 'gi');
      html = html.replace(regex, `$1<img src="${escapeHtml(data.src)}" style="max-width:50px;max-height:50px;cursor:pointer;" onclick="window.open('${escapeHtml(data.src)}','_blank')">`);
    } catch (error) {
      console.warn('è¡¨æƒ…ç¬¦è™Ÿè™•ç†éŒ¯èª¤:', alt, error);
    }
  }
  
  // è™•ç†åœ–ç‰‡æ¨™ç±¤ [s]
  html = html.replace(/\[s\](.*?)(?:\[e\]|$)/gi, (match, urlContent) => {
    let content = urlContent.trim();
    
    if (content.includes(' ')) {
      content = content.split(' ')[0];
    }
    
    content = content.replace(/^\s+|\s+$/g, '');
    
    if (!isValidUrl(content)) {
      console.log('ç„¡æ•ˆçš„ URL:', content);
      return match;
    }
    
    let replacement;
    
    if (content.toLowerCase().includes('.mp4')) {
      replacement = `<br><video src="${content}" controls autoplay muted loop class="zero-width-image" loading="lazy">
              <a href="${content}" target="_blank" rel="noopener noreferrer">${content}</a>
              </video>`;
    } else {
      replacement = `<br><img src="${content}" class="zero-width-image" loading="lazy" 
              onerror="this.style.display='none'; this.nextElementSibling && this.nextElementSibling.style.display='inline'" 
              onclick="window.open('${content}','_blank')">`;
    }
    
    return replacement;
  });

  // è™•ç†å½±ç‰‡æ¨™ç±¤ [y]
  html = html.replace(/\[y\](.*?)\[t\]/gi, (match, urlContent) => {
    let content = urlContent.trim();
    
    if (content.includes(' ')) {
      content = content.split(' ')[0];
    }
    
    content = content.replace(/^\s+|\s+$/g, '');
    
    if (!isValidUrl(content)) {
      console.log('ç„¡æ•ˆçš„ URL:', content);
      return match;
    }
    
    let replacement;
    
    const youtubeMatch = content.match(/(?:https?:\/\/)?(?:www\.)?youtu(?:\.be\/|be\.com\/(?:shorts\/|(?:\S*(?:watch|embed)(?:(?:(?=\/[-a-zA-Z0-9_]{11,}(?!\S))\/)|(?:\S*v=|v\/)))))([-a-zA-Z0-9_]{11,})/);
    if (youtubeMatch) {
      const id = escapeHtml(youtubeMatch[1]);
      replacement = `<br><iframe src="https://www.youtube.com/embed/${id}?autoplay=0" width="340" height="191" frameborder="0" allowfullscreen class="zero-width-image"></iframe>`;
    } else if (content.toLowerCase().includes('.mp4')) {
      replacement = `<br><video src="${content}" controls autoplay muted loop class="zero-width-image" loading="lazy">
              <a href="${content}" target="_blank" rel="noopener noreferrer">${content}</a>
              </video>`;
    } else {
      replacement = `<a href="${content}" target="_blank" rel="noopener noreferrer">${escapeHtml(content)}</a>`;
    }
    
    return replacement;
  });
  
  // è™•ç†éŸ³è¨Šæ ¼å¼ [a]ç¶²å€[o]
  html = html.replace(/\[a\](.*?)(?:\[o\]|$)/gi, (match, urlContent) => {
    let content = urlContent.trim();
    
    if (content.includes(' ')) {
      content = content.split(' ')[0];
    }
    
    content = content.replace(/^\s+|\s+$/g, '');
    
    if (!isValidUrl(content)) {
      console.log('ç„¡æ•ˆçš„éŸ³è¨Š URL:', content);
      return match;
    }
    
    if (!isAudioFile(content)) {
      console.log('ééŸ³è¨Šæª”æ¡ˆ:', content);
      return `<a href="${content}" target="_blank" rel="noopener noreferrer">${escapeHtml(content)}</a>`;
    }
    
    const audioId = 'audio-' + Math.random().toString(36).substr(2, 9);
    const iconId = 'icon-' + audioId;
    
    const audioElement = `
      <span class="audio-icon" id="${iconId}" title="é»æ“Šæ’­æ”¾éŸ³è¨Š (æœ€å¤š15ç§’)" data-audio-url="${content}">
        ğŸ”ˆ
      </span>
      <audio id="${audioId}" class="hidden-audio" preload="none">
        <source src="${content}" type="audio/mpeg">
      </audio>
    `;
    
    setTimeout(() => {
      const iconElement = document.getElementById(iconId);
      const audioElem = document.getElementById(audioId);
      
      if (iconElement && audioElem) {
        let isPlaying = false;
        
        iconElement.addEventListener('click', function() {
          if (!isPlaying) {
            isPlaying = true;
            iconElement.classList.add('playing');
            iconElement.innerHTML = 'ğŸ”Š';
            iconElement.title = 'æ’­æ”¾ä¸­...é»æ“Šåœæ­¢';
            
            audioElem.play().catch(error => {
              console.error('éŸ³è¨Šæ’­æ”¾å¤±æ•—:', error);
              resetAudioState();
              iconElement.title = 'æ’­æ”¾å¤±æ•—';
              iconElement.innerHTML = 'âŒ';
            });
            
            const timeUpdateHandler = function() {
              if (this.currentTime > 300) {
                this.pause();
                resetAudioState();
              }
            };
            
            audioElem.addEventListener('timeupdate', timeUpdateHandler);
            audioElem.addEventListener('ended', resetAudioState);
            audioElem.addEventListener('pause', resetAudioState);
            
          } else {
            audioElem.pause();
            resetAudioState();
          }
          
          function resetAudioState() {
            isPlaying = false;
            audioElem.currentTime = 0;
            iconElement.classList.remove('playing');
            iconElement.innerHTML = 'ğŸ”ˆ';
            iconElement.title = 'é»æ“Šæ’­æ”¾éŸ³è¨Š (æœ€å¤š300ç§’)';
          }
        });
        
        audioElem.addEventListener('error', function() {
          console.error('éŸ³è¨Šè¼‰å…¥å¤±æ•—:', content);
          iconElement.style.background = '#666';
          iconElement.title = 'éŸ³è¨Šè¼‰å…¥å¤±æ•—';
          iconElement.innerHTML = 'âŒ';
        });
      }
    }, 100);
    
    return audioElement;
  });

  // ç§»é™¤æ®˜ç•™çš„æ¨™ç±¤å­—ç¬¦
  html = html.replace(/(?<!<img[^>]*|<\/?video|<\/?iframe|<\/?a[^>]*)\[s\]|\[e\]|\[y\]|\[t\](?!>)/gi, '');

  // è™•ç†å…¶ä»–æ™®é€šç¶²å€
  html = html.replace(/(https?:\/\/[^\s<>"'\]\[]+)/g, url => {
    if (!isValidUrl(url)) {
      return escapeHtml(url);
    }
    
    // æª¢æŸ¥ URL æ˜¯å¦å·²ç¶“åœ¨ src æˆ– href å±¬æ€§ä¸­
    const escapedUrl = escapeHtml(url);
    if (html.includes(`src="${url}"`) || 
        html.includes(`src="${escapedUrl}"`) ||
        html.includes(`href="${url}"`) || 
        html.includes(`href="${escapedUrl}"`)) {
      return url;
    }
    
    return `<a href="${url}" target="_blank" rel="noopener noreferrer">${escapeHtml(url)}</a>`;
  });

  return html;
}

// URL é©—è­‰å‡½æ•¸
function isValidUrl(url) {
  try {
    const urlObj = new URL(url);
    return urlObj.protocol === 'http:' || urlObj.protocol === 'https:';
  } catch {
    return false;
  }
}

// éŸ³è¨Šæª”æ¡ˆæª¢æ¸¬å‡½æ•¸
function isAudioFile(url) {
  const audioPatterns = [
    /\.mp3(\?.*)?$/i,
    /\.wav(\?.*)?$/i,
    /\.ogg(\?.*)?$/i,
    /\.m4a(\?.*)?$/i,
    /\.aac(\?.*)?$/i,
    /\.webm(\?.*)?$/i,
    /\.flac(\?.*)?$/i
  ];
  
  return audioPatterns.some(pattern => pattern.test(url));
}

// æ­£å‰‡è¡¨é”å¼è·³è„«å‡½æ•¸
function escapeRegExp(string) {
  return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

// ===================== å®Œæ•´çš„è¨Šæ¯è™•ç†å‡½æ•¸ =====================
async function processMessage(text) {
  function decodeHtmlEntities(text) {
    const textarea = document.createElement('textarea');
    textarea.innerHTML = text;
    return textarea.value;
  }
  
  let decodedText = decodeHtmlEntities(text);
  let html = decodedText;
  
  // æª¢æŸ¥æ˜¯å¦åŒ…å« [r] æ¨™ç±¤
  const hasRtag = html.includes('[r]') && html.includes('[m]');
  
  if (hasRtag) {
    // ä½¿ç”¨æ­£å‰‡è¡¨é”å¼æå– [r] æ¨™ç±¤å…§å®¹
    const rtagMatch = html.match(/\[r\](.*?)\[m\]/);
    if (rtagMatch) {
      // æå– [r] æ¨™ç±¤å…§çš„å…§å®¹
      const rtagContent = rtagMatch[1].trim();
      
      // æ¸…ç†å…§å®¹
      const cleanedContent = rtagContent.replace(/[\r\n]/g, "").replace(/\[r\]/g, '').replace(/\[/g, '');
      
      // åˆ†å‰²åƒæ•¸ï¼šæ ¼å¼ç‚º [r]ä½¿ç”¨è€…åç¨±,timestamp[m]
      const parts = cleanedContent.split(',');
      
      if (parts.length >= 2) {
        const repliedUsername = parts[0].trim();
        const repliedTimestamp = parts[1].trim();
        
        // å˜—è©¦ç²å–åŸå§‹è¨Šæ¯å…§å®¹
        let originalMessageText = '[åŸå§‹è¨Šæ¯å·²ä¸å¯ç”¨]';
        const messageInfo = messageIdMap.get(repliedTimestamp);
        if (messageInfo && messageInfo.message) {
          originalMessageText = messageInfo.message;
        }
        
        // è™•ç†åŸå§‹è¨Šæ¯ä¸­çš„è¡¨æƒ…å’Œåœ–ç‰‡
        let processedOriginalMessage = processMediaAndEmojis(originalMessageText);
        
        // å¾åŸå§‹è¨Šæ¯ä¸­ç§»é™¤ [r] æ¨™ç±¤éƒ¨åˆ†ï¼Œåªä¿ç•™å‰©é¤˜å…§å®¹
        const remainingContent = html.substring(rtagMatch[0].length).trim();
        
        // è™•ç†å‰©é¤˜å…§å®¹ä¸­çš„åª’é«”å’Œè¡¨æƒ…
        let processedRemainingContent = processMediaAndEmojis(remainingContent);
        
        // å‰µå»ºå®Œæ•´çš„å›è¦†çµæ§‹
        return `
          <div class="reply-context">
            <span class="reply-icon">â†©</span>
            å›è¦†çµ¦ 
            <span class="replying-to">${escapeHtml(repliedUsername)}</span>
          </div>
          <div class="reply-message" onclick="scrollToTimestamp('${escapeHtml(repliedTimestamp)}')" style="cursor: pointer;">
            <div class="reply-content">
              <span class="reply-arrow">â†’</span>
              <span class="reply-username">${escapeHtml(repliedUsername)}:</span>
              <span class="reply-text">${processedOriginalMessage}</span>
            </div>
          </div>
          ${processedRemainingContent}
        `;
      }
    }
    
    // å¦‚æœ [r] æ¨™ç±¤æ ¼å¼ä¸æ­£ç¢ºï¼Œè¿”å›åŸå§‹è™•ç†çµæœ
    return processMediaAndEmojis(html);
  } else {
    // æ²’æœ‰ [r] æ¨™ç±¤ï¼Œæ­£å¸¸è™•ç†
    return processMediaAndEmojis(html);
  }
}

// ===================== æ™ºèƒ½è²¼ä¸ŠåŠŸèƒ½ =====================
function handlePaste(event) {
  event.preventDefault();
  
  const clipboardData = event.clipboardData || window.clipboardData;
  const pastedText = clipboardData.getData('text');
  
  const currentValue = input.value;
  const startPos = input.selectionStart;
  const endPos = input.selectionEnd;
  
  const newValue = currentValue.substring(0, startPos) + pastedText + currentValue.substring(endPos);
  
  let finalValue = newValue;
  if (currentValue.substring(0, startPos).endsWith("[s] ")) {
    finalValue = newValue + " [e]";
  } else if (currentValue.substring(0, startPos).endsWith("[y] ")) {
    finalValue = newValue + " [t]";
  } else if (currentValue.substring(0, startPos).endsWith("[a] ")) {
    finalValue = newValue + " [o]";
  }
  
  input.value = finalValue;
  
  const newCursorPos = finalValue.length;
  setTimeout(() => {
    input.focus();
    input.setSelectionRange(newCursorPos, newCursorPos);
  }, 10);
}

function initPasteHandler() {
  input.removeEventListener('paste', handlePaste);
  input.addEventListener('paste', handlePaste);
}

// ===================== è²¼ä¸ŠæŒ‰éˆ•åŠŸèƒ½ =====================
document.getElementById('pastephoto').addEventListener('click', function() {
  if (input.disabled) {
    alert('è«‹å…ˆç™»å…¥å¾Œå†ä½¿ç”¨æ­¤åŠŸèƒ½');
    return;
  }
  
  const currentValue = input.value;
  const cursorPos = input.selectionStart;
  
  const newValue = currentValue.substring(0, cursorPos) + '[s] ' + currentValue.substring(cursorPos);
  input.value = newValue;
  
  const newCursorPos = cursorPos + 4;
  setTimeout(() => {
    input.focus();
    input.setSelectionRange(newCursorPos, newCursorPos);
  }, 10);
  
  initPasteHandler();
});

document.getElementById('pastevideo').addEventListener('click', function() {
  if (input.disabled) {
    alert('è«‹å…ˆç™»å…¥å¾Œå†ä½¿ç”¨æ­¤åŠŸèƒ½');
    return;
  }
  
  const currentValue = input.value;
  const cursorPos = input.selectionStart;
  
  const newValue = currentValue.substring(0, cursorPos) + '[y] ' + currentValue.substring(cursorPos);
  input.value = newValue;
  
  const newCursorPos = cursorPos + 4;
  setTimeout(() => {
    input.focus();
    input.setSelectionRange(newCursorPos, newCursorPos);
  }, 10);
  
  initPasteHandler();
});

document.getElementById('pasteaudio').addEventListener('click', function() {
  if (input.disabled) {
    alert('è«‹å…ˆç™»å…¥å¾Œå†ä½¿ç”¨æ­¤åŠŸèƒ½');
    return;
  }
  
  const currentValue = input.value;
  const cursorPos = input.selectionStart;
  
  const newValue = currentValue.substring(0, cursorPos) + '[a] ' + currentValue.substring(cursorPos);
  input.value = newValue;
  
  const newCursorPos = cursorPos + 4;
  setTimeout(() => {
    input.focus();
    input.setSelectionRange(newCursorPos, newCursorPos);
  }, 10);
  
  initPasteHandler();
});

// é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–è²¼ä¸Šè™•ç†å™¨
window.addEventListener('load', function() {
  initPasteHandler();
});

input.addEventListener('focus', function() {
  initPasteHandler();
});

// ===================== å›è¦†åŠŸèƒ½ (ä½¿ç”¨ timestamp) =====================
function setupReply(messageId, username, messageText, timestamp) {
  replyingTo = {
    id: messageId,
    username: username,
    message: messageText,
    timestamp: timestamp,
    // å„²å­˜åŸå§‹è¨Šæ¯å…§å®¹ï¼ˆæˆªæ–·å¾Œï¼‰
    originalMessage: truncateMessageText(messageText, 50)
  };
  
  replyTargetName.textContent = username;
  replyIndicator.style.display = 'flex';
  input.focus();
  
  const existingPreview = document.getElementById('replyPreview');
  if (existingPreview) {
    existingPreview.remove();
  }
  
  const preview = document.createElement('div');
  preview.id = 'replyPreview';
  preview.className = 'reply-preview';
  preview.innerHTML = `
    å›è¦†çµ¦ <span class="replying-to">${username}</span>: ${truncateMessageText(messageText, 25)}
    <div style="margin-top: 5px; font-size: 11px; color: #adadb8;">
      ä½¿ç”¨ä»¥ä¸‹æ ¼å¼æ’å…¥å›è¦†é€£çµï¼š
      <button onclick="insertRtag()" style="margin-left: 5px; padding: 2px 6px; background: #3a3a3d; color: #fff; border: none; border-radius: 3px; font-size: 11px; cursor: pointer;">
        æ’å…¥ [r] æ¨™ç±¤
      </button>
    </div>
  `;
  
  replyIndicator.parentNode.insertBefore(preview, replyIndicator.nextSibling);
}

// æ’å…¥ [r] æ¨™ç±¤ (ä½¿ç”¨ timestamp)
function insertRtag() {
  if (!replyingTo) return;
  
  const currentValue = input.value;
  const cursorPos = input.selectionStart;
  
  // ä½¿ç”¨ timestamp è€Œä¸æ˜¯ message ID
  const rtag = `[r]${replyingTo.username},${replyingTo.timestamp}[m] `;
  const newValue = currentValue.substring(0, cursorPos) + rtag + currentValue.substring(cursorPos);
  input.value = newValue;
  
  adjustTextareaHeight();
  const newCursorPos = cursorPos + rtag.length;
  setTimeout(() => {
    input.focus();
    input.setSelectionRange(newCursorPos, newCursorPos);
  }, 10);
  
  updateCharCounter();
}

function cancelReply() {
  replyingTo = null;
  replyIndicator.style.display = 'none';
  
  const preview = document.getElementById('replyPreview');
  if (preview) {
    preview.remove();
  }
}

function truncateMessage(text, maxLength) {
  if (text.length <= maxLength) return text;
  return text.substring(0, maxLength) + '...';
}

// ===================== @åŠŸèƒ½ =====================
function addRecentUser(username, displayName, avatar) {
  const existingIndex = recentUsers.findIndex(user => user.username === username);
  
  if (existingIndex >= 0) {
    const user = recentUsers.splice(existingIndex, 1)[0];
    recentUsers.unshift(user);
  } else {
    recentUsers.unshift({
      username: username,
      displayName: displayName || username,
      avatar: avatar || 'https://static-cdn.jtvnw.net/user-default-pictures-uv/294c98b5-e34d-42cd-a8f0-140b72fba9b0-profile_image-70x70.png'
    });
  }
  
  if (recentUsers.length > 20) {
    recentUsers = recentUsers.slice(0, 20);
  }
}

function showMentionAutocomplete(query) {
  mentionQuery = query.toLowerCase();
  mentionAutocomplete.innerHTML = '';
  
  if (!mentionQuery) {
    hideMentionAutocomplete();
    return;
  }
  
  const matchedUsers = recentUsers.filter(user => 
    user.username.toLowerCase().includes(mentionQuery) || 
    user.displayName.toLowerCase().includes(mentionQuery)
  );
  
  if (matchedUsers.length === 0) {
    hideMentionAutocomplete();
    return;
  }
  
  matchedUsers.forEach((user, index) => {
    const item = document.createElement('div');
    item.className = 'mention-item';
    item.innerHTML = `
      <img src="${user.avatar}" alt="${user.username}">
      <div>
        <div class="username">${user.displayName}</div>
        <div class="display-name">@${user.username}</div>
      </div>
    `;
    
    item.addEventListener('click', () => {
      selectMention(user);
    });
    
    mentionAutocomplete.appendChild(item);
  });
  
  mentionAutocomplete.style.display = 'block';
  mentionActive = true;
  mentionIndex = -1;
}

function hideMentionAutocomplete() {
  mentionAutocomplete.style.display = 'none';
  mentionActive = false;
  mentionIndex = -1;
}

function selectMention(user) {
  const currentValue = input.value;
  const atIndex = currentValue.lastIndexOf('@');
  
  if (atIndex >= 0) {
    const newValue = currentValue.substring(0, atIndex) + `@${user.username} `;
    input.value = newValue;
    
    adjustTextareaHeight();
    
    input.focus();
    input.setSelectionRange(newValue.length, newValue.length);
  }
  
  hideMentionAutocomplete();
}

function navigateMentions(direction) {
  if (!mentionActive) return;
  
  const items = mentionAutocomplete.querySelectorAll('.mention-item');
  if (items.length === 0) return;
  
  items.forEach(item => item.classList.remove('active'));
  
  mentionIndex += direction;
  
  if (mentionIndex < 0) {
    mentionIndex = items.length - 1;
  } else if (mentionIndex >= items.length) {
    mentionIndex = 0;
  }
  
  items[mentionIndex].classList.add('active');
}

function handleMentionKeydown(e) {
  if (!mentionActive) return;
  
  switch (e.key) {
    case 'ArrowUp':
      e.preventDefault();
      navigateMentions(-1);
      break;
    case 'ArrowDown':
      e.preventDefault();
      navigateMentions(1);
      break;
    case 'Enter':
      e.preventDefault();
      const activeItem = mentionAutocomplete.querySelector('.mention-item.active');
      if (activeItem) {
        const index = Array.from(mentionAutocomplete.querySelectorAll('.mention-item')).indexOf(activeItem);
        const matchedUsers = recentUsers.filter(user => 
          user.username.toLowerCase().includes(mentionQuery) || 
          user.displayName.toLowerCase().includes(mentionQuery)
        );
        if (matchedUsers[index]) {
          selectMention(matchedUsers[index]);
        }
      }
      break;
    case 'Escape':
      hideMentionAutocomplete();
      break;
  }
}

function handleInputChange(e) {
  const value = input.value;
  const cursorPos = input.selectionStart;
  
  const textBeforeCursor = value.substring(0, cursorPos);
  const lastAtPos = textBeforeCursor.lastIndexOf('@');
  
  if (lastAtPos >= 0 && (lastAtPos === 0 || /\s/.test(value[lastAtPos - 1]))) {
    const query = textBeforeCursor.substring(lastAtPos + 1);
    showMentionAutocomplete(query);
  } else {
    hideMentionAutocomplete();
  }
  
  adjustTextareaHeight();
  updateCharCounter();
}

function adjustTextareaHeight() {
  input.style.height = 'auto';
  input.style.height = Math.min(input.scrollHeight, 120) + 'px';
}

function checkMention(messageText, tags) {
  if (!username || username === 'justinfan666') return false;
  
  const usernameMentionRegex = new RegExp(`@${username}\\b`, 'i');
  if (usernameMentionRegex.test(messageText)) {
    return true;
  }
  
  if (userDisplayName && userDisplayName !== username) {
    const displayNameMentionRegex = new RegExp(`@${escapeRegExp(userDisplayName)}(?=$|\\s|[\\.,!\\?\\)\\(])`, 'i');
    if (displayNameMentionRegex.test(messageText)) {
      return true;
    }
  }
  
  return false;
}

// ===================== è¡¨æƒ…ç³»çµ± =====================
function loadEmojiSets() {
  fetch("https://chicktv.github.io/tv/showset.txt").then(r=>r.json()).then(setarray=>{
    setarray.set.forEach(list=>{
      emojiLists[list.name] = {emojis:[], image:list.image||''};
      fetch(`https://chicktv.github.io/tv/${list.name}.txt`).then(r=>r.json()).then(data=>{
        data[list.name].forEach(icon=>{
          if(icon.alt && icon.src){
            emojiLists[list.name].emojis.push({alt:icon.alt, src:icon.src, dis:icon.dis||icon.alt});
            altToEmojiMap[icon.alt] = {src:icon.src, width:'32', height:'32'};
          }
        });
        renderEmojiPanel();
      });
    });
  });

  fetch("https://chicktv.github.io/tv/skuser_icon.txt").then(r=>r.json()).then(icons=>{
    emojiLists["æœ¬å°"] = {emojis:[], image:"https://chicktv.github.io/tv/chick.jpg"};
    icons.forEach(i=>{
      emojiLists["æœ¬å°"].emojis.push({alt:i.alt, src:i.src, dis:i.alt});
      altToEmojiMap[i.alt] = {src:i.src, width:'32', height:'32'};
    });
    renderEmojiPanel();
  });

  const saved = JSON.parse(localStorage.getItem('myBTTV')||'[]');
  emojiLists["BTTV"] = {
    emojis: saved.map(url=>({alt:url.split('/').pop().split('?')[0], src:url, dis:url})),
    image: "https://static-cdn.jtvnw.net/badges/v1/ed51a614-2c44-4a60-80b6-62908436b43a/3"
  };
  
  loadAudioData();
  renderEmojiPanel();
}

// è¼‰å…¥éŸ³è¨Šè³‡æ–™
async function loadAudioData() {
  try {
    const response = await fetch('https://chicktv.github.io/tv/audio.txt');
    if (response.ok) {
      const remoteAudios = await response.json();
      const localAudios = JSON.parse(localStorage.getItem('myAudios') || '[]');
      const mergedAudios = mergeAudioLists(remoteAudios, localAudios);
      
      audioLists["éŸ³è¨Š"] = {
        audios: mergedAudios,
        image: "ğŸ”Š"
      };
    } else {
      throw new Error('é ç«¯éŸ³è¨Šåˆ—è¡¨è¼‰å…¥å¤±æ•—');
    }
  } catch (error) {
    console.error('è¼‰å…¥é ç«¯éŸ³è¨Šåˆ—è¡¨å¤±æ•—ï¼Œä½¿ç”¨æœ¬åœ°å„²å­˜çš„éŸ³è¨Š:', error);
    const localAudios = JSON.parse(localStorage.getItem('myAudios') || '[]');
      audioLists["éŸ³è¨Š"] = {
        audios: localAudios,
        image: "ğŸ”Š"
      };
    }
}

function mergeAudioLists(remoteAudios, localAudios) {
  const merged = [...remoteAudios];
  const urlSet = new Set(remoteAudios.map(audio => audio.url));
  
  localAudios.forEach(localAudio => {
    if (!urlSet.has(localAudio.url)) {
      merged.push(localAudio);
      urlSet.add(localAudio.url);
    }
  });
  
  return merged;
}

function renderEmojiPanel() {
  const tabs = document.getElementById('emojiTabs');
  const content = document.getElementById('emojiContent');
  tabs.innerHTML = ''; 
  content.innerHTML = '';

  Object.keys(emojiLists).forEach((name, i) => {
    const tab = document.createElement('div');
    tab.className = 'emoji-tab';
    tab.style.backgroundImage = `url(${emojiLists[name].image || 'https://via.placeholder.com/36?text=' + name[0]})`;
    tab.title = name;
    tab.onclick = () => {
      document.querySelectorAll('.emoji-tab').forEach(t=>t.classList.remove('active'));
      tab.classList.add('active');
      renderTabContent(name);
    };
    if (i===0) tab.classList.add('active');
    tabs.appendChild(tab);
  });

  const audioTab = document.createElement('div');
  audioTab.className = 'emoji-tab';
  audioTab.textContent = 'ğŸ”Š';
  audioTab.title = 'éŸ³è¨Š';
  audioTab.onclick = () => {
    document.querySelectorAll('.emoji-tab').forEach(t=>t.classList.remove('active'));
    audioTab.classList.add('active');
    renderTabContent('éŸ³è¨Š');
  };
  tabs.appendChild(audioTab);

  renderTabContent(Object.keys(emojiLists)[0] || 'BTTV');
}

function renderTabContent(name) {
  const content = document.getElementById('emojiContent');
  content.innerHTML = '';

  if (name === "BTTV") {
    content.innerHTML += `
      <div class="bttv-input">
        <input type="text" id="bttvUrl" placeholder="è¼¸å…¥åœ–ç‰‡ç¶²å€">
        <button onclick="addBTTV()">å„²å­˜</button>
        <button onclick="isDeleteMode=!isDeleteMode;renderEmojiPanel()" style="background:${isDeleteMode?'#666':'#c42b1c'}">
          ${isDeleteMode?'å–æ¶ˆ':'åˆªé™¤'}
        </button>
      </div>`;
    
    emojiLists[name].emojis.forEach(emoji => {
      const div = document.createElement('div');
      div.className = 'emoji-item';
      div.innerHTML = `<img src="${emoji.src}" title="${emoji.dis||emoji.alt}">`;
      if (isDeleteMode) {
        div.innerHTML += `<div class="delete-btn" onclick="event.stopPropagation();deleteBTTV('${emoji.src}')">X</div>`;
      }
      div.onclick = () => {
        if (!isDeleteMode) {
          input.value += (input.value ? ' ' : '') + `[s] ${emoji.src} [e]`;
          adjustTextareaHeight();
          input.focus();
          document.getElementById('emojiPanel').style.display = 'none';
        }
      };
      content.appendChild(div);
    });
  } else if (name === "éŸ³è¨Š") {
    content.innerHTML += `
      <div class="audio-input-form">
        <div class="audio-input-row">
          <input type="text" id="audioName" placeholder="éŸ³è¨Šåç¨±">
        </div>
        <div class="audio-input-row">
          <input type="text" id="audioUrl" placeholder="è¼¸å…¥éŸ³è¨Šç¶²å€">
        </div>
        <div class="audio-buttons">
          <button onclick="addAudio()">å„²å­˜</button>
          <button onclick="toggleAudioDeleteMode()" class="${isAudioDeleteMode ? 'delete-mode' : ''}" id="audioDeleteBtn">
            ${isAudioDeleteMode ? 'å–æ¶ˆ' : 'åˆªé™¤'}
          </button>
        </div>
      </div>`;
    
    audioLists[name].audios.forEach((audio, index) => {
      const audioDiv = document.createElement('div');
      audioDiv.className = 'audio-item';
      audioDiv.innerHTML = `
        <div class="audio-icon-small">ğŸ”Š</div>
        <div class="audio-name">${audio.name}</div>
      `;
      
      if (isAudioDeleteMode) {
        audioDiv.innerHTML += `<div class="delete-btn" onclick="event.stopPropagation();deleteAudio(${index})">X</div>`;
      }
      
      audioDiv.onclick = () => {
        if (!isAudioDeleteMode) {
          input.value += (input.value ? ' ' : '') + `[a] ${audio.url} [o]`;
          adjustTextareaHeight();
          input.focus();
          document.getElementById('emojiPanel').style.display = 'none';
          
          audioDiv.classList.add('playing');
          setTimeout(() => {
            audioDiv.classList.remove('playing');
          }, 500);
        }
      };
      
      content.appendChild(audioDiv);
    });
  } else {
    emojiLists[name].emojis.forEach(emoji => {
      const div = document.createElement('div');
      div.className = 'emoji-item';
      div.innerHTML = `<img src="${emoji.src}" title="${emoji.dis||emoji.alt}">`;
      div.onclick = () => {
        input.value += (input.value ? ' ' : '') + (emoji.alt || emoji.src);
        adjustTextareaHeight();
        input.focus();
        document.getElementById('emojiPanel').style.display = 'none';
      };
      content.appendChild(div);
    });
  }
}

window.addBTTV = () => {
  const url = document.getElementById('bttvUrl').value.trim();
  if (!url) return;
  const saved = JSON.parse(localStorage.getItem('myBTTV')||'[]');
  if (!saved.includes(url)) {
    saved.push(url);
    localStorage.setItem('myBTTV', JSON.stringify(saved));
    emojiLists["BTTV"].emojis.push({alt:url.split('/').pop().split('?')[0], src:url});
    renderEmojiPanel();
  }
  document.getElementById('bttvUrl').value = '';
};

window.deleteBTTV = (url) => {
  let saved = JSON.parse(localStorage.getItem('myBTTV')||'[]');
  saved = saved.filter(u=>u!==url);
  localStorage.setItem('myBTTV', JSON.stringify(saved));
  emojiLists["BTTV"].emojis = emojiLists["BTTV"].emojis.filter(e=>e.src!==url);
  renderEmojiPanel();
};

// æ·»åŠ éŸ³è¨Š
function addAudio() {
  const name = document.getElementById('audioName').value.trim();
  const url = document.getElementById('audioUrl').value.trim();
  
  if (!name || !url) {
    alert('è«‹å¡«å¯«éŸ³è¨Šåç¨±å’Œç¶²å€');
    return;
  }
  
  function isValidUrl(url) {
    try {
      const urlObj = new URL(url);
      return urlObj.protocol === 'http:' || urlObj.protocol === 'https:';
    } catch {
      return false;
    }
  }
  
  if (!isValidUrl(url)) {
    alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„éŸ³è¨Šç¶²å€');
    return;
  }
  
  const savedAudios = JSON.parse(localStorage.getItem('myAudios') || '[]');
  
  const exists = savedAudios.some(audio => 
    audio.name === name || audio.url === url
  );
  
  if (exists) {
    alert('å·²å­˜åœ¨ç›¸åŒåç¨±æˆ–ç¶²å€çš„éŸ³è¨Š');
    return;
  }
  
  savedAudios.push({ name, url });
  localStorage.setItem('myAudios', JSON.stringify(savedAudios));
  
  audioLists["éŸ³è¨Š"].audios = savedAudios;
  
  document.getElementById('audioName').value = '';
  document.getElementById('audioUrl').value = '';
  
  renderTabContent('éŸ³è¨Š');
}

// åˆ‡æ›éŸ³è¨Šåˆªé™¤æ¨¡å¼
function toggleAudioDeleteMode() {
  isAudioDeleteMode = !isAudioDeleteMode;
  renderTabContent('éŸ³è¨Š');
}

// åˆªé™¤éŸ³è¨Š
function deleteAudio(index) {
  const savedAudios = JSON.parse(localStorage.getItem('myAudios') || '[]');
  
  if (index >= 0 && index < savedAudios.length) {
    savedAudios.splice(index, 1);
    localStorage.setItem('myAudios', JSON.stringify(savedAudios));
    
    audioLists["éŸ³è¨Š"].audios = savedAudios;
    
    renderTabContent('éŸ³è¨Š');
  }
}

// è¡¨æƒ…é¢æ¿æ‹–æ›³
let dragging = false, offsetX, offsetY;
document.querySelector('.emoji-header')?.addEventListener('mousedown', e=>{
  if (e.target === document.getElementById('emojiCloseBtn')) return;
  
  dragging = true;
  const p = document.getElementById('emojiPanel');
  offsetX = e.clientX - p.offsetLeft;
  offsetY = e.clientY - p.offsetTop;
});
document.addEventListener('mousemove', e=>{
  if(dragging){
    const p = document.getElementById('emojiPanel');
    p.style.left = (e.clientX - offsetX) + 'px';
    p.style.top = (e.clientY - offsetY) + 'px';
  }
});
document.addEventListener('mouseup', ()=>{dragging=false;});

// è¡¨æƒ…é¢æ¿é–‹é—œåŠŸèƒ½
document.getElementById('emojiBtn').onclick = () => {
  const p = document.getElementById('emojiPanel');
  p.style.display = p.style.display==='flex' ? 'none' : 'flex';
  if (p.style.display==='flex') {
    p.style.left = '50%'; p.style.top = '50%';
    p.style.transform = 'translate(-50%,-50%)';
    renderEmojiPanel();
  }
};

document.getElementById('emojiCloseBtn').onclick = () => {
  document.getElementById('emojiPanel').style.display = 'none';
};

// ===================== tmi.js é€£ç·š =====================
function connectChat() {
  if (isConnected) return;
  
  client = new tmi.client({
    connection: { secure: true, reconnect: true },
    identity: oauthToken ? { username, password: oauthToken } : undefined,
    channels: [channel]
  });

  client.on('connected', () => {
    isConnected = true;
    status.textContent = `å·²é€£ç·š${channel} ${oauthToken?'ï¼ˆå·²ç™»å…¥ï¼‰':''}`;
    loadEmojiSets();
  });

  client.on('message', async (ch, tags, message, self) => {
    try {
      addRecentUser(
        tags.username, 
        tags['display-name'], 
        tags['user-avatar'] || 'https://static-cdn.jtvnw.net/user-default-pictures-uv/294c98b5-e34d-42cd-a8f0-140b72fba9b0-profile_image-70x70.png'
      );

      const isMentioned = checkMention(message, tags);
      
      // ç‚ºæ¯æ¢è¨Šæ¯ç”Ÿæˆä¸€å€‹ timestamp
      const messageTimestamp = tags['tmi-sent-ts'] || Date.now();
      
      // è¨˜éŒ„ timestamp æ˜ å°„ï¼ŒåŒ…å«å®Œæ•´çš„åŸå§‹è¨Šæ¯
      if (messageTimestamp) {
        messageIdMap.set(messageTimestamp.toString(), {
          username: tags['display-name'] || tags.username,
          timestamp: messageTimestamp,
          elementId: `timestamp-${messageTimestamp}`,
          message: message, // å„²å­˜å®Œæ•´çš„åŸå§‹è¨Šæ¯
          processedMessage: await processMessage(message) // å„²å­˜è™•ç†å¾Œçš„è¨Šæ¯ï¼ˆå¯é¸ï¼‰
        });
      }

      // æª¢æŸ¥æ˜¯å¦åŒ…å« [r] æ¨™ç±¤
      const hasRtag = message.includes('[r]') && message.includes('[m]');
      
      let div;
      if (hasRtag) {
        // å¦‚æœæ˜¯åŒ…å« [r] æ¨™ç±¤çš„è¨Šæ¯ï¼Œå‰µå»ºå¸¶æœ‰å›è¦†æ¨£å¼çš„å®¹å™¨
        div = document.createElement('div');
        div.className = `msg-with-reply ${isMentioned ? 'mentioned-message' : ''}`;
        div.id = `timestamp-${messageTimestamp}`;
        div.setAttribute('data-timestamp', messageTimestamp);
        div.setAttribute('data-message-id', tags.id || '');
      } else {
        // æ™®é€šè¨Šæ¯
        div = document.createElement('div');
        div.className = `msg ${isMentioned ? 'mentioned-message' : ''}`;
        div.id = `timestamp-${messageTimestamp}`;
        div.setAttribute('data-timestamp', messageTimestamp);
        div.setAttribute('data-message-id', tags.id || '');
      }

      const msgContent = document.createElement('div');
      msgContent.className = 'msg-content';
      
      const nameContainer = document.createElement('div');
      nameContainer.className = 'name-container';
      
      const nameSpan = document.createElement('span');
      nameSpan.className = 'name';
      nameSpan.style.color = tags.color || '#9147ff';
      
      const badges = parseBadges(tags.badges);
      const badgesHtml = renderBadges(badges);
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = badgesHtml + escapeHtml(tags['display-name'] || tags.username) + ': ';
      while (tempDiv.firstChild) {
        nameSpan.appendChild(tempDiv.firstChild);
      }
      
      nameContainer.appendChild(nameSpan);
      msgContent.appendChild(nameContainer);
      
      const textContainer = document.createElement('div');
      textContainer.className = 'text-container';
      
      // è™•ç†å®Œæ•´è¨Šæ¯
      const msg = document.createElement('span');
      msg.className = 'message-text';
      msg.innerHTML = await processMessage(message);
      textContainer.appendChild(msg);
      
      msgContent.appendChild(textContainer);
      
      if (oauthToken && !self) {
        const buttonContainer = document.createElement('div');
        buttonContainer.className = 'button-container';
        
        const replyBtn = document.createElement('button');
        replyBtn.className = 'reply-btn';
        replyBtn.innerHTML = 'â†©ï¸';
        replyBtn.title = 'å›è¦†æ­¤è¨Šæ¯';
        replyBtn.onclick = () => {
          setupReply(tags.id || messageTimestamp.toString(), tags['display-name'] || tags.username, message, messageTimestamp.toString());
        };
        buttonContainer.appendChild(replyBtn);
        
        msgContent.appendChild(buttonContainer);
      }
      
      div.appendChild(msgContent);
      chat.appendChild(div);
      
      limitMessages();
      
      if (autoScroll) {
        forceScrollToBottom();
      }
    } catch (error) {
      console.error('è™•ç†è¨Šæ¯æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
      
      const fallbackDiv = document.createElement('div');
      fallbackDiv.className = 'msg';
      fallbackDiv.innerHTML = `
        <div class="msg-content">
          <div class="name-container">
            <span class="name" style="color: ${tags.color || '#9147ff'}">
              ${escapeHtml(tags['display-name'] || tags.username)}: 
            </span>
          </div>
          <div class="text-container">
            <span class="message-text">${escapeHtml(message)}</span>
          </div>
        </div>
      `;
      chat.appendChild(fallbackDiv);
      
      limitMessages();
      
      if (autoScroll) {
        forceScrollToBottom();
      }
    }
  });

  client.connect().catch(console.error);
}

function reconnectChat() {
  if (client) {
    client.disconnect();
    isConnected = false;
  }
  
  connectChat();
}

// ===================== å­—æ•¸é™åˆ¶åŠŸèƒ½ =====================
const charCounter = document.getElementById('charCounter');

function updateCharCounter() {
  const text = input.value;
  const count = text.length;
  
  charCounter.textContent = `${count}/500`;
  
  if (count > 500) {
    charCounter.classList.add('over-limit');
    charCounter.classList.remove('near-limit');
    document.getElementById('sendBtn').disabled = true;
    document.getElementById('sendBtn').title = 'è¨Šæ¯é•·åº¦è¶…é500å­—é™åˆ¶';
  } else if (count > 450) {
    charCounter.classList.add('near-limit');
    charCounter.classList.remove('over-limit');
    document.getElementById('sendBtn').disabled = false;
    document.getElementById('sendBtn').title = 'é€å‡ºè¨Šæ¯';
  } else {
    charCounter.classList.remove('over-limit', 'near-limit');
    if (input.disabled) {
      document.getElementById('sendBtn').disabled = true;
      document.getElementById('sendBtn').title = 'è«‹å…ˆç™»å…¥';
    } else {
      document.getElementById('sendBtn').disabled = false;
      document.getElementById('sendBtn').title = 'é€å‡ºè¨Šæ¯';
    }
  }
}

function limitInputLength(e) {
  const text = input.value;
  
  if (text.length >= 500) {
    if (e.key.length === 1 && !e.ctrlKey && !e.metaKey) {
      e.preventDefault();
      return;
    }
  }
}

// ===================== ç™¼é€è¨Šæ¯åŠŸèƒ½ =====================
function send() {
  let msg = input.value.trim();
  
  if (msg.length > 500) {
    alert('è¨Šæ¯é•·åº¦ä¸èƒ½è¶…é500å­—ï¼ç›®å‰å­—æ•¸ï¼š' + msg.length);
    msg = msg.substring(0, 500);
    input.value = msg;
    updateCharCounter();
    return;
  }
  
  if (msg && oauthToken && client?.readyState() === 'OPEN') {
    // å¦‚æœæ­£åœ¨å›è¦†æŸæ¢è¨Šæ¯
    if (replyingTo) {
      // æª¢æŸ¥æ˜¯å¦å·²ç¶“åŒ…å« [r] æ¨™ç±¤
      const hasRtag = msg.includes('[r]') && msg.includes('[m]');
      
      if (!hasRtag) {
        // å¯ä»¥é¸æ“‡è‡ªå‹•æ·»åŠ  [r] æ¨™ç±¤
        // é€™è£¡æˆ‘å€‘ä¸è‡ªå‹•æ·»åŠ ï¼Œè®“ç”¨æˆ¶é¸æ“‡æ˜¯å¦è¦æ’å…¥
      }
      
      const currentReplyTarget = {...replyingTo};
      
      // ç™¼é€è¨Šæ¯
      client.say(channel, msg).then(() => {
        input.value = '';
        adjustTextareaHeight();
        updateCharCounter();
        
        setTimeout(() => {
          if (replyingTo && replyingTo.id === currentReplyTarget.id) {
            console.log('å®‰å…¨æ©Ÿåˆ¶ï¼šå¼·åˆ¶æ¸…é™¤å›è¦†ç‹€æ…‹');
            cancelReply();
          }
        }, 3000);
        
      }).catch(err => {
        console.error('ç™¼é€è¨Šæ¯å¤±æ•—:', err);
        input.value = '';
        adjustTextareaHeight();
        updateCharCounter();
        cancelReply();
      });
    } else {
      client.say(channel, msg).then(() => {
        input.value = '';
        adjustTextareaHeight();
        updateCharCounter();
      });
    }
  }
}

document.getElementById('sendBtn').onclick = send;

// Enter éµè¡Œç‚º
input.addEventListener('keydown', e => {
  if (e.key === 'Enter') {
    if (e.ctrlKey) {
      const cursorPos = input.selectionStart;
      const textBefore = input.value.substring(0, cursorPos);
      const textAfter = input.value.substring(cursorPos);
      
      input.value = textBefore + '\n' + textAfter;
      input.selectionStart = input.selectionEnd = cursorPos + 1;
      
      adjustTextareaHeight();
      
      e.preventDefault();
    } else {
      e.preventDefault();
      send();
    }
  }
});

// æ·»åŠ @åŠŸèƒ½çš„äº‹ä»¶ç›£è½
input.addEventListener('input', handleInputChange);
input.addEventListener('keydown', limitInputLength);
input.addEventListener('keydown', handleMentionKeydown);

// é»æ“Šå…¶ä»–åœ°æ–¹æ™‚éš±è—@åˆ—è¡¨
document.addEventListener('click', (e) => {
  if (!mentionAutocomplete.contains(e.target) && e.target !== input) {
    hideMentionAutocomplete();
  }
});

cancelReplyBtn.onclick = cancelReply;

// ===================== æ–°å¢ [r] æ¨™ç±¤æŒ‰éˆ• =====================
// åœ¨è²¼ä¸ŠæŒ‰éˆ•å€åŸŸæ·»åŠ  [r] æ¨™ç±¤æŒ‰éˆ•
const pasteBtn = document.getElementById('pastebtn');
if (pasteBtn) {
  const rTagButton = document.createElement('button');
  rTagButton.id = 'pasteRtag';
  rTagButton.type = 'button';
  rTagButton.className = 'sk_botton';
  rTagButton.textContent = 'å›è¦† [r]';
  rTagButton.title = 'æ’å…¥å›è¦†æ¨™ç±¤';
  pasteBtn.appendChild(rTagButton);

  rTagButton.addEventListener('click', function() {
    if (input.disabled) {
      alert('è«‹å…ˆç™»å…¥å¾Œå†ä½¿ç”¨æ­¤åŠŸèƒ½');
      return;
    }
    
    if (replyingTo) {
      insertRtag();
    } else {
      // æ’å…¥ç©ºçš„ [r] æ¨™ç±¤æ¨¡æ¿
      const currentValue = input.value;
      const cursorPos = input.selectionStart;
      
      const newValue = currentValue.substring(0, cursorPos) + '[r]ä½¿ç”¨è€…åç¨±,timestamp[m] ' + currentValue.substring(cursorPos);
      input.value = newValue;
      
      adjustTextareaHeight();
      const newCursorPos = cursorPos + 4;
      setTimeout(() => {
        input.focus();
        input.setSelectionRange(newCursorPos, newCursorPos + 4);
      }, 10);
    }
    
    updateCharCounter();
  });
}

// ===================== åˆå§‹åŒ– =====================
// åœ¨æ–‡æª”è¼‰å…¥å®Œæˆå¾Œåˆå§‹åŒ–é»æ“Šäº‹ä»¶ç›£è½
document.addEventListener('DOMContentLoaded', function() {
  // ç›£è½å›è¦†è¨Šæ¯çš„é»æ“Š
  document.addEventListener('click', function(e) {
    // è™•ç†å›è¦†ä¸Šä¸‹æ–‡çš„é»æ“Š
    if (e.target.closest('.reply-context') || e.target.closest('.reply-message')) {
      const replyContext = e.target.closest('.reply-context') || e.target.closest('.reply-message').previousElementSibling;
      if (replyContext) {
        const replyingToSpan = replyContext.querySelector('.replying-to');
        if (replyingToSpan) {
          const username = replyingToSpan.textContent;
          // å¯ä»¥æ·»åŠ æœå°‹è©²ä½¿ç”¨è€…è¨Šæ¯çš„åŠŸèƒ½
          console.log('é»æ“Šäº†å›è¦†çµ¦:', username);
        }
      }
    }
    
    // è™•ç†å›è¦†è¨Šæ¯é è¦½çš„é»æ“Š
    if (e.target.closest('.reply-message')) {
      const replyMessage = e.target.closest('.reply-message');
      const usernameElement = replyMessage.querySelector('.reply-username');
      if (usernameElement) {
        const username = usernameElement.textContent.replace(':', '');
        // å˜—è©¦æœå°‹è©²ä½¿ç”¨è€…çš„æœ€æ–°è¨Šæ¯
        const userMessages = document.querySelectorAll(`.name[style*="${username}"], .name[data-username="${username}"]`);
        if (userMessages.length > 0) {
          const latestMessage = userMessages[userMessages.length - 1];
          latestMessage.closest('.msg, .msg-with-reply').scrollIntoView({
            behavior: 'smooth',
            block: 'center'
          });
        }
      }
    }
  });
  
  // åˆå§‹åŒ–è²¼ä¸Šè™•ç†å™¨
  initPasteHandler();
});

// æ–°å¢ [r] æ¨™ç±¤æ’å…¥æŒ‰éˆ•åˆ°å›è¦†æŒ‡ç¤ºå™¨
const insertRtagBtn = document.createElement('button');
insertRtagBtn.className = 'insert-r-tag';
insertRtagBtn.id = 'insertRtagBtn';
insertRtagBtn.style.cssText = 'margin-left: 10px; background: #e6d670; color: #000; border: none; border-radius: 3px; padding: 4px 8px; font-size: 12px; cursor: pointer;';
insertRtagBtn.textContent = 'æ’å…¥ [r] æ¨™ç±¤';
replyIndicator.appendChild(insertRtagBtn);

insertRtagBtn.addEventListener('click', function() {
  if (replyingTo) {
    insertRtag();
  }
});
</script>
</body>

</html>





