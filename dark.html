<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ChickChat - Twitch风格聊天室</title>
<style>
/* ========== Twitch Dark Theme ========== */
:root {
    --twitch-bg-primary: #0e0e10;
    --twitch-bg-secondary: #1f1f23;
    --twitch-bg-tertiary: #18181b;
    --twitch-text-primary: #efeff1;
    --twitch-text-secondary: #adadb8;
    --twitch-accent: #9147ff;
    --twitch-accent-hover: #772ce8;
    --twitch-border: #26262c;
    --twitch-scrollbar: #3a3a3d;
    --twitch-scrollbar-hover: #53535f;
    --twitch-mention: #9147ff;
    --twitch-reply: #00c7ac;
    --twitch-broadcaster: #e91916;
    --twitch-moderator: #00c7ac;
    --twitch-vip: #bf94ff;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
    background: var(--twitch-bg-primary);
    color: var(--twitch-text-primary);
    line-height: 1.4;
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

/* ========== 顶部状态栏 ========== */
#status-bar {
    display: flex;
    align-items: center;
    padding: 8px 12px;
    background: var(--twitch-bg-secondary);
    border-bottom: 1px solid var(--twitch-border);
    font-size: 12px;
    min-height: 40px;
}

#status {
    color: var(--twitch-accent);
    font-weight: 500;
}

#user-info {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-left: auto;
    font-size: 13px;
}

#user-info img {
    width: 24px;
    height: 24px;
    border-radius: 50%;
}

#logout-btn {
    background: var(--twitch-broadcaster);
    color: white;
    border: none;
    border-radius: 4px;
    padding: 4px 8px;
    cursor: pointer;
    font-size: 11px;
    font-weight: 600;
    transition: background-color 0.2s;
}

#logout-btn:hover {
    background: #c51614;
}

/* ========== 聊天容器 ========== */
#chat-container {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

/* ========== 聊天区域 ========== */
#chat {
    flex: 1;
    overflow-y: auto;
    padding: 12px;
    scroll-behavior: smooth;
    display: flex;
    flex-direction: column;
}

/* Twitch风格的滚动条 */
#chat::-webkit-scrollbar {
    width: 8px;
}

#chat::-webkit-scrollbar-track {
    background: var(--twitch-bg-secondary);
}

#chat::-webkit-scrollbar-thumb {
    background: var(--twitch-scrollbar);
    border-radius: 4px;
}

#chat::-webkit-scrollbar-thumb:hover {
    background: var(--twitch-scrollbar-hover);
}

/* ========== 消息样式 ========== */
.message {
    margin-bottom: 8px;
    padding: 4px 0;
    display: flex;
    align-items: flex-start;
    position: relative;
}

.message:hover {
    background: rgba(255, 255, 255, 0.03);
    border-radius: 4px;
}

.message:hover .message-actions {
    opacity: 1;
}

.message-content {
    display: flex;
    align-items: flex-start;
    flex-wrap: wrap;
    width: 100%;
    line-height: 1.4;
}

/* 徽章样式 */
.badges {
    display: flex;
    align-items: center;
    margin-right: 4px;
    flex-shrink: 0;
}

.badge {
    width: 18px;
    height: 18px;
    margin-right: 2px;
    vertical-align: middle;
}

/* 用户名样式 */
.username {
    font-weight: bold;
    margin-right: 6px;
    color: inherit;
    flex-shrink: 0;
    white-space: nowrap;
}

/* 消息文本样式 */
.message-text {
    word-break: break-word;
    overflow-wrap: break-word;
    white-space: normal;
    display: inline;
    flex: 1;
    min-width: 0;
}

/* 消息操作按钮 */
.message-actions {
    position: absolute;
    right: 0;
    top: 0;
    display: flex;
    gap: 4px;
    opacity: 0;
    transition: opacity 0.2s;
    background: var(--twitch-bg-secondary);
    border-radius: 4px;
    padding: 2px;
}

.reply-btn {
    background: none;
    border: none;
    color: var(--twitch-text-secondary);
    font-size: 12px;
    cursor: pointer;
    padding: 4px 6px;
    border-radius: 3px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.reply-btn:hover {
    background: var(--twitch-scrollbar);
    color: var(--twitch-text-primary);
}

/* ========== 提及消息样式 ========== */
.mentioned-message {
    background: rgba(145, 71, 255, 0.1);
    border-left: 3px solid var(--twitch-mention);
    padding-left: 8px;
    margin: 6px 0;
    border-radius: 0 4px 4px 0;
}

.mentioned-message:hover {
    background: rgba(145, 71, 255, 0.15);
}

/* ========== 回覆消息样式 ========== */
.reply-message {
    background: rgba(0, 199, 172, 0.1);
    border-left: 3px solid var(--twitch-reply);
    padding-left: 8px;
    margin: 6px 0;
    border-radius: 0 4px 4px 0;
}

.reply-message:hover {
    background: rgba(0, 199, 172, 0.15);
}

.reply-context {
    font-size: 11px;
    color: var(--twitch-text-secondary);
    margin-bottom: 4px;
    display: flex;
    align-items: center;
    width: 100%;
}

.reply-icon {
    margin-right: 4px;
    color: var(--twitch-reply);
    font-size: 10px;
}

.reply-username {
    font-weight: bold;
    color: var(--twitch-reply);
    margin-right: 6px;
}

.reply-preview {
    color: var(--twitch-text-secondary);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    flex: 1;
}

/* 回覆指示器样式 */
#reply-indicator {
    display: flex;
    align-items: center;
    background: var(--twitch-bg-secondary);
    padding: 6px 10px;
    border-radius: 4px;
    margin-bottom: 8px;
    font-size: 12px;
    color: var(--twitch-text-secondary);
    border-left: 3px solid var(--twitch-reply);
}

#cancel-reply-btn {
    margin-left: auto;
    background: none;
    border: none;
    color: var(--twitch-text-secondary);
    cursor: pointer;
    font-size: 12px;
    padding: 2px 6px;
    border-radius: 3px;
}

#cancel-reply-btn:hover {
    background: var(--twitch-scrollbar);
    color: var(--twitch-text-primary);
}

/* ========== 输入区域 ========== */
#input-container {
    background: var(--twitch-bg-secondary);
    padding: 12px 16px;
    border-top: 1px solid var(--twitch-border);
}

.chat-input-wrapper {
    display: flex;
    align-items: center;
    background: var(--twitch-bg-primary);
    border-radius: 4px;
    padding: 8px 12px;
    position: relative;
    border: 1px solid var(--twitch-border);
}

.chat-input-wrapper:focus-within {
    border-color: var(--twitch-accent);
}

.chat-input {
    flex: 1;
    background: transparent;
    border: none;
    color: var(--twitch-text-primary);
    font-size: 14px;
    outline: none;
}

.chat-input::placeholder {
    color: var(--twitch-text-secondary);
}

.chat-buttons {
    display: flex;
    gap: 8px;
}

.chat-button {
    background: transparent;
    border: none;
    color: var(--twitch-text-secondary);
    cursor: pointer;
    padding: 4px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
}

.chat-button:hover {
    background: var(--twitch-scrollbar);
    color: var(--twitch-text-primary);
}

.chat-button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.chat-button:disabled:hover {
    background: transparent;
    color: var(--twitch-text-secondary);
}

/* ========== 快速按钮区域 ========== */
#quick-buttons {
    display: flex;
    gap: 8px;
    margin-top: 8px;
}

.quick-button {
    padding: 4px 8px;
    background: var(--twitch-bg-tertiary);
    color: var(--twitch-text-primary);
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    transition: background-color 0.2s;
}

.quick-button:hover {
    background: var(--twitch-scrollbar);
}

/* ========== 登录按钮 ========== */
#login-btn {
    margin-top: 8px;
    padding: 8px 16px;
    background: var(--twitch-accent);
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 13px;
    font-weight: 600;
    transition: background-color 0.2s;
    width: 100%;
}

#login-btn:hover {
    background: var(--twitch-accent-hover);
}

/* ========== 提及自动完成 ========== */
.mention-autocomplete {
    position: absolute;
    bottom: 100%;
    left: 0;
    right: 0;
    background: var(--twitch-bg-tertiary);
    border: 1px solid var(--twitch-border);
    border-radius: 4px;
    max-height: 200px;
    overflow-y: auto;
    z-index: 1000;
    box-shadow: 0 4px 12px rgba(0,0,0,0.5);
    display: none;
}

.mention-item {
    padding: 8px 12px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    border-bottom: 1px solid var(--twitch-border);
}

.mention-item:last-child {
    border-bottom: none;
}

.mention-item:hover, .mention-item.active {
    background: var(--twitch-accent);
    color: white;
}

.mention-item img {
    width: 20px;
    height: 20px;
    border-radius: 50%;
}

.mention-item .username {
    font-weight: bold;
}

.mention-item .display-name {
    color: var(--twitch-text-secondary);
}

.mention-item:hover .display-name, .mention-item.active .display-name {
    color: white;
}

/* ========== 提及高亮 ========== */
.mention-highlight {
    background-color: var(--twitch-mention);
    color: #ffffff;
    padding: 2px 6px;
    border-radius: 4px;
    font-weight: bold;
}

/* ========== 媒体内容样式 ========== */
.media-content {
    margin-top: 4px;
    display: block;
    max-width: 250px;
    max-height: 200px;
    border-radius: 6px;
    overflow: hidden;
    background: #000;
}

.media-content img, 
.media-content video, 
.media-content iframe {
    width: 100%;
    height: auto;
    display: block;
    border-radius: 6px;
}

/* ========== 表情符号样式 ========== */
.emoji {
    max-width: 90px;
    max-height: 90px;
    vertical-align: middle;
    margin: 0 2px;
}

/* ========== 链接样式 ========== */
a {
    color: var(--twitch-accent);
    text-decoration: none;
}

a:hover {
    text-decoration: underline;
}

/* ========== 表情面板样式 ========== */
.emoji-panel {
    position: fixed;
    background: var(--twitch-bg-tertiary);
    border: 1px solid var(--twitch-border);
    border-radius: 4px;
    z-index: 9999;
    width: 380px;
    height: 460px;
    display: none;
    box-shadow: 0 0 30px rgba(0,0,0,0.9);
    color: white;
    flex-direction: column;
    font-size: 13px;
}

.emoji-header {
    background: var(--twitch-accent);
    padding: 12px;
    text-align: center;
    cursor: move;
    font-weight: 600;
    border-radius: 4px 4px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.emoji-close-btn {
    background: none;
    border: none;
    color: white;
    font-size: 18px;
    cursor: pointer;
    width: 24px;
    height: 24px;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.emoji-close-btn:hover {
    background: rgba(255, 255, 255, 0.2);
}

.emoji-tabs {
    display: flex;
    flex-wrap: wrap;
    background: var(--twitch-bg-secondary);
    padding: 8px;
    gap: 5px;
    overflow-x: auto;
    border-bottom: 1px solid var(--twitch-border);
}

.emoji-tab {
    width: 36px;
    height: 36px;
    background: var(--twitch-scrollbar);
    border-radius: 4px;
    cursor: pointer;
    background-size: cover;
    background-position: center;
    flex-shrink: 0;
}

.emoji-tab.active {
    outline: 2px solid var(--twitch-accent);
}

.emoji-content {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
    background: var(--twitch-bg-tertiary);
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.emoji-item {
    position: relative;
}

.emoji-item img {
    width: 40px;
    height: 40px;
    border-radius: 4px;
    cursor: pointer;
}

.delete-btn {
    position: absolute;
    top: -8px;
    right: -8px;
    background: var(--twitch-broadcaster);
    color: white;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    font-size: 12px;
    line-height: 20px;
    text-align: center;
    cursor: pointer;
    display: none;
}

.emoji-item:hover .delete-btn {
    display: block;
}

.bttv-input {
    width: 100%;
    display: flex;
    gap: 6px;
    margin-bottom: 10px;
}

.bttv-input input {
    flex: 1;
    padding: 8px;
    background: var(--twitch-bg-secondary);
    color: white;
    border: 1px solid var(--twitch-scrollbar);
    border-radius: 4px;
}

.bttv-input input:focus {
    outline: none;
    border-color: var(--twitch-accent);
}

/* ========== 用户角色颜色 ========== */
.broadcaster {
    color: var(--twitch-broadcaster);
}

.moderator {
    color: var(--twitch-moderator);
}

.vip {
    color: var(--twitch-vip);
}

.subscriber {
    color: var(--twitch-accent);
}
</style>
</head>
<body>
    <!-- 顶部状态栏 -->
    <div id="status-bar">
        <div id="status">載入中...</div>
        <div id="user-info" style="display:none;">
            <img id="user-avatar" src="" alt="頭像">
            <span id="user-name"></span>
            <button id="logout-btn">登出</button>
        </div>
    </div>

    <!-- 聊天容器 -->
    <div id="chat-container">
        <!-- 聊天区域 -->
        <div id="chat"></div>
        
        <!-- 回覆指示器 -->
        <div id="reply-indicator" style="display: none;">
            <span>回覆給 <span id="reply-target-name"></span></span>
            <button id="cancel-reply-btn">取消</button>
        </div>
    </div>

    <!-- 输入区域 -->
    <div id="input-container">
        <div class="chat-input-wrapper">
            <input type="text" id="chat-input" class="chat-input" placeholder="登入後即可發言..." autocomplete="off" disabled>
            <div class="mention-autocomplete" id="mention-autocomplete"></div>
            <div class="chat-buttons">
                <button class="chat-button" id="emoji-btn" title="表情">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M10 2C5.58 2 2 5.58 2 10s3.58 8 8 8 8-3.58 8-8-3.58-8-8-8zm0 14.5c-3.59 0-6.5-2.91-6.5-6.5S6.41 3.5 10 3.5s6.5 2.91 6.5 6.5-2.91 6.5-6.5 6.5zM6.5 9c.83 0 1.5-.67 1.5-1.5S7.33 6 6.5 6 5 6.67 5 7.5 5.67 9 6.5 9zm7 0c.83 0 1.5-.67 1.5-1.5S14.33 6 13.5 6 12 6.67 12 7.5s.67 1.5 1.5 1.5zM10 14c-1.66 0-3.14-.69-4.2-1.8l1.41-1.41C7.83 11.53 8.84 12 10 12s2.17-.47 2.79-1.21l1.41 1.41C13.14 13.31 11.66 14 10 14z"/>
                    </svg>
                </button>
                <button class="chat-button" id="send-btn" disabled title="送出訊息">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M2.93 4.26l14.76-2.66c.95-.17 1.73.61 1.56 1.56L15.74 17.1c-.2 1.09-1.57 1.41-2.23.49l-3.14-4.37-2.66 2.66c-.39.39-1.02.39-1.41 0-.39-.39-.39-1.02 0-1.41l2.66-2.66L1.44 6.49c-.92-.66-.6-2.03.49-2.23z"/>
                    </svg>
                </button>
            </div>
        </div>
        
        <!-- 快速按钮 -->
        <div id="quick-buttons">
            <button id="paste-photo" class="quick-button">圖片</button>
            <button id="paste-video" class="quick-button">影片</button>
        </div>
        
        <!-- 登录按钮 -->
        <button id="login-btn">Twitch 登入</button>
    </div>

    <!-- 表情面板 -->
    <div id="emoji-panel" class="emoji-panel">
        <div class="emoji-header">
            自訂表情面板（拖曳移動）
            <button class="emoji-close-btn" id="emoji-close-btn" title="關閉">×</button>
        </div>
        <div class="emoji-tabs" id="emoji-tabs"></div>
        <div class="emoji-content" id="emoji-content"></div>
    </div>

    <script src="https://chicktv.github.io/tv/tmi.min.js"></script>
    <script>
    // ===================== 重要設定 =====================
    const CLIENT_ID = '0uhjgjpko804ba35q1nj1h6x2eriq9';
    const channel = "whitewing940920";

    const REDIRECT_URI = encodeURIComponent(location.origin + location.pathname);
    const AUTH_URL = `https://id.twitch.tv/oauth2/authorize?client_id=${CLIENT_ID}&redirect_uri=${REDIRECT_URI}&response_type=token&scope=chat:read+chat:edit`;

    // ===================== 全域變數 =====================
    let oauthToken = '';
    let username = 'justinfan666';
    let userDisplayName = '';
    let userAvatar = '';
    let client = null;
    let isConnected = false;

    const status = document.getElementById('status');
    const chat = document.getElementById('chat');
    const chatInput = document.getElementById('chat-input');
    const loginBtn = document.getElementById('login-btn');
    const logoutBtn = document.getElementById('logout-btn');
    const userInfo = document.getElementById('user-info');
    const userAvatarEl = document.getElementById('user-avatar');
    const userNameEl = document.getElementById('user-name');
    const sendBtn = document.getElementById('send-btn');
    const emojiBtn = document.getElementById('emoji-btn');
    const emojiPanel = document.getElementById('emoji-panel');
    const emojiCloseBtn = document.getElementById('emoji-close-btn');
    const pastePhotoBtn = document.getElementById('paste-photo');
    const pasteVideoBtn = document.getElementById('paste-video');

    // 回覆功能變數
    let replyingTo = null;
    const replyIndicator = document.getElementById('reply-indicator');
    const replyTargetName = document.getElementById('reply-target-name');
    const cancelReplyBtn = document.getElementById('cancel-reply-btn');

    // 表情系統
    let emojiLists = {};
    let altToEmojiMap = {};
    let isDeleteMode = false;

    // 徽章映射
    let badgeMap = {};

    // @功能變數
    let recentUsers = [];
    let mentionAutocomplete = document.getElementById('mention-autocomplete');
    let mentionActive = false;
    let mentionIndex = -1;
    let mentionQuery = '';

    // 訊息計數器
    let messageCount = 0;
    const MAX_MESSAGES = 100;

    // 表情面板拖拽状态
    let isDragging = false;
    let dragOffsetX = 0;
    let dragOffsetY = 0;

    // 初始化
    document.addEventListener('DOMContentLoaded', function() {
        setupEventListeners();
        checkLogin();
        loadBadgeMap();
    });

    // 設置事件監聽器
    function setupEventListeners() {
        // 輸入相關
        chatInput.addEventListener('keypress', e => { 
            if(e.key === 'Enter') sendMessage(); 
        });
        chatInput.addEventListener('input', handleInputChange);
        chatInput.addEventListener('keydown', handleMentionKeydown);
        
        // 按鈕事件
        sendBtn.addEventListener('click', sendMessage);
        loginBtn.addEventListener('click', loginWithPopup);
        logoutBtn.addEventListener('click', logout);
        
        // 表情按钮事件
        emojiBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            toggleEmojiPanel();
        });
        
        emojiCloseBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            emojiPanel.style.display = 'none';
        });
        
        pastePhotoBtn.addEventListener('click', function() {
            pasteTemplate('[s] 網址 [e]');
        });
        
        pasteVideoBtn.addEventListener('click', function() {
            pasteTemplate('[y] 網址 [t]');
        });
        
        cancelReplyBtn.addEventListener('click', cancelReply);
        
        // 點擊外部關閉表情面板和提及列表
        document.addEventListener('click', function(e) {
            if (!emojiPanel.contains(e.target) && e.target !== emojiBtn) {
                emojiPanel.style.display = 'none';
            }
            if (!mentionAutocomplete.contains(e.target) && e.target !== chatInput) {
                hideMentionAutocomplete();
            }
        });
        
        // 表情面板拖曳
        setupEmojiPanelDrag();
    }

    // ===================== 登入系統 =====================
    function checkLogin() {
        const saved = localStorage.getItem('twitch_token');
        if (saved) {
            oauthToken = saved;
            fetchUserInfo(saved.replace('oauth:', ''));
        } else {
            connectChat();
        }
    }

    function loginWithPopup() {
        if (CLIENT_ID.includes('請填入')) {
            alert('請先填入 CLIENT_ID！\n前往 https://twitchapps.com/tmi/ 點「Connect with Twitch」取得');
            return;
        }
        
        const width = 600;
        const height = 700;
        const left = (screen.width - width) / 2;
        const top = (screen.height - height) / 2;
        
        const popup = window.open(
            AUTH_URL,
            'Twitch Login',
            `width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=yes,status=yes`
        );
        
        if (!popup || popup.closed || typeof popup.closed === 'undefined') {
            alert('彈出視窗被阻擋了！請允許彈出視窗，或使用其他瀏覽器。');
            return;
        }
        
        const checkPopup = setInterval(() => {
            if (popup.closed) {
                clearInterval(checkPopup);
                const token = localStorage.getItem('twitch_token');
                if (token) {
                    oauthToken = token;
                    fetchUserInfo(token.replace('oauth:', ''));
                }
            }
        }, 500);
    }

    async function fetchUserInfo(token) {
        try {
            const res = await fetch('https://api.twitch.tv/helix/users', {
                headers: { 'Client-ID': CLIENT_ID, 'Authorization': 'Bearer ' + token }
            });
            const data = await res.json();
            if (data.data?.[0]) {
                username = data.data[0].login;
                userDisplayName = data.data[0].display_name;
                userAvatar = data.data[0].profile_image_url;
                loginSuccess();
            }
        } catch (e) {
            console.error('取得用戶資訊失敗:', e);
            alert('登入失敗，請重新登入');
            logout();
        }
    }

    function loginSuccess() {
        status.textContent = `已連線至 ${channel}（已登入）`;
        chatInput.disabled = false;
        chatInput.placeholder = "傳送訊息";
        sendBtn.disabled = false;
        loginBtn.style.display = 'none';
        userInfo.style.display = 'flex';
        userAvatarEl.src = userAvatar;
        userNameEl.textContent = userDisplayName;
        
        reconnectChat();
    }

    function logout() {
        localStorage.removeItem('twitch_token');
        location.reload();
    }

    // 檢查URL中的token
    window.addEventListener('load', async function() {
        if (location.hash.includes('access_token=')) {
            const token = new URLSearchParams(location.hash.slice(1)).get('access_token');
            if (token) {
                oauthToken = 'oauth:' + token;
                localStorage.setItem('twitch_token', oauthToken);
                
                if (window.opener) {
                    window.close();
                } else {
                    history.replaceState(null, null, location.pathname);
                    fetchUserInfo(token);
                }
            }
        }
    });

    // ===================== 聊天功能 =====================
    function connectChat() {
        if (isConnected) return;
        
        client = new tmi.client({
            connection: { secure: true, reconnect: true },
            identity: oauthToken ? { username, password: oauthToken } : undefined,
            channels: [channel]
        });

        client.on('connected', () => {
            isConnected = true;
            status.textContent = `已連線至 ${channel}${oauthToken?'（已登入）':''}`;
            loadEmojiSets();
        });

        client.on('message', async (ch, tags, message, self) => {
            try {
                // 添加用戶到最近用戶列表
                addRecentUser(
                    tags.username, 
                    tags['display-name'], 
                    tags['user-avatar'] || 'https://static-cdn.jtvnw.net/user-default-pictures-uv/294c98b5-e34d-42cd-a8f0-140b72fba9b0-profile_image-70x70.png'
                );

                // 檢查是否提及當前用戶
                const isMentioned = checkMention(message, tags);
                
                // 檢查是否為回覆訊息
                const isReply = tags['reply-parent-msg-id'];
                
                // 創建消息元素
                const messageEl = document.createElement('div');
                
                // 根據消息類型設置不同的樣式
                if (isReply) {
                    messageEl.className = 'message reply-message';
                } else if (isMentioned) {
                    messageEl.className = 'message mentioned-message';
                } else {
                    messageEl.className = 'message';
                }
                
                messageEl.id = `msg-${tags.id}`;
                
                // 解析徽章
                const badges = parseBadges(tags.badges);
                const badgesHtml = renderBadges(badges);
                
                // 設置用戶名顏色和類別
                let usernameClass = '';
                if (badges.some(b => b.name === 'broadcaster')) {
                    usernameClass = 'broadcaster';
                } else if (badges.some(b => b.name === 'moderator')) {
                    usernameClass = 'moderator';
                } else if (badges.some(b => b.name === 'vip')) {
                    usernameClass = 'vip';
                } else if (badges.some(b => b.name === 'subscriber')) {
                    usernameClass = 'subscriber';
                }
                
                // 處理消息內容
                const messageHtml = await processMessage(message);
                
                // 如果是回覆消息，添加回覆上下文
                let replyContextHtml = '';
                if (isReply && tags['reply-parent-display-name'] && tags['reply-parent-msg-body']) {
                    replyContextHtml = `
                        <div class="reply-context">
                            <span class="reply-icon">↩</span>
                            <span class="reply-username">${escapeHtml(tags['reply-parent-display-name'])}</span>
                            <span class="reply-preview">${truncateMessage(tags['reply-parent-msg-body'], 50)}</span>
                        </div>
                    `;
                }
                
                // 創建消息HTML
                messageEl.innerHTML = `
                    ${replyContextHtml}
                    <div class="message-content">
                        <div class="badges">${badgesHtml}</div>
                        <span class="username ${usernameClass}" style="color: ${tags.color || '#9147ff'}">${escapeHtml(tags['display-name'] || tags.username)}:</span>
                        <span class="message-text">${messageHtml}</span>
                        <div class="message-actions">
                            <button class="reply-btn" title="回覆此訊息">↩️</button>
                        </div>
                    </div>
                `;
                
                // 添加回覆按鈕事件
                const replyBtn = messageEl.querySelector('.reply-btn');
                if (replyBtn && oauthToken && !self) {
                    replyBtn.addEventListener('click', () => {
                        setupReply(tags.id, tags['display-name'] || tags.username, message);
                    });
                }
                
                // 添加到聊天區域
                chat.appendChild(messageEl);
                
                // 限制消息數量
                limitMessages();
                
                // 滾動到底部
                scrollToBottom();
            } catch (error) {
                console.error('處理訊息時發生錯誤:', error);
            }
        });

        client.connect().catch(console.error);
    }

    function reconnectChat() {
        if (client) {
            client.disconnect();
            isConnected = false;
        }
        
        connectChat();
    }

    function sendMessage() {
        const msg = chatInput.value.trim();
        if (msg && oauthToken && client?.readyState() === 'OPEN') {
            if (replyingTo) {
                client.reply(channel, msg, replyingTo.id).then(() => {
                    chatInput.value = '';
                    cancelReply();
                }).catch(err => {
                    console.error('回覆發送失敗:', err);
                    // 回覆失敗時改為發送普通訊息
                    client.say(channel, msg).then(() => {
                        chatInput.value = '';
                        cancelReply();
                    });
                });
            } else {
                client.say(channel, msg).then(() => {
                    chatInput.value = '';
                });
            }
        }
    }

    // ===================== 消息處理 =====================
    async function processMessage(text) {
        // 解碼 HTML 實體
        function decodeHtmlEntities(text) {
            const textarea = document.createElement('textarea');
            textarea.innerHTML = text;
            return textarea.value;
        }
        
        let decodedText = decodeHtmlEntities(text);
        let html = decodedText;

        // 驗證 URL 是否安全的函數
        function isValidUrl(url) {
            try {
                const urlObj = new URL(url);
                return urlObj.protocol === 'http:' || urlObj.protocol === 'https:';
            } catch {
                return false;
            }
        }

        // 處理@提及高亮
        if (username && username !== 'justinfan666') {
            const mentionRegex = new RegExp(`@${username}\\b`, 'gi');
            html = html.replace(mentionRegex, `<span class="mention-highlight">@${username}</span>`);
        }

        // 處理表情符號
        for (const [alt, data] of Object.entries(altToEmojiMap)) {
            try {
                const escapedAlt = escapeRegExp(alt);
                const regex = new RegExp(`(^|\\s)(${escapedAlt})(?=$|\\s|[\\.,!\\?\\)\\(])`, 'g');
                html = html.replace(regex, `$1<img src="${escapeHtml(data.src)}" class="emoji">`);
            } catch (error) {
                console.warn('表情符號處理錯誤:', alt, error);
            }
        }

        // 處理圖片和影片格式 [s]網址[e]
        const sTagRegex = /\[s\](.*?)(?:\[e\]|$)/gi;
        let sTagMatch;
        
        while ((sTagMatch = sTagRegex.exec(html)) !== null) {
            const fullMatch = sTagMatch[0];
            let urlContent = sTagMatch[1].trim();
            
            if (urlContent.includes(' ')) {
                urlContent = urlContent.split(' ')[0];
            }
            
            urlContent = urlContent.replace(/^\s+|\s+$/g, '');
            
            if (!isValidUrl(urlContent)) {
                console.log('無效的 URL:', urlContent);
                continue;
            }
            
            let replacement;
            
            if (urlContent.toLowerCase().includes('.mp4')) {
                replacement = `<div class="media-content"><video src="${escapeHtml(urlContent)}" controls autoplay muted loop></video></div>`;
            } else {
                replacement = `<div class="media-content"><img src="${escapeHtml(urlContent)}" loading="lazy" onerror="this.parentElement.style.display='none'"></div>`;
            }
            
            html = html.replace(fullMatch, replacement);
            sTagRegex.lastIndex = 0;
            break;
        }

        // 處理影片格式 [y]網址[t]
        const yTagRegex = /\[y\](.*?)\[t\]/gi;
        let yTagMatch;
        
        while ((yTagMatch = yTagRegex.exec(html)) !== null) {
            const fullMatch = yTagMatch[0];
            let urlContent = yTagMatch[1].trim();
            
            if (urlContent.includes(' ')) {
                urlContent = urlContent.split(' ')[0];
            }
            
            urlContent = urlContent.replace(/^\s+|\s+$/g, '');
            
            if (!isValidUrl(urlContent)) {
                console.log('無效的 YouTube URL:', urlContent);
                continue;
            }
            
            let replacement;
            
            // 檢查是否為 YouTube 影片
            const youtubeMatch = urlContent.match(/(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{11})(?:&[^&\s]*)?/);
            if (youtubeMatch) {
                const id = escapeHtml(youtubeMatch[1]);
                replacement = `<div class="media-content"><iframe src="https://www.youtube.com/embed/${id}?autoplay=0" frameborder="0" allowfullscreen></iframe></div>`;
            } else if (urlContent.toLowerCase().includes('.mp4')) {
                replacement = `<div class="media-content"><video src="${escapeHtml(urlContent)}" controls autoplay muted loop></video></div>`;
            } else {
                replacement = `<a href="${escapeHtml(urlContent)}" target="_blank" rel="noopener noreferrer">${escapeHtml(urlContent)}</a>`;
            }
            
            html = html.replace(fullMatch, replacement);
            yTagRegex.lastIndex = 0;
            break;
        }

        // 移除殘留的標籤字符
        html = html.replace(/(?<!<img[^>]*|<\/?video|<\/?iframe|<\/?a[^>]*)\[s\]|\[e\]|\[y\]|\[t\](?!>)/gi, '');

        // 處理其他普通網址（轉為超連結）
        html = html.replace(/(https?:\/\/[^\s<>"'\]\[]+)/g, url => {
            if (!isValidUrl(url)) {
                return escapeHtml(url);
            }
            
            if (html.includes(`src="${url}"`) || html.includes(`href="${url}"`)) {
                return url;
            }
            
            return `<a href="${escapeHtml(url)}" target="_blank" rel="noopener noreferrer">${escapeHtml(url)}</a>`;
        });

        return html;
    }

    // ===================== 輔助函數 =====================
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#x27;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;');
    }

    function escapeRegExp(string) {
        return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    function scrollToBottom() {
        chat.scrollTop = chat.scrollHeight;
    }

    function limitMessages() {
        const messages = chat.querySelectorAll('.message');
        if (messages.length > MAX_MESSAGES) {
            const messagesToRemove = messages.length - MAX_MESSAGES;
            for (let i = 0; i < messagesToRemove; i++) {
                if (messages[i]) {
                    messages[i].remove();
                }
            }
        }
    }

    function pasteTemplate(template) {
        if (chatInput.disabled) {
            alert('請先登入後再使用此功能');
            return;
        }
        
        chatInput.value += template;
        const startPos = chatInput.value.indexOf('網址');
        const endPos = startPos + 2;
        chatInput.focus();
        chatInput.setSelectionRange(startPos, endPos);
    }

    function truncateMessage(text, maxLength) {
        if (text.length <= maxLength) return text;
        return text.substring(0, maxLength) + '...';
    }

    // ===================== 徽章功能 =====================
    async function loadBadgeMap() {
        try {
            const response = await fetch('https://chicktv.github.io/tv/badges.txt');
            const data = await response.json();
            badgeMap = data;
            console.log('徽章映射載入成功');
        } catch (error) {
            console.error('載入徽章映射失敗:', error);
            badgeMap = {};
        }
    }

    function parseBadges(badgesData) {
        if (!badgesData) return [];
        
        const badges = [];
        
        try {
            let badgePairs = [];
            
            if (typeof badgesData === 'string') {
                badgePairs = badgesData.split(',');
            } else if (typeof badgesData === 'object') {
                badgePairs = Object.entries(badgesData).map(([name, version]) => `${name}/${version}`);
            }
            
            for (const pair of badgePairs) {
                const [name, version] = pair.split('/');
                if (name && version) {
                    const badgeKey = `${name}/${version}`;
                    let badgeUrl;
                    
                    if (badgeMap[badgeKey]) {
                        badgeUrl = badgeMap[badgeKey];
                    } else {
                        badgeUrl = `https://static-cdn.jtvnw.net/badges/v1/${name}/${version}`;
                    }
                    
                    badges.push({
                        name: name,
                        displayName: name.charAt(0).toUpperCase() + name.slice(1),
                        url: badgeUrl,
                        version: version
                    });
                }
            }
        } catch (error) {
            console.error('解析徽章時發生錯誤:', error, badgesData);
            return [];
        }
        
        return badges;
    }

    function renderBadges(badges) {
        if (!badges || badges.length === 0) return '';
        
        return badges.map(badge => 
            `<img src="${badge.url}" class="badge" title="${badge.displayName}" alt="${badge.displayName}" onerror="this.style.display='none'">`
        ).join('');
    }

    // ===================== 回覆功能 =====================
    function setupReply(messageId, username, messageText) {
        replyingTo = {
            id: messageId,
            username: username,
            message: messageText
        };
        
        replyTargetName.textContent = username;
        replyIndicator.style.display = 'flex';
        chatInput.focus();
    }

    function cancelReply() {
        replyingTo = null;
        replyIndicator.style.display = 'none';
    }

    // ===================== @功能 =====================
    function addRecentUser(username, displayName, avatar) {
        const existingIndex = recentUsers.findIndex(user => user.username === username);
        
        if (existingIndex >= 0) {
            const user = recentUsers.splice(existingIndex, 1)[0];
            recentUsers.unshift(user);
        } else {
            recentUsers.unshift({
                username: username,
                displayName: displayName || username,
                avatar: avatar || 'https://static-cdn.jtvnw.net/user-default-pictures-uv/294c98b5-e34d-42cd-a8f0-140b72fba9b0-profile_image-70x70.png'
            });
        }
        
        if (recentUsers.length > 20) {
            recentUsers = recentUsers.slice(0, 20);
        }
    }

    function showMentionAutocomplete(query) {
        mentionQuery = query.toLowerCase();
        mentionAutocomplete.innerHTML = '';
        
        if (!mentionQuery) {
            hideMentionAutocomplete();
            return;
        }
        
        const matchedUsers = recentUsers.filter(user => 
            user.username.toLowerCase().includes(mentionQuery) || 
            user.displayName.toLowerCase().includes(mentionQuery)
        );
        
        if (matchedUsers.length === 0) {
            hideMentionAutocomplete();
            return;
        }
        
        matchedUsers.forEach((user, index) => {
            const item = document.createElement('div');
            item.className = 'mention-item';
            item.innerHTML = `
                <img src="${user.avatar}" alt="${user.username}">
                <div>
                    <div class="username">${user.displayName}</div>
                    <div class="display-name">@${user.username}</div>
                </div>
            `;
            
            item.addEventListener('click', () => {
                selectMention(user);
            });
            
            mentionAutocomplete.appendChild(item);
        });
        
        mentionAutocomplete.style.display = 'block';
        mentionActive = true;
        mentionIndex = -1;
    }

    function hideMentionAutocomplete() {
        mentionAutocomplete.style.display = 'none';
        mentionActive = false;
        mentionIndex = -1;
    }

    function selectMention(user) {
        const currentValue = chatInput.value;
        const atIndex = currentValue.lastIndexOf('@');
        
        if (atIndex >= 0) {
            const newValue = currentValue.substring(0, atIndex) + `@${user.username} `;
            chatInput.value = newValue;
            chatInput.focus();
            chatInput.setSelectionRange(newValue.length, newValue.length);
        }
        
        hideMentionAutocomplete();
    }

    function navigateMentions(direction) {
        if (!mentionActive) return;
        
        const items = mentionAutocomplete.querySelectorAll('.mention-item');
        if (items.length === 0) return;
        
        items.forEach(item => item.classList.remove('active'));
        
        mentionIndex += direction;
        
        if (mentionIndex < 0) {
            mentionIndex = items.length - 1;
        } else if (mentionIndex >= items.length) {
            mentionIndex = 0;
        }
        
        items[mentionIndex].classList.add('active');
    }

    function handleMentionKeydown(e) {
        if (!mentionActive) return;
        
        switch (e.key) {
            case 'ArrowUp':
                e.preventDefault();
                navigateMentions(-1);
                break;
            case 'ArrowDown':
                e.preventDefault();
                navigateMentions(1);
                break;
            case 'Enter':
                e.preventDefault();
                const activeItem = mentionAutocomplete.querySelector('.mention-item.active');
                if (activeItem) {
                    const index = Array.from(mentionAutocomplete.querySelectorAll('.mention-item')).indexOf(activeItem);
                    const matchedUsers = recentUsers.filter(user => 
                        user.username.toLowerCase().includes(mentionQuery) || 
                        user.displayName.toLowerCase().includes(mentionQuery)
                    );
                    if (matchedUsers[index]) {
                        selectMention(matchedUsers[index]);
                    }
                }
                break;
            case 'Escape':
                hideMentionAutocomplete();
                break;
        }
    }

    function handleInputChange(e) {
        const value = chatInput.value;
        const cursorPos = chatInput.selectionStart;
        
        const textBeforeCursor = value.substring(0, cursorPos);
        const lastAtPos = textBeforeCursor.lastIndexOf('@');
        
        if (lastAtPos >= 0 && (lastAtPos === 0 || /\s/.test(value[lastAtPos - 1]))) {
            const query = textBeforeCursor.substring(lastAtPos + 1);
            showMentionAutocomplete(query);
        } else {
            hideMentionAutocomplete();
        }
    }

    function checkMention(messageText, tags) {
        if (!username || username === 'justinfan666') return false;
        
        const mentionRegex = new RegExp(`@${username}\\b`, 'i');
        return mentionRegex.test(messageText);
    }

    // ===================== 表情系統 =====================
    function loadEmojiSets() {
        fetch("https://chicktv.github.io/tv/showset.txt").then(r=>r.json()).then(setarray=>{
            setarray.set.forEach(list=>{
                emojiLists[list.name] = {emojis:[], image:list.image||''};
                fetch(`https://chicktv.github.io/tv/${list.name}.txt`).then(r=>r.json()).then(data=>{
                    data[list.name].forEach(icon=>{
                        if(icon.alt && icon.src){
                            emojiLists[list.name].emojis.push({alt:icon.alt, src:icon.src, dis:icon.dis||icon.alt});
                            altToEmojiMap[icon.alt] = {src:icon.src, width:'32', height:'32'};
                        }
                    });
                    renderEmojiPanel();
                });
            });
        });

        fetch("https://chicktv.github.io/tv/skuser_icon.txt").then(r=>r.json()).then(icons=>{
            emojiLists["本台"] = {emojis:[], image:"https://chicktv.github.io/tv/chick.jpg"};
            icons.forEach(i=>{
                emojiLists["本台"].emojis.push({alt:i.alt, src:i.src, dis:i.alt});
                altToEmojiMap[i.alt] = {src:i.src, width:'32', height:'32'};
            });
            renderEmojiPanel();
        });

        const saved = JSON.parse(localStorage.getItem('myBTTV')||'[]');
        emojiLists["BTTV"] = {
            emojis: saved.map(url=>({alt:url.split('/').pop().split('?')[0], src:url, dis:url})),
            image: "https://cdn.betterttv.net/assets/logo.png"
        };
        renderEmojiPanel();
    }

    function renderEmojiPanel() {
        const tabs = document.getElementById('emoji-tabs');
        const content = document.getElementById('emoji-content');
        tabs.innerHTML = ''; content.innerHTML = '';

        Object.keys(emojiLists).forEach((name, i) => {
            const tab = document.createElement('div');
            tab.className = 'emoji-tab';
            tab.style.backgroundImage = `url(${emojiLists[name].image || 'https://via.placeholder.com/36?text=' + name[0]})`;
            tab.title = name;
            tab.onclick = () => {
                document.querySelectorAll('.emoji-tab').forEach(t=>t.classList.remove('active'));
                tab.classList.add('active');
                renderTabContent(name);
            };
            if (i===0) tab.classList.add('active');
            tabs.appendChild(tab);
        });
        renderTabContent(Object.keys(emojiLists)[0] || 'BTTV');
    }

    function renderTabContent(name) {
        const content = document.getElementById('emoji-content');
        content.innerHTML = '';

        if (name === "BTTV") {
            content.innerHTML += `
                <div class="bttv-input">
                    <input type="text" id="bttv-url" placeholder="輸入圖片網址">
                    <button onclick="addBTTV()">儲存</button>
                    <button onclick="isDeleteMode=!isDeleteMode;renderEmojiPanel()" style="background:${isDeleteMode?'#666':'#c42b1c'}">
                        ${isDeleteMode?'取消刪除':'開啟刪除'}
                    </button>
                </div>`;
        }

        emojiLists[name].emojis.forEach(emoji => {
            const div = document.createElement('div');
            div.className = 'emoji-item';
            div.innerHTML = `<img src="${emoji.src}" title="${emoji.dis||emoji.alt}">`;
            if (name==="BTTV" && isDeleteMode) {
                div.innerHTML += `<div class="delete-btn" onclick="event.stopPropagation();deleteBTTV('${emoji.src}')">X</div>`;
            }
            div.onclick = () => {
                if (name!=="BTTV" || !isDeleteMode) {
                    chatInput.value += (chatInput.value ? ' ' : '') + (emoji.alt || emoji.src);
                    chatInput.focus();
                    emojiPanel.style.display = 'none';
                }
            };
            content.appendChild(div);
        });
    }

    window.addBTTV = () => {
        const url = document.getElementById('bttv-url').value.trim();
        if (!url) return;
        const saved = JSON.parse(localStorage.getItem('myBTTV')||'[]');
        if (!saved.includes(url)) {
            saved.push(url);
            localStorage.setItem('myBTTV', JSON.stringify(saved));
            emojiLists["BTTV"].emojis.push({alt:url.split('/').pop().split('?')[0], src:url});
            renderEmojiPanel();
        }
        document.getElementById('bttv-url').value = '';
    };

    window.deleteBTTV = (url) => {
        let saved = JSON.parse(localStorage.getItem('myBTTV')||'[]');
        saved = saved.filter(u=>u!==url);
        localStorage.setItem('myBTTV', JSON.stringify(saved));
        emojiLists["BTTV"].emojis = emojiLists["BTTV"].emojis.filter(e=>e.src!==url);
        renderEmojiPanel();
    };

    function toggleEmojiPanel() {
        if (emojiPanel.style.display === 'flex') {
            emojiPanel.style.display = 'none';
        } else {
            emojiPanel.style.display = 'flex';
            // 确保表情面板在视图中
            emojiPanel.style.left = '50%';
            emojiPanel.style.top = '50%';
            emojiPanel.style.transform = 'translate(-50%, -50%)';
            renderEmojiPanel();
        }
    }

    function setupEmojiPanelDrag() {
        const emojiHeader = document.querySelector('.emoji-header');
        
        emojiHeader.addEventListener('mousedown', function(e) {
            if (e.target === emojiCloseBtn) return;
            
            isDragging = true;
            dragOffsetX = e.clientX - emojiPanel.offsetLeft;
            dragOffsetY = e.clientY - emojiPanel.offsetTop;
            
            // 防止文本选中
            e.preventDefault();
        });
        
        document.addEventListener('mousemove', function(e) {
            if (isDragging) {
                emojiPanel.style.left = (e.clientX - dragOffsetX) + 'px';
                emojiPanel.style.top = (e.clientY - dragOffsetY) + 'px';
                emojiPanel.style.transform = 'none';
            }
        });
        
        document.addEventListener('mouseup', function() {
            isDragging = false;
        });
    }
    </script>
</body>
</html>
