<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Twitch Console v8.4 - Full Feature Edition</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        :root { --t-bg: #0e0e10; --t-alt: #18181b; --t-purp: #9147ff; --t-text: #efeff1; }
        body { background: var(--t-bg); color: var(--t-text); font-family: sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* --- Webkit Scrollbar Ê®£Âºè --- */
        #chat-container::-webkit-scrollbar, #emojiContent::-webkit-scrollbar, #emojiTabs::-webkit-scrollbar { width: 8px; height: 8px; }
        #chat-container::-webkit-scrollbar-track, #emojiContent::-webkit-scrollbar-track, #emojiTabs::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.2); }
        #chat-container::-webkit-scrollbar-thumb, #emojiContent::-webkit-scrollbar-thumb, #emojiTabs::-webkit-scrollbar-thumb { background: #444; border-radius: 10px; }
        #chat-container::-webkit-scrollbar-thumb:hover, #emojiContent::-webkit-scrollbar-thumb:hover, #emojiTabs::-webkit-scrollbar-thumb:hover { background: var(--t-purp); }

        .header-bar { background: var(--t-alt); padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; flex-shrink: 0; }
        #chat-container { flex: 1; overflow-y: auto; padding: 15px; background: #000; scroll-behavior: smooth; }
        .chat-line { position: relative; border-radius: 4px; line-height: 1.6; word-wrap: break-word; color: var(--t-text); transition: background 0.3s, border 0.3s; padding: 1px; margin-bottom: 5px; border: 1px solid transparent; }
        .chat-line:hover { background: rgba(255,255,255,0.08); }
        .chat-line:has(.quote-box) { border: 1px solid #9147ff; background: rgba(145, 71, 255, 0.1) !important; margin-left: 2px; }
        .self-name { color: var(--t-purp); font-weight: bold; }
        .media-preview { max-width: 250px !important; max-height: 250px !important; border-radius: 6px; margin-top: 10px; display: block; border: 1px solid #444; }
        .audio-player { margin-top: 10px; display: block; max-width: 300px; }
        .alt-emoji { max-width: 120px !important; max-height: 120px !important; vertical-align: top; margin: 2px; }
        .badge { width: 18px; height: 18px; vertical-align: middle; margin-right: 4px; display: inline-block; }
        .reply-btn { position: absolute; right: 10px; top: 10px; width: 28px; height: 28px; border-radius: 50%; display: none; align-items: center; justify-content: center; cursor: pointer; color: #fff; font-size: 10px; z-index: 10; border: 1px solid #444; }
		.reply-btn:hover {background-color: #3c3a39;}
        .chat-line:hover .reply-btn { display: flex; }
        .quote-box { color: #adadb8; padding: 1px; border-radius: 4px; margin-bottom: 1px; line-height: 1.4; display: block; cursor: pointer; border: 1px solid rgba(255,255,255,0.05); }
        .quote-box:hover { background: rgba(255,255,255,0.15); }
        .quote-user { color: #adadb8; margin-right: 5px; }
        .mention-self-tag { background-color: #9147ff; color: #ffffff !important; padding: 2px 6px; border-radius: 4px; font-weight: bold; display: inline-block; margin-bottom: 2px; }
        .footer { padding: 10px; background: var(--t-alt); border-top: 1px solid #333; flex-shrink: 0; }
        #reply-indicator { display:none; color:#adadb8; font-size:12px; margin-bottom:8px; padding:8px; background:rgba(145,71,255,0.1); border-radius:4px; border: 1px solid rgba(145,71,255,0.3); }
        #msginput { flex: 1; background: #000; border: 1px solid #444; color: #fff; padding: 25px; border-radius: 4px; outline: none; }
        #sendbtn { background: var(--t-purp); color: #fff; border: none; padding: 0 20px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .tool-btn { padding: 1px 1px; background: #2f2f35; color: #ccc; border: 1px solid #444; border-radius: 4px; cursor: pointer; font-size: 11px; margin-right: 5px; }
        
        /* Ë°®ÊÉÖÈù¢Êùø */
        #emojiPanel { position: fixed; display: none; width: 450px; height: 500px; background: #1f182e; border: 2px solid #443a5a; border-radius: 12px; z-index: 5000; left: 50%; top: 50%; transform: translate(-50%, -50%); flex-direction: column; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        #emojiTabs {display: flex;flex-wrap: wrap;background: #1f1f23;padding: 8px;gap: 5px;overflow-x: auto;border-bottom: 1px solid #26262c;}
        #emojiContent { flex: 1;overflow-y: auto;padding: 10px;background: #18181b;display: flex;flex-wrap: wrap;gap: 5px;align-content: flex-start; }
        .emoji-tab { width: 36px;height: 36px;background: #3a3a3d;border-radius: 4px;cursor: pointer;background-size: cover;background-position: center;flex-shrink: 0; }
        .emoji-item {  position: relative;width: 40px;height: 40px;border-radius: 4px;cursor: pointer;}
        .emoji-item img {width: 40px;height: 40px;border-radius: 4px;cursor: pointer;}
        .bttv-input-area, .audio-input-form { width: 100%;display: flex;gap: 6px;margin-bottom: 10px; }
        .custom-input { background: #000; border: 1px solid #444; color: #fff; padding: 8px; border-radius: 4px; }

        /* ÈóúÈçµ‰øÆÊ≠£ÔºöÁ¢∫‰øù ‚úï Âá∫Áèæ */
        .delete-btn { position: absolute;top: -8px;right: -8px;background: #e91916;color: white;width: 20px;height: 20px;border-radius: 50%;font-size: 12px;line-height: 20px;text-align: center;cursor: pointer;display: none; z-index: 100; border: 1px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.5); }
        /* Áï∂Áà∂Â±§Êúâ .show-del ÊôÇÈ°ØÁ§∫ÊåâÈàï */
        .show-del .delete-btn { display: block; }

        .audio-item { cursor:pointer; background:rgba(145,71,255,0.1); border:1px solid #444; border-radius:4px; padding:8px; text-align:center; font-size:11px; position:relative; color: #fff; }
    </style>
</head>
<body onload="initApp()">

<div class="header-bar">
    <div style="font-weight:bold;">Twitch Console v8.4</div>
    <div id="auth-area"><button onclick="twitchLoginPopup()" style="background:var(--t-purp); color:white; border:none; padding:8px 16px; border-radius:4px; cursor:pointer;">ÁôªÂÖ• Twitch</button></div>
</div>

<div id="chat-container"><div id="messages"></div></div>

<div id="emojiPanel">
    <div style="padding:12px; display:flex; justify-content:space-between; background:#26262c; border-radius: 12px 12px 0 0; align-items:center;">
        <b style="font-size:14px;">Ë≥áÊ∫êÂ∫´ (Ë°®ÊÉÖ/Èü≥Ë®ä)</b>
        <button onclick="$('#emojiPanel').hide()" style="background:none; border:none; color:white; cursor:pointer; font-size:18px;">‚úï</button>
    </div>
    <div id="emojiTabs"></div>
    <div id="emojiContent"></div>
</div>

<div class="footer">
    <div id="reply-indicator">
        Ê≠£Âú®ÂõûË¶Ü <span id="replying-to-user" style="color:#9147ff; font-weight:bold;"></span> 
        <span onclick="cancelReply()" style="float:right; cursor:pointer; color:#efeff1;">‚úï ÂèñÊ∂àÂõûË¶Ü</span>
    </div>
    <div style="display:flex; gap:1px; margin-bottom:8px;">
        <button class="tool-btn" onclick="insertTagOnly('[s] ')">ÂúñÁâá</button>
        <button class="tool-btn" onclick="insertTagOnly('[y] ')">ÂΩ±Áâá</button>
        <button class="tool-btn" onclick="insertTagOnly('[a] ')">Èü≥Ë®ä</button>
        <button class="tool-btn" onclick="renderEmojiPanel(); $('#emojiPanel').css('display','flex')"><svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M10 2C5.58 2 2 5.58 2 10s3.58 8 8 8 8-3.58 8-8-3.58-8-8-8zm0 14.5c-3.59 0-6.5-2.91-6.5-6.5S6.41 3.5 10 3.5s6.5 2.91 6.5 6.5-2.91 6.5-6.5 6.5zM6.5 9c.83 0 1.5-.67 1.5-1.5S7.33 6 6.5 6 5 6.67 5 7.5 5.67 9 6.5 9zm7 0c.83 0 1.5-.67 1.5-1.5S14.33 6 13.5 6 12 6.67 12 7.5s.67 1.5 1.5 1.5zM10 14c-1.66 0-3.14-.69-4.2-1.8l1.41-1.41C7.83 11.53 8.84 12 10 12s2.17-.47 2.79-1.21l1.41 1.41C13.14 13.31 11.66 14 10 14z"/>
                    </svg></button>
    </div>
    <div style="display:flex; gap:10px;">
        <input id="msginput" type="text" placeholder="ÂÇ≥ÈÄÅË®äÊÅØ..." autocomplete="off">
        <button id="sendbtn" onclick="sendMessage()"><svg width="20" height="40" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M2.93 4.26l14.76-2.66c.95-.17 1.73.61 1.56 1.56L15.74 17.1c-.2 1.09-1.57 1.41-2.23.49l-3.14-4.37-2.66 2.66c-.39.39-1.02.39-1.41 0-.39-.39-.39-1.02 0-1.41l2.66-2.66L1.44 6.49c-.92-.66-.6-2.03.49-2.23z"/>
                    </svg></button>
    </div>
</div>

<script>
    const CHANNEL = "69nocondom";
    const CLIENT_ID = '0uhjgjpko804ba35q1nj1h6x2eriq9';
    let ACCESS_TOKEN = "", socket, altMap = {}, emojiLists = {}, audioLists = {}, customBadges = {};
    let msgCache = {}; 
    let myLoginId = "", myDisplayName = ""; 
    let pendingReply = { id: null, user: null };
    
    // Á¢∫‰øùÂà™Èô§ÁãÄÊÖãËÆäÊï∏Ê≠£Á¢∫
    let isDeleteMode = false;
    let isAudioDeleteMode = false;

    function getTagValue(tags, key) { const regex = new RegExp(`${key}=([^;\\s]+)`); const match = tags.match(regex); return match ? match[1] : null; }

    async function initApp() {
        const savedToken = localStorage.getItem('twitch_access_token');
        if (savedToken) { 
            ACCESS_TOKEN = savedToken; 
            myLoginId = localStorage.getItem('twitch_my_login') || ""; 
            myDisplayName = localStorage.getItem('twitch_my_display') || ""; 
            updateAuthUI(); 
        }
        if (window.location.hash) {
            const params = new URLSearchParams(window.location.hash.substring(1));
            const token = params.get("access_token");
            if (token) { ACCESS_TOKEN = token; localStorage.setItem('twitch_access_token', ACCESS_TOKEN); await fetchUserInfo(); }
            window.location.hash = "";
        }
        await fetchBadges();
        await loadResources();
        setupAutoTag();
        startChat();
    }

    async function fetchUserInfo() {
        try {
            const r = await fetch('https://api.twitch.tv/helix/users', { headers: { 'Authorization': `Bearer ${ACCESS_TOKEN}`, 'Client-Id': CLIENT_ID } });
            const d = await r.json();
            if(d.data && d.data[0]) {
                myLoginId = d.data[0].login; myDisplayName = d.data[0].display_name;
                localStorage.setItem('twitch_my_login', myLoginId); localStorage.setItem('twitch_my_display', myDisplayName);
                updateAuthUI();
            }
        } catch(e) {}
    }

    function updateAuthUI() { if (myDisplayName) { $("#auth-area").html(`<span style="color:#00ff00; font-weight:bold; margin-right:10px;">‚óè ${myDisplayName}</span><button onclick="logout()" style="background:#444; color:white; border:none; padding:4px 8px; border-radius:4px; cursor:pointer; font-size:11px;">ÁôªÂá∫</button>`); } }
    function logout() { localStorage.clear(); window.location.reload(); }
    function twitchLoginPopup() { const redirect = window.location.href.split('#')[0]; window.location.href = `https://id.twitch.tv/oauth2/authorize?client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(redirect)}&response_type=token&scope=chat:read+chat:edit+user:read:email`; }

    async function loadResources() {
        try {
            const skData = await $.getJSON("https://chicktv.github.io/tv/skuser_icon.txt");
            if (Array.isArray(skData)) {
                emojiLists["Â∏∏Áî®"] = { emojis: skData, image: skData[0].src };
                skData.forEach(i => { if(i.alt) altMap[i.alt.toLowerCase()] = i.src; });
            }
            
            const savedBTTV = JSON.parse(localStorage.getItem('myBTTV') || '[]');
            emojiLists["BTTV"] = {
                emojis: savedBTTV.map(url => ({ alt: url.split('/').pop().split('?')[0], src: url, dis: url })),
                image: "https://static-cdn.jtvnw.net/badges/v1/ed51a614-2c44-4a60-80b6-62908436b43a/3"
            };

            await loadAudioData();

            const res = await $.getJSON("https://chicktv.github.io/tv/showset.txt");
            for (const item of res.set) {
                let n = (typeof item === 'object') ? item.name : item;
                let img = (typeof item === 'object') ? item.image : "";
                if (!n || n === "skuser_icon") continue;
                $.getJSON(`https://chicktv.github.io/tv/${n}.txt`, d => {
                    let list = d[n] || [];
                    emojiLists[n] = { emojis: list, image: img };
                    list.forEach(e => { if(e.alt) altMap[e.alt.toLowerCase()] = e.src; });
                });
            }
        } catch(e){}
    }

    async function loadAudioData() {
        try {
            const response = await fetch('https://chicktv.github.io/tv/audio.txt');
            const localAudios = JSON.parse(localStorage.getItem('myAudios') || '[]');
            if (response.ok) {
                const remoteAudios = await response.json();
                audioLists["Èü≥Ë®ä"] = { audios: mergeAudioLists(remoteAudios, localAudios), image: "üîä" };
            } else { throw new Error(); }
        } catch (e) {
            audioLists["Èü≥Ë®ä"] = { audios: JSON.parse(localStorage.getItem('myAudios') || '[]'), image: "üîä" };
        }
    }

    function mergeAudioLists(remote, local) {
        const merged = [...remote];
        const urlSet = new Set(remote.map(a => a.url));
        local.forEach(l => { if (!urlSet.has(l.url)) { merged.push(l); urlSet.add(l.url); } });
        return merged;
    }

    function renderEmojiPanel() {
        const tabs = $("#emojiTabs").empty();
        Object.keys(emojiLists).forEach((name, i) => {
            const tab = $('<div class="emoji-tab"></div>')
                .css("background-image", `url(${emojiLists[name].image})`)
                .attr("title", name)
                .on('click', function() { $(".emoji-tab").css("opacity", "0.6"); $(this).css("opacity", "1"); renderTabContent(name); });
            if (i === 0) tab.css("opacity", "1");
            tabs.append(tab);
        });

        const audioTab = $('<div class="emoji-tab" style="color:white; text-align:center; line-height:32px;">üîä</div>')
            .on('click', function() { $(".emoji-tab").css("opacity", "0.6"); $(this).css("opacity", "1"); renderTabContent("Èü≥Ë®ä"); });
        tabs.append(audioTab);

        renderTabContent(Object.keys(emojiLists)[0]);
    }

    function renderTabContent(name) {
        const content = $("#emojiContent").empty();
        if (name === "BTTV") {
            content.append(`
                <div class="bttv-input-area">
                    <input type="text" id="bttvUrl" class="custom-input" placeholder="Ë≤º‰∏äÂúñÁâáÁ∂≤ÂùÄ..." style="flex:1">
                    <div style="display:flex; gap:5px;">
                        <button onclick="addBTTV()" style="background:var(--t-purp); color:white; border:none; border-radius:4px; cursor:pointer; padding:5px 15px;">ÂÑ≤Â≠ò</button>
                        <button onclick="isDeleteMode=!isDeleteMode;renderTabContent('BTTV')" style="background:${isDeleteMode?'#666':'#c42b1c'}; color:white; border:none; border-radius:4px; padding:5px 15px;">${isDeleteMode?'ÂèñÊ∂à':'Âà™Èô§'}</button>
                    </div>
                </div>`);
            emojiLists[name].emojis.forEach(e => {
                // ‰øÆÊ≠£ÈáçÈªûÔºöÊ†πÊìö isDeleteMode Ê±∫ÂÆöÊòØÂê¶Âä†‰∏ä show-del
                const item = $(`<div class="emoji-item ${isDeleteMode ? 'show-del' : ''}"><img src="${e.src}" style="max-width:40px;"><div class="delete-btn" onclick="event.stopPropagation();deleteBTTV('${e.src}')">‚úï</div></div>`);
                item.on('click', () => { if(!isDeleteMode) { insertAtCursor(` [s] ${e.src} [e] `); $("#emojiPanel").hide(); } });
                content.append(item);
            });
        } else if (name === "Èü≥Ë®ä") {
            content.append(`
                <div class="audio-input-form" style="flex-wrap:wrap">
                    <input type="text" id="audioName" class="custom-input" placeholder="Èü≥Ë®äÂêçÁ®±" style="flex:1; min-width:120px;">
                    <input type="text" id="audioUrl" class="custom-input" placeholder="Èü≥Ë®äÁ∂≤ÂùÄ" style="flex:2; min-width:180px;">
                    <div style="display:flex; gap:5px;">
                        <button onclick="addAudio()" style="background:var(--t-purp); color:white; border:none; border-radius:4px; padding:5px 15px;">ÂÑ≤Â≠òÈü≥Ë®ä</button>
                        <button onclick="isAudioDeleteMode=!isAudioDeleteMode;renderTabContent('Èü≥Ë®ä')" style="background:${isAudioDeleteMode?'#666':'#c42b1c'}; color:white; border:none; border-radius:4px; padding:5px 15px;">${isAudioDeleteMode?'ÂèñÊ∂à':'Âà™Èô§'}</button>
                    </div>
                </div>`);
            audioLists[name].audios.forEach((a, index) => {
                // ‰øÆÊ≠£ÈáçÈªûÔºöÊ†πÊìö isAudioDeleteMode Ê±∫ÂÆöÊòØÂê¶Âä†‰∏ä show-del
                const item = $(`<div class="audio-item ${isAudioDeleteMode ? 'show-del' : ''}">üîä<br>${a.name}<div class="delete-btn" onclick="event.stopPropagation();deleteAudio(${index})">‚úï</div></div>`);
                item.on('click', () => { if(!isAudioDeleteMode) { insertAtCursor(` [a] ${a.url} [o] `); $("#emojiPanel").hide(); } });
                content.append(item);
            });
        } else {
            emojiLists[name].emojis.forEach(e => {
                $('<div class="emoji-item"></div>').append($('<img style="max-width:40px;">').attr('src', e.src))
                .on('click', () => { insertAtCursor(` ${e.alt} `); $('#emojiPanel').hide(); }).appendTo(content);
            });
        }
    }

    window.addBTTV = () => {
        const url = $("#bttvUrl").val().trim();
        if (!url) return;
        const saved = JSON.parse(localStorage.getItem('myBTTV') || '[]');
        if (!saved.includes(url)) {
            saved.push(url);
            localStorage.setItem('myBTTV', JSON.stringify(saved));
            emojiLists["BTTV"].emojis.push({ alt: url.split('/').pop(), src: url });
            renderTabContent("BTTV");
        }
        $("#bttvUrl").val("");
    };

    window.deleteBTTV = (url) => {
        let saved = JSON.parse(localStorage.getItem('myBTTV') || '[]');
        saved = saved.filter(u => u !== url);
        localStorage.setItem('myBTTV', JSON.stringify(saved));
        emojiLists["BTTV"].emojis = emojiLists["BTTV"].emojis.filter(e => e.src !== url);
        renderTabContent("BTTV");
    };

    window.addAudio = () => {
        const name = $("#audioName").val().trim(), url = $("#audioUrl").val().trim();
        if (!name || !url) return alert("Ë´ãÂ°´ÂØ´ÂÆåÊï¥");
        const saved = JSON.parse(localStorage.getItem('myAudios') || '[]');
        saved.push({ name, url });
        localStorage.setItem('myAudios', JSON.stringify(saved));
        audioLists["Èü≥Ë®ä"].audios = mergeAudioLists([], saved);
        renderTabContent("Èü≥Ë®ä");
    };

    window.deleteAudio = (i) => {
        let saved = JSON.parse(localStorage.getItem('myAudios') || '[]');
        saved.splice(i, 1);
        localStorage.setItem('myAudios', JSON.stringify(saved));
        audioLists["Èü≥Ë®ä"].audios = saved;
        renderTabContent("Èü≥Ë®ä");
    };
	
	 window.handleAudioClick = (btn, url) => {
        if (btn.dataset.isPlaying === "true") {
            // Ê≠£Âú®Êí≠Êîæ‰∏≠ÔºåÈªûÊìäÂç≥ÂÅúÊ≠¢
            if (btn.currentAudio) {
                btn.currentAudio.pause();
                btn.currentAudio.currentTime = 0;
            }
            resetAudioState(btn);
        } else {
            // ÈñãÂßãÊí≠Êîæ
            const audioElem = new Audio(url);
            btn.currentAudio = audioElem;
            btn.dataset.isPlaying = "true";
            btn.classList.add('playing');
            btn.innerHTML = 'üîä';
            btn.title = 'Êí≠Êîæ‰∏≠...ÈªûÊìäÂÅúÊ≠¢';

            audioElem.play().catch(error => {
                console.error('Èü≥Ë®äÊí≠ÊîæÂ§±Êïó:', error);
                resetAudioState(btn);
                btn.title = 'Êí≠ÊîæÂ§±Êïó';
                btn.innerHTML = '‚ùå';
            });

            audioElem.onended = () => {
                resetAudioState(btn);
            };
        }
    };

    function parseContent(str) {
        let s = str, placeholders = [];
        s = s.replace(/\[s\](.*?)\[e\]/gi, (m, content) => { 
            let id = `__PH_${placeholders.length}__`; const url = content.trim();
            let html = url.toLowerCase().includes(".mp4") ? `<video class="media-preview" autoplay loop muted playsinline><source src="${url}" type="video/mp4"></video>` : `<img src="${url}" class="media-preview" onclick="window.open('${url}','_blank')">`;
            placeholders.push(html); return id; 
        });
        s = s.replace(/\[y\](.*?)\[t\]/gi, (m, content) => {
            const url = content.trim(); let id = `__PH_${placeholders.length}__`; let html = "";
            const ytMatch = url.match(/(?:v=|\/shorts\/|youtu.be\/)([^#&?]*)/);
            if (url.toLowerCase().includes(".mp4")) html = `<video class="media-preview" controls><source src="${url}" type="video/mp4"></video>`;
            else if (ytMatch && ytMatch[1]) html = `<iframe class="media-preview" width="320" height="180" src="https://www.youtube.com/embed/${ytMatch[1]}" frameborder="0" allowfullscreen></iframe>`;
            else html = `<a href="${url}" target="_blank" style="color:#58a6ff;">${url}</a>`;
            placeholders.push(html); return id;
        });
           s = s.replace(/\[a\](.*?)\[o\]/gi, (m, content) => {
            const url = content.trim(); let id = `__PH_${placeholders.length}__`;
            let html = `<span class="audio-icon-btn" onclick="handleAudioClick(this, '${url}')" data-is-playing="false" title="ÈªûÊìäÊí≠ÊîæÈü≥Ë®ä">üîà</span>`;
            placeholders.push(html); return id;
        });
        s = s.replace(/https?:\/\/[^\s]+/gi, (url) => url.includes('__PH_') ? url : `<a href="${url}" target="_blank" style="color:#58a6ff;">${url}</a>`);
        let words = s.split(' ');
        s = words.map(w => { if(w.includes('__PH_')) return w; const src = altMap[w.toLowerCase()]; return src ? `<img src="${src}" class="alt-emoji">` : w; }).join(' ');
        placeholders.forEach((html, i) => { s = s.replace(`__PH_${i}__`, html); });
        return s;
    }

    function sendMessage() {
        const val = $("#msginput").val(); if (!val || !socket || socket.readyState !== 1) return;
        const selfTs = Date.now().toString(); let finalCmd = "", replyDisplay = "";
        if (pendingReply.id) {
            finalCmd = `@reply-parent-msg-id=${pendingReply.id} PRIVMSG #${CHANNEL} :${val}`;
            replyDisplay = `<div class="quote-box" onclick="scrollToMsg('${pendingReply.id}')">ÂõûË¶Ü<span class="quote-user">@${pendingReply.user}:</span>${msgCache[pendingReply.id]||"..."}</div>`;
        } else finalCmd = `PRIVMSG #${CHANNEL} :${val}`;
        socket.send(finalCmd); msgCache[selfTs] = val;
        $("#messages").append(`<div class="chat-line ts-${selfTs}">${replyDisplay}<b class="self-name">${myDisplayName || myLoginId}:</b> <span>${parseContent(val)}</span></div>`);
        $("#chat-container").scrollTop($("#chat-container")[0].scrollHeight);
        cancelReply(); $("#msginput").val("");
    }

    function startChat() {
        if(socket) socket.close();
        socket = new WebSocket('wss://irc-ws.chat.twitch.tv:443');
        socket.onopen = () => {
            socket.send('CAP REQ :twitch.tv/tags twitch.tv/commands');
            socket.send(`PASS oauth:${ACCESS_TOKEN || 'dummy'}`);
            socket.send(`NICK ${ACCESS_TOKEN ? 'user' : 'justinfan'+Math.floor(Math.random()*1000)}`);
            socket.send(`JOIN #${CHANNEL}`);
        };
        socket.onmessage = (e) => {
            if (e.data.startsWith('PING')) { socket.send('PONG :tmi.twitch.tv'); return; }
            if (!e.data.includes('PRIVMSG')) return;
            const parts = e.data.split(` PRIVMSG #${CHANNEL} :`);
            const tags = parts[0], rawMsg = parts[1].trim();
            const msgId = getTagValue(tags, "id");
            const ts = getTagValue(tags, "tmi-sent-ts") || Date.now().toString();
            const user = getTagValue(tags, "display-name") || "User";
            const color = getTagValue(tags, "color") || "#9147ff";
            if (msgId) msgCache[msgId] = rawMsg;
            msgCache[ts] = rawMsg;
            let replyHtml = "", displayMsg = rawMsg;
            const pUser = getTagValue(tags, "reply-parent-display-name");
            const pId = getTagValue(tags, "reply-parent-msg-id");
            const pBodyRaw = getTagValue(tags, "reply-parent-msg-body");
            if (pUser && pId) {
                let isMe = (pUser === myDisplayName || pUser === myLoginId);
                let pBody = pBodyRaw ? pBodyRaw.replace(/\\s/g, " ") : (msgCache[pId] || "...");
                const userTagClass = isMe ? 'quote-user mention-self-tag' : 'quote-user';
                replyHtml = `<div class="quote-box" onclick="scrollToMsg('${pId}')"><svg width="17" height="17" viewBox="0 0 24 20" fill="currentColor"><path d="M9 10h2v2H9v-2Zm6 0h-2v2h2v-2Z"></path><path fill-rule="evenodd" d="m12 22-3-3H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2h-4l-3 3Zm-2.172-5L12 19.172 14.172 17H19V5H5v12h4.828Z" clip-rule="evenodd"></path></svg> ÂõûË¶Ü<span class="${userTagClass}">@${pUser}:</span>${pBody}</div>`;
                const mention = `@${pUser} `;
                if (displayMsg.startsWith(mention)) displayMsg = displayMsg.substring(mention.length);
            } 
            else if (rawMsg.includes("[r]")) {
                const myR = rawMsg.match(/\[r\](.*?),([\d\w-]+)\[m\]/);
                if(myR) {
                    let body = msgCache[myR[2]] || "...";
                    replyHtml = `<div class="quote-box" onclick="scrollToMsg('${myR[2]}')"><svg width="17" height="17" viewBox="0 0 24 20" fill="currentColor"><path d="M9 10h2v2H9v-2Zm6 0h-2v2h2v-2Z"></path><path fill-rule="evenodd" d="m12 22-3-3H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2h-4l-3 3Zm-2.172-5L12 19.172 14.172 17H19V5H5v12h4.828Z" clip-rule="evenodd"></path></svg> ÂõûË¶Ü<span class="quote-user">@${myR[1]}:</span>${body}</div>`;
                    displayMsg = rawMsg.replace(/\[r\](.*?),([\d\w-]+)\[m\]/gi, "");
                }
            }
            const badgeStr = getTagValue(tags, "badges");
            const line = `<div class="chat-line ts-${ts} id-${msgId}" data-msg-id="${msgId}">
                <div class="reply-btn" onclick="replyNative('${user}','${msgId}')"><img src="https://chicktv.github.io/tv/re2.png" width="35" height="35"></div>
                ${replyHtml}
                ${renderBadges(badgeStr)}
                <b style="color:${color}">${user}:</b> <span>${parseContent(displayMsg)}</span>
            </div>`;
            $("#messages").append(line);
            $("#chat-container").scrollTop($("#chat-container")[0].scrollHeight);
        };
        socket.onclose = () => { setTimeout(startChat, 3000); };
    }
    
    function renderBadges(badgeStr) {
        if (!badgeStr) return "";
        let html = "";
        badgeStr.split(',').forEach(b => {
            const key = b.split('/')[0];
            const url = customBadges[b] || customBadges[key];
            if (url) html += `<img class="badge" src="${url}">`;
        });
        return html;
    }

    function fetchBadges() { return $.getJSON("https://chicktv.github.io/tv/badges.txt", d => { customBadges = d; }); }
    function setupAutoTag() { 
        document.getElementById('msginput').addEventListener('paste', (e) => {
            const data = (e.clipboardData || window.clipboardData).getData('text');
            if (!data.match(/^https?:\/\//i)) return;
            const input = e.target;
            if (input.value.endsWith('[s] ')) { e.preventDefault(); insertAtCursor(data + ' [e]'); }
            else if (input.value.endsWith('[y] ')) { e.preventDefault(); insertAtCursor(data + ' [t]'); }
            else if (input.value.endsWith('[a] ')) { e.preventDefault(); insertAtCursor(data + ' [o]'); }
        });
    }
    function insertTagOnly(s) { const i = $("#msginput")[0], st = i.selectionStart; i.value = i.value.substring(0, st) + s + i.value.substring(i.selectionEnd); i.focus(); }
    function insertAtCursor(v) { const i = $("#msginput")[0], st = i.selectionStart; i.value = i.value.substring(0, st) + v + i.value.substring(i.selectionEnd); i.focus(); }
    function replyNative(u, id) { pendingReply = { id: id, user: u }; $("#replying-to-user").text(u); $("#reply-indicator").show(); $("#msginput").focus(); }
    function cancelReply() { pendingReply = { id: null, user: null }; $("#reply-indicator").hide(); }
    $(document).on('keypress', '#msginput', e => { if (e.which == 13) sendMessage(); });
</script>
</body>
</html>
