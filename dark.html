<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Twitch Console v8.4 - Auto-Close Emoji Panel</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        :root { --t-bg: #0e0e10; --t-alt: #18181b; --t-purp: #9147ff; --t-text: #efeff1; }
        body { background: var(--t-bg); color: var(--t-text); font-family: sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* 頁首 */
        .header-bar { background: var(--t-alt); padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; flex-shrink: 0; }
        #chat-container { flex: 1; overflow-y: auto; padding: 15px; background: #000; }
        
        /* 聊天訊息樣式 */
        .chat-line { position: relative; margin-bottom: 8px; padding: 8px 45px 8px 10px; border-radius: 4px; line-height: 1.6; word-wrap: break-word; color: var(--t-text); }
        .chat-line:hover { background: rgba(255,255,255,0.08); }
        .self-name { color: var(--t-purp); font-weight: bold; }
        
        /* 媒體預覽 */
        .media-preview { max-width: 250px !important; max-height: 250px !important; border-radius: 6px; margin-top: 10px; display: block; border: 1px solid #444; }
        .alt-emoji { max-width: 80px !important; max-height: 80px !important; vertical-align: middle; margin: 2px; }
        .badge { width: 18px; height: 18px; vertical-align: middle; margin-right: 4px; }

        /* 回覆按鈕 (RE) */
        .reply-btn { position: absolute; right: 10px; top: 10px; width: 28px; height: 28px; background: #2f2f35; border-radius: 4px; display: none; align-items: center; justify-content: center; cursor: pointer; color: #fff; font-size: 10px; z-index: 10; border: 1px solid #444; }
        .chat-line:hover .reply-btn { display: flex; }

        /* 引用框基礎樣式 */
        .quote-box { font-size: 12px; color: #adadb8; background: rgba(255,255,255,0.1); padding: 8px; border-radius: 4px; margin-bottom: 8px; border-left: 3px solid #333; line-height: 1.4; display: block; }
        .quote-user { font-weight: bold; color: #9147ff; margin-right: 5px; transition: all 0.2s; }

        /* 當自己被回覆 (@) 時，針對 quote-user 進行提亮 */
        .mention-self-tag { 
            background-color: #9147ff;
            color: #ffffff !important;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
            display: inline-block;
            margin-bottom: 2px;
        }

        /* 頁腳 */
        .footer { padding: 15px; background: var(--t-alt); border-top: 1px solid #333; flex-shrink: 0; }
        #reply-indicator { display:none; color:#adadb8; font-size:12px; margin-bottom:8px; padding:8px; background:rgba(145,71,255,0.1); border-radius:4px; border: 1px solid rgba(145,71,255,0.3); }
        #msginput { flex: 1; background: #000; border: 1px solid #444; color: #fff; padding: 12px; border-radius: 4px; outline: none; }
        #sendbtn { background: var(--t-purp); color: #fff; border: none; padding: 0 20px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        
        .tool-btn { padding: 4px 10px; background: #2f2f35; color: #ccc; border: 1px solid #444; border-radius: 4px; cursor: pointer; font-size: 11px; margin-right: 5px; }
        
        /* 表情面板樣式 */
        #emojiPanel { position: fixed; display: none; width: 450px; height: 500px; background: #1f182e; border: 2px solid #443a5a; border-radius: 12px; z-index: 5000; left: 50%; top: 50%; transform: translate(-50%, -50%); flex-direction: column; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        #emojiTabs { display: flex; gap: 10px; padding: 12px; overflow-x: auto; background: #0e0e10; border-bottom: 1px solid #333; }
        #emojiContent { flex: 1; overflow-y: auto; padding: 15px; display: grid; grid-template-columns: repeat(auto-fill, 50px); gap: 12px; background: #18181b; }
        .emoji-tab { width: 32px; height: 32px; background-size: contain; background-repeat: no-repeat; cursor: pointer; opacity: 0.6; }
        .emoji-tab:hover { opacity: 1; }
        .emoji-item { cursor:pointer; display:flex; align-items:center; justify-content:center; background:rgba(255,255,255,0.03); border-radius:4px; padding: 5px; transition: background 0.2s; }
        .emoji-item:hover { background: rgba(145, 71, 255, 0.2); }
    </style>
</head>
<body onload="initApp()">

<div class="header-bar">
    <div style="font-weight:bold;">Twitch Console v8.4</div>
    <div id="auth-area"><button onclick="twitchLoginPopup()" style="background:var(--t-purp); color:white; border:none; padding:8px 16px; border-radius:4px; cursor:pointer;">登入 Twitch</button></div>
</div>

<div id="chat-container"><div id="messages"></div></div>

<div id="emojiPanel">
    <div style="padding:12px; display:flex; justify-content:space-between; background:#26262c; border-radius: 12px 12px 0 0; align-items:center;">
        <b style="font-size:14px;">表情資源庫</b>
        <button onclick="$('#emojiPanel').hide()" style="background:none; border:none; color:white; cursor:pointer; font-size:18px;">✕</button>
    </div>
    <div id="emojiTabs"></div>
    <div id="emojiContent"></div>
</div>

<div class="footer">
    <div id="reply-indicator">
        正在回覆 <span id="replying-to-user" style="color:#9147ff; font-weight:bold;"></span> 
        <span onclick="cancelReply()" style="float:right; cursor:pointer; color:#efeff1;">✕ 取消回覆</span>
    </div>
    <div style="display:flex; gap:6px; margin-bottom:10px;">
        <button class="tool-btn" onclick="insertTagOnly('[s] ')">圖片</button>
        <button class="tool-btn" onclick="insertTagOnly('[y] ')">影片/MP4</button>
        <button class="tool-btn" onclick="$('#emojiPanel').css('display','flex')">☺ 表情</button>
    </div>
    <div style="display:flex; gap:10px;">
        <input id="msginput" type="text" placeholder="傳送訊息..." autocomplete="off">
        <button id="sendbtn" onclick="sendMessage()">發送</button>
    </div>
</div>

<script>
    const CHANNEL = "69nocondom";
    const CLIENT_ID = '0uhjgjpko804ba35q1nj1h6x2eriq9';
    let ACCESS_TOKEN = "", socket, altMap = {}, emojiSets = {}, customBadges = {};
    let msgCache = {}, shadowCache = {}; 
    let myLoginId = "", myDisplayName = ""; 
    let pendingReply = { id: null, user: null };

    async function initApp() {
        const savedToken = localStorage.getItem('twitch_access_token');
        if (savedToken) { 
            ACCESS_TOKEN = savedToken; 
            myLoginId = localStorage.getItem('twitch_my_login') || ""; 
            myDisplayName = localStorage.getItem('twitch_my_display') || ""; 
            updateAuthUI(); 
        }
        if (window.location.hash) {
            const params = new URLSearchParams(window.location.hash.substring(1));
            const token = params.get("access_token");
            if (token) { ACCESS_TOKEN = token; localStorage.setItem('twitch_access_token', ACCESS_TOKEN); await fetchUserInfo(); }
            window.location.hash = "";
        }
        await loadResources();
        await fetchBadges();
        setupAutoTag();
        startChat();
    }

    async function fetchUserInfo() {
        try {
            const r = await fetch('https://api.twitch.tv/helix/users', { headers: { 'Authorization': `Bearer ${ACCESS_TOKEN}`, 'Client-Id': CLIENT_ID } });
            const d = await r.json();
            if(d.data && d.data[0]) {
                myLoginId = d.data[0].login; myDisplayName = d.data[0].display_name;
                localStorage.setItem('twitch_my_login', myLoginId); localStorage.setItem('twitch_my_display', myDisplayName);
                updateAuthUI();
            }
        } catch(e) {}
    }

    function updateAuthUI() { if (myDisplayName) { $("#auth-area").html(`<span style="color:#00ff00; font-weight:bold; margin-right:10px;">● ${myDisplayName}</span><button onclick="logout()" style="background:#444; color:white; border:none; padding:4px 8px; border-radius:4px; cursor:pointer; font-size:11px;">登出</button>`); } }
    function logout() { localStorage.clear(); window.location.reload(); }
    function twitchLoginPopup() { const redirect = window.location.href.split('#')[0]; window.location.href = `https://id.twitch.tv/oauth2/authorize?client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(redirect)}&response_type=token&scope=chat:read+chat:edit+user:read:email`; }

    async function loadResources() {
        try {
            const skData = await $.getJSON("https://chicktv.github.io/tv/skuser_icon.txt");
            if (Array.isArray(skData)) {
                emojiSets["常用"] = skData;
                skData.forEach(i => { if(i.alt) altMap[i.alt.toLowerCase()] = i.src; });
                $('<div class="emoji-tab"></div>').css("background-image", `url(${skData[0].src})`).on('click', function(){ renderEmojiList("常用"); }).appendTo("#emojiTabs");
            }
            const res = await $.getJSON("https://chicktv.github.io/tv/showset.txt");
            for (const item of res.set) {
                let n = (typeof item === 'object') ? item.name : item;
                let img = (typeof item === 'object') ? item.image : "";
                if (!n || n === "skuser_icon") continue;
                $.getJSON(`https://chicktv.github.io/tv/${n}.txt`, d => {
                    emojiSets[n] = d[n] || [];
                    emojiSets[n].forEach(e => { if(e.alt) altMap[e.alt.toLowerCase()] = e.src; });
                    $('<div class="emoji-tab"></div>').css("background-image", `url(${img})`).on('click', function(){ renderEmojiList(n); }).appendTo("#emojiTabs");
                });
            }
        } catch(e){}
    }

    // --- 修改後的表情列表渲染：加入自動關閉功能 ---
    function renderEmojiList(n) {
        $("#emojiContent").empty();
        if(emojiSets[n]) emojiSets[n].forEach(e => {
            $('<div class="emoji-item"></div>')
                .append($('<img style="max-width:40px; max-height:40px;">').attr('src', e.src))
                .on('click', () => {
                    insertAtCursor(` ${e.alt} `); // 插入表情
                    $('#emojiPanel').hide();      // 自動關閉面板
                }).appendTo("#emojiContent");
        });
    }

    function parseContent(str) {
        let s = str, placeholders = [];
        s = s.replace(/\[s\](.*?)\[e\]/gi, (m, content) => { 
            let id = `__PH_${placeholders.length}__`; 
            const url = content.trim();
            let html = url.toLowerCase().endsWith(".mp4") 
                ? `<video class="media-preview" autoplay loop muted playsinline onclick="window.open('${url}','_blank')"><source src="${url}" type="video/mp4"></video>`
                : `<img src="${url}" class="media-preview" onclick="window.open('${url}','_blank')">`;
            placeholders.push(html); return id; 
        });
        s = s.replace(/\[y\](.*?)\[t\]/gi, (m, content) => {
            const url = content.trim(); let id = `__PH_${placeholders.length}__`; let html = "";
            if (url.toLowerCase().endsWith(".mp4")) { html = `<video class="media-preview" controls><source src="${url}" type="video/mp4"></video>`; }
            else { const v = url.match(/(?:v=|\/shorts\/|youtu.be\/)([^#&?]*)/)?.[1]; html = v ? `<iframe class="media-preview" width="250" height="140" src="https://www.youtube.com/embed/${v}" frameborder="0" allowfullscreen></iframe>` : `<a href="${url}" target="_blank" style="color:#58a6ff;">${url}</a>`; }
            placeholders.push(html); return id;
        });
        s = s.replace(/https?:\/\/[^\s]+/gi, (url) => url.includes('__PH_') ? url : `<a href="${url}" target="_blank" style="color:#58a6ff;">${url}</a>`);
        let words = s.split(' ');
        s = words.map(w => { if(w.includes('__PH_')) return w; const src = altMap[w.toLowerCase()]; return src ? `<img src="${src}" class="alt-emoji">` : w; }).join(' ');
        placeholders.forEach((html, i) => { s = s.replace(`__PH_${i}__`, html); });
        return s;
    }

    function sendMessage() {
        const val = $("#msginput").val();
        if (!val || !socket || socket.readyState !== 1) return;

        let finalRawCommand = "";
        let replyDisplayHtml = "";

        if (pendingReply.id) {
            finalRawCommand = `@reply-parent-msg-id=${pendingReply.id} PRIVMSG #${CHANNEL} :${val}`;
            let originalText = msgCache[pendingReply.id] || "...";
            replyDisplayHtml = `<div class="quote-box">回覆<span class="quote-user">@${pendingReply.user}:</span>${originalText}</div>`;
        } else {
            finalRawCommand = `PRIVMSG #${CHANNEL} :${val}`;
        }

        socket.send(finalRawCommand);
        const selfTs = Date.now().toString();
        msgCache[selfTs] = val;
        
        $("#messages").append(`<div class="chat-line">${replyDisplayHtml}<b class="self-name">${myDisplayName || myLoginId}:</b> ${parseContent(val)}</div>`);
        $("#chat-container").scrollTop($("#chat-container")[0].scrollHeight);
        
        cancelReply();
        $("#msginput").val("");
    }

    function startChat() {
        if(socket) socket.close();
        socket = new WebSocket('wss://irc-ws.chat.twitch.tv:443');
        socket.onopen = () => {
            socket.send('CAP REQ :twitch.tv/tags twitch.tv/commands');
            socket.send(`PASS oauth:${ACCESS_TOKEN || 'dummy'}`);
            socket.send(`NICK ${ACCESS_TOKEN ? 'user' : 'justinfan'+Math.floor(Math.random()*1000)}`);
            socket.send(`JOIN #${CHANNEL}`);
        };
        socket.onmessage = (e) => {
            if (!e.data.includes('PRIVMSG')) return;
            const parts = e.data.split(` PRIVMSG #${CHANNEL} :`), tags = parts[0], rawMsg = parts[1].trim();
            const user = tags.match(/display-name=([^;]+)/)?.[1] || "User", color = tags.match(/color=([^;]+)/)?.[1] || "#9147ff";
            const msgId = tags.match(/id=([^;]+)/)?.[1];
            
            if (msgId) msgCache[msgId] = rawMsg;

            let replyHtml = "";
            const pUser = tags.match(/reply-parent-display-name=([^;]+)/)?.[1];
            const pBodyRaw = tags.match(/reply-parent-msg-body=([^;]+)/)?.[1];
            let displayMsg = rawMsg;

            if(pUser) {
                let isMe = (pUser === myDisplayName || pUser === myLoginId);
                let pBody = pBodyRaw.replace(/\\s/g, " ");
                const userTagClass = isMe ? 'quote-user mention-self-tag' : 'quote-user';
                replyHtml = `<div class="quote-box"><span class="${userTagClass}">@${pUser}:</span>${pBody}</div>`;
                const mentionPrefix = `@${pUser} `;
                if (displayMsg.startsWith(mentionPrefix)) { displayMsg = displayMsg.substring(mentionPrefix.length); }
            } 
            else if (rawMsg.includes("[r]")) {
                const myR = rawMsg.match(/\[r\](.*?),([\d\w-]+)\[m\]/);
                if(myR) {
                    let isMe = (myR[1] === myDisplayName || myR[1] === myLoginId);
                    let body = msgCache[myR[2]] || "...";
                    const userTagClass = isMe ? 'quote-user mention-self-tag' : 'quote-user';
                    replyHtml = `<div class="quote-box"><span class="${userTagClass}">@${myR[1]}:</span>${body}</div>`;
                    displayMsg = rawMsg.replace(/\[r\](.*?),([\d\w-]+)\[m\]/gi, "");
                }
            }

            const badgeStr = tags.match(/badges=([^;]*)/)?.[1];
            const line = `<div class="chat-line">
                <div class="reply-btn" onclick="replyNative('${user}','${msgId}')">RE</div>
                ${replyHtml}
                ${parseBadges(badgeStr)}
                <b style="color:${color}">${user}:</b> ${parseContent(displayMsg)}
            </div>`;
            
            $("#messages").append(line);
            $("#chat-container").scrollTop($("#chat-container")[0].scrollHeight);
        };
    }

    function replyNative(u, id) {
        pendingReply = { id: id, user: u };
        $("#replying-to-user").text(u);
        $("#reply-indicator").css('display', 'block');
        $("#msginput").val("").focus();
    }

    function cancelReply() {
        pendingReply = { id: null, user: null };
        $("#reply-indicator").hide();
    }

    function parseBadges(s) {
        if(!s || !customBadges) return "";
        let h = ""; s.split(',').forEach(b => { const k = b.split('/')[0], u = customBadges[b] || customBadges[k]; if(u) h += `<img class="badge" src="${u}">`; });
        return h;
    }

    function setupAutoTag() {
        const input = document.getElementById('msginput');
        input.addEventListener('paste', (e) => {
            const data = (e.clipboardData || window.clipboardData).getData('text');
            if (!data.match(/^https?:\/\//i)) return;
            const start = input.selectionStart;
            const textBefore = input.value.substring(0, start).trim();
            if (textBefore.endsWith('[s]')) { e.preventDefault(); insertAtCursor(data + ' [e]'); }
            else if (textBefore.endsWith('[y]')) { e.preventDefault(); insertAtCursor(data + ' [t]'); }
        });
    }

    function insertTagOnly(s) { const i = $("#msginput")[0], st = i.selectionStart; i.value = i.value.substring(0, st) + s + i.value.substring(i.selectionEnd); i.focus(); }
    function insertAtCursor(v) { const i = $("#msginput")[0], st = i.selectionStart; i.value = i.value.substring(0, st) + v + i.value.substring(i.selectionEnd); i.focus(); }
    function fetchBadges() { return $.getJSON("https://chicktv.github.io/tv/badges.txt", d => customBadges = d); }
    $(document).on('keypress', '#msginput', e => { if (e.which == 13) sendMessage(); });
</script>
</body>
</html>
