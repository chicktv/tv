<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Twitch Ultimate Console v4.4 - Social Media Support</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        :root { --t-bg: #0e0e10; --t-alt: #18181b; --t-purp: #9147ff; --t-text: #efeff1; }
        body { background: var(--t-bg); color: var(--t-text); font-family: sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        .header-bar { background: var(--t-alt); padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; flex-shrink: 0; }
        #chat-container { flex-grow: 1; overflow-y: auto; padding: 15px; background: #000; }
        .media-preview { max-width: 200px !important; border-radius: 6px; margin-top: 10px; display: block; border: 1px solid #444; overflow: hidden; }
        .alt-emoji { max-width: 150px !important; max-height: 150px !important; vertical-align: middle; margin: 2px; }
        .sk-user-icon { width: 24px; height: 24px; border-radius: 4px; vertical-align: middle; margin-right: 8px; border: 1px solid #444; object-fit: cover; }
        .badge { width: 18px; height: 18px; vertical-align: middle; margin-right: 4px; }
        .chat-line { position: relative; margin-bottom: 8px; padding: 10px 45px 10px 10px; border-radius: 4px; line-height: 1.6; word-wrap: break-word; background: rgba(255,255,255,0.02); }
        .chat-line:hover { background: rgba(255,255,255,0.08); }
        .reply-btn { position: absolute; right: 10px; top: 10px; width: 28px; height: 28px; background: #2f2f35; border-radius: 4px; display: none; align-items: center; justify-content: center; cursor: pointer; color: #fff; z-index: 10; font-size: 10px; }
        .chat-line:hover .reply-btn { display: flex; }
        .quote-box { font-size: 12px; color: #adadb8; background: rgba(0,0,0,0.5); padding: 8px; border-radius: 4px; margin-bottom: 8px; border-left: 3px solid var(--t-purp); }
        #emojiPanel { position: fixed; display: none; width: 450px; height: 500px; background: #1f182e; border: 2px solid #443a5a; border-radius: 12px; z-index: 5000; left: 50%; top: 50%; transform: translate(-50%, -50%); flex-direction: column; box-shadow: 0 20px 50px rgba(0,0,0,0.9); }
        #emojiTabs { display: flex; gap: 10px; padding: 12px; background: #0e0e10; overflow-x: auto; border-bottom: 1px solid #333; min-height: 60px; align-items: center; flex-shrink: 0; }
        #emojiContent { flex: 1; overflow-y: auto; padding: 15px; display: grid; grid-template-columns: repeat(auto-fill, minmax(50px, 1fr)); gap: 12px; background: #18181b; align-content: start; }
        .emoji-tab { width: 36px; height: 36px; background-size: contain; background-repeat: no-repeat; background-position: center; cursor: pointer; border: 2px solid transparent; border-radius: 4px; flex-shrink: 0; opacity: 0.6; }
        .emoji-tab.active { border-color: var(--t-purp); background-color: #26262c; opacity: 1; }
        .emoji-item { cursor: pointer; display: flex; align-items: center; justify-content: center; height: 50px; }
        .emoji-item img { max-width: 100%; max-height: 100%; }
        .footer { padding: 15px; background: var(--t-alt); border-top: 1px solid #333; flex-shrink: 0; }
        #msginput { width: 100%; background: #000; border: 1px solid #444; color: #fff; padding: 12px; border-radius: 4px; outline: none; box-sizing: border-box; }
    </style>
</head>
<body onload="initApp()">

<div class="header-bar">
    <div style="font-weight:bold;">Twitch Console v4.4</div>
    <div id="auth-area"><button onclick="twitchLoginPopup()" style="background:var(--t-purp); color:white; border:none; padding:8px 16px; border-radius:4px; cursor:pointer;">登入</button></div>
</div>

<div id="chat-container"><div id="messages"></div></div>

<div id="emojiPanel">
    <div style="padding:12px; display:flex; justify-content:space-between; background:#26262c; border-radius: 12px 12px 0 0;">
        <strong>資源與表情包</strong>
        <span onclick="$('#emojiPanel').hide()" style="cursor:pointer; font-size:20px;">&times;</span>
    </div>
    <div id="emojiTabs"></div>
    <div id="emojiContent"></div>
</div>

<div class="footer">
    <div style="display:flex; gap:8px; margin-bottom:12px;">
        <button onclick="insertTag('[s] ', ' [e]')" style="padding:8px 12px; background:#2f2f35; color:white; border:none; border-radius:4px; cursor:pointer;">圖片</button>
        <button onclick="insertTag('[y] ', ' [t]')" style="padding:8px 12px; background:#2f2f35; color:white; border:none; border-radius:4px; cursor:pointer;">影片</button>
        <button onclick="$('#emojiPanel').css('display','flex')" style="padding:8px 12px; background:#2f2f35; color:white; border:none; border-radius:4px; cursor:pointer;">☺ 表情</button>
    </div>
    <input id="msginput" type="text" placeholder="系統載入中..." autocomplete="off">
</div>

<script>
    const CHANNEL = "69nocondom";
    const CLIENT_ID = '0uhjgjpko804ba35q1nj1h6x2eriq9';
    let ACCESS_TOKEN = "", socket, userIcons = {}, altMap = {}, emojiSets = {}, customBadges = {}, msgCache = {};

    async function initApp() {
        if (window.location.hash) {
            const params = new URLSearchParams(window.location.hash.substring(1));
            const token = params.get("access_token");
            if (window.opener && token) { window.opener.postMessage({ type: "TWITCH_TOKEN", token: token }, "*"); window.close(); return; }
        }
        await fetchUserIcons();
        await fetchBadges();
        await loadResources();
        startChat();
        $("#msginput").attr("placeholder", "傳送訊息...");
    }

    function fetchUserIcons() {
        return $.getJSON("https://chicktv.github.io/tv/skuser_icon.txt", data => {
            if (Array.isArray(data)) {
                data.forEach(item => { if (item.alt) userIcons[item.alt.toLowerCase()] = item.src; });
                emojiSets["常用"] = data;
                const $tab = $('<div class="emoji-tab"></div>').css("background-image", `url(${data[0].src})`).attr("title", "常用").on('click', function() {
                    $(".emoji-tab").removeClass("active"); $(this).addClass("active"); renderEmojiList("常用");
                });
                $("#emojiTabs").append($tab);
            }
        });
    }

    function fetchBadges() { return $.getJSON("https://chicktv.github.io/tv/badges.txt", data => customBadges = data); }

    async function loadResources() {
        try {
            const data = await $.getJSON("https://chicktv.github.io/tv/showset.txt");
            for (const setItem of data.set) {
                let name = (typeof setItem === 'object') ? setItem.name : setItem;
                let img = (typeof setItem === 'object') ? setItem.image : "";
                if (!name || name === "skuser_icon") continue;
                try {
                    const d = await $.getJSON(`https://chicktv.github.io/tv/${name}.txt`);
                    emojiSets[name] = d[name] || [];
                    emojiSets[name].forEach(e => { if(e.alt) altMap[e.alt.toLowerCase()] = e.src; });
                    const $tab = $('<div class="emoji-tab"></div>').css("background-image", `url(${img})`).attr("title", name).on('click', function() {
                        $(".emoji-tab").removeClass("active"); $(this).addClass("active"); renderEmojiList(name);
                    });
                    $("#emojiTabs").append($tab);
                } catch (e) {}
            }
            if ($(".emoji-tab").length > 0) $(".emoji-tab").first().click();
        } catch (e) {}
    }

    function renderEmojiList(name) {
        const content = $("#emojiContent").empty();
        if (!emojiSets[name]) return;
        emojiSets[name].forEach(e => {
            $('<div class="emoji-item"></div>').append($('<img>').attr('src', e.src).attr('title', e.alt)).on('click', () => insertAtCursor(` ${e.alt} `)).appendTo(content);
        });
    }

    function startChat() {
        if(socket) socket.close();
        socket = new WebSocket('wss://irc-ws.chat.twitch.tv:443');
        socket.onopen = () => {
            socket.send('CAP REQ :twitch.tv/tags twitch.tv/commands');
            socket.send(ACCESS_TOKEN ? `PASS oauth:${ACCESS_TOKEN}` : 'PASS dummy');
            socket.send(ACCESS_TOKEN ? 'NICK dummy' : `NICK justinfan${Math.floor(Math.random()*1000)}`); 
            socket.send(`JOIN #${CHANNEL}`);
        };
        socket.onmessage = (e) => {
            if (!e.data.includes('PRIVMSG')) return;
            const parts = e.data.split(` PRIVMSG #${CHANNEL} :`), tags = parts[0], rawMsg = parts[1].trim();
            const user = tags.match(/display-name=([^;]+)/)?.[1] || "User", color = tags.match(/color=([^;]+)/)?.[1] || "#9147ff";
            const badgeStr = tags.match(/badges=([^;]*)/)?.[1], msgId = tags.match(/id=([^;]+)/)?.[1], ts = tags.match(/tmi-sent-ts=([\d]+)/)?.[1];
            const cacheKey = ts || msgId;

            let msg = rawMsg, replyHtml = "";
            const pUser = tags.match(/reply-parent-display-name=([^;]+)/)?.[1], pMsg = tags.match(/reply-parent-msg-body=([^;]+)/)?.[1];
            
            if (pUser) {
                replyHtml = `<div class="quote-box"><strong>@${pUser}</strong>: ${pMsg.replace(/\\s/g, " ")}</div>`;
            } else {
                msg = msg.replace(/\[r\](.*?),([\d\w-]+)\[m\]/gi, (m, u, k) => {
                    replyHtml = `<div class="quote-box"><strong>@${u}</strong>: ${msgCache[k] || "..."}</div>`; return "";
                });
            }

            // --- 媒體解析開始 ---
            msg = msg.replace(/\[s\](.*?)\[e\]/gi, (m, c) => `<img src="${c.trim()}" class="media-preview">`);
            msg = msg.replace(/\[y\](.*?)\[t\]/gi, (m, c) => {
                const v = c.trim().match(/(?:v=|\/shorts\/|youtu.be\/|embed\/)([^#&?]*)/)?.[1];
                return v ? `<iframe class="media-preview" width="200" height="150" src="https://www.youtube.com/embed/${v}" frameborder="0" allowfullscreen></iframe>` : m;
            });
            // X / Twitter
            msg = msg.replace(/(https?:\/\/(?:www\.)?(?:twitter\.com|x\.com)\/[a-zA-Z0-9_]+\/status\/([0-9]+))/gi, (m, url, id) => {
                return `<div class="media-preview" style="border:1px solid #333; padding:5px; font-size:12px;"><a href="${m}" target="_blank" style="color:#1da1f2;">推文連結</a><img src="${m.replace(/twitter\.com|x\.com/g, 'vxtwitter.com')}.jpg" style="width:100%; margin-top:5px;" onerror="this.style.display='none'"></div>`;
            });
            // Instagram
            msg = msg.replace(/(https?:\/\/(?:www\.)?instagram\.com\/(?:p|reels|reel)\/([^/?#& ]+))/gi, (m, url, id) => {
                return `<iframe class="media-preview" src="https://www.instagram.com/p/${id}/embed" width="200" height="280" frameborder="0" scrolling="no"></iframe>`;
            });
            // Steam
            msg = msg.replace(/(https?:\/\/store\.steampowered\.com\/app\/([0-9]+))/gi, (m, url, id) => {
                return `<iframe src="https://store.steampowered.com/widget/${id}/" frameborder="0" width="200" height="190" class="media-preview"></iframe>`;
            });
            // --- 媒體解析結束 ---

            msg = msg.split(' ').map(word => {
                const clean = word.trim().toLowerCase();
                const src = altMap[clean] || userIcons[clean];
                return src ? `<img src="${src}" class="alt-emoji" title="${word}">` : word;
            }).join(' ');

            msgCache[cacheKey] = msg;
            const skIcon = userIcons[user.toLowerCase()] ? `<img src="${userIcons[user.toLowerCase()]}" class="sk-user-icon">` : "";
            const html = `<div class="chat-line"><div class="reply-btn" onclick="reply('${user}','${cacheKey}')">RE</div>${replyHtml}${skIcon}${parseBadges(badgeStr)}<span style="color:${color};font-weight:bold;">${user}: </span><span>${msg}</span></div>`;
            $("#messages").append(html);
            $("#chat-container").scrollTop($("#chat-container")[0].scrollHeight);
        };
    }

    function parseBadges(bStr) {
        if (!bStr || !customBadges) return "";
        let h = "";
        bStr.split(',').forEach(b => {
            const key = b.split('/')[0].trim();
            const url = customBadges[b.trim()] || customBadges[key + "/1"] || customBadges[key];
            if (url) h += `<img class="badge" src="${url}">`;
        });
        return h;
    }
    function insertTag(s, e) { const el = document.getElementById("msginput"); const st = el.selectionStart, en = el.selectionEnd; el.value = el.value.substring(0, st) + s + el.value.substring(st, en) + e + el.value.substring(en); el.focus(); }
    function insertAtCursor(v) { const el = document.getElementById("msginput"); const st = el.selectionStart; el.value = el.value.substring(0, st) + v + el.value.substring(el.selectionEnd); el.focus(); }
    function reply(u, k) { $("#msginput").val(`[r]${u},${k}[m] @${u} `).focus(); }
    function twitchLoginPopup() { const url = `https://id.twitch.tv/oauth2/authorize?client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(window.location.href.split('#')[0])}&response_type=token&scope=chat:read+chat:edit`; window.open(url, "TwitchLogin", "width=500,height=600"); }
    window.addEventListener("message", (e) => { if (e.data.type === "TWITCH_TOKEN") { ACCESS_TOKEN = e.data.token; startChat(); } });
    $(document).on('keypress', '#msginput', e => { if (e.which == 13 && $("#msginput").val()) { socket.send(`PRIVMSG #${CHANNEL} :${$("#msginput").val()}`); $("#msginput").val(""); } });
</script>
</body>
</html>
