<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>chickchat</title>
<style>
    /* ========== Twitch Dark Theme ========== */
    body {
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
        background: #0e0e10;
        color: #efeff1;
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        line-height: 1.4;
        height: 100vh;
        display: flex;
        flex-direction: column;
    }
    
    #status {
        margin: 8px 12px;
        font-weight: 500;
        color: #bf94ff;
        font-size: 10px;
    }
    
    #userInfo {
        display: flex;
        align-items: center;
        gap: 8px;
        margin: 0 12px 8px;
        font-size: 13px;
    }
    
    #userInfo img {
        width: 30px;
        height: 30px;
        border-radius: 50%;
    }
    
    #logoutBtn {
        margin-left: auto;
        background: #e91916;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 6px 12px;
        cursor: pointer;
        font-size: 12px;
        font-weight: 600;
        transition: background-color 0.2s;
    }
    
    #logoutBtn:hover {
        background: #c51614;
    }
    
    #chat-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        background: #0e0e10;
        position: relative;
    }
    
    #chat {
        flex: 1;
        overflow-y: auto;
        white-space: wrap; 
        background: #0e0e10;
        padding: 12px;
        border-radius: 0;
        border: 1px solid #26262c;
        font-size: 14px;
        scroll-behavior: smooth;
    }
    
    #input-container {
        background: #1f1f23;
        padding: 1px 1px;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    /* å­—æ•¸è¨ˆæ•¸å™¨æ¨£å¼ */
.char-counter {
    position: absolute;
    right: 40px;
    bottom: 5px;
    font-size: 12px;
    color: #adadb8;
    pointer-events: none;
    padding: 2px 6px;
    border-radius: 4px;
}

.char-counter.over-limit {
    color: #e91916;
    font-weight: bold;
}

.char-counter.near-limit {
    color: #ffd400;
}

/* èª¿æ•´è¼¸å…¥æ¡†å®¹å™¨ä½ç½® */
.chat-input-wrapper {
    display: flex;
    align-items: flex-start;
    background: #0e0e10;
    border-radius: 4px;
    padding: 5px 5px;
    position: relative;
}

    /* ä¿®æ”¹è¼¸å…¥æ¡†ç‚º textarea ä¸¦èª¿æ•´æ¨£å¼ */
    .chat-input {
        flex: 1;
        background: transparent;
        color: #efeff1;
        font-size: 14px;
        outline: none;
        flex-wrap: wrap;
        resize: none;
        min-height: 40px;
        max-height: 120px;
        font-family: inherit;
        line-height: 1.4;
        padding: 8px 0;
		border-radius: 0.2rem;
    }

    .chat-input::placeholder {
        color: #adadb8;
    }

    .chat-buttons {
        display: flex;
        gap: 8px;
        margin-top: 5px;
    }

    .chat-button {
        background: transparent;
        border: none;
        color: #9147ff;
        cursor: pointer;
        padding: 4px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .chat-button:hover {
        background: #3a3a3d;
    }
    
	/* éŸ³è¨Šæ’­æ”¾å™¨æ¨£å¼ */
.audio-player {
    max-width: 300px !important;
    background: #1f1f23 !important;
    border-radius: 8px !important;
    padding: 8px !important;
    margin: 4px 0 !important;
    border: 1px solid #3a3a3d !important;
}

.audio-player audio {
    width: 100% !important;
    height: 40px !important;
    background: #0e0e10 !important;
    border-radius: 4px !important;
}

.audio-info {
    font-size: 11px;
    color: #adadb8;
    margin-top: 4px;
    text-align: center;
}
	
	/* éŸ³è¨Šå–‡å­åœ–æ¨™æ¨£å¼ */
.audio-icon {
    display: inline-block;
    background: #9147ff;
    color: white;
    border-radius: 50%;
    width: 32px;
    height: 32px;
    text-align: center;
    line-height: 32px;
    font-size: 16px;
    cursor: pointer;
    margin: 2px;
    vertical-align: middle;
    transition: all 0.2s ease;
    position: relative;
}

.audio-icon:hover {
    background: #772ce8;
    transform: scale(1.1);
}

.audio-icon.playing {
    background: #e91916;
    animation: pulse 1s infinite;
}

@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.1); }
    100% { transform: scale(1); }
}

/* éš±è—çš„éŸ³è¨Šå…ƒç´  */
.hidden-audio {
    position: absolute;
    opacity: 0;
    pointer-events: none;
    width: 0;
    height: 0;
}


/* éŸ³è¨Šåˆ†é æ¨£å¼ */
.audio-item {
    position: relative;
    width: 40px;
    height: 40px;
    background: #3a3a3d;
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    padding: 4px;
    transition: background-color 0.2s;
}

.audio-item:hover {
    background: #53535f;
}

.audio-item.playing {
    background: #9147ff;
}

.audio-icon-small {
    font-size: 16px;
    margin-bottom: 2px;
}

.audio-name {
    font-size: 10px;
    text-align: center;
    word-break: break-word;
    line-height: 1.2;
    max-width: 100%;
    
    text-overflow: ellipsis;
    white-space: wrap;
}
.audio-item .delete-btn {
    position: absolute;
    top: -8px;
    right: -8px;
    background: #e91916;
    color: white;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    font-size: 12px;
    line-height: 20px;
    text-align: center;
    cursor: pointer;
    display: none;
    z-index: 10;
}

.audio-item:hover .delete-btn {
    display: block;
}

/* éŸ³è¨Šè¼¸å…¥è¡¨å–®æ¨£å¼ */
.audio-input-form {
   
    width: 95%;
    display: flex;
    gap: 1px;
    margin-bottom: 2px;

}

.audio-input-row {
    display: flex;
    gap: 6px;
}

.audio-input-row input {
    flex: 1;
    padding: 6px;
    background: #0e0e10;
    color: white;
    border: 1px solid #3a3a3d;
    border-radius: 4px;
    font-size: 12px;
}

.audio-input-row input:focus {
    outline: none;
    border-color: #9147ff;
}

.audio-buttons {
    display: flex;
    gap: 6px;
}

.audio-buttons button {
    flex: 1;
    padding: 6px;
    background: #9147ff;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 12px;
    transition: background-color 0.2s;
}

.audio-buttons button:hover {
    background: #772ce8;
}

.audio-buttons button.delete-mode {
    background: #e91916;
}

.audio-buttons button.delete-mode:hover {
    background: #c51614;
}
	
	/* @åŠŸèƒ½æ¨£å¼ */

    .mention-autocomplete {

        position: absolute;

        bottom: 100%;

        left: 0;

        right: 0;

        background: #18181b;

        border: 1px solid #26262c;

        border-radius: 4px;

        max-height: 200px;

        overflow-y: auto;

        z-index: 1000;

        box-shadow: 0 4px 12px rgba(0,0,0,0.5);

        display: none;

    }

    

    .mention-item {

        padding: 8px 12px;

        cursor: pointer;

        display: flex;

        align-items: center;

        gap: 8px;

        border-bottom: 1px solid #26262c;

    }

    

    .mention-item:last-child {

        border-bottom: none;

    }

    

    .mention-item:hover, .mention-item.active {

        background: #9147ff;

        color: white;

    }

    

    .mention-item img {

        width: 20px;

        height: 20px;

        border-radius: 50%;

    }

    

    .mention-item .username {

        font-weight: bold;

    }

    

    .mention-item .display-name {

        color: #adadb8;

    }

    

    .mention-item:hover .display-name, .mention-item.active .display-name {

        color: white;

    }

    

    /* @æåŠè¦–è¦ºåé¥‹æ¨£å¼ */

    .mention-highlight {

        background-color: #9147ff;

        color: #ffffff;

        padding: 2px 6px;

        border-radius: 4px;

        font-weight: bold;

    }

    

    /* è¢«æåŠçš„è¨Šæ¯å®¹å™¨æ¨£å¼ */

    .mentioned-message .msg-content {

        padding: 0;

    }
	
	
	
    #loginBtn {
        padding: 8px 16px;
        background: #9147ff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
        font-weight: 600;
        transition: background-color 0.2s;
        margin-top: 8px;
    }
    
    #loginBtn:hover {
        background: #772ce8;
    }
    
    #loginBtn:disabled {
        background: #464649;
        cursor: not-allowed;
    }
    
    .msg {
        margin: 4px 0;
        word-wrap: break-word;
        padding: 2px 0;
        position: relative;
    }
    
    .msg:hover .reply-btn {
        opacity: 1;
    }
    
    /* ä¿®æ”¹è¨Šæ¯å…§å®¹å¸ƒå±€ - ç§»é™¤ text-container */
    .msg-content {
        display: block;
        position: relative;
        width: 100%;
        line-height: 1.4;
        padding: 2px 0;
    }
    
    /* åç¨±å®¹å™¨ä½¿ç”¨æµ®å‹• */
    .name-container {
        float: left;
        margin-right: 6px;
        max-width: 30%;
    }
    
    /* æŒ‰éˆ•å®¹å™¨ä½¿ç”¨çµ•å°å®šä½åœ¨å³å´ */
    .button-container {
        position: absolute;
        right: 0;
        top: 0;
        white-space: nowrap;
        opacity: 0;
        transition: opacity 0.2s;
    }
    
    .msg:hover .button-container {
        opacity: 1;
    }
    
	 .msg-with-reply:hover .reply-btn {

        opacity: 1;

    }
	



.msg-with-reply .reply-btn:active {
    transform: scale(0.95) !important;
}
.msg-with-reply * {
    overflow: visible !important;
}

.msg-with-reply:hover .button-container {
    opacity: 1 !important;
}
.msg-with-reply .reply-btn:hover {
    opacity: 1 !important;
}
	
	
	
    /* ç¢ºä¿åç¨±å’Œæ–‡å­—åœ¨åŒä¸€è¡Œ */
    .name {
        font-weight: bold;
        color: inherit;
        white-space: nowrap;
        display: inline;
    }
    
    .message-text {
        display: inline;
        line-height: 1.4;
        word-break: break-word;
        overflow-wrap: break-word;
        white-space: normal;
    }
    
    /* å›è¦†è¨Šæ¯çš„èª¿æ•´ */
.msg-with-reply .msg-content {
    position: relative;
    display: block;
    width: 94%;
    padding-right: 80px !important; /* å¼·åˆ¶ç‚ºæŒ‰éˆ•é ç•™ç©ºé–“ */
    min-height: 40px;
    overflow: visible !important;
}


  .msg-with-reply .button-container {
    position: absolute !important;
    right: 70px !important;
    top: 40% !important;
    transform: translateY(-70%) !important;

   
}

.msg-with-reply .button-container {
    position: absolute !important;
    right: 70px !important;
    top: 40% !important;
    transform: translateY(-70%) !important;
    
}



    /* å¿«é€ŸæŒ‰éˆ• */
    #pastebtn {
      position: relative;
      display: flex;
      gap: 0px;
      margin-top: 8px;
    }
    .sk_botton {
      position: relative;
      padding: 0 8px;
      height: 24px;
      line-height: 24px;
      font-size: 12px;
      background: #333;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-right: 4px;
    }
    
    .sk_botton:hover {
      background: #444;
    }

    /* é€£çµå’Œåª’é«”æ¨£å¼ */
    a {
        color: #bf94ff;
        text-decoration: none;
    }
    
    a:hover {
        text-decoration: underline;
    }
    
    /* ç¢ºä¿æ‰€æœ‰åª’é«”å…ƒç´ éƒ½æœ‰ç›¸åŒçš„å¤§å° */
    img.zero-width-image, 
    video.zero-width-image, 
    iframe.zero-width-image, 
    .zero-width-image {
        max-width: 250px !important;
        max-height: 200px !important;
        border-radius: 6px !important;
        object-fit: fill !important;
        background: #000 !important;
        flex-shrink: 0 !important;
        vertical-align: top !important;
        align-self: flex-start !important;
        padding: 0px !important;
    }

    /* å¦å¤–ç¢ºä¿æ™®é€šçš„ img, video, iframe ä¹Ÿæœ‰ç›¸åŒçš„å¤§å° */
    img, video, iframe {
        max-width: 150px !important;
        max-height: 150px !important;
        border-radius: 6px !important;
        object-fit: fill !important;
        background: #000 !important;
        flex-shrink: 0 !important;
        vertical-align: top !important;
        align-self: flex-start !important;
        padding: 0px !important;
    }
    
    video {
        background: #000;
    }
    
    iframe {
        border: none;
    }

    /* è¡¨æƒ…é¢æ¿æ¨£å¼ */
    .emoji-panel {
        position: fixed;
        background: #18181b;
        border: 1px solid #26262c;
        border-radius: 4px;
        z-index: 999999;
        width: 380px;
        height: 460px;
        display: none;
        box-shadow: 0 0 30px rgba(0,0,0,0.9);
        color: white;
        flex-direction: column;
        font-size: 13px;
    }
    
    .emoji-header {
        background: #9147ff;
        padding: 12px;
        text-align: center;
        cursor: move;
        font-weight: 600;
        border-radius: 4px 4px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .emoji-close-btn {
        background: none;
        border: none;
        color: white;
        font-size: 18px;
        cursor: pointer;
        width: 24px;
        height: 24px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.2s;
    }
    
    .emoji-close-btn:hover {
        background: rgba(255, 255, 255, 0.2);
    }
    
    .emoji-tabs {
        display: flex;
        flex-wrap: wrap;
        background: #1f1f23;
        padding: 8px;
        gap: 5px;
        overflow-x: auto;
        border-bottom: 1px solid #26262c;
    }
    
    .emoji-tab {
        width: 36px;
        height: 36px;
        background: #3a3a3d;
        border-radius: 4px;
        cursor: pointer;
        background-size: cover;
        background-position: center;
        flex-shrink: 0;
    }
    
    .emoji-tab.active {
        outline: 2px solid #9147ff;
    }
    
    .emoji-content {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
    background: #18181b;
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
    align-content: flex-start;

}
    
    .emoji-item {
		position: relative;
         width: 40px;
        height: 40px;
        border-radius: 4px;
        cursor: pointer;
    }
    
    .emoji-item img {
        width: 40px;
        height: 40px;
        border-radius: 4px;
        cursor: pointer;
    }
    
    .delete-btn {
        position: absolute;
        top: -8px;
        right: -8px;
        background: #e91916;
        color: white;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        font-size: 12px;
        line-height: 20px;
        text-align: center;
        cursor: pointer;
        display: none;
    }
    
    .emoji-item:hover .delete-btn {
        display: block;
    }
    
    .bttv-input {
        width: 100%;
        display: flex;
        gap: 6px;
        margin-bottom: 10px;
		
    }
    
    .bttv-input input {
        flex: 1;
        padding: 8px;
        background: #1f1f23;
        color: white;
        border: 1px solid #3a3a3d;
        border-radius: 4px;
    }
    
    .bttv-input input:focus {
        outline: none;
        border-color: #9147ff;
    }
    
    /* æ²è»¸æ¨£å¼ */
    #chat::-webkit-scrollbar {
        width: 8px;
    }
    
    #chat::-webkit-scrollbar-track {
        background: #1f1f23;
    }
    
    #chat::-webkit-scrollbar-thumb {
        background: #3a3a3d;
        border-radius: 4px;
    }
    
    #chat::-webkit-scrollbar-thumb:hover {
        background: #53535f;
    }
    
    .emoji-content::-webkit-scrollbar {
        width: 6px;
    }
    
    .emoji-content::-webkit-scrollbar-track {
        background: #1f1f23;
    }
    
    .emoji-content::-webkit-scrollbar-thumb {
        background: #3a3a3d;
        border-radius: 3px;
    }
    
      /* å›è¦†åŠŸèƒ½æ¨£å¼ */
    .reply-btn {
        opacity: 0;
        background: none;
        border: none;
        color: #adadb8;
        font-size: 12px;
        cursor: pointer;
        padding: 4px 6px;
        transition: all 0.2s;
        border-radius: 3px;
        white-space: nowrap;
        flex-shrink: 0;
    }
    
    .reply-btn:hover {
        background: #3a3a3d;
        color: #efeff1;
    }
    
    .reply-indicator {
        display: flex;
        align-items: center;
        background: #1f1f23;
        padding: 6px 10px;
        border-radius: 4px;
        margin-bottom: 8px;
        font-size: 12px;
        color: #adadb8;
    }
    
    .reply-indicator .cancel-reply {
        margin-left: auto;
        background: none;
        border: none;
        color: #adadb8;
        cursor: pointer;
        font-size: 12px;
        padding: 2px 6px;
        border-radius: 3px;
    }
    
    .reply-indicator .cancel-reply:hover {
        background: #3a3a3d;
        color: #efeff1;
    }
    
    .reply-preview {
        background: #1f1f23;
        padding: 8px;
        border-radius: 4px;
        margin-bottom: 8px;
        border-left: 3px solid #9147ff;
        font-size: 12px;
        color: #adadb8;
    }
    
    .reply-preview .replying-to {
        font-weight: bold;
        color: #9147ff;
    }
    
    /* æ”¹é€²çš„å›è¦†è¨Šæ¯æ¨£å¼ */
    .reply-context {
        font-size: 11px;
        color: #adadb8;
        margin-bottom: 4px;
        display: flex;
        align-items: center;
    }
    
    .reply-context .reply-icon {
        margin-right: 4px;
        color: #9147ff;
    }
    
    .reply-context .replying-to {
        font-weight: bold;
        color: #9147ff;
    }
    
    .reply-message {
        background: #1f1f23;
        border-left: 2px solid #9147ff;
        padding: 6px 8px;
        margin-bottom: 6px;
        border-radius: 0 4px 4px 0;
        font-size: 12px;
        color: #adadb8;
        display: flex;
        align-items: flex-start;
    }
    
    .reply-message .reply-avatar {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        margin-right: 6px;
        flex-shrink: 0;
    }
    
    .reply-message .reply-content {
        flex: 1;
        overflow: hidden;
    }
    
    .reply-message .reply-username {
        font-weight: bold;
        color: #9147ff;
        margin-right: 6px;
        font-size:14px;
        font-weight: bold;
        flex-shrink: 0;
    }
    
    .reply-message .reply-text {
        color: #adadb8;
        word-break: break-word;
        line-height: 1.3;
    }
    
    .reply-message .reply-arrow {
        color: #9147ff;
        margin-right: 6px;
        font-size: 10px;
    }
    
    .reply-container {
        margin-bottom: 8px;
    }
    
    /* æ”¹é€²çš„å®Œæ•´å›è¦†è¨Šæ¯å®¹å™¨ */
    .msg-with-reply {
    position: relative;
    background: rgba(30, 30, 35, 0.7);
    border-radius: 8px;
    margin: 8px 0;
    padding: 12px;
    border: 1px solid rgba(255, 255, 255, 0.1);
    overflow: visible !important; /* ç¢ºä¿ä¸è£å‰ªå…§å®¹ */
}
    .reply-header {
        display: flex;
        align-items: center;
        padding: 6px 12px;
        background: rgba(31, 31, 35, 0.8);
        display:none;
        font-size: 11px;
        color: #bf94ff;
    }
    
    .reply-header .reply-icon {
        margin-right: 6px;
        font-size: 10px;
    }
    
    .reply-header .reply-username {
        font-weight: bold;
        margin-right: 0px;
    }
    
    .reply-original {
        padding: 8px 12px;
        background: rgba(31, 31, 35, 0.8);
        margin: 0;
        font-size: 12px;
        color: #adadb8;
        max-height: 60px;
        overflow: hidden;
        line-height: 1.3;
    }
    
    .reply-original .original-username {
        font-weight: bold;
        color: #9147ff;
        margin-right: 6px;
    }
    
    /* å¾½ç« æ¨£å¼ */
    .badge {
        width: 18px;
        height: 18px;
        margin-right: 4px;
        vertical-align: middle;
    }
    
    /* ========== æ–°æ·»åŠ ï¼šæ²å‹•åˆ°åº•éƒ¨æŒ‰éˆ• ========== */
    #scrollToBottomBtn {
        position: absolute;
        bottom: 80px;
        right: 20px;
        width: 40px;
        height: 40px;
        background: rgba(145, 71, 255, 0.8);
        color: white;
        border: none;
        border-radius: 50%;
        cursor: pointer;
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 100;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        transition: all 0.3s ease;
        font-size: 20px;
    }
    
    #scrollToBottomBtn:hover {
        background: rgba(145, 71, 255, 1);
        transform: scale(1.1);
    }
    
    #scrollToBottomBtn:active {
        transform: scale(0.95);
    }
    
    #scrollToBottomBtn svg {
        width: 24px;
        height: 24px;
    }
</style>
</head>
<body>
    <div id="status">è¼‰å…¥ä¸­...</div>
    
    <div id="userInfo" style="display:none;">
        <img id="userAvatar" src="" alt="é ­åƒ">
        <span id="userName"></span>
        <button id="logoutBtn">ç™»å‡º</button>
    </div>
    
    <div id="chat-container">
        <div id="chat"></div>
        <button id="scrollToBottomBtn" title="æ»¾å‹•åˆ°æœ€æ–°è¨Šæ¯" style="font-size: 24px; line-height: 1;">â‡£</button>
		 <div id="pastebtn">
            <button id="pastephoto" data-name="photo" type="button" class="sk_botton">åœ–ç‰‡</button>
            <button id="pastevideo" type="button" class="sk_botton" data-name="video">å½±ç‰‡</button>
			<button id="pasteaudio" type="button" class="sk_botton" data-name="audio">éŸ³è¨Š</button>
			   <button class="chat-button" id="emojiBtn" title="è¡¨æƒ…">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M10 2C5.58 2 2 5.58 2 10s3.58 8 8 8 8-3.58 8-8-3.58-8-8-8zm0 14.5c-3.59 0-6.5-2.91-6.5-6.5S6.41 3.5 10 3.5s6.5 2.91 6.5 6.5-2.91 6.5-6.5 6.5zM6.5 9c.83 0 1.5-.67 1.5-1.5S7.33 6 6.5 6 5 6.67 5 7.5 5.67 9 6.5 9zm7 0c.83 0 1.5-.67 1.5-1.5S14.33 6 13.5 6 12 6.67 12 7.5s.67 1.5 1.5 1.5zM10 14c-1.66 0-3.14-.69-4.2-1.8l1.41-1.41C7.83 11.53 8.84 12 10 12s2.17-.47 2.79-1.21l1.41 1.41C13.14 13.31 11.66 14 10 14z"/>
                    </svg>
                </button>
        </div>
        <div id="replyIndicator" class="reply-indicator" style="display: none;">
            <span>å›è¦†çµ¦ <span id="replyTargetName"></span></span>
            <button class="cancel-reply" id="cancelReplyBtn">å–æ¶ˆ</button>
        </div>
    </div>
    
    <div id="input-container">
        <div class="chat-input-wrapper">
            <textarea id="msgInput" class="chat-input" placeholder="ç™»å…¥å¾Œå³å¯ç™¼è¨€..." autocomplete="off" disabled rows="1"></textarea>
            <div class="mention-autocomplete" id="mentionAutocomplete"></div>
			<div id="charCounter" class="char-counter">0/500</div>
            <div class="chat-buttons">
              
                <button class="chat-button" id="sendBtn" disabled title="é€å‡ºè¨Šæ¯">
                    <svg width="20" height="40" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M2.93 4.26l14.76-2.66c.95-.17 1.73.61 1.56 1.56L15.74 17.1c-.2 1.09-1.57 1.41-2.23.49l-3.14-4.37-2.66 2.66c-.39.39-1.02.39-1.41 0-.39-.39-.39-1.02 0-1.41l2.66-2.66L1.44 6.49c-.92-.66-.6-2.03.49-2.23z"/>
                    </svg>
                </button>
            </div>
        </div>
        
       
        
        <button id="loginBtn">TWITCH ç™»å…¥</button>
    </div>

    <!-- è‡ªè¨‚è¡¨æƒ…é¢æ¿ -->
    <div id="emojiPanel" class="emoji-panel">
        <div class="emoji-header">
            è‡ªè¨‚è¡¨æƒ…é¢æ¿ï¼ˆæ‹–æ›³ç§»å‹•ï¼‰
            <button class="emoji-close-btn" id="emojiCloseBtn" title="é—œé–‰">Ã—</button>
        </div>
        <div class="emoji-tabs" id="emojiTabs"></div>
        <div class="emoji-content" id="emojiContent"></div>
    </div>

    <script src="https://chicktv.github.io/tv/tmi.min.js"></script>

    <script>
  // ===================== é‡è¦è¨­å®š =====================
    const CLIENT_ID = '0uhjgjpko804ba35q1nj1h6x2eriq9';
    const channel = "69nocondom";

    const REDIRECT_URI = encodeURIComponent(location.origin + location.pathname);
    const AUTH_URL = `https://id.twitch.tv/oauth2/authorize?client_id=${CLIENT_ID}&redirect_uri=${REDIRECT_URI}&response_type=token&scope=chat:read+chat:edit`;

    // ===================== å…¨åŸŸè®Šæ•¸ =====================
    let oauthToken = '';
    let username = 'justinfan666';
    let userDisplayName = '';
    let userAvatar = '';
    let client = null;
    let isConnected = false;
	
	// éŸ³è¨Šç³»çµ±è®Šæ•¸
    let audioLists = {};
    let isAudioDeleteMode = false;

    // æ²å‹•æ§åˆ¶è®Šæ•¸
    let autoScroll = true;
    let userScrolling = false;
    let scrollTimeout = null;

    const status   = document.getElementById('status');
    const chat     = document.getElementById('chat');
    const input    = document.getElementById('msgInput');
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const userInfo = document.getElementById('userInfo');
    const userAvatarEl = document.getElementById('userAvatar');
    const userNameEl   = document.getElementById('userName');
    const scrollToBottomBtn = document.getElementById('scrollToBottomBtn');

    // å›è¦†åŠŸèƒ½è®Šæ•¸
    let replyingTo = null;
    const replyIndicator = document.getElementById('replyIndicator');
    const replyTargetName = document.getElementById('replyTargetName');
    const cancelReplyBtn = document.getElementById('cancelReplyBtn');

    // è¡¨æƒ…ç³»çµ±
    let emojiLists = {};
    let altToEmojiMap = {};
    let isDeleteMode = false;

    // å¾½ç« æ˜ å°„
    let badgeMap = {};

    // @åŠŸèƒ½è®Šæ•¸
    let recentUsers = []; // å­˜å„²æœ€è¿‘ç™¼è¨€çš„ç”¨æˆ¶
    let mentionAutocomplete = document.getElementById('mentionAutocomplete');
    let mentionActive = false;
    let mentionIndex = -1;
    let mentionQuery = '';

    // æ­£å‰‡
    const youtubeRegex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
    const twitterImageRegex = /https?:\/\/pbs\.twimg\.com\/media\/[^?]+\?format=(jpg|jpeg|png|gif|webp)/i;
    const mp4Regex = /\.mp4(?:[/?].*)?$/i;

    // è¨Šæ¯è¨ˆæ•¸å™¨
    let messageCount = 0;
    const MAX_MESSAGES = 100;

    //é˜²æ­¢ XSS
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // ===================== æ²å‹•æ§åˆ¶åŠŸèƒ½ =====================
    function checkScrollPosition() {
        // æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦åœ¨åº•éƒ¨ï¼ˆè·é›¢åº•éƒ¨å°æ–¼50pxè¦–ç‚ºåœ¨åº•éƒ¨ï¼‰
        const isAtBottom = chat.scrollHeight - chat.clientHeight - chat.scrollTop < 50;
        
        if (isAtBottom) {
            // ç”¨æˆ¶åœ¨åº•éƒ¨ï¼Œå•Ÿç”¨è‡ªå‹•æ»¾å‹•
            autoScroll = true;
            hideScrollButton();
        } else {
            // ç”¨æˆ¶ä¸åœ¨åº•éƒ¨ï¼Œæš«åœè‡ªå‹•æ»¾å‹•
            autoScroll = false;
            showScrollButton();
        }
    }

    function showScrollButton() {
        scrollToBottomBtn.style.display = 'flex';
    }

    function hideScrollButton() {
        scrollToBottomBtn.style.display = 'none';
    }

    function scrollToBottom() {
        chat.scrollTop = chat.scrollHeight;
        autoScroll = true;
        hideScrollButton();
        
        // ç¢ºä¿æ»¾å‹•åˆ°æœ€åº•éƒ¨
        setTimeout(() => {
            chat.scrollTop = chat.scrollHeight;
        }, 50);
    }

    // ç›£è½æ²å‹•äº‹ä»¶
    chat.addEventListener('scroll', () => {
        // æ¸…é™¤ä¹‹å‰çš„è¨ˆæ™‚å™¨
        if (scrollTimeout) {
            clearTimeout(scrollTimeout);
        }
        
        // è¨­ç½®æ–°çš„è¨ˆæ™‚å™¨ï¼Œåœ¨åœæ­¢æ»¾å‹•å¾Œæª¢æŸ¥ä½ç½®
        scrollTimeout = setTimeout(() => {
            checkScrollPosition();
        }, 150);
    });

    // é»æ“Šæ»¾å‹•æŒ‰éˆ•
    scrollToBottomBtn.addEventListener('click', scrollToBottom);

    // ===================== å¾½ç« åŠŸèƒ½ =====================
    // è¼‰å…¥å¾½ç« æ˜ å°„https://www.streamdatabase.com/twitch/global-badges
    async function loadBadgeMap() {
        try {
            const response = await fetch('https://chicktv.github.io/tv/badges.txt');
            const data = await response.json();
            badgeMap = data;
            console.log('å¾½ç« æ˜ å°„è¼‰å…¥æˆåŠŸ');
        } catch (error) {
            console.error('è¼‰å…¥å¾½ç« æ˜ å°„å¤±æ•—:', error);
            // å¦‚æœè¼‰å…¥å¤±æ•—ï¼Œä½¿ç”¨é è¨­çš„å¾½ç« URLæ ¼å¼
            badgeMap = {};
        }
    }

    function parseBadges(badgesData) {
        if (!badgesData) return [];
        
        const badges = [];
        
        try {
            // è™•ç†ä¸åŒæ ¼å¼çš„å¾½ç« æ•¸æ“š
            let badgePairs = [];
            
            if (typeof badgesData === 'string') {
                // å¦‚æœæ˜¯å­—ä¸²æ ¼å¼ï¼š'broadcaster/1,moderator/1'
                badgePairs = badgesData.split(',');
            } else if (typeof badgesData === 'object') {
                // å¦‚æœæ˜¯ç‰©ä»¶æ ¼å¼ï¼š{broadcaster: '1', moderator: '1'}
                badgePairs = Object.entries(badgesData).map(([name, version]) => `${name}/${version}`);
            }
            
            for (const pair of badgePairs) {
                const [name, version] = pair.split('/');
                if (name && version) {
                    // å¾æ˜ å°„ä¸­ç²å–å¾½ç« URLï¼Œå¦‚æœæ²’æœ‰å‰‡ä½¿ç”¨é è¨­æ ¼å¼
                    const badgeKey = `${name}/${version}`;
                    let badgeUrl;
                    
                    if (badgeMap[badgeKey]) {
                        badgeUrl = badgeMap[badgeKey];
                    } else {
                        // å¦‚æœæ˜ å°„ä¸­æ²’æœ‰ï¼Œä½¿ç”¨é è¨­çš„Twitchå¾½ç« URLæ ¼å¼
                        badgeUrl = `https://static-cdn.jtvnw.net/badges/v1/${name}/${version}`;
                    }
                    
                    badges.push({
                        name: name,
                        displayName: name.charAt(0).toUpperCase() + name.slice(1), // é¦–å­—æ¯å¤§å¯«
                        url: badgeUrl,
                        version: version
                    });
                }
            }
        } catch (error) {
            console.error('è§£æå¾½ç« æ™‚ç™¼ç”ŸéŒ¯èª¤:', error, badgesData);
            return [];
        }
        
        return badges;
    }

    function renderBadges(badges) {
        if (!badges || badges.length === 0) return '';
        
        return badges.map(badge => 
            `<img src="${badge.url}" class="badge" title="${badge.displayName}" alt="${badge.displayName}" onerror="this.style.display='none'">`
        ).join('');
    }

    // ===================== å¼·åˆ¶æ»¾å‹•è§£æ±ºæ–¹æ¡ˆ =====================
    function forceScrollToBottom() {
        // åªæœ‰åœ¨å•Ÿç”¨è‡ªå‹•æ»¾å‹•æ™‚æ‰æ»¾å‹•
        if (autoScroll) {
            chat.scrollTop = chat.scrollHeight;
            
            const maxAttempts = 10;
            let attempts = 0;
            
            const scrollInterval = setInterval(() => {
                chat.scrollTop = chat.scrollHeight;
                attempts++;
                
                if (attempts >= maxAttempts) {
                    clearInterval(scrollInterval);
                }
            }, 100);
        }
    }

    // ===================== è¨Šæ¯é™åˆ¶åŠŸèƒ½ =====================
    function limitMessages() {
        // ç²å–æ‰€æœ‰è¨Šæ¯å…ƒç´ 
        const messages = chat.querySelectorAll('.msg, .msg-with-reply');
        
        // å¦‚æœè¨Šæ¯æ•¸é‡è¶…éé™åˆ¶ï¼Œç§»é™¤æœ€èˆŠçš„è¨Šæ¯
        if (messages.length > MAX_MESSAGES) {
            const messagesToRemove = messages.length - MAX_MESSAGES;
            for (let i = 0; i < messagesToRemove; i++) {
                if (messages[i]) {
                    messages[i].remove();
                }
            }
        }
    }

    // ===================== ç™»å…¥ç³»çµ± - å½ˆå‡ºè¦–çª—æ–¹æ¡ˆ =====================
    function checkLogin() {
        const saved = localStorage.getItem('twitch_token');
        if (saved) {
            oauthToken = saved;
            fetchUserInfo(saved.replace('oauth:', ''));
        } else {
            connectChat();
        }
    }

    function loginWithPopup() {
        if (CLIENT_ID.includes('è«‹å¡«å…¥')) {
            alert('è«‹å…ˆå¡«å…¥ CLIENT_IDï¼\nå‰å¾€ https://twitchapps.com/tmi/ é»ã€ŒConnect with Twitchã€å–å¾—');
            return;
        }
        
        const width = 600;
        const height = 700;
        const left = (screen.width - width) / 2;
        const top = (screen.height - height) / 2;
        
        const popup = window.open(
            AUTH_URL,
            'Twitch Login',
            `width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=yes,status=yes`
        );
        
        if (!popup || popup.closed || typeof popup.closed === 'undefined') {
            alert('å½ˆå‡ºè¦–çª—è¢«é˜»æ“‹äº†ï¼è«‹å…è¨±å½ˆå‡ºè¦–çª—ï¼Œæˆ–ä½¿ç”¨å…¶ä»–ç€è¦½å™¨ã€‚');
            return;
        }
        
        const checkPopup = setInterval(() => {
            if (popup.closed) {
                clearInterval(checkPopup);
                const token = localStorage.getItem('twitch_token');
                if (token) {
                    oauthToken = token;
                    fetchUserInfo(token.replace('oauth:', ''));
                }
            }
        }, 500);
    }

    async function fetchUserInfo(token) {
        try {
            const res = await fetch('https://api.twitch.tv/helix/users', {
                headers: { 'Client-ID': CLIENT_ID, 'Authorization': 'Bearer ' + token }
            });
            const data = await res.json();
            if (data.data?.[0]) {
                username = data.data[0].login;
                userDisplayName = data.data[0].display_name;
                userAvatar = data.data[0].profile_image_url;
                loginSuccess();
            }
        } catch (e) {
            console.error('å–å¾—ç”¨æˆ¶è³‡è¨Šå¤±æ•—:', e);
            alert('ç™»å…¥å¤±æ•—ï¼Œè«‹é‡æ–°ç™»å…¥');
            logout();
        }
    }

    function loginSuccess() {
        status.textContent = `å·²ç™»å…¥æˆåŠŸï¼š${userDisplayName}ï¼Œå¯ä»¥ç™¼è¨€å›‰ï¼`;
        input.disabled = false;
        document.getElementById('sendBtn').disabled = false;
        input.placeholder = "å‚³é€è¨Šæ¯";
        loginBtn.style.display = 'none';
        userInfo.style.display = 'none';
        userAvatarEl.src = userAvatar;
        userNameEl.textContent = userDisplayName;
        
        reconnectChat();
    }

    function logout() {
        localStorage.removeItem('twitch_token');
        location.reload();
    }

    loginBtn.onclick = loginWithPopup;
    logoutBtn.onclick = logout;

    window.addEventListener('load', async function() {
        // å…ˆè¼‰å…¥å¾½ç« æ˜ å°„
        await loadBadgeMap();
		 // åˆå§‹åŒ–å­—æ•¸è¨ˆæ•¸å™¨
        updateCharCounter();
    
	
        
        if (location.hash.includes('access_token=')) {
            const token = new URLSearchParams(location.hash.slice(1)).get('access_token');
            if (token) {
                oauthToken = 'oauth:' + token;
                localStorage.setItem('twitch_token', oauthToken);
                
                if (window.opener) {
                    window.close();
                } else {
                    history.replaceState(null, null, location.pathname);
                    fetchUserInfo(token);
                }
            }
        } else {
            checkLogin();
        }
    });

// ===================== ä¿®æ­£çš„è¨Šæ¯è™•ç†å‡½æ•¸ =====================
async function processMessage(text) {
    // å…ˆè§£ç¢¼ HTML å¯¦é«”
    function decodeHtmlEntities(text) {
        const textarea = document.createElement('textarea');
        textarea.innerHTML = text;
        return textarea.value;
    }
    
    let decodedText = decodeHtmlEntities(text);
    let html = decodedText;

    // é©—è­‰ URL æ˜¯å¦å®‰å…¨çš„å‡½æ•¸
    function isValidUrl(url) {
        try {
            const urlObj = new URL(url);
            // åªå…è¨± http å’Œ https å”è­°
            return urlObj.protocol === 'http:' || urlObj.protocol === 'https:';
        } catch {
            return false;
        }
    }

    // è™•ç†@æåŠé«˜äº® - åœ¨è™•ç†å…¶ä»–å…§å®¹ä¹‹å‰
    if (username && username !== 'justinfan666') {
        // ä¿®å¾©ï¼šåŒæ™‚æª¢æŸ¥ä½¿ç”¨è€…åç¨±å’Œé¡¯ç¤ºåç¨±
        const mentionRegex = new RegExp(`@${username}\\b`, 'gi');
        html = html.replace(mentionRegex, `<span class="mention-highlight">@${username}</span>`);
        
        // æ–°å¢ï¼šæª¢æŸ¥é¡¯ç¤ºåç¨±çš„æåŠ
        if (userDisplayName && userDisplayName !== username) {
            const displayNameMentionRegex = new RegExp(`@${escapeRegExp(userDisplayName)}(?=$|\\s|[\\.,!\\?\\)\\(])`, 'gi');
            html = html.replace(displayNameMentionRegex, `<span class="mention-highlight">@${userDisplayName}</span>`);
        }
    }

    // å…ˆè™•ç†è¡¨æƒ…ç¬¦è™Ÿ - åœ¨ HTML è½‰ç¾©ä¹‹å‰
    for (const [alt, data] of Object.entries(altToEmojiMap)) {
        try {
            // ä½¿ç”¨æ­£å‰‡è¡¨é”å¼è·³è„«å‡½æ•¸
            const escapedAlt = escapeRegExp(alt);
            // ä½¿ç”¨å–®è©é‚Šç•Œä¾†åŒ¹é…è¡¨æƒ…ç¬¦è™Ÿ
            const regex = new RegExp(`(^|\\s)(${escapedAlt})(?=$|\\s|[\\.,!\\?\\)\\(])`, 'gi');
            html = html.replace(regex, `$1<img src="${escapeHtml(data.src)}" style="max-width:50px;max-height:50px;cursor:pointer;" onclick="window.open('${escapeHtml(data.src)}','_blank')">`);
        } catch (error) {
            console.warn('è¡¨æƒ…ç¬¦è™Ÿè™•ç†éŒ¯èª¤:', alt, error);
        }
    }

    // ===================== ä¿®æ­£çš„ [s] æ¨™ç±¤è™•ç† =====================
    // ä½¿ç”¨å…¨å±€æ›¿æ›è€Œä¸æ˜¯å–®æ¬¡åŒ¹é…
    html = html.replace(/\[s\](.*?)(?:\[e\]|$)/gi, (match, urlContent) => {
        let content = urlContent.trim();
        
        // å¦‚æœ URL å…§å®¹åŒ…å«ç©ºæ ¼ï¼Œåªå–ç¬¬ä¸€å€‹å–®è©ï¼ˆé€šå¸¸æ˜¯å®Œæ•´çš„ URLï¼‰
        if (content.includes(' ')) {
            content = content.split(' ')[0];
        }
        
        // æ¸…ç† URLï¼Œç§»é™¤å¤šé¤˜çš„ç©ºç™½å’Œæ¨™ç±¤
        content = content.replace(/^\s+|\s+$/g, '');
        
        if (!isValidUrl(content)) {
            console.log('ç„¡æ•ˆçš„ URL:', content);
            return match; // è¿”å›åŸå§‹åŒ¹é…ï¼Œä¸é€²è¡Œæ›¿æ›
        }
        
        let replacement;
        
        // æª¢æŸ¥æ˜¯å¦åŒ…å« .mp4
        if (content.toLowerCase().includes('.mp4')) {
            // ä½¿ç”¨ video æ¨™ç±¤
            replacement = `<br><video src="${escapeHtml(content)}" controls autoplay muted loop class="zero-width-image" loading="lazy">
                    <a href="${escapeHtml(content)}" target="_blank" rel="noopener noreferrer">${escapeHtml(content)}</a>
                    </video>`;
        } else {
            // å¦å‰‡ä½¿ç”¨ img æ¨™ç±¤
            replacement = `<br><img src="${escapeHtml(content)}" class="zero-width-image" loading="lazy" 
                    onerror="this.style.display='none'; this.nextElementSibling && this.nextElementSibling.style.display='inline'" 
                    onclick="window.open('${escapeHtml(content)}','_blank')">`;
        }
        
        return replacement;
    });

    // ===================== ä¿®æ­£çš„ [y] æ¨™ç±¤è™•ç† =====================
    html = html.replace(/\[y\](.*?)\[t\]/gi, (match, urlContent) => {
        let content = urlContent.trim();
        
        // å¦‚æœ URL å…§å®¹åŒ…å«ç©ºæ ¼ï¼Œåªå–ç¬¬ä¸€å€‹å–®è©
        if (content.includes(' ')) {
            content = content.split(' ')[0];
        }
        
        content = content.replace(/^\s+|\s+$/g, '');
        
        if (!isValidUrl(content)) {
            console.log('ç„¡æ•ˆçš„ YouTube URL:', content);
            return match; // è¿”å›åŸå§‹åŒ¹é…ï¼Œä¸é€²è¡Œæ›¿æ›
        }
        
        let replacement;
        
        // æª¢æŸ¥æ˜¯å¦ç‚º YouTube å½±ç‰‡
        const youtubeMatch = content.match(/(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{11})(?:&[^&\s]*)?/);
        if (youtubeMatch) {
            const id = escapeHtml(youtubeMatch[1]);
            replacement = `<br><iframe src="https://www.youtube.com/embed/${id}?autoplay=0" width="340" height="191" frameborder="0" allowfullscreen class="zero-width-image"></iframe>`;
        } else if (content.toLowerCase().includes('.mp4')) {
            // å¦‚æœä¸æ˜¯ YouTube ä½†åŒ…å« .mp4ï¼Œä½¿ç”¨ video æ¨™ç±¤
            replacement = `<br><video src="${escapeHtml(content)}" controls autoplay muted loop class="zero-width-image" loading="lazy">
                    <a href="${escapeHtml(content)}" target="_blank" rel="noopener noreferrer">${escapeHtml(content)}</a>
                    </video>`;
        } else {
            // æ—¢ä¸æ˜¯ YouTube ä¹Ÿä¸æ˜¯ .mp4ï¼Œé¡¯ç¤ºç‚ºé€£çµ
            replacement = `<a href="${escapeHtml(content)}" target="_blank" rel="noopener noreferrer">${escapeHtml(content)}</a>`;
        }
        
        return replacement;
    });
	
// ===================== è™•ç†éŸ³è¨Šæ ¼å¼ [a]ç¶²å€[o] =====================
html = html.replace(/\[a\](.*?)(?:\[o\]|$)/gi, (match, urlContent) => {
    let content = urlContent.trim();
    
    // å¦‚æœ URL å…§å®¹åŒ…å«ç©ºæ ¼ï¼Œåªå–ç¬¬ä¸€å€‹å–®è©ï¼ˆé€šå¸¸æ˜¯å®Œæ•´çš„ URLï¼‰
    if (content.includes(' ')) {
        content = content.split(' ')[0];
    }
    
    content = content.replace(/^\s+|\s+$/g, '');
    
    if (!isValidUrl(content)) {
        console.log('ç„¡æ•ˆçš„éŸ³è¨Š URL:', content);
        return match;
    }
    
    // æª¢æŸ¥æ˜¯å¦ç‚ºéŸ³è¨Šæª”æ¡ˆ
    if (!isAudioFile(content)) {
        console.log('ééŸ³è¨Šæª”æ¡ˆ:', content);
        return `<a href="${escapeHtml(content)}" target="_blank" rel="noopener noreferrer">${escapeHtml(content)}</a>`;
    }
    
    // å‰µå»ºå”¯ä¸€çš„ID
    const audioId = 'audio-' + Math.random().toString(36).substr(2, 9);
    const iconId = 'icon-' + audioId;
    
    // è¿”å›å–‡å­åœ–æ¨™å’Œéš±è—çš„éŸ³è¨Šå…ƒç´ 
    const audioElement = `
        <span class="audio-icon" id="${iconId}" title="é»æ“Šæ’­æ”¾éŸ³è¨Š (æœ€å¤š15ç§’)" data-audio-url="${escapeHtml(content)}">
            ğŸ”ˆ
        </span>
        <audio id="${audioId}" class="hidden-audio" preload="none">
            <source src="${escapeHtml(content)}" type="audio/mpeg">
        </audio>
    `;
    
    // åœ¨å…ƒç´ æ’å…¥åˆ°DOMå¾Œï¼Œæ·»åŠ é»æ“Šäº‹ä»¶
    setTimeout(() => {
        const iconElement = document.getElementById(iconId);
        const audioElem = document.getElementById(audioId);
        
        if (iconElement && audioElem) {
            let isPlaying = false;
            
            iconElement.addEventListener('click', function() {
                if (!isPlaying) {
                    // é–‹å§‹æ’­æ”¾
                    isPlaying = true;
                    iconElement.classList.add('playing');
                    iconElement.innerHTML = 'ğŸ”Š'; // åˆ‡æ›ç‚ºæ’­æ”¾ä¸­çš„åœ–æ¨™
                    iconElement.title = 'æ’­æ”¾ä¸­...é»æ“Šåœæ­¢';
                    
                    audioElem.play().catch(error => {
                        console.error('éŸ³è¨Šæ’­æ”¾å¤±æ•—:', error);
                        resetAudioState();
                        iconElement.title = 'æ’­æ”¾å¤±æ•—';
                        iconElement.innerHTML = 'âŒ';
                    });
                    
                    // ç›£è½æ™‚é–“æ›´æ–°ä¾†é™åˆ¶300ç§’
                    const timeUpdateHandler = function() {
                        if (this.currentTime > 300) {
                            this.pause();
                            resetAudioState();
                        }
                    };
                    
                    audioElem.addEventListener('timeupdate', timeUpdateHandler);
                    audioElem.addEventListener('ended', resetAudioState);
                    audioElem.addEventListener('pause', resetAudioState);
                    
                } else {
                    // åœæ­¢æ’­æ”¾
                    audioElem.pause();
                    resetAudioState();
                }
                
                function resetAudioState() {
                    isPlaying = false;
                    audioElem.currentTime = 0;
                    iconElement.classList.remove('playing');
                    iconElement.innerHTML = 'ğŸ”ˆ'; // æ¢å¾©ç‚ºéœéŸ³åœ–æ¨™
                    iconElement.title = 'é»æ“Šæ’­æ”¾éŸ³è¨Š (æœ€å¤š300ç§’)';
                }
            });
            
            // è™•ç†éŸ³è¨Šè¼‰å…¥éŒ¯èª¤
            audioElem.addEventListener('error', function() {
                console.error('éŸ³è¨Šè¼‰å…¥å¤±æ•—:', content);
                iconElement.style.background = '#666';
                iconElement.title = 'éŸ³è¨Šè¼‰å…¥å¤±æ•—';
                iconElement.innerHTML = 'âŒ';
            });
        }
    }, 100);
    
    return audioElement;
});

// æª¢æ¸¬æ˜¯å¦ç‚ºéŸ³è¨Šæª”æ¡ˆçš„å‡½æ•¸
function isAudioFile(url) {
    const audioPatterns = [
        /\.mp3(\?.*)?$/i,
        /\.wav(\?.*)?$/i,
        /\.ogg(\?.*)?$/i,
        /\.m4a(\?.*)?$/i,
        /\.aac(\?.*)?$/i,
        /\.webm(\?.*)?$/i,
        /\.flac(\?.*)?$/i
    ];
    
    return audioPatterns.some(pattern => pattern.test(url));
}

	

    // ç§»é™¤æ®˜ç•™çš„æ¨™ç±¤å­—ç¬¦ï¼ˆåªç§»é™¤æœªè¢«è™•ç†çš„æ¨™ç±¤ï¼‰
    html = html.replace(/(?<!<img[^>]*|<\/?video|<\/?iframe|<\/?a[^>]*)\[s\]|\[e\]|\[y\]|\[t\](?!>)/gi, '');

    // è™•ç†å…¶ä»–æ™®é€šç¶²å€ï¼ˆè½‰ç‚ºè¶…é€£çµï¼‰
    html = html.replace(/(https?:\/\/[^\s<>"'\]\[]+)/g, url => {
        if (!isValidUrl(url)) {
            return escapeHtml(url);
        }
        
        // è·³éå·²ç¶“è¢«è™•ç†éçš„ç¶²å€
        if (html.includes(`src="${url}"`) || html.includes(`href="${url}"`)) {
            return url;
        }
        
        return `<a href="${escapeHtml(url)}" target="_blank" rel="noopener noreferrer">${escapeHtml(url)}</a>`;
    });

    return html;
}

    // æ­£å‰‡è¡¨é”å¼è·³è„«å‡½æ•¸
    function escapeRegExp(string) {
        return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    // HTML è·³è„«å‡½æ•¸
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#x27;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;');
    }

    // æ–°å¢ï¼šå‰µå»ºå‚™ç”¨é€£çµçš„å‡½æ•¸
    function createFallbackLink(url) {
        const link = document.createElement('a');
        link.href = url;
        link.target = '_blank';
        link.rel = 'noopener noreferrer';
        link.textContent = url;
        link.style.color = '#bf94ff';
        link.style.textDecoration = 'none';
        link.style.wordBreak = 'break-all';
        return link;
    }
	
	 // åˆå§‹åŒ–è²¼ä¸Šäº‹ä»¶ç›£è½
    function initPasteHandler() {
        input.removeEventListener('paste', handlePaste);
        input.addEventListener('paste', handlePaste);
    }

   // ===================== æ™ºèƒ½è²¼ä¸ŠåŠŸèƒ½ =====================
    // æ›´å¯é çš„å®ç°
    function handlePaste(event) {
    // é˜»æ­¢é»˜è®¤ç²˜è´´è¡Œä¸º
    event.preventDefault();
    
    // è·å–ç²˜è´´çš„å†…å®¹
    const clipboardData = event.clipboardData || window.clipboardData;
    const pastedText = clipboardData.getData('text');
    
    // è·å–å½“å‰è¾“å…¥æ¡†çš„å€¼å’Œå…‰æ ‡ä½ç½®
    const currentValue = input.value;
    const startPos = input.selectionStart;
    const endPos = input.selectionEnd;
    
    // æ’å…¥ç²˜è´´çš„æ–‡æœ¬
    const newValue = currentValue.substring(0, startPos) + pastedText + currentValue.substring(endPos);
    
    // æ£€æŸ¥æ˜¯å¦éœ€è¦æ·»åŠ ç»“æŸæ ‡ç­¾
    let finalValue = newValue;
    if (currentValue.substring(0, startPos).endsWith("[s] ")) {
        finalValue = newValue + " [e]";
    } else if (currentValue.substring(0, startPos).endsWith("[y] ")) {
        finalValue = newValue + " [t]";
    } else if (currentValue.substring(0, startPos).endsWith("[a] ")) {
        finalValue = newValue + " [o]";
    }
    
    // è®¾ç½®æ–°çš„è¾“å…¥æ¡†å€¼
    input.value = finalValue;
    
    // å°†å…‰æ ‡ç§»åŠ¨åˆ°æ–°æ–‡æœ¬çš„æœ«å°¾
    const newCursorPos = finalValue.length;
    setTimeout(() => {
        input.focus();
        input.setSelectionRange(newCursorPos, newCursorPos);
    }, 10);
}

    // åˆå§‹åŒ–è²¼ä¸Šäº‹ä»¶ç›£è½
    function initPasteHandler() {
        input.removeEventListener('paste', handlePaste);
        input.addEventListener('paste', handlePaste);
    }

    // ===================== è²¼ä¸ŠæŒ‰éˆ•åŠŸèƒ½ =====================
    document.getElementById('pastephoto').addEventListener('click', function() {
        if (input.disabled) {
            alert('è«‹å…ˆç™»å…¥å¾Œå†ä½¿ç”¨æ­¤åŠŸèƒ½');
            return;
        }
        
        // æ’å…¥ [s] ä¸¦åŠ ä¸Šç©ºæ ¼
        const currentValue = input.value;
        const cursorPos = input.selectionStart;
        
        // åœ¨å…‰æ ‡ä½ç½®æ’å…¥ [s] 
        const newValue = currentValue.substring(0, cursorPos) + '[s] ' + currentValue.substring(cursorPos);
        input.value = newValue;
        
        // èšç„¦åˆ°è¼¸å…¥æ¡†ä¸¦å°‡å…‰æ¨™ç§»å‹•åˆ° [s] å¾Œé¢
        const newCursorPos = cursorPos + 4; // [s] çš„é•¿åº¦æ˜¯4
        setTimeout(() => {
            input.focus();
            input.setSelectionRange(newCursorPos, newCursorPos);
        }, 10);
        
        // ç¢ºä¿è²¼ä¸Šè™•ç†å™¨å·²åˆå§‹åŒ–
        initPasteHandler();
    });

    document.getElementById('pastevideo').addEventListener('click', function() {
        if (input.disabled) {
            alert('è«‹å…ˆç™»å…¥å¾Œå†ä½¿ç”¨æ­¤åŠŸèƒ½');
            return;
        }
        
        // æ’å…¥ [y] ä¸¦åŠ ä¸Šç©ºæ ¼
        const currentValue = input.value;
        const cursorPos = input.selectionStart;
        
        // åœ¨å…‰æ ‡ä½ç½®æ’å…¥ [y] 
        const newValue = currentValue.substring(0, cursorPos) + '[y] ' + currentValue.substring(cursorPos);
        input.value = newValue;
        
        // èšç„¦åˆ°è¼¸å…¥æ¡†ä¸¦å°‡å…‰æ¨™ç§»å‹•åˆ° [y] å¾Œé¢
        const newCursorPos = cursorPos + 4; // [y] çš„é•¿åº¦æ˜¯4
        setTimeout(() => {
            input.focus();
            input.setSelectionRange(newCursorPos, newCursorPos);
        }, 10);
        
        // ç¢ºä¿è²¼ä¸Šè™•ç†å™¨å·²åˆå§‹åŒ–
        initPasteHandler();
    });

        
    

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–ç²˜è´´å¤„ç†å™¨
    window.addEventListener('load', function() {
        initPasteHandler();
    });

    // è¾“å…¥æ¡†è·å¾—ç„¦ç‚¹æ—¶ä¹Ÿç¡®ä¿ç²˜è´´å¤„ç†å™¨å·¥ä½œ
    input.addEventListener('focus', function() {
        initPasteHandler();
    });
	
	// éŸ³è¨Šè²¼ä¸ŠæŒ‰éˆ•åŠŸèƒ½
document.getElementById('pasteaudio').addEventListener('click', function() {
    if (input.disabled) {
        alert('è«‹å…ˆç™»å…¥å¾Œå†ä½¿ç”¨æ­¤åŠŸèƒ½');
        return;
    }
    
    // æ’å…¥ [a] ä¸¦åŠ ä¸Šç©ºæ ¼
    const currentValue = input.value;
    const cursorPos = input.selectionStart;
    
    // åœ¨å…‰æ ‡ä½ç½®æ’å…¥ [a] 
    const newValue = currentValue.substring(0, cursorPos) + '[a] ' + currentValue.substring(cursorPos);
    input.value = newValue;
    
    // èšç„¦åˆ°è¼¸å…¥æ¡†ä¸¦å°‡å…‰æ¨™ç§»å‹•åˆ° [a] å¾Œé¢
    const newCursorPos = cursorPos + 4; // [a] çš„é•¿åº¦æ˜¯4
    setTimeout(() => {
        input.focus();
        input.setSelectionRange(newCursorPos, newCursorPos);
    }, 10);
    
    // ç¢ºä¿è²¼ä¸Šè™•ç†å™¨å·²åˆå§‹åŒ–
    initPasteHandler();
});
	

    // ===================== å›è¦†åŠŸèƒ½ =====================
    function setupReply(messageId, username, messageText) {
        replyingTo = {
            id: messageId,
            username: username,
            message: messageText
        };
        
        replyTargetName.textContent = username;
        replyIndicator.style.display = 'flex';
        input.focus();
        
        const existingPreview = document.getElementById('replyPreview');
        if (existingPreview) {
            existingPreview.remove();
        }
        
        const preview = document.createElement('div');
        preview.id = 'replyPreview';
        preview.className = 'reply-preview';
        preview.innerHTML = `
            å›è¦†çµ¦ <span class="replying-to">${username}</span>: ${truncateMessage(messageText, 25)}
        `;
        
        replyIndicator.parentNode.insertBefore(preview, replyIndicator.nextSibling);
    }

    function cancelReply() {
        replyingTo = null;
        replyIndicator.style.display = 'none';
        
        const preview = document.getElementById('replyPreview');
        if (preview) {
            preview.remove();
        }
    }

    function truncateMessage(text, maxLength) {
        if (text.length <= maxLength) return text;
        return text.substring(0, maxLength) + '...';
    }

    // ===================== @åŠŸèƒ½ =====================
    function addRecentUser(username, displayName, avatar) {
        // æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦å·²ç¶“å­˜åœ¨
        const existingIndex = recentUsers.findIndex(user => user.username === username);
        
        if (existingIndex >= 0) {
            // å¦‚æœå­˜åœ¨ï¼Œç§»åˆ°æœ€å‰é¢
            const user = recentUsers.splice(existingIndex, 1)[0];
            recentUsers.unshift(user);
        } else {
            // å¦‚æœä¸å­˜åœ¨ï¼Œæ·»åŠ åˆ°æœ€å‰é¢
            recentUsers.unshift({
                username: username,
                displayName: displayName || username,
                avatar: avatar || 'https://static-cdn.jtvnw.net/user-default-pictures-uv/294c98b5-e34d-42cd-a8f0-140b72fba9b0-profile_image-70x70.png'
            });
        }
        
        // é™åˆ¶æœ€è¿‘ç”¨æˆ¶æ•¸é‡
        if (recentUsers.length > 20) {
            recentUsers = recentUsers.slice(0, 20);
        }
    }

    function showMentionAutocomplete(query) {
        mentionQuery = query.toLowerCase();
        mentionAutocomplete.innerHTML = '';
        
        if (!mentionQuery) {
            hideMentionAutocomplete();
            return;
        }
        
        // éæ¿¾åŒ¹é…çš„ç”¨æˆ¶
        const matchedUsers = recentUsers.filter(user => 
            user.username.toLowerCase().includes(mentionQuery) || 
            user.displayName.toLowerCase().includes(mentionQuery)
        );
        
        if (matchedUsers.length === 0) {
            hideMentionAutocomplete();
            return;
        }
        
        // é¡¯ç¤ºåŒ¹é…çš„ç”¨æˆ¶
        matchedUsers.forEach((user, index) => {
            const item = document.createElement('div');
            item.className = 'mention-item';
            item.innerHTML = `
                <img src="${user.avatar}" alt="${user.username}">
                <div>
                    <div class="username">${user.displayName}</div>
                    <div class="display-name">@${user.username}</div>
                </div>
            `;
            
            item.addEventListener('click', () => {
                selectMention(user);
            });
            
            mentionAutocomplete.appendChild(item);
        });
        
        mentionAutocomplete.style.display = 'block';
        mentionActive = true;
        mentionIndex = -1;
    }

    function hideMentionAutocomplete() {
        mentionAutocomplete.style.display = 'none';
        mentionActive = false;
        mentionIndex = -1;
    }

    function selectMention(user) {
        const currentValue = input.value;
        const atIndex = currentValue.lastIndexOf('@');
        
        if (atIndex >= 0) {
            // æ›¿æ›@å¾Œé¢çš„å…§å®¹ç‚ºç”¨æˆ¶å
            const newValue = currentValue.substring(0, atIndex) + `@${user.username} `;
            input.value = newValue;
            
            // èª¿æ•´ textarea é«˜åº¦
            adjustTextareaHeight();
            
            // é‡æ–°èšç„¦ä¸¦å°‡å…‰æ¨™æ”¾åœ¨æœ«å°¾
            input.focus();
            input.setSelectionRange(newValue.length, newValue.length);
        }
        
        hideMentionAutocomplete();
    }

    function navigateMentions(direction) {
        if (!mentionActive) return;
        
        const items = mentionAutocomplete.querySelectorAll('.mention-item');
        if (items.length === 0) return;
        
        // ç§»é™¤ç•¶å‰é¸ä¸­çš„æ¨£å¼
        items.forEach(item => item.classList.remove('active'));
        
        // è¨ˆç®—æ–°çš„ç´¢å¼•
        mentionIndex += direction;
        
        if (mentionIndex < 0) {
            mentionIndex = items.length - 1;
        } else if (mentionIndex >= items.length) {
            mentionIndex = 0;
        }
        
        // æ·»åŠ é¸ä¸­æ¨£å¼
        items[mentionIndex].classList.add('active');
    }

    function handleMentionKeydown(e) {
        if (!mentionActive) return;
        
        switch (e.key) {
            case 'ArrowUp':
                e.preventDefault();
                navigateMentions(-1);
                break;
            case 'ArrowDown':
                e.preventDefault();
                navigateMentions(1);
                break;
            case 'Enter':
                e.preventDefault();
                const activeItem = mentionAutocomplete.querySelector('.mention-item.active');
                if (activeItem) {
                    const index = Array.from(mentionAutocomplete.querySelectorAll('.mention-item')).indexOf(activeItem);
                    const matchedUsers = recentUsers.filter(user => 
                        user.username.toLowerCase().includes(mentionQuery) || 
                        user.displayName.toLowerCase().includes(mentionQuery)
                    );
                    if (matchedUsers[index]) {
                        selectMention(matchedUsers[index]);
                    }
                }
                break;
            case 'Escape':
                hideMentionAutocomplete();
                break;
        }
    }

   function handleInputChange(e) {
    const value = input.value;
    const cursorPos = input.selectionStart;
    
    // æª¢æŸ¥å…‰æ¨™å‰æ˜¯å¦æœ‰@ç¬¦è™Ÿ
    const textBeforeCursor = value.substring(0, cursorPos);
    const lastAtPos = textBeforeCursor.lastIndexOf('@');
    
    // æª¢æŸ¥@ç¬¦è™Ÿå‰æ˜¯å¦æœ‰ç©ºæ ¼æˆ–æ˜¯åœ¨é–‹é ­
    if (lastAtPos >= 0 && (lastAtPos === 0 || /\s/.test(value[lastAtPos - 1]))) {
        const query = textBeforeCursor.substring(lastAtPos + 1);
        showMentionAutocomplete(query);
    } else {
        hideMentionAutocomplete();
    }
    
    // èª¿æ•´ textarea é«˜åº¦
    adjustTextareaHeight();
    
    // æ›´æ–°å­—æ•¸è¨ˆæ•¸å™¨
    updateCharCounter();
}

    // èª¿æ•´ textarea é«˜åº¦ä»¥é©æ‡‰å…§å®¹
    function adjustTextareaHeight() {
        input.style.height = 'auto';
        input.style.height = Math.min(input.scrollHeight, 120) + 'px';
    }

    // æª¢æŸ¥è¨Šæ¯æ˜¯å¦æåŠç•¶å‰ç”¨æˆ¶ - ä¿®å¾©ï¼šåŒæ™‚æª¢æŸ¥ä½¿ç”¨è€…åç¨±å’Œé¡¯ç¤ºåç¨±
    function checkMention(messageText, tags) {
        if (!username || username === 'justinfan666') return false;
        
        // ä½¿ç”¨æ­£å‰‡è¡¨é”å¼æª¢æŸ¥æ˜¯å¦æåŠç•¶å‰ç”¨æˆ¶çš„ä½¿ç”¨è€…åç¨±
        const usernameMentionRegex = new RegExp(`@${username}\\b`, 'i');
        if (usernameMentionRegex.test(messageText)) {
            return true;
        }
        
        // æ–°å¢ï¼šæª¢æŸ¥æ˜¯å¦æåŠç•¶å‰ç”¨æˆ¶çš„é¡¯ç¤ºåç¨±
        if (userDisplayName && userDisplayName !== username) {
            const displayNameMentionRegex = new RegExp(`@${escapeRegExp(userDisplayName)}(?=$|\\s|[\\.,!\\?\\)\\(])`, 'i');
            if (displayNameMentionRegex.test(messageText)) {
                return true;
            }
        }
        
        return false;
    }

    // ===================== è¡¨æƒ…ç³»çµ± =====================
function loadEmojiSets() {
    fetch("https://chicktv.github.io/tv/showset.txt").then(r=>r.json()).then(setarray=>{
        setarray.set.forEach(list=>{
            emojiLists[list.name] = {emojis:[], image:list.image||''};
            fetch(`https://chicktv.github.io/tv/${list.name}.txt`).then(r=>r.json()).then(data=>{
                data[list.name].forEach(icon=>{
                    if(icon.alt && icon.src){
                        emojiLists[list.name].emojis.push({alt:icon.alt, src:icon.src, dis:icon.dis||icon.alt});
                        altToEmojiMap[icon.alt] = {src:icon.src, width:'32', height:'32'};
                    }
                });
                renderEmojiPanel();
            });
        });
    });

    fetch("https://chicktv.github.io/tv/skuser_icon.txt").then(r=>r.json()).then(icons=>{
        emojiLists["æœ¬å°"] = {emojis:[], image:"https://chicktv.github.io/tv/chick.jpg"};
        icons.forEach(i=>{
            emojiLists["æœ¬å°"].emojis.push({alt:i.alt, src:i.src, dis:i.alt});
            altToEmojiMap[i.alt] = {src:i.src, width:'32', height:'32'};
        });
        renderEmojiPanel();
    });

    const saved = JSON.parse(localStorage.getItem('myBTTV')||'[]');
    emojiLists["BTTV"] = {
        emojis: saved.map(url=>({alt:url.split('/').pop().split('?')[0], src:url, dis:url})),
        image: "https://static-cdn.jtvnw.net/badges/v1/ed51a614-2c44-4a60-80b6-62908436b43a/3"
    };
    
    // è¼‰å…¥éŸ³è¨Šè³‡æ–™
    loadAudioData();
    
    renderEmojiPanel();
}


// è¼‰å…¥éŸ³è¨Šè³‡æ–™
async function loadAudioData() {
    try {
        // å…ˆå¾é ç¨‹ URL åŠ è¼‰éŸ³è¨Šåˆ—è¡¨
        const response = await fetch('https://chicktv.github.io/tv/audio.txt');
        if (response.ok) {
            const remoteAudios = await response.json();
            
            // ç„¶å¾Œå¾ localStorage åŠ è¼‰ç”¨æˆ¶è‡ªå®šç¾©éŸ³è¨Š
            const localAudios = JSON.parse(localStorage.getItem('myAudios') || '[]');
            
            // åˆä½µéŸ³è¨Šåˆ—è¡¨ï¼ˆé¿å…é‡è¤‡ï¼‰
            const mergedAudios = mergeAudioLists(remoteAudios, localAudios);
            
            audioLists["éŸ³è¨Š"] = {
                audios: mergedAudios,
                image: "ğŸ”Š"
            };
            
            console.log('éŸ³è¨Šè³‡æ–™è¼‰å…¥æˆåŠŸï¼Œé ç«¯:', remoteAudios.length, 'æœ¬åœ°:', localAudios.length, 'åˆä½µå¾Œ:', mergedAudios.length);
        } else {
            throw new Error('é ç«¯éŸ³è¨Šåˆ—è¡¨è¼‰å…¥å¤±æ•—');
        }
    } catch (error) {
        console.error('è¼‰å…¥é ç«¯éŸ³è¨Šåˆ—è¡¨å¤±æ•—ï¼Œä½¿ç”¨æœ¬åœ°å„²å­˜çš„éŸ³è¨Š:', error);
        
        // å¦‚æœé ç«¯è¼‰å…¥å¤±æ•—ï¼Œåªä½¿ç”¨æœ¬åœ°å„²å­˜çš„éŸ³è¨Š
        const localAudios = JSON.parse(localStorage.getItem('myAudios') || '[]');
        audioLists["éŸ³è¨Š"] = {
            audios: localAudios,
            image: "ğŸ”Š"
        };
    }
}

// åˆä½µéŸ³è¨Šåˆ—è¡¨ï¼ˆé¿å…é‡è¤‡ï¼‰
function mergeAudioLists(remoteAudios, localAudios) {
    const merged = [...remoteAudios];
    const urlSet = new Set(remoteAudios.map(audio => audio.url));
    
    // æ·»åŠ æœ¬åœ°éŸ³è¨Šï¼Œé¿å…é‡è¤‡çš„ URL
    localAudios.forEach(localAudio => {
        if (!urlSet.has(localAudio.url)) {
            merged.push(localAudio);
            urlSet.add(localAudio.url);
        }
    });
    
    return merged;
}


    function renderEmojiPanel() {
    const tabs = document.getElementById('emojiTabs');
    const content = document.getElementById('emojiContent');
    tabs.innerHTML = ''; 
    content.innerHTML = '';

    // å…ˆæ¸²æŸ“è¡¨æƒ…åˆ†é 
    Object.keys(emojiLists).forEach((name, i) => {
        const tab = document.createElement('div');
        tab.className = 'emoji-tab';
        tab.style.backgroundImage = `url(${emojiLists[name].image || 'https://via.placeholder.com/36?text=' + name[0]})`;
        tab.title = name;
        tab.onclick = () => {
            document.querySelectorAll('.emoji-tab').forEach(t=>t.classList.remove('active'));
            tab.classList.add('active');
            renderTabContent(name);
        };
        if (i===0) tab.classList.add('active');
        tabs.appendChild(tab);
    });

    // æ·»åŠ éŸ³è¨Šåˆ†é 
    const audioTab = document.createElement('div');
    audioTab.className = 'emoji-tab';
    audioTab.textContent = 'ğŸ”Š';
    audioTab.title = 'éŸ³è¨Š';
    audioTab.onclick = () => {
        document.querySelectorAll('.emoji-tab').forEach(t=>t.classList.remove('active'));
        audioTab.classList.add('active');
        renderTabContent('éŸ³è¨Š');
    };
    tabs.appendChild(audioTab);

    renderTabContent(Object.keys(emojiLists)[0] || 'BTTV');
}

function renderTabContent(name) {
    const content = document.getElementById('emojiContent');
    content.innerHTML = '';

    if (name === "BTTV") {
        content.innerHTML += `
            <div class="bttv-input">
                <input type="text" id="bttvUrl" placeholder="è¼¸å…¥åœ–ç‰‡ç¶²å€">
                <button onclick="addBTTV()">å„²å­˜</button>
                <button onclick="isDeleteMode=!isDeleteMode;renderEmojiPanel()" style="background:${isDeleteMode?'#666':'#c42b1c'}">
                    ${isDeleteMode?'å–æ¶ˆ':'åˆªé™¤'}
                </button>
            </div>`;
        
        emojiLists[name].emojis.forEach(emoji => {
            const div = document.createElement('div');
            div.className = 'emoji-item';
            div.innerHTML = `<img src="${emoji.src}" title="${emoji.dis||emoji.alt}">`;
            if (isDeleteMode) {
                div.innerHTML += `<div class="delete-btn" onclick="event.stopPropagation();deleteBTTV('${emoji.src}')">X</div>`;
            }
            div.onclick = () => {
                if (!isDeleteMode) {
                    input.value += (input.value ? ' ' : '') + `[s] ${emoji.src} [e]`;
                    adjustTextareaHeight();
                    input.focus();
                    document.getElementById('emojiPanel').style.display = 'none';
                }
            };
            content.appendChild(div);
        });
    } else if (name === "éŸ³è¨Š") {
        // éŸ³è¨Šåˆ†é 
        content.innerHTML += `
            <div class="audio-input-form">
                <div class="audio-input-row">
                    <input type="text" id="audioName" placeholder="éŸ³è¨Šåç¨±">
                </div>
                <div class="audio-input-row">
                    <input type="text" id="audioUrl" placeholder="è¼¸å…¥éŸ³è¨Šç¶²å€">
                </div>
                <div class="audio-buttons">
                    <button onclick="addAudio()">å„²å­˜</button>
                    <button onclick="toggleAudioDeleteMode()" class="${isAudioDeleteMode ? 'delete-mode' : ''}" id="audioDeleteBtn">
                        ${isAudioDeleteMode ? 'å–æ¶ˆ' : 'åˆªé™¤'}
                    </button>
                </div>
            </div>`;
        
        // é¡¯ç¤ºå·²å„²å­˜çš„éŸ³è¨Š
        audioLists[name].audios.forEach((audio, index) => {
            const audioDiv = document.createElement('div');
            audioDiv.className = 'audio-item';
            audioDiv.innerHTML = `
                <div class="audio-icon-small">ğŸ”Š</div>
                <div class="audio-name">${audio.name}</div>
            `;
            
            if (isAudioDeleteMode) {
                audioDiv.innerHTML += `<div class="delete-btn" onclick="event.stopPropagation();deleteAudio(${index})">X</div>`;
            }
            
            audioDiv.onclick = () => {
                if (!isAudioDeleteMode) {
                    // æ’å…¥éŸ³è¨Šæ¨™ç±¤åˆ°è¼¸å…¥æ¡†
                    input.value += (input.value ? ' ' : '') + `[a] ${audio.url} [o]`;
                    adjustTextareaHeight();
                    input.focus();
                    document.getElementById('emojiPanel').style.display = 'none';
                    
                    // æ·»åŠ æ’­æ”¾åé¥‹
                    audioDiv.classList.add('playing');
                    setTimeout(() => {
                        audioDiv.classList.remove('playing');
                    }, 500);
                }
            };
            
            content.appendChild(audioDiv);
        });
    } else {
        // å…¶ä»–è¡¨æƒ…åˆ†é 
        emojiLists[name].emojis.forEach(emoji => {
            const div = document.createElement('div');
            div.className = 'emoji-item';
            div.innerHTML = `<img src="${emoji.src}" title="${emoji.dis||emoji.alt}">`;
            div.onclick = () => {
                input.value += (input.value ? ' ' : '') + (emoji.alt || emoji.src);
                adjustTextareaHeight();
                input.focus();
                document.getElementById('emojiPanel').style.display = 'none';
            };
            content.appendChild(div);
        });
    }
}

    window.addBTTV = () => {
        const url = document.getElementById('bttvUrl').value.trim();
        if (!url) return;
        const saved = JSON.parse(localStorage.getItem('myBTTV')||'[]');
        if (!saved.includes(url)) {
            saved.push(url);
            localStorage.setItem('myBTTV', JSON.stringify(saved));
            emojiLists["BTTV"].emojis.push({alt:url.split('/').pop().split('?')[0], src:url});
            renderEmojiPanel();
        }
        document.getElementById('bttvUrl').value = '';
    };

    window.deleteBTTV = (url) => {
        let saved = JSON.parse(localStorage.getItem('myBTTV')||'[]');
        saved = saved.filter(u=>u!==url);
        localStorage.setItem('myBTTV', JSON.stringify(saved));
        emojiLists["BTTV"].emojis = emojiLists["BTTV"].emojis.filter(e=>e.src!==url);
        renderEmojiPanel();
    };
	
	// æ·»åŠ éŸ³è¨Š
// æ·»åŠ éŸ³è¨Šï¼ˆè·³éç¢ºèªå°è©±æ¡†ï¼‰
function addAudio() {
    const name = document.getElementById('audioName').value.trim();
    const url = document.getElementById('audioUrl').value.trim();
    
    if (!name || !url) {
        alert('è«‹å¡«å¯«éŸ³è¨Šåç¨±å’Œç¶²å€');
        return;
    }
    
    // é©—è­‰ URL æ ¼å¼
    if (!isValidUrl(url)) {
        alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„éŸ³è¨Šç¶²å€');
        return;
    }
    
    // å¾ localStorage è®€å–ç¾æœ‰éŸ³è¨Š
    const savedAudios = JSON.parse(localStorage.getItem('myAudios') || '[]');
    
    // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒåç¨±æˆ–ç¶²å€çš„éŸ³è¨Š
    const exists = savedAudios.some(audio => 
        audio.name === name || audio.url === url
    );
    
    if (exists) {
        alert('å·²å­˜åœ¨ç›¸åŒåç¨±æˆ–ç¶²å€çš„éŸ³è¨Š');
        return;
    }
    
    // æ·»åŠ æ–°éŸ³è¨Š
    savedAudios.push({ name, url });
    localStorage.setItem('myAudios', JSON.stringify(savedAudios));
    
    // æ›´æ–°éŸ³è¨Šåˆ—è¡¨
    audioLists["éŸ³è¨Š"].audios = savedAudios;
    
    // æ¸…ç©ºè¼¸å…¥æ¡†
    document.getElementById('audioName').value = '';
    document.getElementById('audioUrl').value = '';
    
    // é‡æ–°æ¸²æŸ“é¢æ¿
    renderTabContent('éŸ³è¨Š');
}

// åˆ‡æ›éŸ³è¨Šåˆªé™¤æ¨¡å¼
function toggleAudioDeleteMode() {
    isAudioDeleteMode = !isAudioDeleteMode;
    renderTabContent('éŸ³è¨Š');
}

// åˆªé™¤éŸ³è¨Šï¼ˆè·³éç¢ºèªå°è©±æ¡†ï¼‰
function deleteAudio(index) {
    // å¾ localStorage è®€å–ç¾æœ‰éŸ³è¨Š
    const savedAudios = JSON.parse(localStorage.getItem('myAudios') || '[]');
    
    // ç§»é™¤æŒ‡å®šç´¢å¼•çš„éŸ³è¨Š
    if (index >= 0 && index < savedAudios.length) {
        savedAudios.splice(index, 1);
        localStorage.setItem('myAudios', JSON.stringify(savedAudios));
        
        // æ›´æ–°éŸ³è¨Šåˆ—è¡¨
        audioLists["éŸ³è¨Š"].audios = savedAudios;
        
        // é‡æ–°æ¸²æŸ“é¢æ¿
        renderTabContent('éŸ³è¨Š');
    }
}

// éŸ³è¨Šæª”æ¡ˆæª¢æ¸¬å‡½æ•¸
function isAudioFile(url) {
    const audioPatterns = [
        /\.mp3(\?.*)?$/i,
        /\.wav(\?.*)?$/i,
        /\.ogg(\?.*)?$/i,
        /\.m4a(\?.*)?$/i,
        /\.aac(\?.*)?$/i,
        /\.webm(\?.*)?$/i,
        /\.flac(\?.*)?$/i
    ];
    
    return audioPatterns.some(pattern => pattern.test(url));
}

// URL é©—è­‰å‡½æ•¸
function isValidUrl(url) {
    try {
        const urlObj = new URL(url);
        return urlObj.protocol === 'http:' || urlObj.protocol === 'https:';
    } catch {
        return false;
    }
}
	

    // è¡¨æƒ…é¢æ¿æ‹–æ›³
    let dragging = false, offsetX, offsetY;
    document.querySelector('.emoji-header')?.addEventListener('mousedown', e=>{
        if (e.target === document.getElementById('emojiCloseBtn')) return;
        
        dragging = true;
        const p = document.getElementById('emojiPanel');
        offsetX = e.clientX - p.offsetLeft;
        offsetY = e.clientY - p.offsetTop;
    });
    document.addEventListener('mousemove', e=>{
        if(dragging){
            const p = document.getElementById('emojiPanel');
            p.style.left = (e.clientX - offsetX) + 'px';
            p.style.top = (e.clientY - offsetY) + 'px';
        }
    });
    document.addEventListener('mouseup', ()=>{dragging=false;});

    // è¡¨æƒ…é¢æ¿å¼€å…³åŠŸèƒ½
    document.getElementById('emojiBtn').onclick = () => {
        const p = document.getElementById('emojiPanel');
        p.style.display = p.style.display==='flex' ? 'none' : 'flex';
        if (p.style.display==='flex') {
            p.style.left = '50%'; p.style.top = '50%';
            p.style.transform = 'translate(-50%,-50%)';
            renderEmojiPanel();
        }
    };

    document.getElementById('emojiCloseBtn').onclick = () => {
        document.getElementById('emojiPanel').style.display = 'none';
    };

    // ===================== tmi.js é€£ç·š =====================
    function connectChat() {
        if (isConnected) return;
        
        client = new tmi.client({
            connection: { secure: true, reconnect: true },
            identity: oauthToken ? { username, password: oauthToken } : undefined,
            channels: [channel]
        });

        client.on('connected', () => {
            isConnected = true;
            status.textContent = `å·²é€£ç·š${channel} ${oauthToken?'ï¼ˆå·²ç™»å…¥ï¼‰':''}`;
            loadEmojiSets();
        });

        client.on('message', async (ch, tags, message, self) => {
            try {
                // æ·»åŠ ç”¨æˆ¶åˆ°æœ€è¿‘ç”¨æˆ¶åˆ—è¡¨
                addRecentUser(
                    tags.username, 
                    tags['display-name'], 
                    tags['user-avatar'] || 'https://static-cdn.jtvnw.net/user-default-pictures-uv/294c98b5-e34d-42cd-a8f0-140b72fba9b0-profile_image-70x70.png'
                );

                // æª¢æŸ¥æ˜¯å¦æåŠç•¶å‰ç”¨æˆ¶
                const isMentioned = checkMention(message, tags);
                
                // ä¿®æ”¹é€™è£¡ï¼šæª¢æŸ¥æ˜¯å¦ç‚ºå›è¦†è¨Šæ¯ï¼ˆåŒ…å«è‡ªå·±ç™¼é€çš„å›è¦†ï¼‰
                const isReply = tags['reply-parent-msg-id'] || 
                              (self && replyingTo); // å¦‚æœæ˜¯è‡ªå·±ç™¼çš„ä¸”æ­£åœ¨å›è¦†ä¸­
                
                if (isReply) {
                    // å¦‚æœæ˜¯è‡ªå·±ç™¼é€çš„å›è¦†ï¼Œä½¿ç”¨ replyingTo ä¸­çš„è³‡è¨Š
                    const replyParentMsgId = tags['reply-parent-msg-id'] || (replyingTo ? replyingTo.id : null);
                    const replyParentDisplayName = tags['reply-parent-display-name'] || (replyingTo ? replyingTo.username : '');
                    const replyParentMsgBody = tags['reply-parent-msg-body'] || (replyingTo ? replyingTo.message : '');
                    
                    const replyContainer = document.createElement('div');
                    replyContainer.className = `msg-with-reply ${isMentioned ? 'mentioned-message' : ''}`;
                    replyContainer.id = `msg-${tags.id || 'temp-' + Date.now()}`;
                    
                    const replyHeader = document.createElement('div');
                    replyHeader.className = 'reply-header';
                    replyHeader.innerHTML = `
                        <span class="reply-icon">â†©</span>
                         <span>å›è¦†</span>
                        <span class="reply-username">${replyParentDisplayName}</span>
                    `;
                    replyContainer.appendChild(replyHeader);
                    
                    const replyOriginal = document.createElement('div');
                    replyOriginal.className = 'reply-original';
                    replyOriginal.innerHTML = `
                        <span class="original-username">${replyParentDisplayName}:</span>
                        ${truncateMessage(replyParentMsgBody, 100)}
                    `;
                    replyContainer.appendChild(replyOriginal);
                    
                    const msgContent = document.createElement('div');
                    msgContent.className = 'msg-content';
                    
                    // å‰µå»ºåç¨±å®¹å™¨
                    const nameContainer = document.createElement('div');
                    nameContainer.className = 'name-container';
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.className = 'name';
                    nameSpan.style.color = tags.color || '#9147ff';
                    
                    // ä½¿ç”¨æ›´å®‰å…¨çš„æ–¹å¼æ’å…¥å¾½ç« å’Œç”¨æˆ·å
                    const badges = parseBadges(tags.badges);
                    const badgesHtml = renderBadges(badges);
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = badgesHtml + escapeHtml(tags['display-name'] || tags.username || userDisplayName) + ': ';
                    while (tempDiv.firstChild) {
                        nameSpan.appendChild(tempDiv.firstChild);
                    }
                    
                    nameContainer.appendChild(nameSpan);
                    msgContent.appendChild(nameContainer);
                    
                    // å‰µå»ºè¨Šæ¯æ–‡å­—ï¼ˆç›´æ¥æ”¾åœ¨ msg-content ä¸­ï¼‰
                    const msg = document.createElement('span');
                    msg.className = 'message-text';
                    msg.innerHTML = await processMessage(message);
                    msgContent.appendChild(msg);
                    
                    // å‰µå»ºæŒ‰éˆ•å®¹å™¨
                    if (oauthToken && !self) {
                        const buttonContainer = document.createElement('div');
                        buttonContainer.className = 'button-container';
                        
                        const replyBtn = document.createElement('button');
                        replyBtn.className = 'reply-btn';
                        replyBtn.innerHTML = 'â†©ï¸';
                        replyBtn.title = 'å›è¦†æ­¤è¨Šæ¯';
                        replyBtn.onclick = () => {
                            setupReply(tags.id, tags['display-name'] || tags.username, message);
                        };
                        buttonContainer.appendChild(replyBtn);
                        
                        msgContent.appendChild(buttonContainer);
                    }
                    
                    replyContainer.appendChild(msgContent);
                    chat.appendChild(replyContainer);
                    
                    // å¦‚æœæ˜¯è‡ªå·±ç™¼é€çš„å›è¦†ï¼Œæ¸…é™¤å›è¦†ç‹€æ…‹
                    if (self && replyingTo) {
                        setTimeout(() => {
                            cancelReply();
                        }, 100);
                    }
                } else {
                    const div = document.createElement('div');
                    div.className = `msg ${isMentioned ? 'mentioned-message' : ''}`;
                    div.id = `msg-${tags.id}`;

                    const msgContent = document.createElement('div');
                    msgContent.className = 'msg-content';
                    
                    // å‰µå»ºåç¨±å®¹å™¨
                    const nameContainer = document.createElement('div');
                    nameContainer.className = 'name-container';
                    
                    const nameSpan = document.createElement('span');
                    nameSpan.className = 'name';
                    nameSpan.style.color = tags.color || '#9147ff';
                    
                    // ä½¿ç”¨æ›´å®‰å…¨çš„æ–¹å¼æ’å…¥å¾½ç« å’Œç”¨æˆ·å
                    const badges = parseBadges(tags.badges);
                    const badgesHtml = renderBadges(badges);
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = badgesHtml + escapeHtml(tags['display-name'] || tags.username) + ': ';
                    while (tempDiv.firstChild) {
                        nameSpan.appendChild(tempDiv.firstChild);
                    }
                    
                    nameContainer.appendChild(nameSpan);
                    msgContent.appendChild(nameContainer);
                    
                    // å‰µå»ºè¨Šæ¯æ–‡å­—ï¼ˆç›´æ¥æ”¾åœ¨ msg-content ä¸­ï¼‰
                    const msg = document.createElement('span');
                    msg.className = 'message-text';
                    msg.innerHTML = await processMessage(message);
                    msgContent.appendChild(msg);
                    
                    // å‰µå»ºæŒ‰éˆ•å®¹å™¨
                    if (oauthToken && !self) {
                        const buttonContainer = document.createElement('div');
                        buttonContainer.className = 'button-container';
                        
                        const replyBtn = document.createElement('button');
                        replyBtn.className = 'reply-btn';
                        replyBtn.innerHTML = 'â†©ï¸';
                        replyBtn.title = 'å›è¦†æ­¤è¨Šæ¯';
                        replyBtn.onclick = () => {
                            setupReply(tags.id, tags['display-name'] || tags.username, message);
                        };
                        buttonContainer.appendChild(replyBtn);
                        
                        msgContent.appendChild(buttonContainer);
                    }
                    
                    div.appendChild(msgContent);
                    chat.appendChild(div);
                }
                
                // é™åˆ¶è¨Šæ¯æ•¸é‡ç‚º100æ¢
                limitMessages();
                
                // åªæœ‰åœ¨å•Ÿç”¨è‡ªå‹•æ»¾å‹•æ™‚æ‰æ»¾å‹•åˆ°åº•éƒ¨
                if (autoScroll) {
                    forceScrollToBottom();
                }
            } catch (error) {
                console.error('è™•ç†è¨Šæ¯æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                console.log('æœ‰å•é¡Œçš„è¨Šæ¯è³‡æ–™:', { tags, message });
                
                // å¦‚æœå‡ºé”™ï¼Œä½¿ç”¨ç®€å•çš„æ–¹å¼æ˜¾ç¤ºæ¶ˆæ¯ï¼ˆä¸å¸¦å¾½ç« ï¼‰
                const fallbackDiv = document.createElement('div');
                fallbackDiv.className = 'msg';
                fallbackDiv.innerHTML = `
                    <div class="msg-content">
                        <div class="name-container">
                            <span class="name" style="color: ${tags.color || '#9147ff'}">
                                ${escapeHtml(tags['display-name'] || tags.username)}: 
                            </span>
                        </div>
                        <span class="message-text">${escapeHtml(message)}</span>
                    </div>
                `;
                chat.appendChild(fallbackDiv);
                
                // é™åˆ¶è¨Šæ¯æ•¸é‡ç‚º100æ¢
                limitMessages();
                
                // åªæœ‰åœ¨å•Ÿç”¨è‡ªå‹•æ»¾å‹•æ™‚æ‰æ»¾å‹•åˆ°åº•éƒ¨
                if (autoScroll) {
                    forceScrollToBottom();
                }
            }
        });

        client.connect().catch(console.error);
    }

    function reconnectChat() {
        if (client) {
            client.disconnect();
            isConnected = false;
        }
        
        connectChat();
    }

// ç²å–å­—æ•¸è¨ˆæ•¸å™¨å…ƒç´ 
const charCounter = document.getElementById('charCounter');

// å­—æ•¸é™åˆ¶åŠŸèƒ½
function updateCharCounter() {
    const text = input.value;
    const count = text.length;
    
    // æ›´æ–°è¨ˆæ•¸å™¨é¡¯ç¤º
    charCounter.textContent = `${count}/500`;
    
    // æ ¹æ“šå­—æ•¸æ”¹è®Šæ¨£å¼
    if (count > 500) {
        charCounter.classList.add('over-limit');
        charCounter.classList.remove('near-limit');
    } else if (count > 450) {
        charCounter.classList.add('near-limit');
        charCounter.classList.remove('over-limit');
    } else {
        charCounter.classList.remove('over-limit', 'near-limit');
    }
    
    // å¦‚æœè¶…éé™åˆ¶ï¼Œç¦ç”¨ç™¼é€æŒ‰éˆ•
    if (count > 500) {
        document.getElementById('sendBtn').disabled = true;
        document.getElementById('sendBtn').title = 'è¨Šæ¯é•·åº¦è¶…é500å­—é™åˆ¶';
    } else if (input.disabled) {
        document.getElementById('sendBtn').disabled = true;
        document.getElementById('sendBtn').title = 'è«‹å…ˆç™»å…¥';
    } else {
        document.getElementById('sendBtn').disabled = false;
        document.getElementById('sendBtn').title = 'é€å‡ºè¨Šæ¯';
    }
}

// è¼¸å…¥é™åˆ¶å‡½æ•¸
function limitInputLength(e) {
    const text = input.value;
    
    if (text.length >= 500) {
        // å¦‚æœå·²ç¶“é”åˆ°500å­—ï¼Œé˜»æ­¢ç¹¼çºŒè¼¸å…¥ï¼ˆä½†å…è¨±åˆªé™¤å’Œç‰¹æ®ŠæŒ‰éµï¼‰
        if (e.key.length === 1 && !e.ctrlKey && !e.metaKey) {
            e.preventDefault();
            return;
        }
    }
}
   

    // ===================== ç™¼é€è¨Šæ¯åŠŸèƒ½ =====================
 function send() {
    let msg = input.value.trim();
    
    // æª¢æŸ¥å­—æ•¸é™åˆ¶
    if (msg.length > 500) {
        alert('è¨Šæ¯é•·åº¦ä¸èƒ½è¶…é500å­—ï¼ç›®å‰å­—æ•¸ï¼š' + msg.length);
        // è‡ªå‹•æˆªæ–·åˆ°500å­—
        msg = msg.substring(0, 500);
        input.value = msg;
        updateCharCounter();
        return;
    }
    
    if (msg && oauthToken && client?.readyState() === 'OPEN') {
        if (replyingTo) {
            // å„²å­˜ç•¶å‰çš„å›è¦†ç›®æ¨™
            const currentReplyTarget = {...replyingTo};
            
            client.reply(channel, msg, replyingTo.id).then(() => {
                input.value = '';
                // é‡ç½® textarea é«˜åº¦
                adjustTextareaHeight();
                updateCharCounter(); // æ›´æ–°è¨ˆæ•¸å™¨
                
                // å®‰å…¨æ©Ÿåˆ¶ï¼šå¦‚æœ3ç§’å¾Œ replyingTo é‚„åœ¨ï¼Œå¼·åˆ¶æ¸…é™¤
                setTimeout(() => {
                    if (replyingTo && replyingTo.id === currentReplyTarget.id) {
                        console.log('å®‰å…¨æ©Ÿåˆ¶ï¼šå¼·åˆ¶æ¸…é™¤å›è¦†ç‹€æ…‹');
                        cancelReply();
                    }
                }, 3000);
                
            }).catch(err => {
                console.error('å›è¦†ç™¼é€å¤±æ•—:', err);
                // å›è¦†å¤±æ•—æ™‚æ”¹ç‚ºç™¼é€æ™®é€šè¨Šæ¯
                client.say(channel, msg).then(() => {
                    input.value = '';
                    // é‡ç½® textarea é«˜åº¦
                    adjustTextareaHeight();
                    updateCharCounter(); // æ›´æ–°è¨ˆæ•¸å™¨
                    cancelReply();
                });
            });
        } else {
            client.say(channel, msg).then(() => {
                input.value = '';
                // é‡ç½® textarea é«˜åº¦
                adjustTextareaHeight();
                updateCharCounter(); // æ›´æ–°è¨ˆæ•¸å™¨
            });
        }
    }
}

    document.getElementById('sendBtn').onclick = send;
    
    // ä¿®æ”¹ Enter éµè¡Œç‚ºï¼šEnter ç™¼é€ï¼ŒCtrl+Enter æ›è¡Œ
    input.addEventListener('keydown', e => {
        if (e.key === 'Enter') {
            if (e.ctrlKey) {
                // Ctrl+Enter æ›è¡Œ
                const cursorPos = input.selectionStart;
                const textBefore = input.value.substring(0, cursorPos);
                const textAfter = input.value.substring(cursorPos);
                
                input.value = textBefore + '\n' + textAfter;
                input.selectionStart = input.selectionEnd = cursorPos + 1;
                
                // èª¿æ•´ textarea é«˜åº¦
                adjustTextareaHeight();
                
                e.preventDefault();
            } else {
                // åªæœ‰ Enter ç™¼é€è¨Šæ¯
                e.preventDefault();
                send();
            }
        }
    });

    // æ·»åŠ @åŠŸèƒ½çš„äº‹ä»¶ç›‘å¬
    input.addEventListener('input', handleInputChange);
	input.addEventListener('keydown', limitInputLength); // æ·»åŠ è¼¸å…¥é™åˆ¶
    input.addEventListener('keydown', handleMentionKeydown);

    // ç‚¹å‡»å…¶ä»–åœ°æ–¹æ—¶éšè—@åˆ—è¡¨
    document.addEventListener('click', (e) => {
        if (!mentionAutocomplete.contains(e.target) && e.target !== input) {
            hideMentionAutocomplete();
        }
    });

    cancelReplyBtn.onclick = cancelReply;
	 // åˆå§‹åŒ–è²¼ä¸Šè™•ç†å™¨

    initPasteHandler();
    </script>
</body>
</html>
