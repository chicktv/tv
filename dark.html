<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Twitch Console v5.8</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        :root { --t-bg: #0e0e10; --t-alt: #18181b; --t-purp: #9147ff; --t-text: #efeff1; }
        body { background: var(--t-bg); color: var(--t-text); font-family: sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        .header-bar { background: var(--t-alt); padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; flex-shrink: 0; }
        #chat-container { flex: 1; overflow-y: auto; padding: 15px; background: #000; }
        
        /* 訊息列 */
        .chat-line { position: relative; margin-bottom: 4px; padding: 8px 45px 8px 10px; border-radius: 4px; line-height: 1.5; word-wrap: break-word; }
        .chat-line:hover { background: rgba(255,255,255,0.05); }

        /* --- 重點：提及文字 (@name) 的反選高亮效果 --- */
        .mention-tag { 
            background: #efeff1;    /* 淺色背景 (反相) */
            color: #000 !important; /* 深色文字 */
            padding: 0px 4px; 
            border-radius: 2px; 
            font-weight: bold;
            display: inline-block;
        }

        /* 自己的名字標籤 (維持紫色或一致風格) */
        .self-name { color: var(--t-purp); font-weight: bold; }

        /* 回覆按鈕與其他 */
        .reply-btn { position: absolute; right: 10px; top: 8px; width: 26px; height: 26px; background: #2f2f35; border-radius: 4px; display: none; align-items: center; justify-content: center; cursor: pointer; color: #fff; font-size: 10px; }
        .chat-line:hover .reply-btn { display: flex; }
        .quote-box { font-size: 12px; color: #adadb8; background: rgba(0,0,0,0.4); padding: 8px; border-radius: 4px; margin-bottom: 6px; border-left: 3px solid var(--t-purp); }
        .media-preview { max-width: 200px !important; border-radius: 6px; margin-top: 8px; display: block; border: 1px solid #333; }
        .alt-emoji { max-width: 100px !important; max-height: 100px !important; vertical-align: middle; }
        .badge { width: 18px; height: 18px; vertical-align: middle; margin-right: 4px; }

        .footer { padding: 15px; background: var(--t-alt); border-top: 1px solid #333; flex-shrink: 0; }
        .input-row { display: flex; gap: 10px; margin-top: 10px; }
        #msginput { flex: 1; background: #000; border: 1px solid #444; color: #fff; padding: 12px; border-radius: 4px; outline: none; }
        #sendbtn { background: var(--t-purp); color: #fff; border: none; padding: 0 20px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        
        /* 表情面板 */
        #emojiPanel { position: fixed; display: none; width: 450px; height: 500px; background: #1f182e; border: 2px solid #443a5a; border-radius: 12px; z-index: 5000; left: 50%; top: 50%; transform: translate(-50%, -50%); flex-direction: column; }
        #emojiTabs { display: flex; gap: 8px; padding: 10px; background: #0e0e10; overflow-x: auto; min-height: 55px; }
        #emojiContent { flex: 1; overflow-y: auto; padding: 12px; display: grid; grid-template-columns: repeat(auto-fill, minmax(50px, 1fr)); gap: 10px; background: #18181b; }
        .emoji-tab { width: 32px; height: 32px; background-size: contain; background-repeat: no-repeat; cursor: pointer; opacity: 0.5; }
        .emoji-tab.active { opacity: 1; }
    </style>
</head>
<body onload="initApp()">

<div class="header-bar">
    <div style="font-weight:bold;">Twitch Console v5.8</div>
    <div id="auth-area"><button onclick="twitchLoginPopup()" style="background:var(--t-purp); color:white; border:none; padding:8px 16px; border-radius:4px; cursor:pointer;">登入 Twitch</button></div>
</div>

<div id="chat-container"><div id="messages"></div></div>

<div id="emojiPanel">
    <div style="padding:12px; display:flex; justify-content:space-between; background:#26262c; border-radius: 12px 12px 0 0; align-items:center;">
        <b>表情資源</b>
        <button onclick="$('#emojiPanel').hide()">✕</button>
    </div>
    <div id="emojiTabs"></div>
    <div id="emojiContent"></div>
</div>

<div class="footer">
    <div style="display:flex; gap:8px;">
        <button onclick="insertTag('[s] ', ' [e]')" style="padding:6px 12px; background:#2f2f35; color:white; border:none; border-radius:4px; cursor:pointer;">圖片</button>
        <button onclick="insertTag('[y] ', ' [t]')" style="padding:6px 12px; background:#2f2f35; color:white; border:none; border-radius:4px; cursor:pointer;">影片</button>
        <button onclick="$('#emojiPanel').css('display','flex')" style="padding:6px 12px; background:#2f2f35; color:white; border:none; border-radius:4px; cursor:pointer;">☺ 表情</button>
    </div>
    <div class="input-row">
        <input id="msginput" type="text" placeholder="傳送訊息..." autocomplete="off">
        <button id="sendbtn" onclick="sendMessage()">發送</button>
    </div>
</div>

<script>
    const CHANNEL = "69nocondom";
    const CLIENT_ID = '0uhjgjpko804ba35q1nj1h6x2eriq9';
    let ACCESS_TOKEN = "", socket, altMap = {}, emojiSets = {}, customBadges = {}, msgCache = {};
    let myLoginId = "justinfan123", myDisplayName = "Me"; 

    async function initApp() {
        if (window.location.hash) {
            const token = new URLSearchParams(window.location.hash.substring(1)).get("access_token");
            if (token) {
                if (window.opener) { window.opener.postMessage({ type: "TWITCH_TOKEN", token: token }, "*"); window.close(); return; }
                ACCESS_TOKEN = token;
                try {
                    const r = await fetch('https://api.twitch.tv/helix/users', { headers: { 'Authorization': `Bearer ${ACCESS_TOKEN}`, 'Client-Id': CLIENT_ID } });
                    const d = await r.json();
                    if(d.data && d.data[0]) {
                        myLoginId = d.data[0].login;
                        myDisplayName = d.data[0].display_name;
                        $("#auth-area").html(`<b style="color:#00ff00;">● ${myDisplayName}</b>`);
                    }
                } catch(e) { console.error(e); }
            }
        }
        await loadResources();
        await fetchBadges();
        startChat();
    }

    function twitchLoginPopup() {
        const redirect = window.location.href.split('#')[0];
        const url = `https://id.twitch.tv/oauth2/authorize?client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(redirect)}&response_type=token&scope=chat:read+chat:edit+user:read:email`;
        window.open(url, "TwitchLogin", "width=500,height=600");
    }

    window.addEventListener("message", (e) => {
        if (e.data.type === "TWITCH_TOKEN") {
            window.location.hash = `#access_token=${e.data.token}`;
            window.location.reload();
        }
    });

    async function loadResources() {
        try {
            const skData = await $.getJSON("https://chicktv.github.io/tv/skuser_icon.txt");
            if (Array.isArray(skData)) {
                emojiSets["常用"] = skData;
                skData.forEach(i => { if(i.alt) altMap[i.alt.toLowerCase()] = i.src; });
                $('<div class="emoji-tab"></div>').css("background-image", `url(${skData[0].src})`).on('click', function(){
                    $(".emoji-tab").removeClass("active"); $(this).addClass("active"); renderEmojiList("常用");
                }).appendTo("#emojiTabs");
            }
            const res = await $.getJSON("https://chicktv.github.io/tv/showset.txt");
            for (const item of res.set) {
                let n = (typeof item === 'object') ? item.name : item;
                if (!n || n === "skuser_icon") continue;
                try {
                    const d = await $.getJSON(`https://chicktv.github.io/tv/${n}.txt`);
                    emojiSets[n] = d[n] || [];
                    emojiSets[n].forEach(e => { if(e.alt) altMap[e.alt.toLowerCase()] = e.src; });
                    $('<div class="emoji-tab"></div>').css("background-image", `url(${(typeof item === 'object')?item.image:''})`).on('click', function(){
                        $(".emoji-tab").removeClass("active"); $(this).addClass("active"); renderEmojiList(n);
                    }).appendTo("#emojiTabs");
                } catch(e){}
            }
            $(".emoji-tab").first().click();
        } catch(e){}
    }

    function renderEmojiList(n) {
        $("#emojiContent").empty();
        if(emojiSets[n]) emojiSets[n].forEach(e => {
            $('<div class="emoji-item"></div>').append($('<img>').attr('src', e.src)).on('click', () => insertAtCursor(` ${e.alt} `)).appendTo("#emojiContent");
        });
    }

    function sendMessage() {
        const val = $("#msginput").val();
        if (!val || !socket || socket.readyState !== 1) return;
        socket.send(`PRIVMSG #${CHANNEL} :${val}`);
        
        let msg = val, replyHtml = "";
        msg = msg.replace(/\[r\](.*?),([\d\w-]+)\[m\]/gi, (match, u, k) => {
            replyHtml = `<div class="quote-box">@${u}: ${msgCache[k] || "..."}</div>`;
            return ""; 
        });

        const selfName = myDisplayName || myLoginId;
        const html = `<div class="chat-line">${replyHtml}<b class="self-name">${selfName}:</b> ${parseContent(msg)}</div>`;
        $("#messages").append(html);
        $("#chat-container").scrollTop($("#chat-container")[0].scrollHeight);
        $("#msginput").val("");
    }

    function parseContent(str) {
        let s = str;
        // 媒體解析
        s = s.replace(/\[s\](.*?)\[e\]/gi, '<img src="$1" class="media-preview">');
        s = s.replace(/\[y\](.*?)\[t\]/gi, (m, c) => {
            const v = c.match(/(?:v=|\/shorts\/|youtu.be\/)([^#&?]*)/)?.[1];
            return v ? `<iframe class="media-preview" width="200" height="150" src="https://www.youtube.com/embed/${v}" frameborder="0"></iframe>` : m;
        });

        // --- 重點：偵測訊息中的 @自己 並套用反選標籤 ---
        const myEscapedName = (myDisplayName || "").replace(/[.*+?^${}()|[\]\gt]/g, '\\$&');
        const myEscapedLogin = (myLoginId || "").replace(/[.*+?^${}()|[\]\gt]/g, '\\$&');
        const mentionRegex = new RegExp(`@(${myEscapedName}|${myEscapedLogin})`, 'gi');
        
        s = s.replace(mentionRegex, (match) => `<span class="mention-tag">${match}</span>`);

        // 表情解析
        return s.split(' ').map(w => {
            if (w.startsWith('<span')) return w; // 已經處理過的標籤不處理
            const src = altMap[w.toLowerCase()];
            return src ? `<img src="${src}" class="alt-emoji">` : w;
        }).join(' ');
    }

    function startChat() {
        if(socket) socket.close();
        socket = new WebSocket('wss://irc-ws.chat.twitch.tv:443');
        socket.onopen = () => {
            socket.send('CAP REQ :twitch.tv/tags twitch.tv/commands');
            socket.send(`PASS oauth:${ACCESS_TOKEN || 'dummy'}`);
            socket.send(`NICK ${ACCESS_TOKEN ? 'user' : 'justinfan'+Math.floor(Math.random()*1000)}`);
            socket.send(`JOIN #${CHANNEL}`);
        };
        socket.onmessage = (e) => {
            if (!e.data.includes('PRIVMSG')) return;
            const parts = e.data.split(` PRIVMSG #${CHANNEL} :`), tags = parts[0], rawMsg = parts[1].trim();
            const user = tags.match(/display-name=([^;]+)/)?.[1] || "User", color = tags.match(/color=([^;]+)/)?.[1] || "#9147ff";
            const badgeStr = tags.match(/badges=([^;]*)/)?.[1], msgId = tags.match(/id=([^;]+)/)?.[1], ts = tags.match(/tmi-sent-ts=([\d]+)/)?.[1];
            const cacheKey = ts || msgId;

            let msg = rawMsg, replyHtml = "";
            const pUser = tags.match(/reply-parent-display-name=([^;]+)/)?.[1], pMsg = tags.match(/reply-parent-msg-body=([^;]+)/)?.[1];
            
            if(pUser) {
                replyHtml = `<div class="quote-box">@${pUser}: ${pMsg.replace(/\\s/g, " ")}</div>`;
            } else {
                msg = msg.replace(/\[r\](.*?),([\d\w-]+)\[m\]/gi, (match, u, k) => {
                    replyHtml = `<div class="quote-box">@${u}: ${msgCache[k] || "..."}</div>`;
                    return "";
                });
            }

            const parsedMsg = parseContent(msg);
            msgCache[cacheKey] = parsedMsg;
            
            const isSelf = (user.toLowerCase() === myDisplayName.toLowerCase() || user.toLowerCase() === myLoginId.toLowerCase());
            const nameHtml = isSelf ? `<b class="self-name">${user}:</b>` : `<b style="color:${color}">${user}:</b>`;

            const line = `<div class="chat-line"><div class="reply-btn" onclick="reply('${user}','${cacheKey}')">RE</div>${replyHtml}${parseBadges(badgeStr)}${nameHtml} ${parsedMsg}</div>`;
            $("#messages").append(line);
            $("#chat-container").scrollTop($("#chat-container")[0].scrollHeight);
        };
    }

    function parseBadges(s) {
        if(!s || !customBadges) return "";
        let h = "";
        s.split(',').forEach(b => {
            const k = b.split('/')[0], u = customBadges[b] || customBadges[k];
            if(u) h += `<img class="badge" src="${u}">`;
        });
        return h;
    }

    function insertTag(s, e) { const i = $("#msginput")[0], v = i.value, st = i.selectionStart, en = i.selectionEnd; i.value = v.substring(0, st)+s+v.substring(st, en)+e+v.substring(en); i.focus(); }
    function insertAtCursor(v) { const i = $("#msginput")[0], st = i.selectionStart; i.value = i.value.substring(0, st)+v+i.value.substring(i.selectionEnd); i.focus(); }
    function reply(u, k) { $("#msginput").val(`[r]${u},${k}[m] @${u} `).focus(); }
    function fetchBadges() { return $.getJSON("https://chicktv.github.io/tv/badges.txt", d => customBadges = d); }
    $(document).on('keypress', '#msginput', e => { if (e.which == 13) sendMessage(); });
</script>
</body>
</html>
